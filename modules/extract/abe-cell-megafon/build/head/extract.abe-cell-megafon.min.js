var g_api_headers={"User-Agent":"MLK Android Phone 4.28.10",Connection:"Keep-Alive"},g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/29.0.1547.76 Safari/537.36"},api_url="https://api.megafon.ru/mlk/",replaceNumber=[replaceTagsAndSpaces,/\D/g,"",
/.*(\d\d\d)(\d\d\d)(\d\d)(\d\d)$/,"+7 $1 $2-$3-$4"];
function callAPI(c,a,b,d){c="post"==c?"string"==typeof b?AnyBalance.requestPost(api_url+a,b,addHeaders({"Content-Type":"application/json; charset=utf-8"},g_api_headers)):AnyBalance.requestPost(api_url+a,b,g_api_headers):AnyBalance.requestGet(api_url+a,g_api_headers);a={};if(c)try{a=getJson(c)}catch(f){a=getJsonEval(c)}if("a216"===a.code)throw new AnyBalance.Error(a.message,null,!0);if(a.code&&!d)throw new AnyBalance.Error("Ошибка вызова API! "+a.message,/Неавторизованный доступ/i.test(a.message),
/парол/i.test(a.message));return a}
function megafonLkAPILogin(c){var a=AnyBalance.getPreferences();c=c||{};AnyBalance.setDefaultCharset("utf-8");checkEmpty(a.login&&/^\d{10}$/.test(a.login),"Введите 10 цифр номера телефона без пробелов и разделителей в качестве логина!");AnyBalance.trace("Пробуем войти через API мобильного приложения...");var b=AnyBalance.getCookie("JSESSIONID");b&&AnyBalance.setCookie("api.megafon.ru","JSESSIONID",b);b=AnyBalance.requestGet("https://api.megafon.ru/mlk/auth/check",g_api_headers);if(400<=AnyBalance.getLastStatusCode())throw AnyBalance.trace(b),
new AnyBalance.Error("Сервер мобильного API временно недоступен.");b=getJson(b);b.authenticated&&(AnyBalance.trace("Уже авторизованы на номер "+b.phone),b.phone!=a.login?(AnyBalance.trace("Номер неправильный (надо "+a.login+"), придется авторизоваться заново"),b.authenticated=!1):AnyBalance.trace("Номер правильный, используем текущую сессию"));if(!b.authenticated){b=callAPI("post","login",{login:a.login,password:a.password},!0);if(b.code&&("a211"==b.code&&c.allow_captcha&&(c=AnyBalance.requestGet(api_url+
"auth/captcha",g_api_headers),c=AnyBalance.retrieveCode("Мегафон иногда требует подтвердить, что вы не робот. Сейчас как раз такой случай.\n\nЧтобы уменьшить вероятность требования капчи, используйте опцию входа без пароля с однократным вводом кода из SMS при первом обновлении баланса.",c,{}),b=callAPI("post","login",{login:a.login,password:a.password,captcha:c})),b.code))throw new AnyBalance.Error("Ошибка вызова API! "+b.message,null,/парол/i.test(b.message));__setLoginSuccessful()}}
function randomId(){for(var c="",a=0;11>a;++a)c+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ".substr(Math.floor(62*Math.random()),1);return c}
function megafonLkAPILoginNew(c){c=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");var a=AnyBalance.getData("deviceid");a||(a=randomId(),AnyBalance.setData("deviceid",a),AnyBalance.saveData());AnyBalance.trace("Device id: "+a);g_api_headers["X-MLK-DEVICE-ID"]=a;if(!/^\d{10}$/.test(c.login))throw new AnyBalance.Error("Пожалуйста, укажите в настройках 10 цифр вашего номера Мегафон, например, 9261234567");if(a=AnyBalance.getData("token-"+c.login))if(AnyBalance.trace("Сохранен токен биометрии, входим автоматически"),
d=callAPI("post","auth/biometry",JSON.stringify({captcha:null,msisdn:c.login,token:a}),!0),d.code){AnyBalance.trace(JSON.stringify(d));if(/Внутренняя ошибка/i.test(d.message))throw new AnyBalance.Error(d.message+"\nПожалуйста, попробуйте позже");AnyBalance.trace("Входим по пину");var b=AnyBalance.getData("pin-"+c.login);d=callAPI("post","auth/pin",JSON.stringify({captcha:null,msisdn:c.login,pin:b}),!0);if(d.code){AnyBalance.trace(JSON.stringify(d));if(/Внутренняя ошибка/i.test(d.message))throw new AnyBalance.Error(d.message+
"\nПожалуйста, попробуйте позже");a=null}else d=callAPI("post","api/profile/biometry","{}",!0),d.token&&(AnyBalance.trace("Обновляем токен биометрии"),AnyBalance.setData("token-"+c.login,d.token),AnyBalance.saveData())}if(!a){AnyBalance.trace("Вход по одноразовому паролю. Привязываем устройство");var d=callAPI("post","auth/otp/request",{login:c.login},!0);if(!d.ok)throw AnyBalance.trace(html),new AnyBalance.Error(d.message||"Ошибка входа. Неправильный номер?",null,!0);a=AnyBalance.retrieveCode("Пожалуйста, введите код входа в Личный Кабинет из СМС для привязки номера к устройству",
null,{inputType:"number",time:3E5});d=callAPI("post","auth/otp/submit",{login:c.login,otp:a},!0);if(d.code)throw AnyBalance.trace(html),new AnyBalance.Error(d.message||"Неверный код подтверждения");b=Math.floor(1E3+9E3*Math.random()).toString();callAPI("post","api/profile/pin",JSON.stringify({captcha:null,pin:b}));d=callAPI("post","api/profile/biometry","{}");if(!d.token)throw new AnyBalance.Error("Не удалось получить токен биометрии. Сайт изменен?");AnyBalance.setData("pin-"+c.login,b);AnyBalance.setData("token-"+
c.login,d.token);AnyBalance.saveData()}}
function megafonLkAPIDo(c,a){var b=AnyBalance.getPreferences();AnyBalance.isAvailable("phone")&&getParam(b.login,a,"phone",null,replaceNumber);if(AnyBalance.isAvailable("balance","credit","available","cashback"))try{json=callAPI("get","api/main/balance");var d=json.balanceWithLimit||json.limit||0;getParam(d+"",a,"available",null,replaceTagsAndSpaces,parseBalance);getParam(json.balance+"",a,"balance",null,replaceTagsAndSpaces,parseBalance);getParam(d-json.balance+"",a,"credit",null,replaceTagsAndSpaces,
parseBalance);getParam(json.cashback+"",a,"cashback",null,replaceTagsAndSpaces,parseBalance)}catch(f){AnyBalance.trace("Ошибка получения информации о балансе: "+f.message)}if(AnyBalance.isAvailable("tariff","sub_smit")&&!a.tariff)try{json=callAPI("get","api/tariff/2019-3/current"),getParam(json.name,a,"tariff",null,replaceTagsAndSpaces),json.ratePlanCharges&&json.ratePlanCharges.price&&(b=1,/в [день|сутки]/i.test(json.ratePlanCharges.price.unitPeriod)&&(b=30),getParam(json.ratePlanCharges.price.value*
b+"",a,"sub_smit",null,replaceTagsAndSpaces,parseBalance))}catch(f){AnyBalance.trace("Ошибка получения информации о тарифном плане: "+f.message)}if(AnyBalance.isAvailable("bonus_status","bonus_burn"))try{json=callAPI("get","api/bonus/status"),getParam(json.statusDesc,a,"bonus_status",null,replaceTagsAndSpaces),getParam(null,a,"bonus_burn")}catch(f){AnyBalance.trace("Ошибка получения информации о бонусной программе: "+f.message)}processPersonalOffers(a);processServices(a);processRemaindersApi(a);processMonthExpensesApi(a);
processPaymentsApi(a);if(AnyBalance.isAvailable("month_refill","sub_scl"))try{json=callAPI("get","api/payments/info"),getParam(json.income+"",a,"month_refill",null,replaceTagsAndSpaces,parseBalance),getParam(json.outcome+"",a,"sub_scl",null,replaceTagsAndSpaces,parseBalance)}catch(f){AnyBalance.trace("Ошибка получения информации о расходах и пополнениях: "+f.message+"\n"+f.stack)}processInfoApi(a);processAddNumApi(a);processMegaPowersApi(a);AnyBalance.isAvailable("detalization")&&processDetalizationApi(a);
c.dontTurnOffSms||processSmsTurnOffApi()}
function processPaymentsApi(c){if(AnyBalance.isAvailable("payments"))try{var a=callAPI("get","api/payments/history?offset=0&size=10",!0);if(a.payments){c.payments=[];for(var b=0;b<a.payments.length;b++){var d=a.payments[b],f={};getParam(d.amount,f,"payments.sum");getParam(d.date,f,"payments.date",null,null,parseDate);getParam(d.descr,f,"payments.descr");c.payments.push(f)}}else AnyBalance.trace("Не удалось получить историю платежей: "+JSON.stringify(a))}catch(g){AnyBalance.trace("Ошибка получения истории платежей: "+g.message+
"\n"+g.stack)}}
function processMonthExpensesApi(c){if(AnyBalance.isAvailable("month_expenses"))try{var a=callAPI("get","api/reports/months",!0);if(a.expenseMonths){c.month_expences=[];for(var b=0;b<a.expenseMonths.length;b++){var d=a.expenseMonths[b],f={};getParam(d.amount,f,"month_expences.sum");getParam(d.reportDate,f,"month_expences.date",null,null,parseDate);getParam(d.percent,f,"month_expences.pct");c.month_expences.push(f)}}else AnyBalance.trace("Не удалось получить историю месячных трат: "+JSON.stringify(a))}catch(g){AnyBalance.trace("Ошибка получения истории месячных трат: "+
g.message+"\n"+g.stack)}}
function processRemaindersApi(c){if(AnyBalance.isAvailable("remainders")||AnyBalance.isAvailable("tariff")&&!c.tariff){var a=callAPI("get","api/options/remainders"),b=c.remainders={},d=[];if(a.models)for(var f=a.models.length-1;0<=f;f--){var g=a.models[f];"RATE_PLAN"!=g.optionsRemaindersType||c.tariff||(c.tariff=replaceAll(g.name,replaceTagsAndSpaces));var n=g.remainders&&g.remainders[0]&&g.remainders[0].optionId;if(0<=d.indexOf(g.name+n)&&/OPTION/i.test(g.optionsRemaindersType))AnyBalance.trace("Мы уже обработали пакеты опций из группы "+g.name),
AnyBalance.trace(JSON.stringify(g));else if(g.remainders)for(d.push(g.name+n),n=0;n<g.remainders.length;n++){var e=g.remainders[n],h=e.name,k=e.unit;if(0>e.available)AnyBalance.trace("Игнорируем отрицательные остатки..."+JSON.stringify(e));else if(/мин|сек/i.test(k)&&!/интернет/i.test(h)||/шт/i.test(k)&&/минут/i.test(h)&&!/СМС|SMS|MMS|ММС/i.test(h)){AnyBalance.trace("Parsing minutes..."+JSON.stringify(e));var m=/^9{6,}$/i.test(e.total);m||26E5<+e.total?AnyBalance.trace("Пропускаем безлимит минут: "+
h+" "+(e.available+" "+e.unit)+"/"+(e.total+" "+e.unit)):/в сутки/i.test(h)?getParam(e.available+" "+k,b,"remainders.mins_day",null,replaceTagsAndSpaces,parseMinutes):/бесплат/i.test(h)?getParam(e.available+" "+k,b,"remainders.mins_n_free",null,replaceTagsAndSpaces,parseMinutes):/\.\s*МегаФон|на мегафон|на МФ/i.test(h)&&!/МТС/i.test(h)&&!/стационар/i.test(h)||/внутри сети/i.test(h)?sumParam(e.available+" "+k,b,"remainders.mins_net_left",null,replaceTagsAndSpaces,parseMinutes,aggregate_sum):/Безлимитные входящие/i.test(h)?
AnyBalance.trace("Бесконечное значение минут ("+h+"), пропускаем..."):(sumParam(e.available+" "+k,b,"remainders.mins_left",null,replaceTagsAndSpaces,parseMinutes,aggregate_sum),sumParam(e.total+" "+k,b,"remainders.mins_total",null,replaceTagsAndSpaces,parseMinutes,aggregate_sum))}else if(/шт|sms|смс|mms|ммс/i.test(k))(m=/^9{6,}$/i.test(e.total))?AnyBalance.trace("Пропускаем безлимит смс: "+h+" "+(e.available+" "+e.unit)+"/"+(e.total+" "+e.unit)):/mms|ММС/i.test(h)?(AnyBalance.trace("Parsing mms..."+
JSON.stringify(e)),sumParam(e.available,b,"remainders.mms_left",null,replaceTagsAndSpaces,parseBalance,aggregate_sum),sumParam(e.total,b,"remainders.mms_total",null,replaceTagsAndSpaces,parseBalance,aggregate_sum)):(AnyBalance.trace("Parsing sms..."+JSON.stringify(e)),sumParam(e.available,b,"remainders.sms_left",null,replaceTagsAndSpaces,parseBalance,aggregate_sum),sumParam(e.total,b,"remainders.sms_total",null,replaceTagsAndSpaces,parseBalance,aggregate_sum));else if(/([kmgtкмгт][бb]|[бb](?![\wа-я])|байт|byte)/i.test(k))if(AnyBalance.trace("Parsing data..."+
JSON.stringify(e)),/Гигабайт в дорогу/i.test(h))getParam(e.available+" "+e.unit,b,"remainders.gb_with_you",null,replaceTagsAndSpaces,parseTraffic);else if(/Интернет в роуминге/i.test(h))/Остальные страны/i.test(h)?getParam(e.available+" "+e.unit,b,"remainders.internet_roam_other",null,replaceTagsAndSpaces,parseTraffic):/Популярные страны/i.test(h)?getParam(e.available+" "+e.unit,b,"remainders.internet_roam_popular",null,replaceTagsAndSpaces,parseTraffic):/ЕВРОПА/i.test(h)&&getParam(e.available+" "+
e.unit,b,"remainders.internet_roam_europe",null,replaceTagsAndSpaces,parseTraffic);else if(/Автопродление/i.test(h))getParam(e.available+" "+e.unit,b,"remainders.internet_auto_prolong",null,replaceTagsAndSpaces,parseTraffic);else if(/Интернет в (?:Крыму|поездке)/i.test(h))getParam(e.available+" "+e.unit,b,"remainders.internet_left_crimea",null,replaceTagsAndSpaces,parseTraffic);else{k="";/ноч/i.test(h)&&(k="_night");m=/^9{7,}$/i.test(e.total);var q=getParam(e.available+" "+e.unit,null,null,null,replaceTagsAndSpaces,
parseTraffic),p=getParam(e.total+" "+e.unit,null,null,null,replaceTagsAndSpaces,parseTraffic);m||(m=999E3<=p);m&&AnyBalance.trace("Пропускаем безлимит трафика: "+h+" "+(e.available+" "+e.unit)+"/"+(e.total+" "+e.unit));isset(q)&&!m&&sumParam(q,b,"remainders.internet_left"+k,null,null,null,aggregate_sum);isset(p)&&!m&&sumParam(p,b,"remainders.internet_total"+k,null,null,null,aggregate_sum);isset(q)&&isset(p)&&!m&&sumParam(p-q,b,"remainders.internet_cur"+k,null,null,null,aggregate_sum);isset(q)&&isset(p)&&
sumParam(p-q,b,"remainders.internet_cur_total",null,null,null,aggregate_sum);e.dateTo?sumParam(e.dateTo,b,"remainders.internet_till",null,replaceTagsAndSpaces,parseDate,aggregate_min):e.dateFrom&&e.monthly&&sumParam(e.dateFrom,b,"remainders.internet_till",null,replaceTagsAndSpaces,function(l){if(l=parseDate(l))l=new Date(l),l=(new Date(l.getFullYear(),l.getMonth()+1,l.getDate(),l.getHours(),l.getMinutes(),l.getSeconds())).getTime();return l},aggregate_min)}else AnyBalance.trace("Неизвестные единицы измерений: "+
k+" опция: "+h+": "+JSON.stringify(e))}}else AnyBalance.trace("Остатков не обнаружено: "+JSON.stringify(a))}}
function processInfoApi(c){if(AnyBalance.isAvailable("info")){AnyBalance.trace("Получаем инфо");try{var a=callAPI("get","api/profile/info"),b=c.info={};getParam(a.contractStart,b,"info.date_start",null,null,parseDate);getParam(a.birthdate,b,"info.birthday",null,null,parseDate);getParam(a.email,b,"info.email");getParam(a.name,b,"info.fio");getParam(a.accountNumber,b,"info.license");getParam(a.region.id,b,"info.region_id");getParam(a.region.name,b,"info.region_name");getParam({100:"nw",200:"mos",300:"ctr",
400:"kv",500:"vlg",600:"url",700:"sib",800:"dv"}[a.region.id]||a.region.id,b,"info.filial")}catch(d){AnyBalance.trace("Ошибка получения информации о персональных данных: "+d.message)}}if(AnyBalance.isAvailable("license")&&!b.license)try{a=callAPI("get","api/profile/accountNumber"),getParam(a.accountNumber,b,"info.license")}catch(d){AnyBalance.trace("Ошибка получения информации о лицевом счете: "+d.message)}}
function processAddNumApi(c){if(AnyBalance.isAvailable("add_num","add_num1","add_num2"))try{var a=callAPI("get","api/additionalNumbers/list");if(a.additionalNumbersList&&0<a.additionalNumbersList.length){AnyBalance.trace("Найдено доп. номеров: "+a.additionalNumbersList.length);for(var b=0;b<a.additionalNumbersList.length;b++){var d=1<=b?"add_num_prefix"+(b+1):"add_num_prefix",f=1<=b?"add_num_charge"+(b+1):"add_num_charge";getParam(a.additionalNumbersList[b].number,c,1<=b?"add_num"+(b+1):"add_num",
null,replaceNumber);getParam(a.additionalNumbersList[b].prefix,c,d);getParam(a.additionalNumbersList[b].dailyCharge,c,f)}}else AnyBalance.trace("Не удалось получить список доп. номеров: "+JSON.stringify(a))}catch(g){AnyBalance.trace("Ошибка получения информации о дополнительных номерах: "+g.message)}}
function processSmsTurnOffApi(){try{var c=callAPI("get","api/profile/info");c.notifications?(AnyBalance.trace("Включено смс оповещение о входе, отключаем..."),c=callAPI("post","api/profile/notifications?status=false"),AnyBalance.trace("Отключили, проверяем..."),c=callAPI("get","api/profile/info"),c.notifications?AnyBalance.trace("Не удалось отключить смс оповещение о входе в кабинет. Свяжитесь с разработчиком."):AnyBalance.trace("Успешно отключили смс оповещение о входе в кабинет!")):AnyBalance.trace("Cмс оповещение о входе в кабинет уже отключено!")}catch(a){AnyBalance.trace("Отключение смс не удалось: "+
a.message)}}
function processMegaPowersApi(c){if(AnyBalance.isAvailable("megapowers")){var a=0,b=0;try{var d=callAPI("get","api/preconstructor/megapowers");if(/[МегаСилы|они] недоступны/i.test(d.description))AnyBalance.trace("Не удалось получить список мегасил: "+d.description);else{if(d.options&&0<d.options.length)for(var f=0;f<d.options.length;f++){var g=d.options[f].status;g&&"0"!==g&&(a+=1)}else AnyBalance.trace("Не удалось получить список доступных мегасил: "+JSON.stringify(d));if(d.badges&&0<d.badges.length)for(f=
0;f<d.badges.length;f++)b+=d.badges[f].counterLimit;else AnyBalance.trace("Не удалось получить лимит доступных мегасил: "+JSON.stringify(d))}}catch(n){AnyBalance.trace("Ошибка получения информации о мегасилах: "+n.message)}getParam(a+"/"+b+" шт",c,"megapowers")}}
function processPersonalOffers(c){if(AnyBalance.isAvailable("personal_offers"))try{var a=callAPI("get","api/personaloffer/summary");getParam(a.count,c,"personal_offers")}catch(b){AnyBalance.trace("Ошибка получения информации о персональных предложениях: "+b.message)}}
function processServices(c){if(AnyBalance.isAvailable("services_free","services_paid","services_count","services_abon","services_abon_day","statuslock"))try{var a=callAPI("get","api/options/list/current");getParam(a.free?a.free.length:0,c,"services_free");getParam(a.paid?a.paid.length:0,c,"services_paid");getParam((a.free?a.free.length:0)+(a.paid?a.paid.length:0),c,"services_count");getParam(0,c,"services_abon");getParam(0,c,"services_abon_day");getParam("Номер не блокирован",c,"statuslock");if(a.paid&&
0<a.paid.length)for(var b=0;b<a.paid.length;++b){var d=a.paid[b];AnyBalance.trace("Платная услуга "+d.optionName+": "+d.fees[0]);var f="";!0!==d.monthly&&(f="_day");sumParam(d.monthRate,c,"services_abon"+f,null,null,null,aggregate_sum);/Блокировка номера/i.test(d.optionName)&&getParam("Номер заблокирован",c,"statuslock")}}catch(g){AnyBalance.trace("Ошибка получения информации об услугах: "+g.message)}};
