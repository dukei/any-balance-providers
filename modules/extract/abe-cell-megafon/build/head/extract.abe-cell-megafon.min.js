var g_api_headers={"User-Agent":"MLK Android Phone 3.0.8",Connection:"Keep-Alive"},g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/29.0.1547.76 Safari/537.36"},api_url="https://api.megafon.ru/mlk/",replaceNumber=[replaceTagsAndSpaces,/\D/g,"",/.*(\d\d\d)(\d\d\d)(\d\d)(\d\d)$/,
"+7 $1 $2-$3-$4"];function callAPI(d,b,a,h){d="post"==d?"string"==typeof a?AnyBalance.requestPost(api_url+b,a,addHeaders({"Content-Type":"application/json; charset=utf-8"},g_api_headers)):AnyBalance.requestPost(api_url+b,a,g_api_headers):AnyBalance.requestGet(api_url+b,g_api_headers);var e;try{e=getJson(d)}catch(f){e=getJsonEval(d)}if(e.code&&!h)throw new AnyBalance.Error("Ошибка вызова API! "+e.message,/Неавторизованный доступ/i.test(e.message),/парол/i.test(e.message));return e}
function megafonLkAPILogin(d){var b=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");checkEmpty(b.login&&/^\d{10}$/.test(b.login),"Введите 10 цифр номера телефона без пробелов и разделителей в качестве логина!");AnyBalance.trace("Пробуем войти через API мобильного приложения...");var a=AnyBalance.getCookie("JSESSIONID");a&&AnyBalance.setCookie("api.megafon.ru","JSESSIONID",a);a=AnyBalance.requestGet("https://api.megafon.ru/mlk/auth/check",g_api_headers);if(400<=AnyBalance.getLastStatusCode())throw AnyBalance.trace(a),
new AnyBalance.Error("Сервер мобильного API временно недоступен.");a=getJson(a);a.authenticated&&(AnyBalance.trace("Уже авторизованы на номер "+a.phone),a.phone!=b.login?(AnyBalance.trace("Номер неправильный (надо "+b.login+"), придется авторизоваться заново"),a.authenticated=!1):AnyBalance.trace("Номер правильный, используем текущую сессию"));if(!a.authenticated){a=callAPI("post","login",{login:b.login,password:b.password},!0);if(a.code&&("a211"==a.code&&d.allow_captcha&&(d=AnyBalance.requestGet(api_url+
"auth/captcha",g_api_headers),d=AnyBalance.retrieveCode("Мегафон иногда требует подтвердить, что вы не робот. Сейчас как раз такой случай. Если вы введете цифры с картинки, то мы сможем получить какую-то информацию помимо баланса. В противном случае получим только баланс.\n\nВы можете отключить показ капчи совсем или только ночью в настройках провайдера.",d,{inputType:"number"}),a=callAPI("post","login",{login:b.login,password:b.password,captcha:d})),a.code))throw new AnyBalance.Error("Ошибка вызова API! "+
a.message,null,/парол/i.test(a.message));__setLoginSuccessful()}}
function megafonLkAPIDo(d,b){var a=AnyBalance.getPreferences();AnyBalance.isAvailable("phone")&&getParam(a.login,b,"phone",null,replaceNumber);AnyBalance.isAvailable("balance","credit","available")&&(json=callAPI("get","api/main/balance"),getParam(json.balanceWithLimit+"",b,"available",null,replaceTagsAndSpaces,parseBalance),getParam(json.balance+"",b,"balance",null,replaceTagsAndSpaces,parseBalance),getParam(json.balanceWithLimit-json.balance+"",b,"credit",null,replaceTagsAndSpaces,parseBalance));
AnyBalance.isAvailable("tariff")&&!b.tariff&&(json=callAPI("get","api/tariff/current"),getParam(json.name,b,"tariff",null,replaceTagsAndSpaces));try{AnyBalance.isAvailable("bonus_status","bonus_burn")&&(json=callAPI("get","api/bonus/status"),getParam(json.statusDesc,b,"bonus_status",null,replaceTagsAndSpaces),getParam(null,b,"bonus_burn"))}catch(h){AnyBalance.trace("Не удалось получить информацию о бонусной программе: "+h.message)}processServiceStopContentApi(b);processRemaindersApi(b);processMonthExpensesApi(b);
processPaymentsApi(b);if(AnyBalance.isAvailable("sub_scl"))try{json=callAPI("get","api/payments/info"),getParam(json.outcome+"",b,"sub_scl",null,replaceTagsAndSpaces,parseBalance)}catch(h){AnyBalance.trace("Ошибка получения информации о звонках: "+h.message+"\n"+h.stack)}processInfoApi(b);AnyBalance.isAvailable("detalization")&&processDetalizationApi(b);d.dontTurnOffSms||processSmsTurnOffApi()}
function processPaymentsApi(d){if(AnyBalance.isAvailable("payments"))try{var b=callAPI("get","api/payments/history?offset=0&size=10",!0);if(b.payments){d.payments=[];for(var a=0;a<b.payments.length;a++){var h=b.payments[a],e={};getParam(h.amount,e,"payments.sum");getParam(h.date,e,"payments.date",null,null,parseDate);getParam(h.descr,e,"payments.descr");d.payments.push(e)}}else AnyBalance.trace("Не удалось получить историю платежей: "+JSON.stringify(b))}catch(f){AnyBalance.trace("Ошибка получения истории платежей: "+
f.message+"\n"+f.stack)}}
function processMonthExpensesApi(d){if(AnyBalance.isAvailable("month_expenses"))try{var b=callAPI("get","api/reports/months",!0);if(b.expenseMonths){d.month_expences=[];for(var a=0;a<b.expenseMonths.length;a++){var h=b.expenseMonths[a],e={};getParam(h.amount,e,"month_expences.sum");getParam(h.reportDate,e,"month_expences.date",null,null,parseDate);getParam(h.percent,e,"month_expences.pct");d.month_expences.push(e)}}else AnyBalance.trace("Не удалось получить историю месячных трат: "+JSON.stringify(b))}catch(f){AnyBalance.trace("Ошибка получения истории месячных трат: "+
f.message+"\n"+f.stack)}}
function processRemaindersApi(d){if(AnyBalance.isAvailable("remainders")||AnyBalance.isAvailable("tariff")&&!d.tariff){var b=callAPI("get","api/options/remainders"),a=d.remainders={},h=[];if(b.models)for(var e=b.models.length-1;0<=e;e--){var f=b.models[e];"RATE_PLAN"!=f.optionsRemaindersType||d.tariff||(d.tariff=replaceAll(f.name,replaceTagsAndSpaces));var l=f.remainders&&f.remainders[0]&&f.remainders[0].optionId;if(0<=h.indexOf(f.name+l)&&/OPTION/i.test(f.optionsRemaindersType))AnyBalance.trace("Мы уже обработали пакеты опций из группы "+f.name),
AnyBalance.trace(JSON.stringify(f));else if(f.remainders)for(h.push(f.name+l),l=0;l<f.remainders.length;l++){var c=f.remainders[l],g=c.name,k=c.unit;if(0>c.available)AnyBalance.trace("Игнорируем отрицательные остатки..."+JSON.stringify(c));else if(/мин|сек/i.test(k)&&!/интернет/i.test(g)||/шт/i.test(k)&&/минут/i.test(g)&&!/СМС|SMS|MMS|ММС/i.test(g))AnyBalance.trace("Parsing minutes..."+JSON.stringify(c)),/в сутки/i.test(g)?getParam(c.available+k,a,"remainders.mins_day",null,replaceTagsAndSpaces,parseMinutes):
/бесплат/i.test(g)?getParam(c.available+k,a,"remainders.mins_n_free",null,replaceTagsAndSpaces,parseMinutes):/\.\s*МегаФон|на мегафон|на МФ/i.test(g)&&!/МТС/i.test(g)&&!/стационар/i.test(g)||/внутри сети/i.test(g)?sumParam(c.available+k,a,"remainders.mins_net_left",null,replaceTagsAndSpaces,parseMinutes,aggregate_sum):/Безлимитные входящие/i.test(g)?AnyBalance.trace("Бесконечное значение минут ("+g+"), пропускаем..."):(sumParam(c.available+k,a,"remainders.mins_left",null,replaceTagsAndSpaces,parseMinutes,
aggregate_sum),sumParam(c.total+k,a,"remainders.mins_total",null,replaceTagsAndSpaces,parseMinutes,aggregate_sum));else if(/шт|sms|смс|mms|ммс/i.test(k))/mms|ММС/i.test(g)?(AnyBalance.trace("Parsing mms..."+JSON.stringify(c)),sumParam(c.available,a,"remainders.mms_left",null,replaceTagsAndSpaces,parseBalance,aggregate_sum),sumParam(c.total,a,"remainders.mms_total",null,replaceTagsAndSpaces,parseBalance,aggregate_sum)):(AnyBalance.trace("Parsing sms..."+JSON.stringify(c)),sumParam(c.available,a,"remainders.sms_left",
null,replaceTagsAndSpaces,parseBalance,aggregate_sum),sumParam(c.total,a,"remainders.sms_total",null,replaceTagsAndSpaces,parseBalance,aggregate_sum));else if(/([kmgtкмгт][бb]|[бb](?![\wа-я])|байт|byte)/i.test(k))if(AnyBalance.trace("Parsing data..."+JSON.stringify(c)),/Гигабайт в дорогу/i.test(g))getParam(c.available+c.unit,a,"remainders.gb_with_you",null,replaceTagsAndSpaces,parseTraffic);else if(/Интернет в роуминге/i.test(g))/Остальные страны/i.test(g)?getParam(c.available+c.unit,a,"remainders.internet_roam_other",
null,replaceTagsAndSpaces,parseTraffic):/Популярные страны/i.test(g)?getParam(c.available+c.unit,a,"remainders.internet_roam_popular",null,replaceTagsAndSpaces,parseTraffic):/ЕВРОПА/i.test(g)&&getParam(c.available+c.unit,a,"remainders.internet_roam_europe",null,replaceTagsAndSpaces,parseTraffic);else if(/Автопродление/i.test(g))getParam(c.available+c.unit,a,"remainders.internet_auto_prolong",null,replaceTagsAndSpaces,parseTraffic);else if(/Интернет в Крыму/i.test(g))getParam(c.available+c.unit,a,
"remainders.internet_left_crimea",null,replaceTagsAndSpaces,parseTraffic);else{k="";/ноч/i.test(g)&&(k="_night");var m=/^9{7,}$/i.test(c.total),p=getParam(c.available+c.unit,null,null,null,replaceTagsAndSpaces,parseTraffic),n=getParam(c.total+c.unit,null,null,null,replaceTagsAndSpaces,parseTraffic);m||(m=999E3<=n);m&&AnyBalance.trace("пропускаем безлимит трафика: "+g+" "+(c.available+c.unit)+"/"+(c.total+c.unit));isset(p)&&!m&&sumParam(p,a,"remainders.internet_left"+k,null,null,null,aggregate_sum);
isset(n)&&!m&&sumParam(n,a,"remainders.internet_total"+k,null,null,null,aggregate_sum);isset(p)&&isset(n)&&sumParam(n-p,a,"remainders.internet_cur"+k,null,null,null,aggregate_sum);c.dateTo?sumParam(c.dateTo,a,"remainders.internet_till",null,replaceTagsAndSpaces,parseDate,aggregate_min):c.dateFrom&&c.monthly&&sumParam(c.dateFrom,a,"remainders.internet_till",null,replaceTagsAndSpaces,function(a){if(a=parseDate(a))a=new Date(a),a=(new Date(a.getFullYear(),a.getMonth()+1,a.getDate(),a.getHours(),a.getMinutes(),
a.getSeconds())).getTime();return a},aggregate_min)}else AnyBalance.trace("Неизвестные единицы измерений: "+k+" опция: "+g+": "+JSON.stringify(c))}}else AnyBalance.trace("Остатков не обнаружено: "+JSON.stringify(b))}}
function processInfoApi(d){if(AnyBalance.isAvailable("info")){AnyBalance.trace("Получаем инфо");var b=callAPI("get","api/profile/info");d=d.info={};getParam(b.contractStart,d,"info.date_start",null,null,parseDate);getParam(b.birthdate,d,"info.birthday",null,null,parseDate);getParam(b.email,d,"info.email");getParam(b.name,d,"info.fio");getParam(b.region.id,d,"info.region_id");getParam(b.region.name,d,"info.region_name")}}
function processSmsTurnOffApi(){try{var d=callAPI("get","api/profile/info");d.notifications?(AnyBalance.trace("Включено смс оповещение о входе, отключаем..."),d=callAPI("post","api/profile/notifications?status=false"),AnyBalance.trace("Отключили, проверяем..."),d=callAPI("get","api/profile/info"),d.notifications?AnyBalance.trace("Не удалось отключить смс оповещение о входе в кабинет. Свяжитесь с разработчиком."):AnyBalance.trace("Успешно отключили смс оповещение о входе в кабинет!")):AnyBalance.trace("Cмс оповещение о входе в кабинет уже отключено!")}catch(b){AnyBalance.trace("Отключение смс не удалось: "+
b.message)}}
function processServiceStopContentApi(d){if(AnyBalance.isAvailable("status_stop_content")){for(var b=callAPI("get","api/options/list/additional"),a=0;a<b.list.length;++a)for(var h=b.list[a],e=0;e<h.options.length;++e){var f=h.options[e];if(/Запрет платных контентных|стоп-контент/i.test(f.optionName)||/ad\/stop|stop_content/i.test(f.link)){getParam("1"==f.status?"Услуга подключена "+f.operDate:"Услуга не подключена",d,"status_stop_content");return}}AnyBalance.trace("Услуга Стоп-контент вообще не найдена: "+JSON.stringify(b))}}
;
