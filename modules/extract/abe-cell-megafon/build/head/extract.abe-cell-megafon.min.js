var g_api_headers={"User-Agent":"MLK Android Phone 3.3.10",Connection:"Keep-Alive"},g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/29.0.1547.76 Safari/537.36"},api_url="https://api.megafon.ru/mlk/",replaceNumber=[replaceTagsAndSpaces,/\D/g,"",
/.*(\d\d\d)(\d\d\d)(\d\d)(\d\d)$/,"+7 $1 $2-$3-$4"];
function callAPI(b,a,c,e){b="post"==b?"string"==typeof c?AnyBalance.requestPost(api_url+a,c,addHeaders({"Content-Type":"application/json; charset=utf-8"},g_api_headers)):AnyBalance.requestPost(api_url+a,c,g_api_headers):AnyBalance.requestGet(api_url+a,g_api_headers);a={};if(b)try{a=getJson(b)}catch(k){a=getJsonEval(b)}if("a216"===a.code)throw new AnyBalance.Error(a.message,null,!0);if(a.code&&!e)throw new AnyBalance.Error("Ошибка вызова API! "+a.message,/Неавторизованный доступ/i.test(a.message),
/парол/i.test(a.message));return a}
function megafonLkAPILogin(b){var a=AnyBalance.getPreferences();b=b||{};AnyBalance.setDefaultCharset("utf-8");checkEmpty(a.login&&/^\d{10}$/.test(a.login),"Введите 10 цифр номера телефона без пробелов и разделителей в качестве логина!");AnyBalance.trace("Пробуем войти через API мобильного приложения...");var c=AnyBalance.getCookie("JSESSIONID");c&&AnyBalance.setCookie("api.megafon.ru","JSESSIONID",c);c=AnyBalance.requestGet("https://api.megafon.ru/mlk/auth/check",g_api_headers);if(400<=AnyBalance.getLastStatusCode())throw AnyBalance.trace(c),
new AnyBalance.Error("Сервер мобильного API временно недоступен.");c=getJson(c);c.authenticated&&(AnyBalance.trace("Уже авторизованы на номер "+c.phone),c.phone!=a.login?(AnyBalance.trace("Номер неправильный (надо "+a.login+"), придется авторизоваться заново"),c.authenticated=!1):AnyBalance.trace("Номер правильный, используем текущую сессию"));if(!c.authenticated){c=callAPI("post","login",{login:a.login,password:a.password},!0);if(c.code&&("a211"==c.code&&b.allow_captcha&&(b=AnyBalance.requestGet(api_url+
"auth/captcha",g_api_headers),b=AnyBalance.retrieveCode("Мегафон иногда требует подтвердить, что вы не робот. Сейчас как раз такой случай.\n\nЧтобы уменьшить вероятность требования капчи, используйте опцию входа без пароля с однократным вводом кода из SMS при первом обновлении баланса.",b,{}),c=callAPI("post","login",{login:a.login,password:a.password,captcha:b})),c.code))throw new AnyBalance.Error("Ошибка вызова API! "+c.message,null,/парол/i.test(c.message));__setLoginSuccessful()}}
function randomId(){for(var b="",a=0;11>a;++a)b+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ".substr(Math.floor(62*Math.random()),1);return b}
function megafonLkAPILoginNew(b){b=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");var a=AnyBalance.getData("deviceid");a||(a=randomId(),AnyBalance.setData("deviceid",a),AnyBalance.saveData());AnyBalance.trace("Device id: "+a);g_api_headers["X-MLK-DEVICE-ID"]=a;if(!/^\d{10}$/.test(b.login))throw new AnyBalance.Error("Пожалуйста, укажите в настройках 10 цифр вашего номера Мегафон, например, 9261234567");if(a=AnyBalance.getData("token-"+b.login))if(AnyBalance.trace("Сохранен токен биометрии, входим автоматически"),
e=callAPI("post","auth/biometry",JSON.stringify({captcha:null,msisdn:b.login,token:a}),!0),e.code){AnyBalance.trace(JSON.stringify(e));if(/Внутренняя ошибка/i.test(e.message))throw new AnyBalance.Error(e.message+"\nПожалуйста, попробуйте позже");AnyBalance.trace("Входим по пину");var c=AnyBalance.getData("pin-"+b.login),e=callAPI("post","auth/pin",JSON.stringify({captcha:null,msisdn:b.login,pin:c}),!0);if(e.code){AnyBalance.trace(JSON.stringify(e));if(/Внутренняя ошибка/i.test(e.message))throw new AnyBalance.Error(e.message+
"\nПожалуйста, попробуйте позже");a=null}else e=callAPI("post","api/profile/biometry","{}",!0),e.token&&(AnyBalance.trace("Обновляем токен биометрии"),AnyBalance.setData("token-"+b.login,e.token),AnyBalance.saveData())}if(!a){AnyBalance.trace("Вход по одноразовому паролю. Привязываем устройство");var e=callAPI("post","auth/otp/request",{login:b.login},!0);if(!e.ok)throw AnyBalance.trace(html),new AnyBalance.Error(e.message||"Ошибка входа. Неправильный номер?",null,!0);a=AnyBalance.retrieveCode("Пожалуйста, введите код входа в Личный Кабинет из СМС для привязки номера к устройству",
null,{inputType:"number"});e=callAPI("post","auth/otp/submit",{login:b.login,otp:a},!0);if(e.code)throw AnyBalance.trace(html),new AnyBalance.Error(e.message||"Неверный код подтверждения");c=Math.floor(1E3+9E3*Math.random()).toString();callAPI("post","api/profile/pin",JSON.stringify({captcha:null,pin:c}));e=callAPI("post","api/profile/biometry","{}");if(!e.token)throw new AnyBalance.Error("Не удалось получить токен биометрии. Сайт изменен?");AnyBalance.setData("pin-"+b.login,c);AnyBalance.setData("token-"+
b.login,e.token);AnyBalance.saveData()}}
function megafonLkAPIDo(b,a){var c=AnyBalance.getPreferences();AnyBalance.isAvailable("phone")&&getParam(c.login,a,"phone",null,replaceNumber);AnyBalance.isAvailable("balance","credit","available")&&(json=callAPI("get","api/main/balance"),getParam(json.balanceWithLimit+"",a,"available",null,replaceTagsAndSpaces,parseBalance),getParam(json.balance+"",a,"balance",null,replaceTagsAndSpaces,parseBalance),getParam(json.balanceWithLimit-json.balance+"",a,"credit",null,replaceTagsAndSpaces,parseBalance));
AnyBalance.isAvailable("tariff")&&!a.tariff&&(json=callAPI("get","api/tariff/2019-2/current"),getParam(json.name,a,"tariff",null,replaceTagsAndSpaces));try{AnyBalance.isAvailable("bonus_status","bonus_burn")&&(json=callAPI("get","api/bonus/status"),getParam(json.statusDesc,a,"bonus_status",null,replaceTagsAndSpaces),getParam(null,a,"bonus_burn"))}catch(e){AnyBalance.trace("Не удалось получить информацию о бонусной программе: "+e.message)}processServices(a);processRemaindersApi(a);processMonthExpensesApi(a);
processPaymentsApi(a);if(AnyBalance.isAvailable("sub_scl"))try{json=callAPI("get","api/payments/info"),getParam(json.outcome+"",a,"sub_scl",null,replaceTagsAndSpaces,parseBalance)}catch(e){AnyBalance.trace("Ошибка получения информации о звонках: "+e.message+"\n"+e.stack)}processInfoApi(a);AnyBalance.isAvailable("detalization")&&processDetalizationApi(a);b.dontTurnOffSms||processSmsTurnOffApi()}
function processPaymentsApi(b){if(AnyBalance.isAvailable("payments"))try{var a=callAPI("get","api/payments/history?offset=0&size=10",!0);if(a.payments){b.payments=[];for(var c=0;c<a.payments.length;c++){var e=a.payments[c],k={};getParam(e.amount,k,"payments.sum");getParam(e.date,k,"payments.date",null,null,parseDate);getParam(e.descr,k,"payments.descr");b.payments.push(k)}}else AnyBalance.trace("Не удалось получить историю платежей: "+JSON.stringify(a))}catch(g){AnyBalance.trace("Ошибка получения истории платежей: "+
g.message+"\n"+g.stack)}}
function processMonthExpensesApi(b){if(AnyBalance.isAvailable("month_expenses"))try{var a=callAPI("get","api/reports/months",!0);if(a.expenseMonths){b.month_expences=[];for(var c=0;c<a.expenseMonths.length;c++){var e=a.expenseMonths[c],k={};getParam(e.amount,k,"month_expences.sum");getParam(e.reportDate,k,"month_expences.date",null,null,parseDate);getParam(e.percent,k,"month_expences.pct");b.month_expences.push(k)}}else AnyBalance.trace("Не удалось получить историю месячных трат: "+JSON.stringify(a))}catch(g){AnyBalance.trace("Ошибка получения истории месячных трат: "+
g.message+"\n"+g.stack)}}
function processRemaindersApi(b){if(AnyBalance.isAvailable("remainders")||AnyBalance.isAvailable("tariff")&&!b.tariff){var a=callAPI("get","api/options/remainders"),c=b.remainders={},e=[];if(a.models)for(var k=a.models.length-1;0<=k;k--){var g=a.models[k];"RATE_PLAN"!=g.optionsRemaindersType||b.tariff||(b.tariff=replaceAll(g.name,replaceTagsAndSpaces));var m=g.remainders&&g.remainders[0]&&g.remainders[0].optionId;if(0<=e.indexOf(g.name+m)&&/OPTION/i.test(g.optionsRemaindersType))AnyBalance.trace("Мы уже обработали пакеты опций из группы "+g.name),
AnyBalance.trace(JSON.stringify(g));else if(g.remainders)for(e.push(g.name+m),m=0;m<g.remainders.length;m++){var d=g.remainders[m],f=d.name,h=d.unit;if(0>d.available)AnyBalance.trace("Игнорируем отрицательные остатки..."+JSON.stringify(d));else if(/мин|сек/i.test(h)&&!/интернет/i.test(f)||/шт/i.test(h)&&/минут/i.test(f)&&!/СМС|SMS|MMS|ММС/i.test(f)){AnyBalance.trace("Parsing minutes..."+JSON.stringify(d));var l=/^9{6,}$/i.test(d.total);l||26E5<+d.total?AnyBalance.trace("пропускаем безлимит минут: "+
f+" "+(d.available+d.unit)+"/"+(d.total+d.unit)):/в сутки/i.test(f)?getParam(d.available+h,c,"remainders.mins_day",null,replaceTagsAndSpaces,parseMinutes):/бесплат/i.test(f)?getParam(d.available+h,c,"remainders.mins_n_free",null,replaceTagsAndSpaces,parseMinutes):/\.\s*МегаФон|на мегафон|на МФ/i.test(f)&&!/МТС/i.test(f)&&!/стационар/i.test(f)||/внутри сети/i.test(f)?sumParam(d.available+h,c,"remainders.mins_net_left",null,replaceTagsAndSpaces,parseMinutes,aggregate_sum):/Безлимитные входящие/i.test(f)?
AnyBalance.trace("Бесконечное значение минут ("+f+"), пропускаем..."):(sumParam(d.available+h,c,"remainders.mins_left",null,replaceTagsAndSpaces,parseMinutes,aggregate_sum),sumParam(d.total+h,c,"remainders.mins_total",null,replaceTagsAndSpaces,parseMinutes,aggregate_sum))}else if(/шт|sms|смс|mms|ммс/i.test(h))(l=/^9{6,}$/i.test(d.total))?AnyBalance.trace("пропускаем безлимит смс: "+f+" "+(d.available+d.unit)+"/"+(d.total+d.unit)):/mms|ММС/i.test(f)?(AnyBalance.trace("Parsing mms..."+JSON.stringify(d)),
sumParam(d.available,c,"remainders.mms_left",null,replaceTagsAndSpaces,parseBalance,aggregate_sum),sumParam(d.total,c,"remainders.mms_total",null,replaceTagsAndSpaces,parseBalance,aggregate_sum)):(AnyBalance.trace("Parsing sms..."+JSON.stringify(d)),sumParam(d.available,c,"remainders.sms_left",null,replaceTagsAndSpaces,parseBalance,aggregate_sum),sumParam(d.total,c,"remainders.sms_total",null,replaceTagsAndSpaces,parseBalance,aggregate_sum));else if(/([kmgtкмгт][бb]|[бb](?![\wа-я])|байт|byte)/i.test(h))if(AnyBalance.trace("Parsing data..."+
JSON.stringify(d)),/Гигабайт в дорогу/i.test(f))getParam(d.available+d.unit,c,"remainders.gb_with_you",null,replaceTagsAndSpaces,parseTraffic);else if(/Интернет в роуминге/i.test(f))/Остальные страны/i.test(f)?getParam(d.available+d.unit,c,"remainders.internet_roam_other",null,replaceTagsAndSpaces,parseTraffic):/Популярные страны/i.test(f)?getParam(d.available+d.unit,c,"remainders.internet_roam_popular",null,replaceTagsAndSpaces,parseTraffic):/ЕВРОПА/i.test(f)&&getParam(d.available+d.unit,c,"remainders.internet_roam_europe",
null,replaceTagsAndSpaces,parseTraffic);else if(/Автопродление/i.test(f))getParam(d.available+d.unit,c,"remainders.internet_auto_prolong",null,replaceTagsAndSpaces,parseTraffic);else if(/Интернет в Крыму/i.test(f))getParam(d.available+d.unit,c,"remainders.internet_left_crimea",null,replaceTagsAndSpaces,parseTraffic);else{h="";/ноч/i.test(f)&&(h="_night");var l=/^9{7,}$/i.test(d.total),p=getParam(d.available+d.unit,null,null,null,replaceTagsAndSpaces,parseTraffic),n=getParam(d.total+d.unit,null,null,
null,replaceTagsAndSpaces,parseTraffic);l||(l=999E3<=n);l&&AnyBalance.trace("пропускаем безлимит трафика: "+f+" "+(d.available+d.unit)+"/"+(d.total+d.unit));isset(p)&&!l&&sumParam(p,c,"remainders.internet_left"+h,null,null,null,aggregate_sum);isset(n)&&!l&&sumParam(n,c,"remainders.internet_total"+h,null,null,null,aggregate_sum);isset(p)&&isset(n)&&sumParam(n-p,c,"remainders.internet_cur"+h,null,null,null,aggregate_sum);d.dateTo?sumParam(d.dateTo,c,"remainders.internet_till",null,replaceTagsAndSpaces,
parseDate,aggregate_min):d.dateFrom&&d.monthly&&sumParam(d.dateFrom,c,"remainders.internet_till",null,replaceTagsAndSpaces,function(a){if(a=parseDate(a))a=new Date(a),a=(new Date(a.getFullYear(),a.getMonth()+1,a.getDate(),a.getHours(),a.getMinutes(),a.getSeconds())).getTime();return a},aggregate_min)}else AnyBalance.trace("Неизвестные единицы измерений: "+h+" опция: "+f+": "+JSON.stringify(d))}}else AnyBalance.trace("Остатков не обнаружено: "+JSON.stringify(a))}}
function processInfoApi(b){if(AnyBalance.isAvailable("info")){AnyBalance.trace("Получаем инфо");var a=callAPI("get","api/profile/info");b=b.info={};getParam(a.contractStart,b,"info.date_start",null,null,parseDate);getParam(a.birthdate,b,"info.birthday",null,null,parseDate);getParam(a.email,b,"info.email");getParam(a.name,b,"info.fio");getParam(a.region.id,b,"info.region_id");getParam(a.region.name,b,"info.region_name")}}
function processSmsTurnOffApi(){try{var b=callAPI("get","api/profile/info");b.notifications?(AnyBalance.trace("Включено смс оповещение о входе, отключаем..."),b=callAPI("post","api/profile/notifications?status=false"),AnyBalance.trace("Отключили, проверяем..."),b=callAPI("get","api/profile/info"),b.notifications?AnyBalance.trace("Не удалось отключить смс оповещение о входе в кабинет. Свяжитесь с разработчиком."):AnyBalance.trace("Успешно отключили смс оповещение о входе в кабинет!")):AnyBalance.trace("Cмс оповещение о входе в кабинет уже отключено!")}catch(a){AnyBalance.trace("Отключение смс не удалось: "+
a.message)}}function processServices(b){if(AnyBalance.isAvailable("services_free","services_paid")){var a=callAPI("get","api/options/list/current");getParam(a.free?a.free.length:0,b,"services_free");getParam(a.paid?a.paid.length:0,b,"services_paid")}};
