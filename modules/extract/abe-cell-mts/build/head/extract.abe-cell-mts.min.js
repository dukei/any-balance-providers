var region_aliases={eao:"primorye",dv:"primorye"},regionsOrdinary={auto:"https://ihelper.mts.ru/selfcare/",center:"https://ihelper.mts.ru/selfcare/",primorye:"https://ihelper.dv.mts.ru/selfcare/",nnov:"https://ihelper.nnov.mts.ru/selfcare/",nw:"https://ihelper.nw.mts.ru/selfcare/",sib:"https://ihelper.sib.mts.ru/selfcare/",ural:"https://ihelper.nnov.mts.ru/selfcare/",ug:"https://ihelper.ug.mts.ru/selfcare/"},g_baseurl="https://lk.mts.ru",g_baseurlLogin="https://login.mts.ru",g_savedData,g_headers=
{Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7","Accept-Language":"ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7","Cache-Control":"max-age=0",Connection:"keep-alive","Upgrade-Insecure-Requests":"1","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36","If-Modified-Since":null},replaceNumber=[replaceTagsAndSpaces,/\D/g,"",/.*(\d\d\d)(\d\d\d)(\d\d)(\d\d)$/,
"+7 $1 $2-$3-$4"];function generateUUID(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}function getParamByName(a,b){return getParam(a,null,null,new RegExp("name=[\"']"+b+'["\'][^>]*value=["\']([^"\']+)"',"i"))}function isInOrdinary(a){return/<div[^>]+class="main-menu"/i.test(a)}function uniq_fast(a){for(var b={},c=[],d=a.length,e=0,k=0;k<d;k++){var h=a[k];1!==b[h]&&(b[h]=1,c[e++]=h)}return c}
function setCsrfCookie(a,b){b=getParam(b,null,null,/<input[^>]+name="csrfToken"[^>]*value="([^"]*)/i);a=getParam(a,null,null,/\/\/(.*?)\//);AnyBalance.setCookie(a,"csrfToken",null);AnyBalance.setCookie(a,"csrfToken",null);AnyBalance.setCookie(a,"csrfToken",b)}
function fetchOrdinary(a,b,c){var d=AnyBalance.getPreferences();if(d.phone&&d.phone!=d.login){AnyBalance.trace("Требуется другой номер. Пытаемся переключиться...");a=AnyBalance.requestGet(b+"my-phone-numbers.aspx",g_headers);var e=uniq_fast(sumParam(a,null,null,/__doPostBack\('ctl00\$MainContent\$pagerLink','(\d+)'/g));AnyBalance.trace(e.length+" ещё страниц моих номеров найдено");do{setCsrfCookie(b,a);var k=getParam(a,null,null,/<input[^>]+name="csrfToken"[^>]*value="([^"]*)/i),h=(d.phone||"").replace(/(\d{3})(\d{3})(\d{2})(\d{2})/i,
"$1\\D$2\\D$3\\D$4");if((new RegExp('"account-phone-number current"[^>]*>\\s*\\+7\\s*'+h,"i")).test(a))AnyBalance.trace("Номер "+d.phone+" уже выбран.");else{if(!(new RegExp("doPostBack\\('[^']+','7"+d.phone,"i")).test(a))if(0<e.length){h=e.shift();AnyBalance.trace(d.phone+": этот номер не принадлежит логину "+d.login+". Попробуем другую страницу - "+h);a=AnyBalance.requestPost(b+"my-phone-numbers.aspx",[["ctl00_sm_HiddenField",""],["csrfToken",k],["__EVENTTARGET","ctl00$MainContent$pagerLink"],["__EVENTARGUMENT",
h],["__VIEWSTATE",getParamByName(a,"__VIEWSTATE")],["__VIEWSTATEGENERATOR",getParamByName(a,"__VIEWSTATEGENERATOR")]],addHeaders({Referer:b+"my-phone-numbers.aspx",Origin:"https://ihelper.mts.ru"}));continue}else throw new AnyBalance.Error(d.phone+": этот номер не принадлежит логину "+d.login);a=AnyBalance.requestPost(b+"my-phone-numbers.aspx",[["ctl00_sm_HiddenField",""],["csrfToken",k],["__EVENTTARGET","ctl00$MainContent$transitionLink"],["__EVENTARGUMENT","7"+d.phone],["__VIEWSTATE",getParamByName(a,
"__VIEWSTATE")],["__VIEWSTATEGENERATOR",getParamByName(a,"__VIEWSTATEGENERATOR")]],addHeaders({Referer:b+"my-phone-numbers.aspx",Origin:"https://ihelper.mts.ru"}));if(!(new RegExp("<li>\\s*Номер:\\s*<strong>\\+7\\s*"+h,"i")).test(a))throw new AnyBalance.Error("Не удалось переключиться на номер "+d.phone+". Вероятно, он не принадлежит логину "+d.login);}break}while(1)}getParam(a,c,"tariff",/Тарифный план.*?>([^<]*)/i,replaceTagsAndSpaces);getParam(a,c,"balance",/<span[^>]*id="customer-info-balance[^>]*>([\s\S]*?)(?:\(|<\/span>)/i,
replaceTagsAndSpaces,parseBalance);AnyBalance.isAvailable("info.phone")&&(c.info||(c.info={}),getParam(a,c.info,"info.phone",/Номер:.*?>([^<]*)</i,replaceNumber));AnyBalance.isAvailable("bonus")&&!isset(c.bonus)&&(c.bonus=null);isAvailableStatus()&&(AnyBalance.trace("Fetching status..."),/<h1>Состояние счета<\/h1>/i.test(a)||(AnyBalance.trace('Не нашли заголовка "состояние счета". Заходим на account-status.aspx'),a=AnyBalance.requestGet(b+"account-status.aspx",g_headers)),fetchAccountStatus(a,c));
AnyBalance.isAvailable("remainders.tourist")&&(AnyBalance.trace("Fetching accumulated counters..."),a=AnyBalance.requestGet(b+"accumulated-counters.aspx",g_headers),fetchAccumulatedCounters(a,c));AnyBalance.isAvailable("abonservice","info.date_start")&&(AnyBalance.trace("Fetching paid services..."),checkIHError(a,c),a=AnyBalance.requestGet(b+"product-2-view.aspx",g_headers),sumParam(a,c,"abonservice",/<tr[^>]+class="gm-row-item(?:[\s\S](?!<\/tr>))*?<td[^>]+class="price"[^>]*>([\s\S]*?)<\/td>/ig,replaceTagsAndSpaces,
parseBalance,aggregate_sum),AnyBalance.isAvailable("info.date_start")&&(c.info||(c.info={}),sumParam(a,c.info,"info.date_start",/<tr[^>]+class="gm-row-item(?:[\s\S](?!<\/tr>))*?<td[^>]+class="grid-date"[^>]*>([\s\S]*?)<\/td>/ig,replaceTagsAndSpaces,parseDate,aggregate_min)));AnyBalance.isAvailable("expenses")&&processExpences(b,c);AnyBalance.isAvailable("payments")&&processPayments(b,c);AnyBalance.isAvailable("detalization")&&processDetalization(b,c)}
function checkIHError(a,b,c){if((a=getParam(a,null,null,/<div[^>]+class="b_(?:-page)?error"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces))||c){c="Ошибка МТС при получения данных из интернет-помощника: "+(a||"вероятно, он временно недоступен");if(!0===b)throw new AnyBalance.Error(c);AnyBalance.trace(c);b.were_errors=!0}}function isAvailableStatus(){return AnyBalance.isAvailable("remainders","info.licschet","info.sim","statuslock","credit","usedinthismonth","bonus_balance","debt","pay_till")}
function isAvailableIH(){return isAvailableStatus()||AnyBalance.isAvailable("tourist","abonservice","info.date_start","expenses","payments","detalization")||isAvailable("tariff")&&!isset(result.tariff)||isAvailable("info.phone")&&(!isset(result.info)||!isset(result.info.phone))}
function fetchAccumulatedCounters(a,b){AnyBalance.trace("Parsing accumulated counters...");checkIHError(a,b);b.remainders||(b.remainders={});getParam(a,b.remainders,"remainders.tourist",/Счетчик Туристическая СИМ-карта от МТС\.[\s\S]*?<td[^>]+class="counter-value"[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance)}
function fetchAccountStatus(a,b){AnyBalance.trace("Parsing status...");checkIHError(a,b);AnyBalance.isAvailable("remainders")&&(b.remainders||(b.remainders={}),sumParam(a,b.remainders,"remainders.min_till",[/мин\.?,?\s*(?:Пакет\s*)?действует до ([^<]*)/ig,/Остаток пакета минут:[^<]*действует до([^<]*)/ig],replaceTagsAndSpaces,parseDate,aggregate_min),sumParam(a,b.remainders,"remainders.sms_till",/(?:смс|sms)[^<]*[.:,]*\s*(?:Пакет\s*)?действует до ([^<]*)/ig,replaceTagsAndSpaces,parseDate,aggregate_min),
sumParam(a,b.remainders,"remainders.mms_till",/(?:ммс|mms)[^<]*[.:,]*\s*(?:Пакет\s*)?действует до ([^<]*)/ig,replaceTagsAndSpaces,parseDate,aggregate_min),a=sumParam(a,b.remainders,"remainders.min_left_connect",/МТС Connect:\s+остаток\s*([\d\.,]+)[^<]*/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left_mts_rf",/Оста(?:лось|ток):?\s*([\d\.,]+)\s*(?:бесплатных\s*)?мин[^>]+МТС (?:РФ|России)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,
b.remainders,"remainders.min_left_mts_rf",/Оста(?:лось|ток)[^<]+мин[^>]+МТС РФ:\s*([\d\.,]+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left_mts",/Территория МТС.*?: Осталось\s*([\d\.,]+)\s*мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left_mts",/Оста(?:ток|лось):?\s*([\d\.,]+)\s*мин\S*\s*(?:на\s*)?МТС/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left_mezh",
/междугородные минуты[^<]*?:\s*([\d\.,]+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left_mezh",/Пакет МГ[^<]*?([\d\.,]+?)\s*мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left_mezh",/М2М[^<]*?([\d\.,]+?)\s*мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left_mezh",/Остаток: (\d+) мин в МНР/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,
!0),a=sumParam(a,b.remainders,"remainders.min_left",/Срочный контракт.*?: Осталось\s*([\d\.,]+)\s*мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Остаток (?:еже\S+ )?пакета минут:\s*([\d\.,]+)\s*[м\.,<]/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Остаток бонуса:\s*([\d\.,]+?)\s*мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",
/Пакет минут[^<]*?([\d\.,]+?)\s*мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Осталось:?\s*([\d\.,]+)\s*(?:бесплатных\s*)?мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Остаток:?\s*([\d\.,]+)\s*мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left_mts",/Остаток мин[^<]*?([\d\.,]+)\s*мин[^<]*?МТС России/ig,replaceTagsAndSpaces,
parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Остаток мин[^<]*?([\d\.,]+)\s*мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Остаток еже\S+ пакетов\s*(?:минут\s*)?:?\s*([\d\.,]+)\s*мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Остаток еже\S+ пакета\s*(?:минут\s*)?:?\s*([\d\.,]+)\s*мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,
b.remainders,"remainders.min_left",/Остаток еже\S+ пакета минут:?\s*([\d\.,]+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Остаток пакета:?\s*([\d\.,]+)\s*мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Пакет минут[^:]*:\s*Оста[^\d]*([\d\.,]+)\s*мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Подбаланс минуты\s*:?\s*([\d\.,]+)\s*мин/ig,
replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Остаток пакета минут[^<]*?([\d\.,]+)\s*сек/ig,replaceTagsAndSpaces,function(c){return Math.round(parseBalance(c)/60)},aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/"Бесплатных вызовов при платеже":[^<]*?([\d\.,]+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Осталось минут[^<]*?:\s*([\d\.,]+)/ig,replaceTagsAndSpaces,parseBalance,
aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Осталось по опции[^<]*?:\s*([\d\.,]+)\s+мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/местные минуты[^<]*?:\s*([\d\.,]+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/пакет местных минут[^<]*?:\s*([\d\.,]+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Остаток\s+"[^<]*?([\d\.,]+)\s*мин/ig,
replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),sumParam(a,b.remainders,"remainders.min_local",/Использовано:?\s*([\d\.,]+)\s*мин[^\s]* (местных|на городские)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum),sumParam(a,b.remainders,"remainders.min_love",/Использовано:?\s*([\d\.,]+)\s*мин[^\s]* на любимые/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum),sumParam(a,b.remainders,"remainders.min_used_mts",/Использовано:?\s*(\d+)\s*мин\S* на МТС/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum),
a=sumParam(a,b.remainders,"remainders.sms_left_perezvoni",/Осталось:?\s*([0-5])\s*(?:sms|смс)\.?\s*<[^>]*>/i,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.sms_left",/Остаток еже\S+ пакетов\s*:?\s*([\d\.,]+)\s*(?:смс|sms)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.sms_left",/Остаток еже\S+ пакета\s*:?\s*([\d\.,]+)\s*(?:смс|sms)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,
"remainders.sms_left",/Остаток еже\S+ пакета (?:смс|sms):?\s*([\d\.,]+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.sms_left",/(?:Осталось|Остаток)(?: пакета)? (?:sms|смс):\s*(\d+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.sms_left",/(?:Осталось|Остаток)[^\d]*(\d+)\s*(?:sms|смс)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.sms_left",/Остаток пакета[^<]*?(?:смс|sms):\s*([\d\.,]+)/ig,
replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.sms_left",/Осталось sms[^<]*?:\s*([\d\.,]+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.sms_europe",/Остаток\s+пакета\s+SMS\s+в\s+Европе:([\s\d]+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.sms_world",/Остаток\s+пакета\s+SMS\s+в\s+поездках\s+по\s+миру:([\s\d]+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,
!0),sumParam(a,b.remainders,"remainders.sms_used",/Использовано:\s*([\d\.,]+)\s*(?:смс|sms)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum),sumParam(a,b.remainders,"remainders.mms_left",/(?:Осталось|Остаток)(?: пакета)? (?:mms|ммс):\s*(\d+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum),sumParam(a,b.remainders,"remainders.mms_left",/(?:Осталось|Остаток)[^\d]*(\d+)\s*(?:mms|ммс)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum),sumParam(a,b.remainders,"remainders.min_used",/Накоплено\s*([\d\.,]+)\s*мин[^\s]*/g,
replaceTagsAndSpaces,parseBalance,aggregate_sum),sumParam(a,b.remainders,"remainders.traffic_left_mb",/(?:Осталось|Остаток)[^\d]*(\d+[\.,]?\d* *([kmgкмг][бb]|байт|bytes))/ig,null,parseTraffic,aggregate_sum),sumParam(a,b.remainders,"remainders.traffic_left_mb",/Подбаланс gprs:[^\d]*(\d+[\.,]?\d*\s*([kmgкмг][бb]|байт|bytes))/ig,null,parseTraffic,aggregate_sum),sumParam(a,b.remainders,"remainders.traffic_left_till",[/Подбаланс gprs:[^<]*?[kmgкмг][бb]\s*до\s*([\s\S]*?)<\//ig,/Остаток GPRS-пакета[^<]*[мm][бb][^<]*действует до([^<]*)/ig],
null,parseDate,aggregate_min),getParam(a,b.remainders,"remainders.bonus_balance",/Остаток бонуса:?\s*([\d\.,]+)\s*р/i,replaceTagsAndSpaces,parseBalance),sumParam(a,b.remainders,"remainders.traffic_used_mb",/Использовано:?\s*(\d+\s*[кkmмгg][бb])/ig,replaceTagsAndSpaces,parseTrafficFromKb,aggregate_sum));AnyBalance.isAvailable("info")&&(b.info||(b.info={}),getParam(a,b.info,"info.licschet",/№([\s\S]*?)[:<]/,replaceTagsAndSpaces),getParam(a,b.info,"info.sim",/Номер SIM-карты:([\s\S]*?)[:<]/,replaceTagsAndSpaces));
getParam(a,b,"debt",/Сумма [^<]*по неоплаченным счетам(?:[\s\S](?!<\/td|<\/p))*?([-\d\.,]+)\s+руб/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"pay_till",/оплатить до\s*([\d\.,\/]+)/i,replaceTagsAndSpaces,parseDate);getParam(a,b,"statuslock",/<(?:p|div)[^>]+class="account-status-lock"[^>]*>([\s\S]*?)<\/(?:p|div)>/i,replaceTagsAndSpaces);getParam(a,b,"credit",/(?:Лимит|Сумма кредитного лимита)[\s\S]*?([-\d\.,]+)\s*\(?руб/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"usedinthismonth",/Израсходовано [^<]*?(?:<[^>]*>)?([\d\.,]+) \(?руб/i,
replaceTagsAndSpaces,parseBalance)}function isLoggedIn(a){AnyBalance.getPreferences();a=AnyBalance.requestGet("https://auth-lk.ssl.mts.ru/account/is-authorized",addHeaders({Referer:"https://lk.mts.ru/"}));return"true"===a}
function getLKJson(a,b){try{return getLKJson1(a)}catch(c){AnyBalance.trace(c.message),AnyBalance.trace("Не удалось найти Json с описанием пользователя первым способом. Сайт изменен?")}try{return getLKJson2(a)}catch(c){AnyBalance.trace(c.message),AnyBalance.trace("Не удалось найти Json с описанием пользователя вторым способом. Сайт изменен?")}try{return getLKJson3(a)}catch(c){AnyBalance.trace(c.message),AnyBalance.trace("Не удалось найти Json с описанием пользователя третьим способом. Сайт изменен?")}try{return getLKJson4(a)}catch(c){if(b)throw c;
AnyBalance.trace(c.message);AnyBalance.trace("Не удалось найти Json с описанием пользователя ни одним способом. Сайт изменен?");json={}}return{}}
function getLKJson1(a){AnyBalance.getPreferences();a=AnyBalance.requestGet("https://lk.mts.ru/api/login/user-info",addHeaders({Referer:g_baseurl+"/","X-Login":fetchNumber(),"X-Requested-With":"XMLHttpRequest"}));var b={fio:null,phone_formatted:null,phone:null,license:null,region:null,balance:null,tariff:null},c=getJson(a).userProfile;b.fio=c.displayName;b.phone_formatted=(""+c.login).replace(/(.*)(\d\d\d)(\d\d\d)(\d\d)(\d\d)$/,"+7($2)$3-$4-$5");b.phone=""+c.login;b.license=""+c.accountNumber;b.region=
""+c.regionTitle;b.tariff=getParam(""+c.tariff,null,null,/(?:[\s\S]*?-\s)([\s\S]*?)(?:\s\([\s\S]*?)?$/i,replaceTagsAndSpaces);if(!b.balance){var d=callNewLKApiToken("accountInfo/balance");d=callNewLKApiResult(d);b.balance=getParam(Math.round(100*d.amount)/100)}b.balance||(b.balance=Math.round(100*c.balance)/100);b.balance||AnyBalance.trace("Нулевой баланс! Возможно, что-то не так! \n"+(d?JSON.stringify(d):a));b.phone||AnyBalance.trace("Не удаётся получить информацию о текущем пользователе. Сайт изменен?\n"+
a);return b}
function getLKJson2(a){a=AnyBalance.requestGet("https://lk.mts.ru/api/login/profile",addHeaders({Referer:g_baseurl+"/","X-Login":fetchNumber()}));var b=getJson(a),c={fio:null,phone_formatted:null,phone:null,license:null,region:null,balance:null,tariff:null},d=b.account;c.fio=b.name;c.phone_formatted=(""+d.phone).replace(/(.*)(\d\d\d)(\d\d\d)(\d\d)(\d\d)$/,"+7($2)$3-$4-$5");c.phone=""+d.phone;c.license=""+d.number;c.region=getParam(""+d.tariff.system,null,null,/([\s\S]*?)(?:\s-\s[\s\S]*?)?$/i,replaceTagsAndSpaces);
c.tariff=""+d.tariff.name;if(!c.balance){var e=callNewLKApiGraphql({operationName:"GetBalanceBaseQueryInput",variables:{},query:"query GetBalanceBaseQueryInput {\n  balances {\n    nodes {\n      ... on BalanceInfo {\n        industry {\n          code\n          name\n          industryId\n          __typename\n        }\n        account {\n          idValue\n          idType\n          __typename\n        }\n        name\n        code\n        status\n        source\n        effectiveDate\n        cashbackBalanceText\n        cashbackHintText\n        remainingValue {\n          amount\n          currency\n          __typename\n        }\n        limits {\n          ... on LimitInfo {\n            bannerText\n            className\n            source\n            type\n            remainingValue {\n              amount\n              currency\n              __typename\n            }\n            __typename\n          }\n          ... on LimitError {\n            className\n            type\n            error {\n              message\n              code\n              __typename\n            }\n            __typename\n          }\n          __typename\n        }\n        __typename\n      }\n      ... on BalanceError {\n        industry {\n          code\n          name\n          industryId\n          __typename\n        }\n        account {\n          idValue\n          idType\n          __typename\n        }\n        error {\n          message\n          code\n          __typename\n        }\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n}"},
"GetBalanceBaseQueryInput");if(e&&e.balances&&e.balances.nodes&&e.balances.nodes.length)for(b=0;b<e.balances.nodes.length;++b)if(d=e.balances.nodes[b],d.account.idValue===fetchNumber()){c.balance=getParam(Math.round(100*d.remainingValue.amount)/100);break}}c.balance||AnyBalance.trace("Нулевой баланс! Возможно, что-то не так! \n"+(e?JSON.stringify(e):a));c.phone||AnyBalance.trace("Не удаётся получить информацию о текущем пользователе. Сайт изменен?\n"+a);return c}
function getLKJson3(a){a=AnyBalance.requestGet("https://login.mts.ru/amserver/rest/widget",addHeaders({"Content-Type":"application/json",Referer:g_baseurl+"/"}));var b=getJson(a),c={fio:null,phone_formatted:null,phone:null,license:null,region:null,balance:null,tariff:null};c.fio=b["profile:name"];c.phone_formatted=(""+b["mobile:phone"]).replace(/(.*)(\d\d\d)(\d\d\d)(\d\d)(\d\d)$/,"+7($2)$3-$4-$5");c.phone=""+b["mobile:phone"];c.balance=Math.round(100*b["mobile:balance"])/100;c.balance||AnyBalance.trace("Нулевой баланс! Возможно, что-то не так! \n"+
a);c.phone||AnyBalance.trace("Не удаётся получить информацию о текущем пользователе. Сайт изменен?\n"+a);return c}
function getLKJson4(a){a=AnyBalance.requestGet("https://login.mts.ru/profile/header?ref=https%3A//lk.mts.ru/&scheme=https&style=2015v2",g_headers);var b={fio:null,phone_formatted:null,phone:null,license:null,region:null,balance:null,tariff:null};b.fio=getElement(a,/<div[^>]+b-header_lk__name[^>]*>/i,replaceTagsAndSpaces);b.phone_formatted=getElement(a,/<div[^>]+b-header_lk__phone[^>]*>/i,replaceTagsAndSpaces);b.phone=replaceAll(b.phone_formatted,[/\+7/,"",/\D/g,""]);b.balance=getElement(a,/<div[^>]+b-header_balance[^>]*>/i,
replaceTagsAndSpaces,parseBalance);b.balance||AnyBalance.trace("Нулевой баланс! Возможно, что-то не так! \n"+a);b.phone||AnyBalance.trace("Не удаётся получить информацию о текущем пользователе. Сайт изменен?\n"+a);return b}function isAnotherNumber(){var a=AnyBalance.getPreferences();return a.phone&&a.phone!=a.login}
function checkLoginState(a,b){var c=b&&b.baseurl||g_baseurl,d=AnyBalance.getLastUrl();if(/checkAuthStatus|дождитесь окончания процесса авторизации/i.test(a)||/waitauth/i.test(d)){a={Data:{}};for(var e=20;"Success"!=a.Data.State&&0<e--;){a=AnyBalance.requestGet(c+"/WaitAuth/CheckAuth?_="+(new Date).getTime(),addHeaders({Referer:d}));if(404==AnyBalance.getLastStatusCode())return AnyBalance.trace("Проверка загрузки отсутствует, переходим на лк напрямую: "+c),a=AnyBalance.requestGet(c,addHeaders({Referer:AnyBalance.getLastUrl()}));
a=getJson(a);"PreSuccess"==a.Data.State&&(a=AnyBalance.requestGet(c+"/WaitAuth/CompleteAuth?_="+(new Date).getTime(),addHeaders({Referer:d})),a=getJson(a),AnyBalance.trace("Received PreSuccess, called CompleteAuth: "+JSON.stringify(a)));if("Success"==a.Data.State)break;sleep(1E3)}if("Success"!=a.Data.State){AnyBalance.trace("Слишком долго ждали авторизацию: "+JSON.stringify(a));if(b&&b.automatic)return AnyBalance.trace("МТС не пустил нас в ЛК после ожидания авторизации. Ладно, попробуем с логином и паролем войти."),
AnyBalance.requestGet(g_baseurlLogin.replace(/\/Login.*<removeme>/,"/Logout",addHeaders({Referer:c})));throw new AnyBalance.Error("МТС не пустил нас в "+c+" после ожидания авторизации. Это проблема на сайте МТС, как только работа сайта наладится - данные отобразятся.");}return AnyBalance.requestGet(c,addHeaders({Referer:d}))}return a}
function enterLK(a){var b=enterMtsLK(a);b=checkLoginState(b,{automatic:!0});AnyBalance.trace("isLoggedIn(html) = "+isLoggedIn(b));/no-config&arg=newsession/i.test(AnyBalance.getLastUrl())&&enterLKUI(b,a);isLoggedIn(b)||(AnyBalance.trace("Требуется дологиниться"),b=AnyBalance.requestGet("https://lk.mts.ru/api/Access/user-verification",addHeaders({Referer:g_baseurl+"/"})));if(!isLoggedIn(b)){if(getParam(b,null,null,/(auth-status=0)/i))throw new AnyBalance.Error("Неверный логин или пароль. Повторите попытку или получите новый пароль на сайте "+
g_baseurl+"/.",!1,!0);AnyBalance.trace(b);throw new AnyBalance.Error("Не удалось зайти в личный кабинет. Он изменился или проблемы на сайте.");}__setLoginSuccessful();turnOffLoginSMSNotify();return b}
function loginWithPassword(){AnyBalance.trace("Пробуем войти в личный кабинет...");var a=AnyBalance.getPreferences();g_savedData||(g_savedData=new SavedData("mts",a.login));g_savedData.restoreCookies();var b=AnyBalance.requestGet("https://lk.mts.ru/",g_headers);if(!b||500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Личный кабинет МТС временно недоступен. Попробуйте еще раз позже");AnyBalance.trace("isLoggedIn(html) = "+isLoggedIn(b));isLoggedIn(b)?AnyBalance.trace("Сессия сохранена. Входим автоматически..."):
(AnyBalance.trace("Сессия новая. Будем логиниться заново..."),clearAllCookiesExceptProtection(),enterLK({login:a.login,password:a.password,baseurl:"https://lk.mts.ru",url:"https://auth-lk.ssl.mts.ru/account/login?goto=https://lk.mts.ru/"}));b=AnyBalance.requestGet("https://lk.mts.ru/api/Access/user-verification",addHeaders({Referer:g_baseurl+"/"}));AnyBalance.trace("Верификация пользователя: "+b);g_savedData.setCookies();g_savedData.save();return b}
function followIHLink(){var a="https://ihelper.mts.ru/selfcare/",b=AnyBalance.getCookie("IHLink");b&&(a=getParam(b,null,null,/[\s\S]*?selfcare\//i,replaceTagsAndSpaces)||"https://ihelper.mts.ru/selfcare/");b=null;try{var c=AnyBalance.requestGet(a+"account-status.aspx",addHeaders({Referer:g_baseurl}));var d=AnyBalance.getLastUrl();if(0!=d.indexOf(a)){b=getParam(d,null,null,/ihelper\.([\w\-]+\.)?mts.ru/i,[/\./g,""]);if(!b)throw new AnyBalance.Error("МТС перенаправила на неизвестный регион! "+b);region_aliases[b]&&
(b=region_aliases[b]);if(!regionsOrdinary[b])throw new AnyBalance.Error("МТС перенаправила на неизвестный регион!! "+b);a=regionsOrdinary[b];AnyBalance.trace("Переходим напрямую в помощник "+a);c=AnyBalance.requestGet(a+"account-status.aspx",addHeaders({Referer:g_baseurl}))}if(b=getParam(c,null,null,/<form .*?id="redirect-form".*?action="[^"]*?([^\/\.]+)\.mts\.ru/)){region_aliases[b]&&(b=region_aliases[b]);if(!regionsOrdinary[b])throw new AnyBalance.Error("МТС перенаправила на неизвестный регион: "+
b);a=regionsOrdinary[b];AnyBalance.trace("Redirected, now trying to enter selfcare at address: "+a);c=AnyBalance.requestPost(a+"logon.aspx",{wasRedirected:"1",submit:"Go"},g_headers)}}catch(e){AnyBalance.trace("Не удалось перейти из лк в интернет-помощник: "+e.message)}return{html:c,baseurlHelper:a}}
function login(a){AnyBalance.setDefaultCharset("utf-8");var b=AnyBalance.getPreferences();if(login.isLoggedIn)b=enterLK({login:b.login,onlyAutomatic:!0});else if(b.password)b=loginWithPassword();else{var c=loginWithoutPassword();b=c.html;a.password=c.password}login.isLoggedIn=!0;return b}
function processInfoLK(a,b){if(AnyBalance.isAvailable("balance","tariff","info"))try{var c=getLKJson(a,!0);c&&AnyBalance.trace(JSON.stringify(c));getParam(c.balance,b,"balance");getParam(c.tariff,b,"tariff");AnyBalance.isAvailable(["info.licschet","info.region","info.phone","info.fio"])&&(b.info||(b.info={}),getParam(c.license,b.info,"info.licschet"),getParam(c.region,b.info,"info.region"),getParam(c.phone,b.info,"info.phone",null,replaceNumber),getParam(c.fio,b.info,"info.fio"))}catch(d){AnyBalance.trace("Не удалось получить данные о пользователе, возможно, виджет временно недоступен... \n"+
d.message+"\n"+d.stack),b.were_errors=!0}}function parseTrafficFromKb(a){return parseTraffic(a,"kb")}function fetchNumber(){var a=AnyBalance.getPreferences();return a.phone&&a.phone!=a.login?"7"+a.phone:"7"+a.login}
function callNewLKApiGraphql(a,b){try{html=AnyBalance.requestPost("https://federation.mts.ru/graphql",JSON.stringify(a),addHeaders({"Content-Type":"application/json",Referer:g_baseurl+"/","X-Apollo-Operation-Name":b,"X-Client-Id":"LK","X-Login":fetchNumber()}));var c=getJson(html);return c.data||c}catch(d){return AnyBalance.trace("Ошибка запроса "+b+": "+d.message),{}}}
function callNewLKApiToken(a,b){var c="GET",d="";if(b){var e=getCsrfToken();d=JSON.stringify(b);c="POST";b=addHeaders({Accept:"application/json, text/plain, */*","Content-Type":"application/json",Referer:"https://lk.mts.ru/","X-Csrf-Token":e,"X-Login":fetchNumber()})}else b=addHeaders({Accept:"application/json, text/plain, */*",Referer:"https://lk.mts.ru/","X-Login":fetchNumber()});c=AnyBalance.requestPost("https://lk.mts.ru/api/"+a,d,b,{HTTP_METHOD:c});getJson(c);d=getJson(c);if("string"!==typeof d)throw AnyBalance.trace(c),
new AnyBalance.Error("Неверный ответ API "+a);return{token:d,verb:"api/"+a}}
function callNewLKApiResult(a){for(var b=0;30>b;++b){var c=AnyBalance.requestGet("https://lk.mts.ru/api/longtask/check/"+a.token+"?for="+a.verb,addHeaders({Accept:"application/json, text/plain, */*",Referer:"https://lk.mts.ru/","X-Login":fetchNumber(),"X-Trace-Id":generateUUID()}));AnyBalance.trace("Ожидание результата "+a.verb+" "+(b+1)+"/30");if(400<=AnyBalance.getLastStatusCode())throw AnyBalance.trace("Waiting for result error: "+c),new AnyBalance.Error(c);if(c)return b=getJson(c),AnyBalance.trace("Получен результат "+
a.verb+" от "+b.refreshDate),b.data||b;AnyBalance.sleep(2E3)}throw new AnyBalance.Error("Не удалось получить результат "+a.verb);}
function callNewLKApiData(a,b){var c="GET",d="";if(b){var e=getCsrfToken();d=JSON.stringify(b);c="POST";b=addHeaders({Accept:"application/json, text/plain, */*","Content-Type":"application/json",Referer:"https://lk.mts.ru/","X-Csrf-Token":e,"X-Login":fetchNumber()})}else b=addHeaders({Accept:"application/json, text/plain, */*",Referer:"https://lk.mts.ru/","X-Login":fetchNumber()});c=AnyBalance.requestPost("https://lk.mts.ru/api/"+a,d,b,{HTTP_METHOD:c});c=getJson(c);AnyBalance.trace("Получен результат api/"+
a+" от "+c.refreshDate);return c.data||c}
function processCountersLK(a){a.remainders||(a.remainders={});var b=callNewLKApiToken("sharing/counters");b=callNewLKApiResult(b);if(b.counters&&3>b.counters.length){var c=0;do AnyBalance.trace("Получены не все остатки. Повторная попытка "+(c+1)+"/5"),AnyBalance.sleep(2E3),b=callNewLKApiToken("sharing/counters"),b=callNewLKApiResult(b);while(3>b.counters.length&&3>++c)}for(c=0;c<b.counters.length;++c){var d=b.counters[c];if(/Входящ/i.test(d.name))AnyBalance.trace("Найден счетчик "+d.name+" ("+d.packageType+
"). Это посуточный дополнительный пакет. Пропускаем...");else if(d.isUnlimited)AnyBalance.trace("Найден счетчик "+d.name+" ("+d.packageType+"). Это безлимитный пакет. Пропускаем...");else if(AnyBalance.trace("Найден счетчик "+d.name+" ("+d.packageType+")"),"Calling"===d.packageType){AnyBalance.trace("Это минуты");var e=1;"Second"===d.unitType&&(e=60);sumParam(d.deadlineDate,a.remainders,"remainders.min_till",null,null,parseDateISO,aggregate_min);sumParam(d.usedAmount/e,a.remainders,"remainders.min_local",
null,null,parseBalanceSilent,aggregate_sum);sumParam(d.totalAmount/e,a.remainders,"remainders.min_total",null,null,parseBalanceSilent,aggregate_sum);sumParam((d.totalAmount-d.usedAmount)/e,a.remainders,"remainders.min_left",null,null,parseBalanceSilent,aggregate_sum)}else"Messaging"===d.packageType?(AnyBalance.trace("Это сообщения"),sumParam(d.deadlineDate,a.remainders,"remainders.sms_till",null,null,parseDateISO,aggregate_min),sumParam(d.usedAmount,a.remainders,"remainders.sms_used",null,null,parseBalanceSilent,
aggregate_sum),sumParam(d.totalAmount,a.remainders,"remainders.sms_total",null,null,parseBalanceSilent,aggregate_sum),sumParam(d.totalAmount-d.usedAmount,a.remainders,"remainders.sms_left",null,null,parseBalanceSilent,aggregate_sum)):"Internet"===d.packageType?(AnyBalance.trace("Это трафик"),sumParam(d.deadlineDate,a.remainders,"remainders.traffic_left_till",null,null,parseDateISO,aggregate_min),sumParam(d.usedAmount+" "+d.unitType,a.remainders,"remainders.traffic_used_mb",null,null,parseTraffic,
aggregate_sum),sumParam(d.totalAmount+" "+d.unitType,a.remainders,"remainders.traffic_total_mb",null,null,parseTraffic,aggregate_sum),sumParam(d.usedByAcceptors+" "+d.unitType,a.remainders,"remainders.traffic_used_by_acceptors_mb",null,null,parseTraffic,aggregate_sum),sumParam(d.totalAmount-d.usedAmount+" "+d.unitType,a.remainders,"remainders.traffic_left_mb",null,null,parseTraffic,aggregate_sum)):AnyBalance.trace("Неизвестный счетчик: "+JSON.stringify(d))}}
function processServicesLK(a){a.services||(a.services={});var b=callNewLKApiToken("services/list/active");b=callNewLKApiResult(b);getParam({Unblocked:"Номер не блокирован",OnlyInboundCalls:"Частичная блокировка",VoluntaryBlock:"Добровольная блокировка",BlockDueToInsufficiencyOfMoney:"Номер заблокирован",Blocked:"Номер заблокирован"}[b.accountBlockStatus]||b.accountBlockStatus,a.services,"services.statuslock");getParam(b.services.length,a.services,"services.services");getParam(0,a.services,"services.services_free");
getParam(0,a.services,"services.services_paid");getParam(0,a.services,"services.services_abon");getParam(0,a.services,"services.services_abon_day");for(var c=0;c<b.services.length;++c){var d=b.services[c];!1===d.isSubscriptionFee||0===d.primarySubscriptionFee.value?(AnyBalance.trace("Найдена бесплатная услуга "+d.name),sumParam(1,a.services,"services.services_free",null,null,parseBalanceSilent,aggregate_sum)):!0===d.isSubscriptionFee&&0!==d.primarySubscriptionFee.value?(AnyBalance.trace("Найдена платная услуга "+
d.name+": "+d.primarySubscriptionFee.quotaPeriodicity+" "+d.primarySubscriptionFee.value+" ₽"),sumParam(1,a.services,"services.services_paid",null,null,parseBalanceSilent,aggregate_sum),"Month"!==d.primarySubscriptionFee.unitOfMeasure?sumParam(d.primarySubscriptionFee.value,a.services,"services.services_abon_day",null,null,parseBalanceSilent,aggregate_sum):sumParam(d.primarySubscriptionFee.value,a.services,"services.services_abon",null,null,parseBalanceSilent,aggregate_sum)):AnyBalance.trace("Неизвестный тип услуги: "+
JSON.stringify(d))}b=callNewLKApiToken("contentSubscription/list/active");if((b=callNewLKApiResult(b))&&b.length&&0<b.length)for(c=0;c<b.length;++c)d=b[c],sumParam(1,a.services,"services.services",null,null,parseBalanceSilent,aggregate_sum),0===d.cost?(AnyBalance.trace("Найдена бесплатная услуга "+d.contentName),sumParam(1,a.services,"services.services_free",null,null,parseBalanceSilent,aggregate_sum)):(AnyBalance.trace("Найдена платная услуга "+d.contentName+": "+d.cost+" ₽"+d.costInfo),sumParam(1,
a.services,"services.services_paid",null,null,parseBalanceSilent,aggregate_sum),/30 дней|1 месяц/i.test(d.costInfo)?sumParam(d.cost,a.services,"services.services_abon",null,null,parseBalanceSilent,aggregate_sum):sumParam(d.cost,a.services,"services.services_abon_day",null,null,parseBalanceSilent,aggregate_sum));else AnyBalance.trace("Не удалось получить список дополнительных услуг. Возможно, они отсутствуют")}
function getCsrfToken(){AnyBalance.requestGet("https://lk.mts.ru/api/login/refreshCsrfToken",addHeaders({Accept:"application/json, text/plain, */*",Referer:"https://lk.mts.ru/","X-Login":fetchNumber()}));var a=AnyBalance.getLastResponseHeader("X-Refresh-Csrf-Token");a||AnyBalance.trace("Не удалось получить csrfToken");return a}
function processCashbackLK(a){a.loyalty||(a.loyalty={});var b=AnyBalance.requestGet("https://login.mts.ru/amserver/rest/v1/cashback",g_headers);b=getJson(b);AnyBalance.trace(JSON.stringify(b));getParam(b.cashBackValue,a.loyalty,"loyalty.cashback_mts");getParam(b.pendingCashBackValue,a.loyalty,"loyalty.cashback_mts_pending");b.expiringCashBack&&(getParam(b.expiringCashBack.expiringCashBackValue,a.loyalty,"loyalty.cashback_mts_burning"),getParam(b.expiringCashBack.expiringCashBackDate,a.loyalty,"loyalty.cashback_mts_burning_date",
null,null,parseDateISO));getParam({PREMIUM:"Активна",NO_PREMIUM:"Не активна"}[b.premiumStatus]||b.premiumStatus,a.loyalty,"loyalty.premium_state")}
function processMessagesLK(a){a.messages||(a.messages={});var b=AnyBalance.requestGet("https://login.mts.ru/amserver/rest/ums/v1/messages?product_name=mtsprofile.web",g_headers);b=getJson(b);AnyBalance.trace(JSON.stringify(b));if(b.data&&b.data.products&&0<b.data.products.length)for(var c=0;b.data.products&&c<b.data.products.length;++c){var d=b.data.products[c];sumParam(d.msg_count,a.messages,"messages.total_msg",null,null,parseBalanceSilent,aggregate_sum);sumParam(d.unread_msg_quantity,a.messages,
"messages.unread_msg",null,null,parseBalanceSilent,aggregate_sum)}else AnyBalance.trace("Не удалось получить данные по уведомлениям")}
function processExpensesLK(a){a.expenses||(a.expenses={});var b=new Date,c=b.getFullYear()+"-"+n2(b.getMonth()+1)+"-01T00:00:00+03:00";b=b.getFullYear()+"-"+n2(b.getMonth()+1)+"-"+n2(b.getDate())+"T23:59:59+03:00";if(isAvailable("expenses.traffic_used_total_mb")){var d=[],e=1,k=1;do try{html=AnyBalance.requestPost("https://federation.mts.ru/graphql",JSON.stringify({operationName:"GetExpensesInfoQueryInput",variables:{pageIndex:e,filter:{dateFrom:c,dateTo:b,showFree:!0,tabType:null,categoryId:"mobile_internet",
textSearch:"",transactionsDirection:null,cashbackType:"ALL"}},query:"query GetExpensesInfoQueryInput($pageIndex: Int!, $filter: TransactionsFilterInput!) {\n  transactionsByFilter(input: {pageIndex: $pageIndex, filter: $filter}) {\n    transactions {\n      name\n      type\n      subtitle\n      dateTime\n      unitValue\n      value\n      direction\n      amount\n      icon\n      darkIcon\n      description\n      productType\n      globalCode\n      actionLabel\n      hints\n      cashbackInfo {\n        amount\n        direction\n        __typename\n      }\n      chargePeriod {\n        dateFrom\n        dateTo\n        __typename\n      }\n      __typename\n    }\n    totalPages\n    __typename\n  }\n}"}),
addHeaders({"Content-Type":"application/json",Referer:g_baseurl+"/","X-Client-Id":"LK","X-Login":fetchNumber()}));var h=getJson(html);h.data&&h.data.transactionsByFilter&&(k=h.data.transactionsByFilter.totalPages,d=d.concat(h.data.transactionsByFilter.transactions))}catch(m){throw new AnyBalance.Error("Ошибка получения данных по общему расходу трафика: "+m.message);}while(++e<k+1);if(d&&0<d.length){__transactions=[];for(var g=0;g<d.length;++g)e=d[g],"Network"!==e.type||/Бесплатные интернет-ресурсы МТС/i.test(e.name)||
__transactions.push(e);if(__transactions&&0<__transactions.length)for(AnyBalance.trace("Найдено записей по общему расходу трафика: "+__transactions.length),g=a.expenses.traffic_used_total_mb=0;g<__transactions.length;++g)e=__transactions[g],sumParam(e.value+" "+e.unitValue,a.expenses,"expenses.traffic_used_total_mb",null,null,parseTraffic,aggregate_sum);else AnyBalance.trace("Записей по общему расходу трафика не найдено")}else AnyBalance.trace("Не удалось получить данные по общему расходу трафика")}if(isAvailable(["expenses.usedinthismonth",
"expenses.abonservice","expenses.refill"]))try{html=AnyBalance.requestPost("https://federation.mts.ru/graphql",JSON.stringify({operationName:"GetExpensesInfoBaseQueryInput",variables:{pageIndex:1,filter:{dateFrom:c,dateTo:b,showFree:!1,tabType:null,categoryId:null,textSearch:"",transactionsDirection:null,cashbackType:"ALL"}},query:"query GetExpensesInfoBaseQueryInput($pageIndex: Int!, $filter: TransactionsFilterInput!) {\n  transactionsByFilter(input: {pageIndex: $pageIndex, filter: $filter}) {\n    totalInfo {\n      currency\n      incomeAmount\n      outcomeAmount\n      cashback {\n        incomeAmount\n        outcomeAmount\n        __typename\n      }\n      period {\n        dateFrom\n        dateTo\n        __typename\n      }\n      __typename\n    }\n    categories {\n      alias\n      value\n      name\n      color\n      amount\n      percentage\n      __typename\n    }\n    totalPages\n    transactions {\n      name\n      type\n      subtitle\n      dateTime\n      unitValue\n      value\n      direction\n      amount\n      icon\n      darkIcon\n      description\n      productType\n      globalCode\n      actionLabel\n      hints\n      cashbackInfo {\n        amount\n        direction\n        __typename\n      }\n      chargePeriod {\n        dateFrom\n        dateTo\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n}"}),
addHeaders({"Content-Type":"application/json",Referer:g_baseurl+"/","X-Client-Id":"LK","X-Login":fetchNumber()}));h=getJson(html);AnyBalance.trace(JSON.stringify(h));var f=h.data;if(f.transactionsByFilter&&f.transactionsByFilter.categories&&0<f.transactionsByFilter.categories.length)for(g=0;f.transactionsByFilter.categories&&g<f.transactionsByFilter.categories.length;++g){var l=f.transactionsByFilter.categories[g];AnyBalance.trace('Найдена категория расходов "'+l.name+'": '+l.amount+" ₽");sumParam(l.amount,
a.expenses,"expenses.abonservice",null,null,parseBalanceSilent,aggregate_sum)}else AnyBalance.trace("Не удалось получить данные по категориям расходов за этот месяц");f.transactionsByFilter&&f.transactionsByFilter.totalInfo?(getParam(f.transactionsByFilter.totalInfo.incomeAmount,a.expenses,"expenses.refill"),getParam(f.transactionsByFilter.totalInfo.outcomeAmount,a.expenses,"expenses.usedinthismonth")):AnyBalance.trace("Не удалось получить сводные данные по расходам за этот месяц")}catch(m){AnyBalance.trace("Ошибка получения данных по расходам за этот месяц: "+
m.message)}if(isAvailable("expenses.usedinprevmonth")){b=new Date;g=new Date(b.getFullYear(),b.getMonth(),0);c=g.getFullYear()+"-"+n2(g.getMonth()+1)+"-01T00:00:00+03:00";g=g.getFullYear()+"-"+n2(g.getMonth()+1)+"-"+n2(g.getDate())+"T23:59:59+03:00";try{html=AnyBalance.requestPost("https://federation.mts.ru/graphql",JSON.stringify({operationName:"GetExpensesInfoBaseQueryInput",variables:{pageIndex:1,filter:{dateFrom:c,dateTo:g,showFree:!1,tabType:null,categoryId:null,textSearch:"",transactionsDirection:null,
cashbackType:"ALL"}},query:"query GetExpensesInfoBaseQueryInput($pageIndex: Int!, $filter: TransactionsFilterInput!) {\n  transactionsByFilter(input: {pageIndex: $pageIndex, filter: $filter}) {\n    totalInfo {\n      currency\n      incomeAmount\n      outcomeAmount\n      cashback {\n        incomeAmount\n        outcomeAmount\n        __typename\n      }\n      period {\n        dateFrom\n        dateTo\n        __typename\n      }\n      __typename\n    }\n    categories {\n      alias\n      value\n      name\n      color\n      amount\n      percentage\n      __typename\n    }\n    totalPages\n    transactions {\n      name\n      type\n      subtitle\n      dateTime\n      unitValue\n      value\n      direction\n      amount\n      icon\n      darkIcon\n      description\n      productType\n      globalCode\n      actionLabel\n      hints\n      cashbackInfo {\n        amount\n        direction\n        __typename\n      }\n      chargePeriod {\n        dateFrom\n        dateTo\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n}"}),
addHeaders({"Content-Type":"application/json",Referer:g_baseurl+"/","X-Client-Id":"LK","X-Login":fetchNumber()})),h=getJson(html),AnyBalance.trace(JSON.stringify(h)),f=h.data,f.transactionsByFilter&&f.transactionsByFilter.totalInfo?(getParam(f.transactionsByFilter.totalInfo.incomeAmount,a.expenses,"expenses.refillinprevmonth"),getParam(f.transactionsByFilter.totalInfo.outcomeAmount,a.expenses,"expenses.usedinprevmonth")):AnyBalance.trace("Не удалось получить сводные данные по расходам за прошлый месяц")}catch(m){AnyBalance.trace("Ошибка получения данных по расходам за прошлый месяц: "+
m.message)}}}
function processTransactionsLK(a){a.payments||(a.payments={});var b=new Date,c=new Date(b.getFullYear(),b.getMonth()-6,b.getDate());c=c.getFullYear()+"-"+n2(c.getMonth()+1)+"-"+n2(c.getDate())+"T00:00:00+03:00";b=b.getFullYear()+"-"+n2(b.getMonth()+1)+"-"+n2(b.getDate())+"T23:59:59+03:00";try{html=AnyBalance.requestPost("https://federation.mts.ru/graphql",JSON.stringify({operationName:"GetExpensesInfoBaseQueryInput",variables:{pageIndex:1,filter:{dateFrom:c,dateTo:b,showFree:!1,tabType:"INCOME",categoryId:null,
textSearch:"",transactionsDirection:null,cashbackType:"ALL"}},query:"query GetExpensesInfoBaseQueryInput($pageIndex: Int!, $filter: TransactionsFilterInput!) {\n  transactionsByFilter(input: {pageIndex: $pageIndex, filter: $filter}) {\n    totalInfo {\n      currency\n      incomeAmount\n      outcomeAmount\n      cashback {\n        incomeAmount\n        outcomeAmount\n        __typename\n      }\n      period {\n        dateFrom\n        dateTo\n        __typename\n      }\n      __typename\n    }\n    categories {\n      alias\n      value\n      name\n      color\n      amount\n      percentage\n      __typename\n    }\n    totalPages\n    transactions {\n      name\n      type\n      subtitle\n      dateTime\n      unitValue\n      value\n      direction\n      amount\n      icon\n      darkIcon\n      description\n      productType\n      globalCode\n      actionLabel\n      hints\n      cashbackInfo {\n        amount\n        direction\n        __typename\n      }\n      chargePeriod {\n        dateFrom\n        dateTo\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n}"}),
addHeaders({"Content-Type":"application/json",Referer:g_baseurl+"/","X-Client-Id":"LK","X-Login":fetchNumber()}));var d=getJson(html)}catch(e){AnyBalance.trace("Ошибка получения данных по транзакциям за полгода: "+e.message);return}AnyBalance.trace(JSON.stringify(d));d=d.data;if(d.transactionsByFilter&&d.transactionsByFilter.transactions&&0<d.transactionsByFilter.transactions.length)for(AnyBalance.trace("Найдено транзакций: "+d.transactionsByFilter.transactions.length);d.transactionsByFilter.transactions&&
0<d.transactionsByFilter.transactions.length;){d=d.transactionsByFilter.transactions[0];getParam(d.amount,a.payments,"payments.sum");getParam(d.dateTime,a.payments,"payments.date",null,null,parseDateISO);getParam(d.name,a.payments,"payments.descr");break}else AnyBalance.trace("Не удалось получить данные по последней транзакции")}
function processTariffAbonLK(a){try{html=AnyBalance.requestPost("https://federation.mts.ru/graphql",JSON.stringify({operationName:"GetProductsTariffInfo",variables:{screenName:"default"},query:"query GetProductsTariffInfo($screenName: String!) {\n  tariffInfo(input: {screenName: $screenName}) {\n    name\n    alias\n    tariffPricesInfo {\n      mainPrice {\n        price\n        basePrice\n        date\n        descriptionPrice\n        __typename\n      }\n      __typename\n    }\n    tariffType\n    industryCode\n    tariffManage\n    tariffPaymentType\n    tariffContent {\n      tariffButton\n      tariffSettingUrl\n      autoconvergent {\n        widgetMobile\n        hintBadge\n        badge\n        __typename\n      }\n      familyGroup {\n        addUser\n        addUserUrl\n        __typename\n      }\n      recommendedAmount {\n        title\n        amount\n        text\n        icon\n        modalSheet {\n          text\n          buttons {\n            text\n            url\n            __typename\n          }\n          __typename\n        }\n        __typename\n      }\n      __typename\n    }\n    tariffSigns {\n      key\n      value\n      __typename\n    }\n    __typename\n  }\n}"}),
addHeaders({"Content-Type":"application/json",Referer:g_baseurl+"/","X-Client-Id":"LK","X-Login":fetchNumber()}));var b=getJson(html)}catch(c){AnyBalance.trace("Ошибка получения данных по тарифу: "+c.message);return}AnyBalance.trace(JSON.stringify(b));b=b.data;b.tariffInfo&&b.tariffInfo.tariffPricesInfo&&b.tariffInfo.tariffPricesInfo.mainPrice&&b.tariffInfo.tariffPricesInfo.mainPrice.price?getParam(b.tariffInfo.tariffPricesInfo.mainPrice.price,a,"tariff_abon",null,null,parseBalance):AnyBalance.trace("Не удалось получить данные по абонплате по тарифу")}
function mainLK(a,b){var c=AnyBalance.getPreferences();AnyBalance.trace("Мы в личном кабинете...");if(isAnotherNumber()){AnyBalance.trace("Пробуем переключиться на номер "+c.phone);a=AnyBalance.requestGet("https://lk.mts.ru/api/login/profile",addHeaders({Referer:g_baseurl+"/","X-Login":"7"+c.phone}));var d=getJson(a).slaves;if(1>d.length)AnyBalance.trace("У логина "+c.login+" нет ни одного прикрепленного номера");else{for(a=0;a<d.length;++a){var e=d[a];AnyBalance.trace("Найден номер "+e.phone);if(!k&&
(!c.phone||endsWith(e.phone,c.phone))){AnyBalance.trace("Выбран номер "+e.phone);var k=e}}if(!k)throw new AnyBalance.Error("Не удалось переключиться на номер "+c.phone+". Вероятно, он не принадлежит логину "+c.login);d=k.id;k=getCsrfToken();a=AnyBalance.requestPost("https://auth-lk.ssl.mts.ru/account/switch/"+d,null,addHeaders({"Content-Type":"application/json",Referer:g_baseurl+"/","X-Csrf-Token":k,"X-Login":"7"+c.login}));for(d=5;!/"loginStatus":\s*?"Success"/i.test(a)&&0<d--;){a=AnyBalance.requestGet("https://lk.mts.ru/api/login/user-info",
addHeaders({Accept:"application/json, text/plain, */*","X-Login":fetchNumber(),"X-Requested-With":"XMLHttpRequest"}));if(/"loginStatus":\s*?"Success"/i.test(a))break;sleep(2E3)}if(/"loginStatus":\s*?"Success"/i.test(a))AnyBalance.trace("Успешно переключились на номер "+c.phone),a=AnyBalance.requestGet("https://lk.mts.ru/api/Access/user-verification",addHeaders({Referer:g_baseurl+"/","X-Login":"7"+c.phone})),AnyBalance.trace("Верификация пользователя: "+a);else throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось переключиться на другой номер. Сайт изменен?");
}}processInfoLK(a,b);try{processCountersLK(b)}catch(f){AnyBalance.trace("Ошибка получения остатков из кабинета. Попробуйте ещё раз позднее. Ошибка: "+f.message),b.were_errors=!0}if(isAvailable("cashback"))try{var h=callNewLKApiToken("cashback/account"),g=callNewLKApiResult(h);getParam(g.balance,b,"cashback")}catch(f){AnyBalance.trace("Ошибка получения данных по кешбэку на связь: "+f.message)}if(isAvailable("credit"))try{h=callNewLKApiToken("creditLimit"),g=callNewLKApiResult(h),getParam(g.currentCreditLimitValue,
b,"credit")}catch(f){AnyBalance.trace("Ошибка получения данных по кредитному лимиту: "+f.message)}if(isAvailable("loyalty"))try{processCashbackLK(b)}catch(f){AnyBalance.trace("Ошибка получения данных по кешбэку МТС: "+f.message)}if(isAvailable("services"))try{processServicesLK(b)}catch(f){AnyBalance.trace("Ошибка получения данных по подключенным услугам: "+f.message)}isAvailable("messages")&&processMessagesLK(b);isAvailable("expenses")&&processExpensesLK(b);isAvailable("payments")&&processTransactionsLK(b);
isAvailable("tariff_abon")&&processTariffAbonLK(b)}function sleep(a){AnyBalance.trace("Sleeping "+a+" ms");AnyBalance.sleep(a)}function parseBalanceRound(a){a=parseBalance(a);isset(a)&&(a=Math.round(100*a)/100);return a}
function loginWithoutPassword(){AnyBalance.trace("Entering lk without password...");var a=AnyBalance.getPreferences();checkEmpty(!a.password||/^\w{6,26}$/.test(a.password),"Желаемый пароль должен содержать от 6 до 26 символов");a.password&&checkEmpty(/^[a-zA-Z0-9]+$/.test(a.password)&&/[a-z]/.test(a.password)&&/[A-Z]/.test(a.password)&&/[0-9]/.test(a.password),"Желаемый пароль должен состоять только из латинских букв и цифр и должен содержать хотя бы одну строчную букву, заглавную букву и цифру");
var b={};b.login=a.login;var c;try{var d=enterLK({login:a.login,onlyAutomatic:!0});a.password||(c=generatePassword());(a.password||c)&&changePassword(void 0,a.password||c)}catch(e){AnyBalance.trace("Автоматический вход в кабинет не удался. Пробуем получить пароль через СМС"),c=getPasswordBySMS(a.login),d=enterLK({login:a.login,password:c,baseurl:"https://lk.mts.ru",url:"http://login.mts.ru/amserver/UI/Login?service=lk&goto=http%3A%2F%2Flk.mts.ru%2F"}),a.password&&a.password!=c&&changePassword(c,a.password)}b.password=
a.password||c;b.html=d;return b}function initialize(){var a=loginWithoutPassword(),b={success:!0,__initialization:!0};b.login=prefs.login;b.password=a.password;AnyBalance.setResult(b)}
function getPasswordBySMS(a){var b=g_baseurlLogin+"/amserver/UI/Login?service=smspassword&srcsvc=lk&goto=https%3A%2F%2Flk.ssl.mts.ru%2F",c=AnyBalance.requestGet(b,g_headers),d=getParam(c,/#captcha-wrapper\s*\{[^}]*background-image:\s*url\(\s*['"]data:image\/\w+;base64,([^'"]*)/i,replaceHtmlEntities);if(!d)throw AnyBalance.trace(c),new AnyBalance.Error("Не удалось получить капчу. Сайт изменен?");var e=AnyBalance.retrieveCode("Для получения пароля к личному кабинету по SMS символы, которые вы видите на картинке.",
d,{time:3E5});c=getParam(c,null,null,/<form[^>]+name="Login"[^>]*>([\s\S]*?)<\/form>/i);c=createFormParams(c,function(k,h,g,f){"IDToken1"==g&&(f=a);"IDToken2"==g&&(f=e);return f});c=AnyBalance.requestPost(b,c,addHeaders({Referer:b}));if(b=getParam(c,null,null,/var\s+passwordErr\s*=\s*'([^']*)/,replaceSlashes))throw new AnyBalance.Error(b);return AnyBalance.retrieveCode("На номер "+a+' выслан пароль к личному кабинету МТС. Введите его в поле ниже. \x3c!--#instruction:{"sms":{"number_in":"3339","regexp_in":"Пароль:\\s*(\\w+)"}}#--\x3e',
null,{time:3E5})}
function changePassword(a,b){var c=g_baseurlLogin+"/amserver/UI/Login?service=changepassword2014&ForceAuth=true",d=AnyBalance.requestGet(c,g_headers),e=getParam(d,null,null,/<form[^>]+name="Login"[^>]*>[\s\S]*?<\/form>/i);if(!e)throw AnyBalance.trace(d),new AnyBalance.Error("Не удалось найти форму смены пароля. Сайт изменен?");d=createFormParams(e,function(k,h,g,f){"IDToken1"==g&&(f=a);if("IDToken2"==g||"IDToken3"==g)f=b;return f});d=AnyBalance.requestPost(c,d,addHeaders({Referer:c}));c=AnyBalance.getLastUrl();
AnyBalance.trace("Password change resulted in: "+c);if(!/#pass_changed|https:\/\/lk\.ssl\.mts\.ru/i.test(c)){if(c=sumParam(d,null,null,/var\s+(?:old|new|con)passwordErr\s*=\s*'([^']*)/,replaceSlashes,null,aggregate_join))throw new AnyBalance.Error(c);AnyBalance.trace(d);throw new AnyBalance.Error("Не удалось сменить пароль на желаемый. Сайт изменен?");}return b}
function generatePassword(){var a=String.fromCharCode("A".charCodeAt()+Math.floor(26*Math.random()));a+=String.fromCharCode("0".charCodeAt()+Math.floor(10*Math.random()));for(var b=0;4>b;++b)a+=String.fromCharCode("a".charCodeAt()+Math.floor(26*Math.random()));return a}
function processPayments(a,b){try{AnyBalance.trace("Получаем платежи...");var c=AnyBalance.requestGet(a+"payment-full-history.aspx",g_headers);checkIHError(c,!0);var d=getElement(c,/<form[^>]+aspnetForm[^>]*>/i),e=new Date,k=new Date(e.getFullYear()-1,e.getMonth(),e.getDate()),h=createFormParams(d,function(l,m,n,p){return/from$/i.test(n)?fmtDate(k):/to$/i.test(n)?fmtDate(e):p});setCsrfCookie(a,c);c=AnyBalance.requestPost(a+"payment-full-history.aspx",h,addHeaders({Referer:AnyBalance.getLastUrl()}));
checkIHError(c,!0);var g=getElement(c,/<div[^>]+paymentsGridium[^>]*>/i);if(!g){var f=getElement(c,/<div[^>]+panelMessage[^>]*>/i,replaceTagsAndSpaces,html_entity_decode);if(f&&/платежей не было/i.test(f)){AnyBalance.trace(f);b.payments=[];return}AnyBalance.trace(c);throw new AnyBalance.Error("Не найдена таблица платежей. Сайт изменен?");}g=replaceAll(g,[/<tfoot[^>]*>[\s\S]*?<\/tfoot>/i,""]);b.payments=[];processTable(g,b.payments,"payments.",{date:{re:/Дата/i,result_func:parseDate},sum:{re:/Сумма/i},
descr:{re:/Тип платежа/i,result_func:html_entity_decode}})}catch(l){AnyBalance.trace("Не удалось получить платежи: "+l.message+"\nStack: "+l.stack)}}
function turnOffLoginSMSNotify(){var a=AnyBalance.requestGet("https://profile.mts.ru/account",addHeaders({Referer:"https://login.mts.ru/"})),b=getParam(a,/\/_next\/static\/([\d\S]*?)\/_buildManifest\.js/i,replaceHtmlEntities);if(a&&b){try{a=AnyBalance.requestGet("https://profile.mts.ru/_next/data/"+b+"/account/safety.json",addHeaders({Accept:"*/*",Referer:"https://profile.mts.ru/account"}));var c=getJson(a)}catch(d){AnyBalance.trace("Не удалось получить страницу настроек безопасности. Пропускаем проверку способа входа и оповещения о входе");
return}c.pageProps&&c.pageProps.initialState&&c.pageProps.initialState.smsNotification&&c.pageProps.initialState.smsNotification.notifications?(a=c.pageProps.initialState.smsNotification.notifications)&&!1!==a.lg_sms?(AnyBalance.trace("SMS уведомление о входе в кабинет включено. Выключаем..."),a.lg=!1,a.lg_sms=!1,a=AnyBalance.requestPost("https://profile.mts.ru/api",JSON.stringify({call:"patchSettingNotification",arg:a}),addHeaders({"Content-Type":"application/json",Referer:"https://profile.mts.ru/account/safety/sms-notifications"})),
AnyBalance.trace(a),/successfully/i.test(a)?AnyBalance.trace("SMS уведомление о входе успешно отключено"):AnyBalance.trace("Не удалось отключить SMS уведомление о входе")):AnyBalance.trace("SMS уведомление о входе уже отключено"):AnyBalance.trace("Не удалось получить настройки оповещения о входе")}else AnyBalance.trace("Не удалось получить идентификатор страницы настроек безопасности. Пропускаем проверку способа входа")};
