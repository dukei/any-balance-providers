var g_headers={Connection:"keep-alive","Tele2-User-Agent":'"mytele2-app/4.27.1"; "unknown"; "Android/9"; "Build/12998710"',"X-API-Version":"3","User-Agent":"okhttp/4.2.0"},baseurl="https://api.tele2.ru/";
function callApi(a,c){a=joinUrl(baseurl+"api/",a);var b=g_headers;c&&(c.__post?delete c.__post:(c=JSON.stringify(c),b=addHeaders({"Content-Type":"application/json; charset=UTF-8"})));AnyBalance.trace("Запрос: "+a);c=AnyBalance.requestPost(a,c,b,{HTTP_METHOD:c?"POST":"GET"});a={};if(c&&(a=JSON.parse(c),a.message||a.error_description&&!/Security code[\s\S]*?empty/i.test(a.error_description)))throw AnyBalance.trace(c),c=a.message||a.error_description||"Ошибка обращения к API",new AnyBalance.Error(c,
null,/парол|Msisdn not found|password/i.test(c));AnyBalance.trace("Ответ: "+JSON.stringify(a));return a.data||a}function login(){AnyBalance.setDefaultCharset("utf-8");var a=AnyBalance.getPreferences();checkEmpty(/^\d{10}$/.test(a.login),"Введите логин - номер телефона из 10 цифр! Например, 9771234567");if(!g_headers.Authorization){var c=loginByAccessToken();c||(c=loginByRefreshToken());c||(a.password?loginByPassword():loginBySMS());__setLoginSuccessful()}}
function saveTokens(a){var c=AnyBalance.getPreferences();g_headers.Authorization="Bearer "+a.access_token;AnyBalance.setData("login",c.login);AnyBalance.setData("ac",a.access_token);AnyBalance.setData("rt",a.refresh_token);AnyBalance.saveData()}
function loginBySMS(){var a=AnyBalance.getPreferences();callApi("validation/number/7"+a.login,{sender:"Tele2"});var c=AnyBalance.retrieveCode("Пожалуйста, введите код из SMS для входа в личный кабинет Tele2",null,{inputType:"number",time:18E4});var b=callApi("https://sso.tele2.ru/auth/realms/tele2-b2c/protocol/openid-connect/token?msisdn=7"+a.login+"&action=auth&authType=sms",{__post:!0,username:"7"+a.login,password:c,grant_type:"password",client_id:"android-app",password_type:"sms_code"});if(b.error&&
/Security code[\s\S]*?empty/i.test(b.error_description)){AnyBalance.trace("Теле2 затребовал код подтверждения из письма");b=callApi("https://sso.tele2.ru/auth/realms/tele2-b2c/credential-management/security-codes",{username:"7"+a.login});b=b.security_code_token;var e=AnyBalance.retrieveCode("Пожалуйста, введите код из письма, отправленного на ваш E-mail",null,{inputType:"number",time:18E4});b=callApi("https://sso.tele2.ru/auth/realms/tele2-b2c/protocol/openid-connect/token?msisdn=7"+a.login+"&action=auth&authType=sms",
{__post:!0,username:"7"+a.login,password:c,security_code:e,security_code_token:b,grant_type:"password",client_id:"android-app",password_type:"sms_code"})}saveTokens(b)}
function loginByAccessToken(){if(AnyBalance.getPreferences().login!==AnyBalance.getData("login"))return!1;g_headers.Authorization="Bearer "+AnyBalance.getData("ac");try{callApi("https://sso.tele2.ru/auth/realms/tele2-b2c/protocol/openid-connect/userinfo")}catch(a){return AnyBalance.trace("Не удалось войти по access token: "+a.message),!1}AnyBalance.trace("Вошли по access token");return!0}
function loginByRefreshToken(){if(AnyBalance.getPreferences().login!==AnyBalance.getData("login"))return!1;delete g_headers.Authorization;try{var a=callApi("https://sso.tele2.ru/auth/realms/tele2-b2c/protocol/openid-connect/token?action=refresh",{__post:!0,refresh_token:AnyBalance.getData("rt"),grant_type:"refresh_token",client_id:"android-app"})}catch(c){return AnyBalance.trace("Не удалось получить токен по refresh token: "+c.message),!1}AnyBalance.trace("Получили новый access token по refresh token");
saveTokens(a);return loginByAccessToken()}
function loginByPassword(){var a=AnyBalance.getPreferences();json=callApi("https://sso.tele2.ru/auth/realms/tele2-b2c/protocol/openid-connect/token?msisdn=7"+a.login+"&action=auth&authType=pass",{__post:!0,username:"7"+a.login,password:a.password,grant_type:"password",client_id:"android-app",password_type:"password"});if(json.error&&/Security code[\s\S]*?empty/i.test(json.error_description)){AnyBalance.trace("Теле2 затребовал код подтверждения из письма");json=callApi("https://sso.tele2.ru/auth/realms/tele2-b2c/credential-management/security-codes",
{username:"7"+a.login});var c=json.security_code_token,b=AnyBalance.retrieveCode("Пожалуйста, введите код из письма, отправленного на ваш E-mail",null,{inputType:"number",time:18E4});json=callApi("https://sso.tele2.ru/auth/realms/tele2-b2c/protocol/openid-connect/token?msisdn=7"+a.login+"&action=auth&authType=pass",{__post:!0,username:"7"+a.login,password:a.password,security_code:b,security_code_token:c,grant_type:"password",client_id:"android-app",password_type:"password"})}saveTokens(json)}
function getSubscriberId(){var a=AnyBalance.getPreferences();return"7"+replaceAll(a.login,[/\D/g,"",/.*(\d{10})$/,"$1"])}
function processBalance(a){if(AnyBalance.isAvailable("balance","tariff")){var c=getSubscriberId();AnyBalance.trace("Получаем баланс и тариф");if(AnyBalance.isAvailable("balance"))for(var b=0;3>b;b++)try{AnyBalance.trace("Пытаемся получить баланс, попытка: "+(b+1));var e=AnyBalance.requestGet(baseurl+"api/subscribers/"+c+"/balance",addHeaders({Accept:"*/*","X-Requested-With":"XMLHttpRequest",Referer:baseurl})),d=getJson(e);getParam(d.data.value,a,"balance");AnyBalance.trace("Успешно получили баланс");
break}catch(f){AnyBalance.trace("Не удалось получить баланс, пробуем еще раз...")}if(AnyBalance.isAvailable("tariff"))for(b=0;3>b;b++)try{AnyBalance.trace("Пытаемся получить тариф, попытка: "+(b+1));e=AnyBalance.requestGet(baseurl+"api/subscribers/"+c+"/tariff",addHeaders({Accept:"*/*","X-Requested-With":"XMLHttpRequest",Referer:baseurl}));d=getJson(e);getParam(d.data.frontName,a,"tariff");AnyBalance.trace("Успешно получили тариф");break}catch(f){AnyBalance.trace("Не удалось получить тариф, пробуем еще раз...")}}}
function processRemainders(a){if(AnyBalance.isAvailable("remainders")){AnyBalance.trace("Получаем остатки по услугам");try{a.remainders||(a.remainders={});var c=getSubscriberId();AnyBalance.trace("Пытаемся получить остатки по услугам");var b=AnyBalance.requestGet(baseurl+"api/subscribers/"+c+"/rests",addHeaders({Accept:"*/*","X-Requested-With":"XMLHttpRequest",Referer:baseurl}));AnyBalance.trace("Успешно получили дискаунты: "+b);json=JSON.parse(b);for(c=0;c<json.data.rests.length;++c)getDiscount(a.remainders,
json.data.rests[c])}catch(e){AnyBalance.trace("Не удалось получить данные об остатках пакетов и услуг, попробуйте позже "+e)}}}
function getDiscount(a,c){var b=c.uom;AnyBalance.trace("Найден дискаунт: "+c.service.name+" ("+b+")");if(0!==c.limit)if(getParam({active:"Номер не блокирован",blocked:"Номер заблокирован"}[c.status]||c.status,a,"remainders.statuslock"),getParam(c.endDay,a,"remainders.endDate",null,null,parseDateISO),/min/i.test(b))sumParam(Math.round(100*c.remain)/100,a,"remainders.min_left",null,null,null,aggregate_sum),sumParam(Math.round(100*c.limit/100),a,"remainders.min_total",null,null,null,aggregate_sum),sumParam(Math.round(100*
(c.limit-c.remain)/100),a,"remainders.min_used",null,null,null,aggregate_sum),sumParam(c.endDay||void 0,a,"remainders.min_till",null,null,parseDateISO,aggregate_min);else if(/[кмгkmg][bб]/i.test(b)){b=parseTraffic(c.remain+c.uom);var e=parseTraffic(c.limit+c.uom);sumParam(b,a,"remainders.traffic_left",null,null,null,aggregate_sum);sumParam(e,a,"remainders.traffic_total",null,null,null,aggregate_sum);sumParam(e-b,a,"remainders.traffic_used",null,null,null,aggregate_sum);sumParam(c.endDay||void 0,a,
"remainders.traffic_till",null,null,parseDateISO,aggregate_min)}else/pcs/i.test(b)?(sumParam(c.remain,a,"remainders.sms_left",null,null,null,aggregate_sum),sumParam(c.limit,a,"remainders.sms_total",null,null,null,aggregate_sum),sumParam(c.limit-c.remain,a,"remainders.sms_used",null,null,null,aggregate_sum),sumParam(c.endDay||void 0,a,"remainders.sms_till",null,null,parseDateISO,aggregate_min)):AnyBalance.trace("Неизвестный дискаунт: "+JSON.stringify(c))}
function processPayments(a){if(AnyBalance.isAvailable("month_refill","payments")){AnyBalance.trace("Searching for current month payments");var c=getSubscriberId(),b=new Date,e=b.getFullYear()+"-"+n2(b.getMonth()+1)+"-01";b=b.getFullYear()+"-"+n2(b.getMonth()+1)+"-"+n2(b.getDate());try{var d=AnyBalance.requestGet(baseurl+"api/subscribers/"+c+"/payments?fromDate="+e+"T00%3A00%3A00%2B03%3A00&toDate="+b+"T23%3A59%3A59%2B03%3A00",g_headers),f=getJson(d)}catch(g){}if(f&&f.data){AnyBalance.trace("Current month payments json: "+
JSON.stringify(f));for(e=0;e<f.data.length;++e)sumParam(f.data[e].sum.amount,a,"month_refill",null,null,parseBalanceSilent,aggregate_sum);AnyBalance.trace("Searching for last 3 months payments");try{d=AnyBalance.requestGet(baseurl+"api/subscribers/"+c+"/payments?fromDate="+getFormattedDate({format:"YYYY-MM-DD",offsetMonth:3})+"T00%3A00%3A00%2B03%3A00&toDate="+getFormattedDate({format:"YYYY-MM-DD"})+"T23%3A59%3A59%2B03%3A00",g_headers),f=getJson(d)}catch(g){}if(f&&f.data)for(AnyBalance.trace("Last 3 months payments json: "+
JSON.stringify(f)),a.payments=[],e=0;e<f.data.length;++e)c=f.data[e],d={},getParam(c.sum.amount,d,"payments.sum",null,null,parseBalanceSilent),getParam(c.payDate,d,"payments.date",null,null,parseDateISO),getParam(c.type,d,"payments.descr"),a.payments.push(d);else AnyBalance.trace(d),AnyBalance.trace("Не удалось получить платежи за последние 3 месяца, может их просто нет?")}else AnyBalance.trace(d),AnyBalance.trace("Не удалось получить платежи за текущий месяц, может их просто нет?")}}
function processExpenses(a){if(AnyBalance.isAvailable("expenses_curr_month","expenses_prev_month")){AnyBalance.trace("Searching for current month expenses");var c=getSubscriberId(),b=new Date;b=b.getFullYear()+"-"+n2(b.getMonth()+1);try{var e=AnyBalance.requestGet(baseurl+"api/subscribers/"+c+"/charges?month="+b,addHeaders({"X-API-Version":"1"})),d=getJson(e)}catch(g){}if(d&&d.data){AnyBalance.trace("Current month expenses json: "+JSON.stringify(d));for(b=0;b<d.data.length;++b){var f=d.data[b];sumParam(f.amount.amount,
a,"expenses_curr_month",null,null,parseBalanceSilent,aggregate_sum)}AnyBalance.trace("Searching for previous month expenses");b=new Date;b=new Date(b.getFullYear(),b.getMonth()-1,b.getDate());b=b.getFullYear()+"-"+n2(b.getMonth()+1);try{e=AnyBalance.requestGet(baseurl+"api/subscribers/"+c+"/charges?month="+b,addHeaders({"X-API-Version":"1"})),d=getJson(e)}catch(g){}if(d&&d.data)for(AnyBalance.trace("Previous month expenses json: "+JSON.stringify(d)),b=0;b<d.data.length;++b)f=d.data[b],sumParam(f.amount.amount,
a,"expenses_prev_month",null,null,parseBalanceSilent,aggregate_sum);else AnyBalance.trace(e),AnyBalance.trace("Не удалось получить расходы за прошлый месяц, может их просто нет?")}else AnyBalance.trace(e),AnyBalance.trace("Не удалось получить расходы за текущий месяц, может их просто нет?")}}
function processServices(a){if(AnyBalance.isAvailable("services")){AnyBalance.trace("Searching for services");var c=getSubscriberId();try{var b=AnyBalance.requestGet(baseurl+"api/subscribers/"+c+"/services",g_headers),e=getJson(b)}catch(g){}if(e&&e.data)for(a.services={},getParam(0,a.services,"services.services_free"),getParam(0,a.services,"services.services_paid"),getParam(0,a.services,"services.services_total"),getParam(0,a.services,"services.services_abon"),c=0;c<e.data.length;++c){if(b=e.data[c],
"CONNECTED"==b.status)if(AnyBalance.trace("Найдена услуга "+b.name),0==b.abonentFee.amount||null==b.abonentFee.amount)AnyBalance.trace("Это бесплатная услуга"),sumParam(1,a.services,"services.services_free",null,null,parseBalanceSilent,aggregate_sum),sumParam(1,a.services,"services.services_total",null,null,parseBalanceSilent,aggregate_sum);else if(0!=b.abonentFee.amount){AnyBalance.trace("Это платная услуга");var d=new Date;sumParam(1,a.services,"services.services_paid",null,null,parseBalanceSilent,
aggregate_sum);if("day"==b.abonentFee.period){d=(new Date(d.getFullYear(),d.getMonth()+1,0)).getDate();var f="в сутки"}else d=1,f="в месяц";AnyBalance.trace("Платная услуга "+b.name+": "+b.abonentFee.amount+" ₽ "+f);sumParam(b.abonentFee.amount*d,a.services,"services.services_abon",null,null,parseBalanceSilent,aggregate_sum);sumParam(1,a.services,"services.services_total",null,null,parseBalanceSilent,aggregate_sum)}}else AnyBalance.trace(b),AnyBalance.trace("Не удалось получить список услуг, может их просто нет?")}}
function processInfo(a){if(AnyBalance.isAvailable("info")){var c=getSubscriberId();a=a.info={};var b=AnyBalance.requestGet(baseurl+"api/subscribers/"+c+"/profile",addHeaders({Accept:"*/*","X-Requested-With":"XMLHttpRequest",Referer:baseurl}));b=getJson(b);getParam(b.data.fullName,a,"info.fio");getParam(c.replace(/.*(\d{3})(\d{3})(\d{2})(\d{2})$/i,"+7 $1 $2-$3-$4"),a,"info.mphone");getParam(b.data.address.city+", "+b.data.address.street+", "+b.data.address.house,a,"info.address");getParam(b.data.email||
"Не указан",a,"info.email")}};
