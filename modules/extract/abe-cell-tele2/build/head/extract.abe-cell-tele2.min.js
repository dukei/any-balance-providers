var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/48.0.2564.116 Safari/537.36"},baseurl="https://my.tele2.ru/",baseurlLogin="https://login.tele2.ru/ssotele2/",baseurlLoginIndex,baseurlLoginPost,g_operatorName="Теле2";
function login(){function a(a){if(400<AnyBalance.getLastStatusCode()){var b=getElement(a,/<div[^>]+error[^>]*>/i,replaceTagsAndSpaces);503==AnyBalance.getLastStatusCode()&&(a=AnyBalance.requestGet(baseurl+"login",g_headers));if(400<AnyBalance.getLastStatusCode()){if(b)throw new AnyBalance.Error("Новый кабинет: "+b);AnyBalance.trace(a);throw new AnyBalance.Error("Новый личный кабинет "+g_operatorName+" временно недоступен. Попробуйте позже.",!0);}}return a}var b=baseurlLoginIndex||baseurlLogin+"wap/auth/",
c=baseurlLoginPost||baseurlLogin+"wap/auth/submitLoginAndPassword",e=AnyBalance.getPreferences();checkEmpty(/^\d{10}$/.test(e.login),"Введите логин - номера телефона из 10 цифр! Например, 9771234567");AnyBalance.setDefaultCharset("utf-8");var d=AnyBalance.requestGet(baseurl+"login",g_headers);if(/\w+\/logout/i.test(d))AnyBalance.trace("Уже в кабинете. Используем текущую сессию");else{if(e.password){d=AnyBalance.requestGet(b,g_headers);if(!d||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(d),
new AnyBalance.Error("Ошибка при подключении к сайту провайдера! Попробуйте обновить данные позже.");b=getElement(d,/<form[^>]+(?:authForm|submitLoginAndPassword)/i);if(!b)throw AnyBalance.trace(d),new AnyBalance.Error("Не удалось найти форму входа, сайт изменен?");d=AB.createFormParams(b,function(a,b,c,d){return/number|msisdn/i.test(c)?e.login:"password"==c?e.password:d});d=AnyBalance.requestPost(c,d,addHeaders({Referer:baseurlLoginIndex}))}else d=enterBySms();d=a(d)}if(!/\w+\/logout/i.test(d)){if(/<input[^>]+id\s*=\s*"smsCode"/i.test(d))throw new AnyBalance.Error("У вас настроена двухфакторная авторизация с вводом SMS кода при входе в личный кабинет "+
g_operatorName+". Для работы провайдера требуется запрос СМС кода для входа в ЛК отключить. Инструкцию по отключению см. в описании провайдера.",null,!0);if(c=sumParam(d,null,null,/<(?:div|section)[^>]+class="[^"]*\berror\b[^>]*>([\s\S]*?)(?:<\/section>|<\/div>|<div)/gi,replaceTagsAndSpaces,null,aggregate_join)||"")throw new AnyBalance.Error(c,null,/Неверный пароль|не найден/i.test(c));AnyBalance.trace(d);throw new AnyBalance.Error("Не удалось зайти в личный кабинет. Сайт изменен?");}/<div[^>]+class="user-phone"/i.test(d)||
(d=AnyBalance.requestGet(baseurl+"login",addHeaders({Referer:baseurl})),d=a(d));__setLoginSuccessful();return d}function reenterOld(a){a=AnyBalance.requestGet("https://old.my.tele2.ru/",g_headers);/<form[^>]+id="sso-modal-login-form"/i.test(a)&&(a=getParam(a,null,null,/<input[^>]+name="csrfTokBY"[^>]*value="([^"]*)/i,replaceHtmlEntities),a=AnyBalance.requestGet("https://old.my.tele2.ru/public/login_sso?csrfTokBY="+a,addHeaders({Referer:"https://old.my.tele2.ru/"})));return a}
function enterBySms(){function a(){if(400>f){var a=getJson(c);if(a.success)AnyBalance.setCookie("login.tele2.ru","AUTH_DATA",a.key),c=AnyBalance.requestGet(baseurlLogin+"wap/auth?serviceId=341",g_headers);else{if(a.captchaNeeded){a=AnyBalance.requestGet(baseurlLogin+"wap/auth/captcha?"+(new Date).getTime(),g_headers);g=AnyBalance.retrieveCode("Пожалуйста, введите цифры с картинки",a,{inputType:"number"});a=AnyBalance.requestPost(baseurlLogin+"wap/auth/ussdCaptcha?captchaAnswer="+encodeURIComponent(g),
{},d);a=getJson(a);if(a.success)return c=AnyBalance.requestPost(baseurlLogin+"wap/auth/ussd?pNumber="+encodeURIComponent(b.login),{},d),f=AnyBalance.getLastStatusCode(),!0;throw new AnyBalance.Error("Неверно введены цифры с картинки.");}if(a.forbiddenBranch)throw new AnyBalance.Error("Этот номер не поддерживается личным кабинетом "+g_operatorName+". Убедитесь, что это действительно номер "+g_operatorName+".",null,!0);AnyBalance.trace(c);throw new AnyBalance.Error("Вход в личный кабинет не подтвержден на телефоне пользователя. Чтобы войти, отправьте 1 в ответ на запрос на телефоне или дождитесь SMS кода и введите его.");
}}return!1}var b=AnyBalance.getPreferences(),c=AnyBalance.requestGet(baseurlLogin+"wap/auth/ussd",g_headers);if(!c||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(c),new AnyBalance.Error("Ошибка при подключении к сайту провайдера! Попробуйте обновить данные позже.");var e=getParam(c,[/<input[^>]+value="([^"]+)"[^>]*name="_csrf"/i,/<input[^>]+name="_csrf"[^>]*value="([^"]+)"/i],replaceTagsAndSpaces);if(!e)throw AnyBalance.trace(c),new AnyBalance.Error("Не удалось найти форму входа при входе через SMS, сайт изменен?");
var d=addHeaders({Origin:baseurlLogin.replace(/(.*:\/\/[^\/]+).*/i,"$1"),"X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":e,Referer:AnyBalance.getLastUrl()}),c=AnyBalance.requestPost(baseurlLogin+"wap/auth/ussd?pNumber="+encodeURIComponent(b.login),{},d),f=AnyBalance.getLastStatusCode();a()&&a();if(504==f){var c=AnyBalance.requestGet(baseurlLogin+"wap/auth/requestSms",addHeaders({Referer:AnyBalance.getLastUrl()})),e=getParam(c,[/<input[^>]+value="([^"]+)"[^>]*name="_csrf"/i,/<input[^>]+name="_csrf"[^>]*value="([^"]+)"/i],
replaceTagsAndSpaces),g=AnyBalance.retrieveCode("Вам отправлено SMS-сообщение с кодом для входа в личный кабинет "+g_operatorName+". Введите код из SMS",null,{inputType:"number"}),c=AnyBalance.requestPost(baseurlLogin+"wap/auth/submitSmsCode",{_csrf:e,smsCode:g},addHeaders({Referer:AnyBalance.getLastUrl()}));if(!/\w+\/logout/i.test(c)&&400>AnyBalance.getLastStatusCode()){if(e=getParam(c,null,null,/<section[^>]+class="error"[^>]*>([\s\S]*?)(?:<div|<\/section>)/i,replaceTagsAndSpaces))throw new AnyBalance.Error(e);
AnyBalance.trace(c);throw new AnyBalance.Error("Не удалось войти в кабинет после ввода SMS. Сайт изменен?");}}return c}
function processBalance(a,b){if(AnyBalance.isAvailable("balance","tariff")){AnyBalance.trace("Получаем баланс");for(var c=0;3>c;c++)try{AnyBalance.trace("Пытаемся получить баланс, попытка: "+(c+1));a=AnyBalance.requestGet(baseurl+"main/tariffAndBalance",g_headers);var e=getJson(a);e.currentTariffPlan.name&&getParam(e.currentTariffPlan.name,b,"tariff");getParam(e.balance.amount,b,"balance",null,null,parseBalance);AnyBalance.trace("Успешно получили баланс");break}catch(d){AnyBalance.trace("Не удалось получить баланс, пробуем еще раз...")}}}
function processRemainders(a,b){if(AnyBalance.isAvailable("remainders")){AnyBalance.trace("Получаем остатки услуг");try{b.remainders||(b.remainders={});AnyBalance.trace("Searching for resources left");a=AnyBalance.requestGet(baseurl+"main/discounts",g_headers);AnyBalance.trace("Got discounts: "+a);json=JSON.parse(a);var c=[json.discountsIncluded,json.discountsNotIncluded,json.discountsRollover];for(a=0;a<c.length;++a)for(var e=c[a],d=0;e&&d<e.length;++d){var f=e[d];if(isArray(f))for(var g=0;g<f.length;++g)getDiscount(b.remainders,
f[g]);else getDiscount(b.remainders,f)}}catch(h){AnyBalance.trace("Не удалось получить данные об остатках пакетов и услуг, попробуйте позже "+h)}}}
function getDiscount(a,b){var c=b.name,e=b.limitMeasureCode;AnyBalance.trace("Найден дискаунт: "+c+" ("+e+")");getParam(b.endDateString,a,"remainders.endDate",null,null,parseDateWordSilent);/мин/i.test(e)?(sumParam(Math.round(100*b.rest.value)/100,a,"remainders.min_left",null,null,null,aggregate_sum),sumParam(Math.round(100*(b.limit.value-b.rest.value)/100),a,"remainders.min_used",null,null,null,aggregate_sum),sumParam(b.endDate||void 0,a,"remainders.min_till",null,null,null,aggregate_min)):/[кмгkmg][bб]/i.test(e)?
(c=parseTraffic(b.rest.value+b.rest.measure),e=parseTraffic(b.limit.value+b.limit.measure),sumParam(c,a,"remainders.traffic_left",null,null,null,aggregate_sum),sumParam(e-c,a,"remainders.traffic_used",null,null,null,aggregate_sum),sumParam(b.endDate||void 0,a,"remainders.traffic_till",null,null,null,aggregate_min)):/шт|SMS|MMS/i.test(e)?/ммс|mms/i.test(c)?(sumParam(b.rest.value,a,"remainders.mms_left",null,null,null,aggregate_sum),sumParam(b.limit.value-b.rest.value,a,"remainders.mms_used",null,null,
null,aggregate_sum),sumParam(b.endDate||void 0,a,"remainders.mms_till",null,null,null,aggregate_min)):(sumParam(b.rest.value,a,"remainders.sms_left",null,null,null,aggregate_sum),sumParam(b.limit.value-b.rest.value,a,"remainders.sms_used",null,null,null,aggregate_sum),sumParam(b.endDate||void 0,a,"remainders.sms_till",null,null,null,aggregate_min)):AnyBalance.trace("Неизвестный дискаунт: "+JSON.stringify(b))}
function processPayments(a,b){if(AnyBalance.isAvailable("payments")){AnyBalance.trace("Searching for payments");try{a=AnyBalance.requestGet(baseurl+"payments/history?filter=LAST_10");var c=getParam(a,null,null,/JS_DATA\s*=\s*JSON.parse\s*\(('(?:[^\\']+|\\.)*')/,null,function(a){return getJson(safeEval("return "+a))})}catch(f){}if(c&&c.payments)for(AnyBalance.trace("History json: "+JSON.stringify(c)),b.payments=[],a=0;a<c.payments.length;++a){var e=c.payments[a],d={};getParam(e.amount,d,"payments.sum",
null,null,parseBalanceSilent);getParam(e.type,d,"payments.descr");getParam(e.date,d,"payments.date",null,null,function(a){if(/Вчера/i.test(a))return parseDate(a.replace(/Вчера(?:\s+в)?/i,getFormattedDate({offsetDay:1})));if(/Сегодня/i.test(a))return parseDate(a.replace(/Сегодня(?:\s+в)?/i,getFormattedDate({offsetDay:0})));if(/назад/i.test(a)){var b=(new Date).getTime()-1E3*parseMinutes(a);AnyBalance.trace("Parsed "+(new Date(b)).getTime()+" from "+a);return b}a=/^(\d+\s+[а-яa-z]+(?:\s+\d+)?)/i.exec(a)||
[];return parseDateWord(a[1])});b.payments.push(d)}else AnyBalance.trace(a),AnyBalance.trace("Не удолось получить последние платежи, может их просто нет?")}}
function processInfo(a,b){AnyBalance.isAvailable("info")&&(b=b.info={},getParam(a,b,"info.fio",/<div[^>]+class="user-name"[^>]*>([\s\S]*?)(?:<\/div>|<a)/i,replaceTagsAndSpaces,capitalFirstLetters),getParam(a,b,"info.mphone",/<div[^>]+class="user-phone"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces),AnyBalance.isAvailable("info.email","info.address")&&(a=AnyBalance.requestGet(baseurl+"account"),getParam(a,b,"info.phone_model",/Модель телефона:([\s\S]*?)<\/p>/i,replaceTagsAndSpaces),getParam(a,b,"info.address",
/<div[^>]+id="js-view-element-address-view"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces),getParam(a,b,"info.email",/<div[^>]+id="js-view-element-email-view"[^>]*>([\s\S]*?)<\/div>/i,[/unknown@email.com/i,"",replaceTagsAndSpaces])))};
