var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/48.0.2564.116 Safari/537.36"},baseurl="https://tele2.ru/",baseurlLogin="https://login.tele2.ru/ssotele2/",baseurlLoginIndex,baseurlLoginPost,g_operatorName="Теле2";
function login(){function a(a){if(400<AnyBalance.getLastStatusCode()){var b=getElement(a,/<div[^>]+error[^>]*>/i,replaceTagsAndSpaces);503==AnyBalance.getLastStatusCode()&&(a=AnyBalance.requestGet(baseurl+"login",g_headers));if(400<AnyBalance.getLastStatusCode()){if(b)throw new AnyBalance.Error("Новый кабинет: "+b);AnyBalance.trace(a);throw new AnyBalance.Error("Новый личный кабинет "+g_operatorName+" временно недоступен. Попробуйте позже.",!0);}}return a}var c=baseurlLoginIndex||baseurlLogin+"wap/auth/",
b=baseurlLoginPost||baseurlLogin+"wap/auth/submitLoginAndPassword",e=AnyBalance.getPreferences();checkEmpty(/^\d{10}$/.test(e.login),"Введите логин - номера телефона из 10 цифр! Например, 9771234567");AnyBalance.setDefaultCharset("utf-8");var d=AnyBalance.requestGet(baseurl+"login",g_headers);if(/\w+\/"number":"\d+"/i.test(d))AnyBalance.trace("Уже в кабинете. Используем текущую сессию");else{if(e.password){d=AnyBalance.requestGet(c+"?serviceId=301",g_headers);if(!d||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(d),
new AnyBalance.Error("Ошибка при подключении к сайту провайдера! Попробуйте обновить данные позже.");c=getElement(d,/<form[^>]+(?:authForm|submitLoginAndPassword)/i);if(!c)throw AnyBalance.trace(d),new AnyBalance.Error("Не удалось найти форму входа, сайт изменен?");d=AB.createFormParams(c,function(a,b,c,d){return/number|msisdn/i.test(c)?e.login:"password"==c?e.password:d});d=AnyBalance.requestPost(b,d,addHeaders({Referer:baseurlLoginIndex}))}else d=enterBySms();d=a(d)}if(!/\w+\/logout/i.test(d)){if(/<input[^>]+id\s*=\s*"smsCode"/i.test(d))throw new AnyBalance.Error("У вас настроена двухфакторная авторизация с вводом SMS кода при входе в личный кабинет "+
g_operatorName+". Для работы провайдера требуется запрос СМС кода для входа в ЛК отключить. Инструкцию по отключению см. в описании провайдера.",null,!0);if(b=getElements(d,/<(?:section|div)[^>]+class="[^"]*\berror\b/gi,[/Осталось:/ig,"",replaceTagsAndSpaces]).join("\n")||"")throw new AnyBalance.Error(b,null,/парол|не найден/i.test(b));AnyBalance.trace(d);throw new AnyBalance.Error("Не удалось зайти в личный кабинет. Сайт изменен?");}/<div[^>]+class="user-phone"/i.test(d)||(d=AnyBalance.requestGet(baseurl+
"login",addHeaders({Referer:baseurl})),d=a(d));__setLoginSuccessful();return d}
function enterBySms(){function a(){if(400>f){var a=getJson(b);if(a.success)AnyBalance.setCookie("login.tele2.ru","AUTH_DATA",a.key),b=AnyBalance.requestGet(baseurlLogin+"wap/auth?serviceId=301",g_headers);else{if(a.captchaNeeded){a=AnyBalance.requestGet(baseurlLogin+"wap/auth/captcha?"+(new Date).getTime(),g_headers);g=AnyBalance.retrieveCode("Пожалуйста, введите цифры с картинки",a,{inputType:"number"});a=AnyBalance.requestPost(baseurlLogin+"wap/auth/ussdCaptcha?captchaAnswer="+encodeURIComponent(g),
{},d);a=getJson(a);if(a.success)return b=AnyBalance.requestPost(baseurlLogin+"wap/auth/ussd?pNumber="+encodeURIComponent(c.login),{},d),f=AnyBalance.getLastStatusCode(),!0;throw new AnyBalance.Error("Неверно введены цифры с картинки.");}if(a.forbiddenBranch)throw new AnyBalance.Error("Этот номер не поддерживается личным кабинетом "+g_operatorName+". Убедитесь, что это действительно номер "+g_operatorName+".",null,!0);AnyBalance.trace(b);throw new AnyBalance.Error("Вход в личный кабинет не подтвержден на телефоне пользователя. Чтобы войти, отправьте 1 в ответ на запрос на телефоне или дождитесь SMS кода и введите его.");
}}return!1}var c=AnyBalance.getPreferences(),b=AnyBalance.requestGet(baseurlLogin+"wap/auth/ussd",g_headers);if(!b||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(b),new AnyBalance.Error("Ошибка при подключении к сайту провайдера! Попробуйте обновить данные позже.");var e=getParam(b,[/<input[^>]+value="([^"]+)"[^>]*name="_csrf"/i,/<input[^>]+name="_csrf"[^>]*value="([^"]+)"/i],replaceTagsAndSpaces);if(!e)throw AnyBalance.trace(b),new AnyBalance.Error("Не удалось найти форму входа при входе через SMS, сайт изменен?");
var d=addHeaders({Origin:baseurlLogin.replace(/(.*:\/\/[^\/]+).*/i,"$1"),"X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":e,Referer:AnyBalance.getLastUrl()}),b=AnyBalance.requestPost(baseurlLogin+"wap/auth/ussd?pNumber="+encodeURIComponent(c.login),{},d),f=AnyBalance.getLastStatusCode();a()&&a();if(504==f){var b=AnyBalance.requestGet(baseurlLogin+"wap/auth/requestSms",addHeaders({Referer:AnyBalance.getLastUrl()})),e=getParam(b,[/<input[^>]+value="([^"]+)"[^>]*name="_csrf"/i,/<input[^>]+name="_csrf"[^>]*value="([^"]+)"/i],
replaceTagsAndSpaces),g=AnyBalance.retrieveCode("Вам отправлено SMS-сообщение с кодом для входа в личный кабинет "+g_operatorName+". Введите код из SMS",null,{inputType:"number"}),b=AnyBalance.requestPost(baseurlLogin+"wap/auth/submitSmsCode",{_csrf:e,smsCode:g},addHeaders({Referer:AnyBalance.getLastUrl()}));if(!/\w+\/logout/i.test(b)&&400>AnyBalance.getLastStatusCode()){if(e=getParam(b,null,null,/<section[^>]+class="error"[^>]*>([\s\S]*?)(?:<div|<\/section>)/i,replaceTagsAndSpaces))throw new AnyBalance.Error(e);
AnyBalance.trace(b);throw new AnyBalance.Error("Не удалось войти в кабинет после ввода SMS. Сайт изменен?");}}return b}function getSubscriberId(){var a=AnyBalance.getPreferences();return"7"+replaceAll(a.login,[/\D/g,"",/.*(\d{10})$/,"$1"])}
function processBalance(a,c){if(AnyBalance.isAvailable("balance","tariff")){var b=getSubscriberId();AnyBalance.trace("Получаем баланс");if(AnyBalance.isAvailable("balance"))for(var e=0;3>e;e++)try{AnyBalance.trace("Пытаемся получить баланс, попытка: "+(e+1));a=AnyBalance.requestGet(baseurl+"api/subscribers/"+b+"/balance",addHeaders({Accept:"*/*","X-Requested-With":"XMLHttpRequest",Referer:baseurl}));var d=getJson(a);getParam(d.data.value,c,"balance");AnyBalance.trace("Успешно получили баланс");break}catch(f){AnyBalance.trace("Не удалось получить баланс, пробуем еще раз...")}if(AnyBalance.isAvailable("tariff"))for(e=
0;3>e;e++)try{AnyBalance.trace("Пытаемся получить тариф, попытка: "+(e+1));a=AnyBalance.requestGet(baseurl+"api/subscribers/"+b+"/tariff",addHeaders({Accept:"*/*","X-Requested-With":"XMLHttpRequest",Referer:baseurl}));d=getJson(a);getParam(d.data.frontName,c,"tariff");AnyBalance.trace("Успешно получили тариф");break}catch(f){AnyBalance.trace("Не удалось получить тариф, пробуем еще раз...")}}}
function processRemainders(a,c){if(AnyBalance.isAvailable("remainders")){AnyBalance.trace("Получаем остатки услуг");var b=getParam(a,/"siteId":"([^"]*)/i);if(!b)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось определить регион. Сайт изменен?");try{c.remainders||(c.remainders={});var e=getSubscriberId();AnyBalance.trace("Searching for resources left");a=AnyBalance.requestGet(baseurl+"api/subscribers/"+e+"/"+b+"/rests",addHeaders({Accept:"*/*","X-Requested-With":"XMLHttpRequest",Referer:baseurl}));
AnyBalance.trace("Got discounts: "+a);json=JSON.parse(a);for(a=0;a<json.data.rests.length;++a)getDiscount(c.remainders,json.data.rests[a])}catch(d){AnyBalance.trace("Не удалось получить данные об остатках пакетов и услуг, попробуйте позже "+d)}}}
function getDiscount(a,c){var b=c.uom;AnyBalance.trace("Найден дискаунт: "+c.service.name+" ("+b+")");if(0!==c.limit)if(getParam(c.endDay,a,"remainders.endDate",null,null,parseDateISO),/min/i.test(b))sumParam(Math.round(100*c.remain)/100,a,"remainders.min_left",null,null,null,aggregate_sum),sumParam(Math.round(100*(c.limit-c.remain)/100),a,"remainders.min_used",null,null,null,aggregate_sum),sumParam(c.endDay||void 0,a,"remainders.min_till",null,null,parseDateISO,aggregate_min);else if(/[кмгkmg][bб]/i.test(b)){var b=
parseTraffic(c.remain+c.uom),e=parseTraffic(c.limit+c.uom);sumParam(b,a,"remainders.traffic_left",null,null,null,aggregate_sum);sumParam(e-b,a,"remainders.traffic_used",null,null,null,aggregate_sum);sumParam(c.endDate||void 0,a,"remainders.traffic_till",null,null,parseDateISO,aggregate_min)}else/pcs/i.test(b)?(sumParam(c.remain,a,"remainders.sms_left",null,null,null,aggregate_sum),sumParam(c.limit-c.remain,a,"remainders.sms_used",null,null,null,aggregate_sum),sumParam(c.endDate||void 0,a,"remainders.sms_till",
null,null,parseDateISO,aggregate_min)):AnyBalance.trace("Неизвестный дискаунт: "+JSON.stringify(c))}
function processPayments(a,c){if(AnyBalance.isAvailable("payments")){AnyBalance.trace("Searching for payments");var b=getSubscriberId();try{a=AnyBalance.requestGet(baseurl+"api/subscribers/"+b+"/payments?fromDate="+getFormattedDate({format:"YYYY-MM-DD",offsetMonth:6})+"T00%3A00%3A00%2B03%3A00&toDate="+getFormattedDate({format:"YYYY-MM-DD"})+"T23%3A59%3A59%2B03%3A00",g_headers);var e=getJson(a)}catch(f){}if(e&&e.data)for(AnyBalance.trace("History json: "+JSON.stringify(e)),c.payments=[],a=0;a<e.data.length;++a){var b=
e.data[a],d={};getParam(b.sum.amount,d,"payments.sum",null,null,parseBalanceSilent);getParam(b.type,d,"payments.descr");getParam(b.payDate,d,"payments.date",null,null,parseDateISO);c.payments.push(d)}else AnyBalance.trace(a),AnyBalance.trace("Не удалось получить последние платежи, может их просто нет?")}}
function processInfo(a,c){if(AnyBalance.isAvailable("info")){var b=getSubscriberId();c=c.info={};a=AnyBalance.requestGet(baseurl+"api/subscribers/"+b+"/profile",addHeaders({Accept:"*/*","X-Requested-With":"XMLHttpRequest",Referer:baseurl}));a=getJson(a);getParam(a.data.fullName,c,"info.fio",/<div[^>]+class="user-name"[^>]*>([\s\S]*?)(?:<\/div>|<a)/i,replaceTagsAndSpaces,capitalFirstLetters);getParam(b,c,"info.mphone");getParam(a.data.address.city+" "+a.data.address.street+" "+a.data.address.house,
c,"info.address");getParam(a.data.email||void 0,c,"info.email")}};
