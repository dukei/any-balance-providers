var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","Tele2-User-Agent":"web","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/48.0.2564.116 Safari/537.36"},baseurl="https://msk.tele2.ru/",baseurlLoginIndex,baseurlLoginPost,g_operatorName="Теле2",g_siteId="siteMSK";
function login(){var a=AnyBalance.getPreferences();checkEmpty(/^\d{10}$/.test(a.login),"Введите логин - номера телефона из 10 цифр! Например, 9771234567");AnyBalance.setDefaultCharset("utf-8");var b=AnyBalance.requestGet(baseurl+"api/subscribers/7"+a.login+"/profile",g_headers);if(400<=AnyBalance.getLastStatusCode())if(a.password){b=AnyBalance.requestPost(baseurl+"auth/realms/tele2-b2c/protocol/openid-connect/token",{client_id:"digital-suite-web-app",grant_type:"password",username:"7"+a.login,password:a.password,
password_type:"password"},g_headers);a=getJson(b);if(!a.access_token){if(a=a.error_description)throw new AnyBalance.Error(a,null,/парол|not found|password/i.test(a));AnyBalance.trace(b);throw new AnyBalance.error("Не удалось зайти в личный кабинет. Сайт изменен?");}g_headers.Authorization="Bearer "+a.access_token;b=AnyBalance.requestGet(baseurl+"api/route/redirect?path=/lk&softRedirect=true",g_headers);a=getJson(b);AnyBalance.trace("Правильный сайт: "+a.data.location);baseurl=getParam(a.data.location,
/^https?:\/\/[^\/]*\//i);b=AnyBalance.requestGet(a.data.location,g_headers);a=getParam(b,/"siteId":"([^"]*)/i);if(!a)throw AnyBalance.trace(b),new AnyBalance.Error("Не удалось определить регион. Сайт изменен?");AnyBalance.trace("SiteID: "+a);g_siteId=a}else b=enterBySms();else AnyBalance.trace("Уже в кабинете. Используем текущую сессию");__setLoginSuccessful();return b}
function enterBySms(){function a(){if(400>f){var a=getJson(c);if(a.success)AnyBalance.setCookie("login.tele2.ru","AUTH_DATA",a.key),c=AnyBalance.requestGet(baseurlLogin+"wap/auth?serviceId=301",g_headers);else{if(a.captchaNeeded){a=AnyBalance.requestGet(baseurlLogin+"wap/auth/captcha?"+(new Date).getTime(),g_headers);g=AnyBalance.retrieveCode("Пожалуйста, введите цифры с картинки",a,{inputType:"number"});a=AnyBalance.requestPost(baseurlLogin+"wap/auth/ussdCaptcha?captchaAnswer="+encodeURIComponent(g),
{},e);a=getJson(a);if(a.success)return c=AnyBalance.requestPost(baseurlLogin+"wap/auth/ussd?pNumber="+encodeURIComponent(b.login),{},e),f=AnyBalance.getLastStatusCode(),!0;throw new AnyBalance.Error("Неверно введены цифры с картинки.");}if(a.forbiddenBranch)throw new AnyBalance.Error("Этот номер не поддерживается личным кабинетом "+g_operatorName+". Убедитесь, что это действительно номер "+g_operatorName+".",null,!0);AnyBalance.trace(c);throw new AnyBalance.Error("Вход в личный кабинет не подтвержден на телефоне пользователя. Чтобы войти, отправьте 1 в ответ на запрос на телефоне или дождитесь SMS кода и введите его.");
}}return!1}var b=AnyBalance.getPreferences(),c=AnyBalance.requestGet(baseurlLogin+"wap/auth/ussd",g_headers);if(!c||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(c),new AnyBalance.Error("Ошибка при подключении к сайту провайдера! Попробуйте обновить данные позже.");var d=getParam(c,[/<input[^>]+value="([^"]+)"[^>]*name="_csrf"/i,/<input[^>]+name="_csrf"[^>]*value="([^"]+)"/i],replaceTagsAndSpaces);if(!d)throw AnyBalance.trace(c),new AnyBalance.Error("Не удалось найти форму входа при входе через SMS, сайт изменен?");
var e=addHeaders({Origin:baseurlLogin.replace(/(.*:\/\/[^\/]+).*/i,"$1"),"X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":d,Referer:AnyBalance.getLastUrl()}),c=AnyBalance.requestPost(baseurlLogin+"wap/auth/ussd?pNumber="+encodeURIComponent(b.login),{},e),f=AnyBalance.getLastStatusCode();a()&&a();if(504==f){var c=AnyBalance.requestGet(baseurlLogin+"wap/auth/requestSms",addHeaders({Referer:AnyBalance.getLastUrl()})),d=getParam(c,[/<input[^>]+value="([^"]+)"[^>]*name="_csrf"/i,/<input[^>]+name="_csrf"[^>]*value="([^"]+)"/i],
replaceTagsAndSpaces),g=AnyBalance.retrieveCode("Вам отправлено SMS-сообщение с кодом для входа в личный кабинет "+g_operatorName+". Введите код из SMS",null,{inputType:"number"}),c=AnyBalance.requestPost(baseurlLogin+"wap/auth/submitSmsCode",{_csrf:d,smsCode:g},addHeaders({Referer:AnyBalance.getLastUrl()}));if(!/\w+\/logout/i.test(c)&&400>AnyBalance.getLastStatusCode()){if(d=getParam(c,null,null,/<section[^>]+class="error"[^>]*>([\s\S]*?)(?:<div|<\/section>)/i,replaceTagsAndSpaces))throw new AnyBalance.Error(d);
AnyBalance.trace(c);throw new AnyBalance.Error("Не удалось войти в кабинет после ввода SMS. Сайт изменен?");}}return c}function getSubscriberId(){var a=AnyBalance.getPreferences();return"7"+replaceAll(a.login,[/\D/g,"",/.*(\d{10})$/,"$1"])}
function processBalance(a,b){if(AnyBalance.isAvailable("balance","tariff")){var c=getSubscriberId();AnyBalance.trace("Получаем баланс");if(AnyBalance.isAvailable("balance"))for(var d=0;3>d;d++)try{AnyBalance.trace("Пытаемся получить баланс, попытка: "+(d+1));a=AnyBalance.requestGet(baseurl+"api/subscribers/"+c+"/balance",addHeaders({Accept:"*/*","X-Requested-With":"XMLHttpRequest",Referer:baseurl}));var e=getJson(a);getParam(e.data.value,b,"balance");AnyBalance.trace("Успешно получили баланс");break}catch(f){AnyBalance.trace("Не удалось получить баланс, пробуем еще раз...")}if(AnyBalance.isAvailable("tariff"))for(d=
0;3>d;d++)try{AnyBalance.trace("Пытаемся получить тариф, попытка: "+(d+1));a=AnyBalance.requestGet(baseurl+"api/subscribers/"+c+"/tariff",addHeaders({Accept:"*/*","X-Requested-With":"XMLHttpRequest",Referer:baseurl}));e=getJson(a);getParam(e.data.frontName,b,"tariff");AnyBalance.trace("Успешно получили тариф");break}catch(f){AnyBalance.trace("Не удалось получить тариф, пробуем еще раз...")}}}
function processRemainders(a,b){if(AnyBalance.isAvailable("remainders")){AnyBalance.trace("Получаем остатки услуг");var c=g_siteId;try{b.remainders||(b.remainders={});var d=getSubscriberId();AnyBalance.trace("Searching for resources left");a=AnyBalance.requestGet(baseurl+"api/subscribers/"+d+"/"+c+"/rests",addHeaders({Accept:"*/*","X-Requested-With":"XMLHttpRequest",Referer:baseurl}));AnyBalance.trace("Got discounts: "+a);json=JSON.parse(a);for(a=0;a<json.data.rests.length;++a)getDiscount(b.remainders,
json.data.rests[a])}catch(e){AnyBalance.trace("Не удалось получить данные об остатках пакетов и услуг, попробуйте позже "+e)}}}
function getDiscount(a,b){var c=b.uom;AnyBalance.trace("Найден дискаунт: "+b.service.name+" ("+c+")");if(0!==b.limit)if(getParam(b.endDay,a,"remainders.endDate",null,null,parseDateISO),/min/i.test(c))sumParam(Math.round(100*b.remain)/100,a,"remainders.min_left",null,null,null,aggregate_sum),sumParam(Math.round(100*(b.limit-b.remain)/100),a,"remainders.min_used",null,null,null,aggregate_sum),sumParam(b.endDay||void 0,a,"remainders.min_till",null,null,parseDateISO,aggregate_min);else if(/[кмгkmg][bб]/i.test(c)){var c=
parseTraffic(b.remain+b.uom),d=parseTraffic(b.limit+b.uom);sumParam(c,a,"remainders.traffic_left",null,null,null,aggregate_sum);sumParam(d-c,a,"remainders.traffic_used",null,null,null,aggregate_sum);sumParam(b.endDay||void 0,a,"remainders.traffic_till",null,null,parseDateISO,aggregate_min)}else/pcs/i.test(c)?(sumParam(b.remain,a,"remainders.sms_left",null,null,null,aggregate_sum),sumParam(b.limit-b.remain,a,"remainders.sms_used",null,null,null,aggregate_sum),sumParam(b.endDay||void 0,a,"remainders.sms_till",
null,null,parseDateISO,aggregate_min)):AnyBalance.trace("Неизвестный дискаунт: "+JSON.stringify(b))}
function processPayments(a,b){if(AnyBalance.isAvailable("payments")){AnyBalance.trace("Searching for payments");var c=getSubscriberId();try{a=AnyBalance.requestGet(baseurl+"api/subscribers/"+c+"/payments?fromDate="+getFormattedDate({format:"YYYY-MM-DD",offsetMonth:3})+"T00%3A00%3A00%2B03%3A00&toDate="+getFormattedDate({format:"YYYY-MM-DD"})+"T23%3A59%3A59%2B03%3A00",g_headers);var d=getJson(a)}catch(f){}if(d&&d.data)for(AnyBalance.trace("History json: "+JSON.stringify(d)),b.payments=[],a=0;a<d.data.length;++a){var c=
d.data[a],e={};getParam(c.sum.amount,e,"payments.sum",null,null,parseBalanceSilent);getParam(c.type,e,"payments.descr");getParam(c.payDate,e,"payments.date",null,null,parseDateISO);b.payments.push(e)}else AnyBalance.trace(a),AnyBalance.trace("Не удалось получить последние платежи, может их просто нет?")}}
function processInfo(a,b){if(AnyBalance.isAvailable("info")){var c=getSubscriberId();b=b.info={};a=AnyBalance.requestGet(baseurl+"api/subscribers/"+c+"/profile",addHeaders({Accept:"*/*","X-Requested-With":"XMLHttpRequest",Referer:baseurl}));a=getJson(a);getParam(a.data.fullName,b,"info.fio",/<div[^>]+class="user-name"[^>]*>([\s\S]*?)(?:<\/div>|<a)/i,replaceTagsAndSpaces,capitalFirstLetters);getParam(c,b,"info.mphone");getParam(a.data.address.city+" "+a.data.address.street+" "+a.data.address.house,
b,"info.address");getParam(a.data.email||void 0,b,"info.email")}};
