var g_headers={Connection:"keep-alive","Tele2-User-Agent":'"mytele2-app/4.27.1"; "unknown"; "Android/9"; "Build/12998710"',"X-API-Version":"3","User-Agent":"okhttp/4.2.0"},baseurl="https://api.tele2.ru/";
function callApi(a,b){a=joinUrl(baseurl+"api/",a);var c=g_headers;b&&(b.__post?delete b.__post:(b=JSON.stringify(b),c=addHeaders({"Content-Type":"application/json; charset=UTF-8"})));b=AnyBalance.requestPost(a,b,c,{HTTP_METHOD:b?"POST":"GET"});a={};if(b&&(a=JSON.parse(b),!a.data&&!a.access_token&&!a.current_username))throw AnyBalance.trace(b),b=a.message||a.error_description||"Ошибка обращения к API",new AnyBalance.Error(b,null,/парол|Msisdn not found|password/i.test(b));return a.data||a}
function login(){AnyBalance.setDefaultCharset("utf-8");var a=AnyBalance.getPreferences();checkEmpty(/^\d{10}$/.test(a.login),"Введите логин - номер телефона из 10 цифр! Например, 9771234567");if(!g_headers.Authorization){var b=loginByAccessToken();b||(b=loginByRefreshToken());b||(a.password?loginByPassword():loginBySMS());__setLoginSuccessful()}}
function saveTokens(a){var b=AnyBalance.getPreferences();g_headers.Authorization="Bearer "+a.access_token;AnyBalance.setData("login",b.login);AnyBalance.setData("ac",a.access_token);AnyBalance.setData("rt",a.refresh_token);AnyBalance.saveData()}
function loginBySMS(){var a=AnyBalance.getPreferences();callApi("validation/number/7"+a.login,{sender:"Tele2"});var b=AnyBalance.retrieveCode("Пожалуйста, введите код из SMS для входа в личный кабинет Tele2",null,{inputType:"number",time:18E4});a=callApi("https://sso.tele2.ru/auth/realms/tele2-b2c/protocol/openid-connect/token?msisdn=7"+a.login+"&action=auth&authType=sms",{__post:!0,username:"7"+a.login,password:b,grant_type:"password",client_id:"android-app",password_type:"sms_code"});saveTokens(a)}
function loginByAccessToken(){if(AnyBalance.getPreferences().login!==AnyBalance.getData("login"))return!1;g_headers.Authorization="Bearer "+AnyBalance.getData("ac");try{json=callApi("https://sso.tele2.ru/auth/realms/tele2-b2c/protocol/openid-connect/userinfo")}catch(a){return AnyBalance.trace("Не удалось войти по access token: "+a.message),!1}AnyBalance.trace("Вошли по access token");return!0}
function loginByAccessToken(){if(AnyBalance.getPreferences().login!==AnyBalance.getData("login"))return!1;g_headers.Authorization="Bearer "+AnyBalance.getData("ac");try{callApi("https://sso.tele2.ru/auth/realms/tele2-b2c/protocol/openid-connect/userinfo")}catch(a){return AnyBalance.trace("Не удалось войти по access token: "+a.message),!1}AnyBalance.trace("Вошли по access token");return!0}
function loginByRefreshToken(){if(AnyBalance.getPreferences().login!==AnyBalance.getData("login"))return!1;delete g_headers.Authorization;try{var a=callApi("https://sso.tele2.ru/auth/realms/tele2-b2c/protocol/openid-connect/token?action=refresh",{__post:!0,refresh_token:AnyBalance.getData("rt"),grant_type:"refresh_token",client_id:"android-app"})}catch(b){return AnyBalance.trace("Не удалось получить токен по refresh token: "+b.message),!1}AnyBalance.trace("Получили новый access token по refresh token");
saveTokens(a);return loginByAccessToken()}function loginByPassword(){var a=AnyBalance.getPreferences();json=callApi("https://sso.tele2.ru/auth/realms/tele2-b2c/protocol/openid-connect/token?msisdn=7"+a.login+"&action=auth&authType=pass",{__post:!0,username:"7"+a.login,password:a.password,grant_type:"password",client_id:"android-app",password_type:"password"});saveTokens(json)}function getSubscriberId(){var a=AnyBalance.getPreferences();return"7"+replaceAll(a.login,[/\D/g,"",/.*(\d{10})$/,"$1"])}
function processBalance(a){if(AnyBalance.isAvailable("balance","tariff")){var b=getSubscriberId();AnyBalance.trace("Получаем баланс");if(AnyBalance.isAvailable("balance"))for(var c=0;3>c;c++)try{AnyBalance.trace("Пытаемся получить баланс, попытка: "+(c+1));var d=AnyBalance.requestGet(baseurl+"api/subscribers/"+b+"/balance",addHeaders({Accept:"*/*","X-Requested-With":"XMLHttpRequest",Referer:baseurl})),e=getJson(d);getParam(e.data.value,a,"balance");AnyBalance.trace("Успешно получили баланс");break}catch(f){AnyBalance.trace("Не удалось получить баланс, пробуем еще раз...")}if(AnyBalance.isAvailable("tariff"))for(c=
0;3>c;c++)try{AnyBalance.trace("Пытаемся получить тариф, попытка: "+(c+1));d=AnyBalance.requestGet(baseurl+"api/subscribers/"+b+"/tariff",addHeaders({Accept:"*/*","X-Requested-With":"XMLHttpRequest",Referer:baseurl}));e=getJson(d);getParam(e.data.frontName,a,"tariff");AnyBalance.trace("Успешно получили тариф");break}catch(f){AnyBalance.trace("Не удалось получить тариф, пробуем еще раз...")}}}
function processRemainders(a){if(AnyBalance.isAvailable("remainders")){AnyBalance.trace("Получаем остатки услуг");try{a.remainders||(a.remainders={});var b=getSubscriberId();AnyBalance.trace("Searching for resources left");var c=AnyBalance.requestGet(baseurl+"api/subscribers/"+b+"/rests",addHeaders({Accept:"*/*","X-Requested-With":"XMLHttpRequest",Referer:baseurl}));AnyBalance.trace("Got discounts: "+c);json=JSON.parse(c);for(b=0;b<json.data.rests.length;++b)getDiscount(a.remainders,json.data.rests[b])}catch(d){AnyBalance.trace("Не удалось получить данные об остатках пакетов и услуг, попробуйте позже "+
d)}}}
function getDiscount(a,b){var c=b.uom;AnyBalance.trace("Найден дискаунт: "+b.service.name+" ("+c+")");if(0!==b.limit)if(getParam(b.endDay,a,"remainders.endDate",null,null,parseDateISO),/min/i.test(c))sumParam(Math.round(100*b.remain)/100,a,"remainders.min_left",null,null,null,aggregate_sum),sumParam(Math.round(100*(b.limit-b.remain)/100),a,"remainders.min_used",null,null,null,aggregate_sum),sumParam(b.endDay||void 0,a,"remainders.min_till",null,null,parseDateISO,aggregate_min);else if(/[кмгkmg][bб]/i.test(c)){c=parseTraffic(b.remain+
b.uom);var d=parseTraffic(b.limit+b.uom);sumParam(c,a,"remainders.traffic_left",null,null,null,aggregate_sum);sumParam(d-c,a,"remainders.traffic_used",null,null,null,aggregate_sum);sumParam(b.endDay||void 0,a,"remainders.traffic_till",null,null,parseDateISO,aggregate_min)}else/pcs/i.test(c)?(sumParam(b.remain,a,"remainders.sms_left",null,null,null,aggregate_sum),sumParam(b.limit-b.remain,a,"remainders.sms_used",null,null,null,aggregate_sum),sumParam(b.endDay||void 0,a,"remainders.sms_till",null,null,
parseDateISO,aggregate_min)):AnyBalance.trace("Неизвестный дискаунт: "+JSON.stringify(b))}
function processPayments(a){if(AnyBalance.isAvailable("payments")){AnyBalance.trace("Searching for payments");var b=getSubscriberId();try{var c=AnyBalance.requestGet(baseurl+"api/subscribers/"+b+"/payments?fromDate="+getFormattedDate({format:"YYYY-MM-DD",offsetMonth:3})+"T00%3A00%3A00%2B03%3A00&toDate="+getFormattedDate({format:"YYYY-MM-DD"})+"T23%3A59%3A59%2B03%3A00",g_headers),d=getJson(c)}catch(f){}if(d&&d.data)for(AnyBalance.trace("History json: "+JSON.stringify(d)),a.payments=[],b=0;b<d.data.length;++b){c=
d.data[b];var e={};getParam(c.sum.amount,e,"payments.sum",null,null,parseBalanceSilent);getParam(c.type,e,"payments.descr");getParam(c.payDate,e,"payments.date",null,null,parseDateISO);a.payments.push(e)}else AnyBalance.trace(c),AnyBalance.trace("Не удалось получить последние платежи, может их просто нет?")}}
function processInfo(a){if(AnyBalance.isAvailable("info")){var b=getSubscriberId();a=a.info={};var c=AnyBalance.requestGet(baseurl+"api/subscribers/"+b+"/profile",addHeaders({Accept:"*/*","X-Requested-With":"XMLHttpRequest",Referer:baseurl}));c=getJson(c);getParam(c.data.fullName,a,"info.fio");getParam(b.replace(/.*(\d{3})(\d{3})(\d{2})(\d{2})$/i,"+7 $1 $2-$3-$4"),a,"info.mphone");getParam(c.data.address.city+" "+c.data.address.street+" "+c.data.address.house,a,"info.address");getParam(c.data.email||
void 0,a,"info.email")}};
