var g_headers={Accept:"application/json, text/javascript, */*; q=0.01","Accept-Language":"ru,en;q=0.8",Connection:"keep-alive",Origin:"http://www.gibdd.ru","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2743.116 Safari/537.36"};
function getGibddJson(b){try{var a=getJson(b)}catch(c){AnyBalance.trace(b);if(/При загрузке страницы произошла ошибка|Страницу загрузить не удалось/i.test(b))throw new AnyBalance.Error("Сайт временно работает с перебоями, попробуйте обновить данные позже.");throw new AnyBalance.Error("Не удалось получить информацию, свяжитесь, пожалуйста, с разработчиками.");}return a}
function requestFines(b){AnyBalance.setDefaultCharset("utf-8");AnyBalance.requestGet("https://xn--90adear.xn--p1ai/check/fines/",g_headers);if(400<=AnyBalance.getLastStatusCode())throw AnyBalance.trace("Server returned: "+AnyBalance.getLastStatusString()),new AnyBalance.Error("Сервис проверки штрафов временно недоступен, скоро все снова будет работать.");checkEmpty(b.login,"Введите гос. номер. Номер должен быть в формате а351со190 либо 1234ав199, буквы русские!");checkEmpty(b.password,"Введите номер свидетельства о регистрации в формате 50ХХ123456!");
var a=/(\D{0,1}\d+\D{2})(\d{2,3})/i.exec(b.login);if(!a)throw new AnyBalance.Error("Номер должен быть в формате а123вс190 либо 1234ав199, буквы русские.");var c=AnyBalance.requestGet("http://check.gibdd.ru/proxy/captcha.jpg?",addHeaders({Referer:"https://xn--90adear.xn--p1ai/check/fines/"}));if(400<=AnyBalance.getLastStatusCode())throw AnyBalance.trace("Server returned for captcha: "+AnyBalance.getLastStatusString()),new AnyBalance.Error("Капча на сервисе штрафов временно недоступна, скоро все снова будет работать.");
if(!c)throw new AnyBalance.Error("Не удалось получить капчу. Временные проблемы на сайте или сайт изменен.");c=AnyBalance.retrieveCode("Пожалуйста, введите код с картинки",c,{inputType:"number"});AnyBalance.trace("Капча получена: "+c);a=[["regnum",a[1].toUpperCase()],["regreg",a[2]],["stsnum",b.password.toUpperCase()],["captchaWord",c]];AnyBalance.trace("Пробуем запросить информацию с данными: "+b.login+", "+b.password);b=AnyBalance.requestPost("http://check.gibdd.ru/proxy/check/fines",a,addHeaders({"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",
Referer:"https://xn--90adear.xn--p1ai/check/fines/",Connection:"keep-alive"}));return getGibddJson(b)}
function parseFines(b,a){var c=a.code||a.status;if(200!=c){if(b=a.error||a.message)throw new AnyBalance.Error(b,null,404==c);AnyBalance.trace(JSON.stringify(a));throw new AnyBalance.Error("Не удалось получить данные по штрафам, сайт изменен?");}if(!a.data)throw AnyBalance.trace(JSON.stringify(a)),new AnyBalance.Error("Вероятно, Вами допущена ошибка при заполнении полей запроса.");AnyBalance.trace("Штрафов: "+a.data.length);if(0<a.data.length){b.fines=[];for(c=0;c<a.data.length;c++){var d=a.data[c],
e={__id:d.id,__name:d.NumPost};__shouldProcess("fines",e)&&(getParam(d.Summa+"",e,"fines.summ",null,null,parseBalance),getParam(d.SummaDiscount+"",e,"fines.summDiscount",null,null,parseBalance),getParam(d.DateDecis+"",e,"fines.date",null,null,parseDateGibdd),getParam(d.DateDiscount+"",e,"fines.dateDiscount",null,null,parseDateGibdd),getParam(d.DatePost+"",e,"fines.datePost",null,null,parseDateGibdd),getParam(d.KoAPcode,e,"fines.koap"),getParam(d.KoAPtext.toUpperCase().substring(0,1)+d.KoAPtext.toLowerCase().substring(1),
e,"fines.descr"),getParam(d.NumPost,e,"fines.postanovlenie"),getParam(a.divisions[d.Division].name,e,"fines.podrazdel"));b.fines.push(e);sumParam(d.Summa+"",b,"balance",null,null,parseBalance,aggregate_sum)}getParam(a.data.length,b,"count")}else b.descr="Штрафов нет.",b.count=0}
function parseDateGibdd(b){var a=/(\d{4})\D(\d{2})\D(\d{2})(?:\D(\d{1,2}):(\d{1,2}):(\d{1,2}))?/.exec(b);if(a){var a=new Date(a[1],a[2]-1,+a[3],a[4]||0,a[5]||0,a[6]||0),c=a.getTime();AnyBalance.trace("Parsing date "+a+" from value: "+b);return c}AnyBalance.trace("Failed to parse date from value: "+b)};
