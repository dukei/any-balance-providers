var baseurl="https://www.ibank.belapb.by/v1/cgi/bsi.dll?";function login(){var b=loginBSS(baseurl),a=AnyBalance.requestPost(baseurl,{SID:g_bss_sessionId,tic:1,T:"RT_2IC.form",nvgt:1,SCHEMENAME:"WORKSPACE"},g_headers);return{info:b,html:a}}
function processCards(b,a){if(AnyBalance.isAvailable("cards")){var c=getParam(b.html,null,null,/PCards#([^#]*)/i,replaceTagsAndSpaces),d=AnyBalance.requestPost(baseurl,{SID:g_bss_sessionId,T:"RT_2Plugin.plugin",SchemeName:"PCards",PluginID:c,TemplateName:"simple"},g_headers),c=getElements(d,/<li[^>]+class="page_widget_inner"[^>]*>/ig);AnyBalance.trace("Найдено потенциальных карт: "+c.length);if(0==c.length||1==c.length&&/Карты отсутствуют/i.test(d))/Карты отсутствуют/i.test(d)?(AnyBalance.trace("Активные карты отсутствуют"),
a.cards=[]):(AnyBalance.trace(d),AnyBalance.trace("Не удалось найти таблицу с картами."));else for(a.cards=[],d=0;d<c.length;++d){var e=c[d],f=getParam(e,null,null,/ToSTM\(\'([^']*)/i,replaceHtmlEntities),h=getParam(e,null,null,/ToSTM\(\'[^']*','([^']*)/i,replaceHtmlEntities),k=getParam(e,null,null,/<a[^>]+ToSTM[^>]*>([\s\S]*?)<\/a>/i,replaceTagsAndSpaces),f={__id:h,__name:k,num:h,accnum:f};__shouldProcess("cards",f)&&processCard(e,f);a.cards.push(f)}}}
function getCardBalance(b,a){if(AnyBalance.isAvailable("cards.balance"))try{var c=getParam(b,null,null,/GetRest\(([^)]*)/,null,html_entity_decode);if(!c)throw AnyBalance.trace("Card row: "+b),new AnyBalance.Error("Не удаётся найти ссылку на обновление баланса. Сайт изменен?");var d=getParam(c,null,null,/,\s*"([^"]*)/i,replaceSlashes),e=getParam(c,null,null,/,[^,]*,([^,]*)/i,parseBalance);if(!d||!e)throw AnyBalance.trace("Card row: "+b),new AnyBalance.Error("Не удаётся найти идентификатор карты и валюты. Сайт изменен?");
html=AnyBalance.requestPost(baseurl,{SID:g_bss_sessionId,tic:1,T:"RT_2CardRest.doOperation",TIC:1,OPER:"GETREST",CARD:d,CURR:e,SCHEMENAME:"WORKSPACE"},g_headers);getParam(html,a,"cards.balance",/RST="([^"]*)/i,replaceTagsAndSpaces,parseBalance)}catch(f){AnyBalance.trace("Получение баланса не удалось: "+f.message)}}function getCardInfo(b){for(var a=getCardsInfo(),c=0;c<a.length;++c){var d=a[c];if(d.__id==b)return d}}
function getCardsInfo(){if(isset(getCardsInfo.info))return getCardsInfo.info;html=AnyBalance.requestPost(baseurl,{SID:g_bss_sessionId,tic:1,T:"RT_2IC.SC",ngvt:1,SCHEMENAME:"CARDSCARD",FILTERIDENT:"ALL"},g_headers);var b=getCardsInfo.info=[],a=getElement(html,/<table[^>]+ID="SCROLLER"[^>]*>/i);if(a)return/<THEAD>\s*<TR/i.test(a)||(a=replaceAll(a,[/<THEAD>/i,"<THEAD><TR>",/<\/THEAD>/i,"</TR></THEAD>"])),processTable(a,b,"cards.",{type:{re:/Тип карт/i,result_func:null},__id:{re:/номер карт/i,result_func:null},
main:{re:/осн[^<]*?доп/i,result_func:function(a){return/осн/i.test(a)}},holder:{re:/Держатель/i,result_func:null},status:{re:/Статус/i,result_func:null},till:{re:/Срок действия/i,result_func:parseDate}}),b;(b=getParam(html,null,null,/<BSS_ERROR>([\s\S]*?)<\/BSS_ERROR>/i,replaceTagsAndSpaces))?AnyBalance.trace("Не удалось получить список карт: "+b):(AnyBalance.trace(html),AnyBalance.trace("Не удалось найти таблицу карт!"))}
function processCard(b,a){getParam(b,a,"cards.limit",/Лимит овердрафта:([^<]*)/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"cards.balance_min",/Неснижаемый остаток:([^<]*)/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,["cards.currency","cards.balance","cards.limit","cards.balance_min"],/RESTISO="\s*([^"]*)/i,replaceHtmlEntities);getCardBalance(b,a);var c=getCardInfo(a.__id);if(c)for(var d in c)a[d]=c[d];else AnyBalance.trace("Доп. параметры не найдены для карты "+a.__name);AnyBalance.isAvailable("cards.transactions")&&
processCardTransactions(b,a)}
function processDeposits(b,a){if(AnyBalance.isAvailable("deposits")){b=AnyBalance.requestPost(baseurl,{SID:g_bss_sessionId,tic:1,T:"RT_2IC.form",ngvt:1,SCHEMENAME:"STM",XACTION:"NEW"},g_headers);var c=getElement(b,/<table[^>]+ID="SCROLLER"[^>]*>/i);if(c){var d={type:{re:/Наименование вклада/i,result_func:null},num:{re:/номер договора/i,result_func:null},balance:{re:/Остаток/i},currency:{re:/Валюта/i,result_func:null},till:{re:/Дата[^<]+окончания/i,result_func:parseDate}},e=getElement(c,/<THEAD[^>]*>/i),
c=getElement(c,/<TBODY[^>]*>/i),e=getElements(e,/<th\b[^>]*>/ig),e=initCols(d,e),c=getElements(c,/<tr[^>]*>/ig);AnyBalance.trace("Найдено "+c.length+" депозитов");a.deposits=[];for(var f=0;f<c.length;++f){var h=c[f],k=getElements(h,/<td[^>]*>/ig),g=getParam(h,null,null,/<input[^>]+STM="([^"]*)/i,replaceHtmlEntities),m=getParam(k[e.type],null,null,null,replaceTagsAndSpaces),l=getParam(k[e.num],null,null,null,replaceTagsAndSpaces),g={__id:g,__name:m+" ("+l.substr(-4)+")",num:l};fillColsResult(d,e,k,
g,"deposits.");__shouldProcess("deposits",g)&&processDeposit(h,g);a.deposits.push(g)}}else(d=getParam(b,null,null,/<BSS_ERROR>([\s\S]*?)<\/BSS_ERROR>/i,replaceTagsAndSpaces))?AnyBalance.trace("Не удалось получить список депозитов: "+d):/У Вас нет открытых счетов/i.test(b)?AnyBalance.trace("У вас нет счетов и депозитов"):(AnyBalance.trace(b),AnyBalance.trace("Не удалось найти таблицу депозитов!"))}}function processDeposit(b,a){isAvailable("deposits.transactions")&&processDepositTransactions(b,a)}
function processCredits(b,a){if(AnyBalance.isAvailable("credits")){html=AnyBalance.requestPost(baseurl,{SID:g_bss_sessionId,tic:1,T:"RT_2IC.SC",ngvt:1,SCHEMENAME:"CREDITS",FILTERIDENT:"NEW"},g_headers);var c=getElement(html,/<table[^>]+ID="SCROLLER"[^>]*>/i);if(!c){var d=getParam(html,null,null,/<BSS_ERROR>([\s\S]*?)<\/BSS_ERROR>/i,replaceTagsAndSpaces);d?AnyBalance.trace("Не удалось получить список кредитов: "+d):(AnyBalance.trace(html),AnyBalance.trace("Не удалось найти таблицу кредитов!"));return cards}var d=
{type:{re:/Тип кредита/i,result_func:null},num:{re:/номер договора/i,result_func:null},currency:{re:/Валюта/i,result_func:null},date_start:{re:/Дата заключения/i,result_func:parseDate},till:{re:/Дата[^<]+окончания/i,result_func:parseDate}},e=getElement(c,/<THEAD[^>]*>/i),c=getElement(c,/<TBODY[^>]*>/i),e=getElements(e,/<th\b[^>]*>/ig),e=initCols(d,e),c=getElements(c,/<tr[^>]*>/ig);AnyBalance.trace("Найдено "+c.length+" кредитов");a.credits=[];for(var f=0;f<c.length;++f){var h=c[f],k=getElements(h,
/<td[^>]*>/ig),g=getParam(h,null,null,/SIDR="([^"]*)/i,replaceHtmlEntities),m=getParam(k[e.type],null,null,null,replaceTagsAndSpaces),l=getParam(k[e.num],null,null,null,replaceTagsAndSpaces),g={__id:g,__name:m+" ("+l.substr(-4)+")",num:l};fillColsResult(d,e,k,g,"credits.");__shouldProcess("credits",g)&&processCredit(h,g);a.credits.push(g)}}}
function processCredit(b,a){AnyBalance.trace("Обработка кредита "+a.__name);AnyBalance.isAvailable("credits.fio","credits.address","credits.balance","credits.minpay_debt","credits.minpay_pct","credits.minpay_future","credits.minpay")&&(b=AnyBalance.requestPost(baseurl,{SID:g_bss_sessionId,tic:1,T:"RT_2IC.view",SCHEMENAME:"CREDITS",IDR:a.__id,FORMACTION:"VIEW",TERMINALID:""},g_headers),getParam(b,a,"credits.fio",/Кредитополучатель[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces),getParam(b,
a,"credits.address",/Адрес кредитополучателя[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces),getParam(b,a,"credits.balance",/Остаток по кредиту[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),getParam(b,a,"credits.minpay_debt",/Погашение основного долга[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),getParam(b,a,"credits.minpay_pct",/Погашение начисленных процентов[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),getParam(b,
a,"credits.minpay_future",/Погашение платежей будущих периодов[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),sumParam(b,a,"credits.minpay",/Погашение основного долга[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance,aggregate_sum),sumParam(b,a,"credits.minpay",/Погашение начисленных процентов[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance,aggregate_sum));AnyBalance.isAvailable("credits.transactions")&&processCreditTransactions(b,a)}
function processInfo(b,a){AnyBalance.isAvailable("info")&&(a.info={},getParam(b.info.CNS,a.info,"info.fio"))};
