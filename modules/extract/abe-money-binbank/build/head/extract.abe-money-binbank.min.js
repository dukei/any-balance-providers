var baseurl="https://i.binbank.ru/",baseurlAPI=baseurl+"api/v1/",g_headers={Connection:"keep-alive","Cache-Control":"max-age=0","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8","Accept-Language":"ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7"},g_api_headers={Connection:"keep-alive",Accept:"application/json, text/plain, */*","X-Application-Code":"INTERNET",
Referer:baseurl+"login"};
function apiCall(b,a,c){var d=addHeaders(g_api_headers),e="GET";a&&(e="POST",d=addHeaders({"Content-Type":"application/json;charset=UTF-8"},d));c&&(d=addHeaders(c,d));b=AnyBalance.requestPost(joinUrl(baseurlAPI,b),a?JSON.stringify(a):"",d,{HTTP_METHOD:e});if(!b)throw new AnyBalance.Error("Не удалось получить ответ от сервера. Ошибка при компоновке запроса, проверьте заголовок Authorization!");a=getJson(b);if("required_confirmation"===a.code)return a;if(a.code)throw AnyBalance.trace(b),new AnyBalance.Error(a.message,
{code:a.code,fatal:"invalid_login"===a.code});return a}function isLoggedIn(){try{return apiCall("client"),!0}catch(b){if("unauthorized"===b.code)return!1;throw b;}}
function login(){var b=AnyBalance.getPreferences();AnyBalance.setOptions({SSL_ENABLED_PROTOCOLS:["TLSv1.1","TLSv1.2"]});AnyBalance.setDefaultCharset("utf-8");checkEmpty(b.login,"Введите логин!");checkEmpty(b.password,"Введите пароль!");if(isLoggedIn())AnyBalance.trace("Используем существующую сессию");else{var a=AnyBalance.requestGet(baseurl+"login",g_headers);if(!a||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(a),new AnyBalance.Error("Ошибка при подключении к сайту провайдера! Попробуйте обновить данные позже.");
a=apiCall("auth/login",{login:b.login,password:b.password,channel:"internet",gsm:!0,device_id:"test"});if(!a.permissions){if("required_confirmation"!=a.code)throw AnyBalance.trace(JSON.stringify(a)),new AnyBalance.Error("Не удалось войти. Сайт изменен?");var c=AnyBalance.retrieveCode("Пожалуйста, введите код для входа в интернет банк, который пришел Вам в СМС. Если Вы не желаете получать запрос на СМС каждый раз, зайдите в интернет банк через браузер и отключите посылку СМС при входе в Настройках Профиля",
null,{inputType:"number",time:12E4}),a=apiCall("auth/login",{login:b.login,password:b.password,channel:"internet",gsm:!0,device_id:"test"},{"X-Confirmation-Code":c,"X-Confirmation-Type":"sms","X-Validation-Token":a.validation_token})}if(!a.permissions)throw AnyBalance.trace(JSON.stringify(a)),new AnyBalance.Error("Не удалось войти... Сайт изменен?");__setLoginSuccessful()}return a}
function processInfo(b){if(AnyBalance.isAvailable("info")){var a=apiCall("client");b=b.info={};getParam(a.addresses[0].full_address,b,"info.address",null,replaceTagsAndSpaces);getParam(a.birth_date,b,"info.birthday",null,null,parseDateISO);getParam(a.last_name+" "+a.first_name+" "+a.middle_name,b,"info.name",null,replaceTagsAndSpaces)}}
function getProducts(){if(getProducts.products)return getProducts.products;getProducts.products=apiCall("/api/v1_1/products?$expand=intents&ext_product_groups=external_cards");return getProducts.products}function processAccounts(b){throw new AnyBalance.Error("Не удаётся получить счета. Сайт изменен?");}
function processAccount(b,a){AnyBalance.trace("Обработка счета "+a.__name);getParam(b.rest+"",a,"accounts.balance",null,replaceTagsAndSpaces,parseBalance);getParam(currencys[b.currency],a,["accounts.currency","accounts.balance"]);getParam(b.number,a,"accounts.accnum",null,replaceTagsAndSpaces);getParam(b.type,a,"accounts.type",null,replaceTagsAndSpaces);getParam(states[b.state],a,"accounts.status");AnyBalance.isAvailable("accounts.transactions")&&processAccountTransactions(b,a)}
function processCards(b){var a=getProducts(),c=a.filter(function(a){return"card"===a.product_type});if(c.length)for(AnyBalance.trace("Найдено карт: "+c.length),b.cards=[],a=0;a<c.length;++a){var d=c[a].id,e=c[a].name+" "+c[a].number.substr(-4),d={__id:d,__name:e,num:c[a].number};__shouldProcess("cards",d)&&processCard(c[a],d);b.cards.push(d)}else AnyBalance.trace(JSON.stringify(a)),AnyBalance.trace("Карты не найдены.")}
function processCard(b,a){AnyBalance.trace("Обработка карты "+a.__name);getParam(b.available_amount.amount,a,"cards.balance");getParam(b.available_amount.currency,a,["cards.currency","cards.balance","cards.blocked"]);getParam(b.blocked_amount.amount,a,"cards.blocked");getParam(b.requisites.account_number,a,"cards.accnum",null,replaceTagsAndSpaces);getParam(b.name,a,"cards.type",null,replaceTagsAndSpaces);getParam(b.expire_date,a,"cards.till",null,replaceTagsAndSpaces,parseDateISO);getParam(b.holder,
a,"cards.fio",null,replaceTagsAndSpaces);getParam(b.state_details,a,"cards.status");getParam(jspath1(b,"$.bonus_cards[?(@.type='airmiles')].money_amount.amount"),a,"cards.airmiles");isAvailable("cards.transactions")&&processCardTransactions(b,a)}function processDeposits(b){throw new AnyBalance.Error("Не удаётся получить депозиты. Сайт изменен?");}
function processDeposit(b,a){AnyBalance.trace("Обработка депозита "+a.__name);getParam(b.rest+"",a,"deposits.balance",null,replaceTagsAndSpaces,parseBalance);getParam(currencys[b.currency],a,["deposits.currency","deposits.balance"]);getParam(b.number,a,"deposits.accnum",null,replaceTagsAndSpaces);getParam(b.type,a,"deposits.type",null,replaceTagsAndSpaces);getParam(b.closed,a,"deposits.till",null,replaceTagsAndSpaces,parseDate);getParam(states[b.state],a,"deposits.status");getParam(b.contract,a,"deposits.contract",
null,replaceTagsAndSpaces);getParam(b.rate+"",a,"deposits.rate",null,replaceTagsAndSpaces,parseBalance);isAvailable("deposits.transactions")&&processDepositTransactions(b,a)}function processCredits(b){throw new AnyBalance.Error("Обработка кредитов пока не поддерживается. Пожалуйста, обратитесь к обработчикам");};
