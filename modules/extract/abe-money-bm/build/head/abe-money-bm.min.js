var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/29.0.1547.76 Safari/537.36"},g_baseurls={Bashko:"https://online.bm.ru",Habar:"https://khb-online.mmbank.ru",Hanti:"https://ekburg-online.mmbank.ru",Irkut:"https://nsk-online.mmbank.ru",Kalin:"https://spb-online.mmbank.ru",
Kemer:"https://nsk-online.mmbank.ru",Krasn:"https://nsk-online.mmbank.ru",Kursk:"https://online.bm.ru",Moskv:"https://online.bm.ru",Nizheg:"https://nnov-online.mmbank.ru",Novos:"https://nsk-online.mmbank.ru",Omska:"https://nsk-online.mmbank.ru",Orenb:"https://nnov-online.mmbank.ru",Perms:"https://nnov-online.mmbank.ru",Primo:"https://khb-online.mmbank.ru",Rosto:"https://online.bm.ru",Sahal:"https://khb-online.mmbank.ru",Samar:"https://nnov-online.mmbank.ru",Sankt:"https://spb-online.mmbank.ru",Sever:"https://online.bm.ru",
Stavr:"https://online.bm.ru",Sverd:"https://ekburg-online.mmbank.ru",Tatar:"https://online.bm.ru",Tul_s:"https://online.bm.ru",Tyumen:"https://ekburg-online.mmbank.ru",Volgo:"https://online.bm.ru",Voron:"https://online.bm.ru",Yamalo:"https://ekburg-online.mmbank.ru",Yarosl:"https://online.bm.ru",adige:"https://krasnodar-online.mmbank.ru"},g_baseurl="https://online.bm.ru";function isLoggedIn(a){return/logout/i.test(a)}
function hasCaptcha(a){return/<span[^>]id="[^"]*:captchaBlock"(?:[^>](?!display:\s*none))*>/i.test(a)}
function tryLogin(a){var b=AnyBalance.getPreferences(),c=getCaptcha(a),d=getElement(a,/<form[^>]*loginForm[^>]*>/i);if(!d)throw AnyBalance.trace(a),new AnyBalance.Error("Не удаётся найти форму входа. Сайт изменен?");a=createFormParams(d,function(a,e,d,f){return/:login$/i.test(d)?b.login:/:password$/i.test(d)?b.password:/:saveLogin$/i.test(d)?void 0:/:captchaText$/i.test(d)?c:f});var f=getParam(d,null,null,/<input[^>]+id="[^"]*:saveLogin"[^>]*>/i),e=getParam(f,null,null,/input[^>]+id="([^"]*)/i),f=
getParam(f,null,null,/render:\\?'([^'\\]*)/);a=joinObjects(a,{"javax.faces.behavior.event":"action","javax.faces.partial.event":"click","javax.faces.source":e,"javax.faces.partial.ajax":"true","javax.faces.partial.execute":e,"javax.faces.partial.render":f});a[e]=e;d=getParam(d,null,null,/<form[^>]+action="([^"]*)/i);AnyBalance.requestPost(g_baseurl+d,a,addHeaders({Origin:g_baseurl,Referer:g_baseurl+"/scoring/protected/welcome.jsf","Faces-Request":"partial/ajax"}));return a=AnyBalance.requestPost(g_baseurl+
"/scoring/j_security_check",{j_username:b.login,j_password:b.password,locale:"ru",captcha:c},addHeaders({Origin:g_baseurl,Referer:g_baseurl+"/scoring/protected/welcome.jsf"}))}function findErrors(a){return getElements(a,/<(?:[^>](?!display:\s*none))+class="error"(?:[^>](?!display:\s*none))*>/ig,replaceTagsAndSpaces).join("\n")}
function getCaptcha(a){var b="";hasCaptcha(a)&&(b=getParam(a,null,null,/<img[^>]+id="[^"]*:jcaptcha"[^>]*src="([^"]*)/i)||"");b&&(AnyBalance.trace("Надо капчу вводить..."),a=AnyBalance.requestGet(g_baseurl+b,g_headers),b=AnyBalance.retrieveCode("Пожалуйста, введите код с картинки",a));return b}
function checkForPasswordChange(a){if(!getElements(a,[/<form[^>]*>/ig,/<div[^>]+changePasswordBox/i])[0])return a;throw new AnyBalance.Error("Банк требует изменить параметры безопасности. Пожалуйста, войдите в интернет-банк "+g_baseurl+" через браузер, выполните требования банка, затем введите логин и новый пароль в настройки провайдера.",null,!0);}
function login(){var a=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("windows-1251");checkEmpty(a.login,"Введите логин!");checkEmpty(a.password,"Введите пароль!");a.region&&g_baseurls[a.region]||(a.region="Moskv");g_baseurl=g_baseurls[a.region];AnyBalance.trace("Region is "+a.region+": "+g_baseurl);var b=AnyBalance.requestGet(g_baseurl+"/scoring/protected/welcome.jsf",g_headers);if(isLoggedIn(b))return b=checkForPasswordChange(b);a=hasCaptcha(b);b=tryLogin(b);if(isLoggedIn(b))return b;
form=getElements(b,[/<form[^>]+submitForm[^>]*>/ig,/<input[^>]+name="otp_type"/i])[0];if(!form&&hasCaptcha(b)&&!a){tryLogin(b);if(isLoggedIn(b))return b=checkForPasswordChange(b);form=getElements(b,[/<form[^>]+submitForm[^>]*>/ig,/<input[^>]+name="otp_type"/i])[0]}if(!form){if(a=findErrors(b))throw new AnyBalance.Error(a,null,/Неверно указаны данные для входа/i);AnyBalance.trace(b);throw new AnyBalance.Error("Не удалось войти в интернет-банк. Сайт изменен?");}var a=getParam(form,null,null,/<input[^>]+name="otp_type"[^>]*value+"([^"]*)/i),
a=getParam(b,null,null,new RegExp('<span[^>]+id="otp_type_'+a+'"[^>]*confirmType[^>]*>([\\s\\S]*?)</span>',"i"),replaceTagsAndSpaces),c=AnyBalance.requestPost(g_baseurl+"/scoring/smsPasswordLoginAjaxServlet",{smsSentTime:(new Date).getTime()},addHeaders({Origin:g_baseurl,Referer:g_baseurl+"/scoring/j_security_check","X-Requested-With":"XMLHttpRequest"})),d=AnyBalance.retrieveCode(a||"Введите код подтверждения входа"),a=createFormParams(form,function(a,e,g,h){return"otp"==g?d:"captcha"==g?getCaptcha(b):
"session_id"==g?c:h}),b=AnyBalance.requestPost(g_baseurl+"/scoring/j_security_check",a,addHeaders({Origin:g_baseurl,Referer:g_baseurl+"/scoring/protected/welcome.jsf"}));if(!/logout/i.test(b)){if(a=findErrors(b))throw new AnyBalance.Error(a);AnyBalance.trace(b);throw AnyBalance.Error("Не удалось войти в интернет банк. Сайт изменен?");}return b=checkForPasswordChange(b)}
function processCards(a,b){if(AnyBalance.isAvailable("cards")){AnyBalance.trace("Читаем карты");var c=getElement(a,/<div[^>]+class="cardsBlock"[^>]*>/i);if(c){c=getElements(c,/<div[^>]+productShort[^>]*>/ig);AnyBalance.trace("Найдено "+c.length+" карт");b.cards=[];for(var d=0;d<c.length;++d){var f=c[d],e=getParam(f,null,null,/statement\/card\/(\d+)/i),g=getParam(f,null,null,/<td[^>]*>\s*<span[^>]*>[^<]*<\/span>\s*<span[^>]*>[^<]*\d{4}\s*<\/span>\s*<\/td>/i),h=getParam(g,null,null,null,[replaceTagsAndSpaces,
/\*[*\s]+\*/g,"*"]),k=getParam(f,null,null,/[\*\d]{4}\s+[\*\d]{4}\s+[\*\d]{4}\s+\d{4}/i,replaceTagsAndSpaces),e={__id:e,__name:h,num:k};__shouldProcess("cards",e)&&(getParam(g,e,"cards.type",/<span[^>]*>([^<]*)<\/span>/i,replaceTagsAndSpaces),processCard(f,e));b.cards.push(e)}}else AnyBalance.trace(a),AnyBalance.trace("Не удалось найти блок карт. Карты отсутствуют?")}}
function processInfo(a,b){if(AnyBalance.isAvailable("info")){b.info={};var c=AnyBalance.getPreferences();getParam(a,b.info,"info.fio",/<div[^>]*class="clientName"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(c.login,b.info,"info.login")}}
function processCard(a,b){AnyBalance.trace("Обрабатываем карту "+b.__name);getParam(a,b,"cards.balance",/<span[^>]+amountBox[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"cards.currency",/<span[^>]+amountBox[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseCurrency);getParam(a,b,"cards.name",/<div[^>]+aliasBox[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);if(AnyBalance.isAvailable("cards.late","cards.minpay","cards.debt","cards.gracepay","cards.gracepay_till","cards.limit",
"cards.blocked","cards.sms","cards.till","cards.transactions")){a=AnyBalance.requestGet(g_baseurl+"/scoring/protected/statement/card/"+b.__id,g_headers);var c=getElement(a,/<table[^>]+bigCardShadow[^>]*>/i,replaceHtmlEntities);getParam(c,b,"cards.late",/Просроченная задолженность:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"cards.minpay",/Минимальный платеж:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"cards.debt",
/Всего задолженность:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"cards.blocked",/Заблокировано:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"cards.sms",/Подключено SMS-информирование на номера:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces);getParam(c,b,"cards.till",/Действительна до:([^<]*)/i,replaceTagsAndSpaces,parseDate);getParam(c,b,"cards.limit",/Кредитный лимит:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,
replaceTagsAndSpaces,parseBalance);getParam(c,b,"cards.gracepay",/Сумма платежа в льготном периоде:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"cards.gracepay_till",/Сумма платежа в льготном периоде:[\s\S]*?<span[^>]*>\s*до([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseDate);AnyBalance.isAvailable("cards.transactions")&&processCardTransactions(a,b)}}
function processAccounts(a,b){if(AnyBalance.isAvailable("accounts")){AnyBalance.trace("Читаем счета");var c=getElements(a,[/<div[^>]+class="productShort[^>]*>/i,/statement\/account\/./i])[0];if(c){c=getElements(c,/<div[^>]+productShort[^>]*>/ig);AnyBalance.trace("Найдено "+c.length+" счетов");b.accounts=[];for(var d=0;d<c.length;++d){var f=c[d],e=getParam(f,null,null,/statement\/account\/(\d+)/i),g=getParam(f,null,null,/(?:\d(?:\s+|&nbsp;|&#160;)*){20}/i,replaceTagsAndSpaces),e={__id:e,__name:g,num:g.replace(/\s+/g,
"")};__shouldProcess("accounts",e)&&processAccount(f,e);b.accounts.push(e)}}else AnyBalance.trace(a),AnyBalance.trace("Не удалось найти блок счетов. счета отсутствуют?")}}
function processAccount(a,b){AnyBalance.trace("Обрабатываем счет "+b.__name);getParam(a,b,"accounts.balance",/<span[^>]+amountBox[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"accounts.currency",/<span[^>]+amountBox[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseCurrency);getParam(a,b,"accounts.name",/<div[^>]+aliasBox[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);if(AnyBalance.isAvailable("accounts.date_start","accounts.contract")){a=AnyBalance.requestGet(g_baseurl+
"/scoring/protected/statement/account/"+b.__id,g_headers);var c=getElement(a,/<table[^>]+productFull[^>]*>/i,replaceHtmlEntities);getParam(c,b,"accounts.date_start",/Дата открытия счета:([^<]*)/i,replaceTagsAndSpaces,parseDate);getParam(c,b,"accounts.contract",/Номер договора:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces);AnyBalance.isAvailable("accounts.transactions")&&processAccountTransactions(a,b)}}
function getViewState(a){return getParam(a,null,null,/<input[^>]+name="javax.faces.ViewState"[^>]*value="([^"]*)/i)}
function transliterate(a){var b="",c={"Ё":"YO","Й":"I","Ц":"TS","У":"U","К":"K","Е":"E","Н":"N","Г":"G","Ш":"SH","Щ":"SCH","З":"Z","Х":"H","Ъ":"_","ё":"yo","й":"i","ц":"ts","у":"u","к":"k","е":"e","н":"n","г":"g","ш":"sh","щ":"sch","з":"z","х":"h","ъ":"_","Ф":"F","Ы":"I","В":"V","А":"a","П":"P","Р":"R","О":"O","Л":"L","Д":"D","Ж":"ZH","Э":"E","ф":"f","ы":"i","в":"v","а":"a","п":"p","р":"r","о":"o","л":"l","д":"d","ж":"zh","э":"e","Я":"Ya","Ч":"CH","С":"S","М":"M","И":"I","Т":"T","Ь":"_","Б":"B","Ю":"YU",
"я":"ya","ч":"ch","с":"s","м":"m","и":"i","т":"t","ь":"_","б":"b","ю":"yu"};for(i=0;i<a.length;++i)b+=void 0===c[a[i]]?a[i]:c[a[i]];return b}
function extractRegions(){for(var a=AnyBalance.requestGet(g_baseurl+"/private/web.jsf"),a=getElement(a,/<select[^>]+id="region"[^>]*>/i),a=getElements(a,/<option[^>]*>/ig),b=[],c=[],d={},f=0;f<a.length;++f){var e=getParam(a[f],null,null,null,replaceTagsAndSpaces),g=replaceAll(e,[/Республика\s*/i,"",/\s+.*$/,""]).substr(0,5),g=transliterate(g),h=getParam(a[f],null,null,/<option[^>]+value="([^"]*)/i);d[g]=h;b.push(e);c.push(g)}AnyBalance.setResult({success:!0,valsite:d,names:b.join("|"),values:c.join("|")})}
;
