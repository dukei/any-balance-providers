var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/29.0.1547.76 Safari/537.36"},g_baseurl="https://online.bm.ru";function isLoggedIn(a){return/logout/i.test(a)}
function hasCaptcha(a){return/<span[^>]id="[^"]*:captchaBlock"(?:[^>](?!display:\s*none))*>/i.test(a)}
function tryLogin(a){var b=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");var c=getCaptcha(a),e=getElement(a,/<form[^>]*loginForm[^>]*>/i);if(!e){var d=getElement(a,/<div[^>]+id="mainContent"[^>]*>/i,replaceTagsAndSpaces);if(d&&255>d.length)throw new AnyBalance.Error(d);AnyBalance.trace(a);throw new AnyBalance.Error("Не удаётся найти форму входа. Сайт изменен?");}var d=createFormParams(e,function(a,d,e,f){if(/:login$/i.test(e))return b.login;if(/:password$/i.test(e))return b.password;
if(!/:saveLogin$/i.test(e))return/:captchaText$/i.test(e)?c:f}),f=getParam(e,null,null,/<input[^>]+id="[^"]*:loginBtn"[^>]*>/i),g=getParam(f,null,null,/<input[^>]+id="([^"]*)/i,replaceHtmlEntities),h=getParam(f,null,null,/execute:\\?'([^'\\]*)/i),f=getParam(f,null,null,/render:\\?'([^'\\]*)/),k=getParam(e,null,null,/<form[^>]+id="([^"]*)/i,replaceHtmlEntities),d=joinObjects(d,{"javax.faces.behavior.event":"action","javax.faces.partial.event":"click","javax.faces.source":g,"javax.faces.partial.ajax":"true",
"javax.faces.partial.execute":h,"javax.faces.partial.render":f});d[k]=k;e=getParam(e,null,null,/<form[^>]+action="([^"]*)/i);d=AnyBalance.requestPost(g_baseurl+e,d,addHeaders({Origin:g_baseurl,Referer:g_baseurl+"/scoring/protected/welcome.jsf","Faces-Request":"partial/ajax"}));d=getParam(d,null,null,/<message[^>]*>([\s\S]*?)<\/message>/i,null,getJson);if(d.showCaptcha&&!c)return AnyBalance.trace("Потребовался ввод капчи"),a.replace(/(captchaBlock"[^>]*)display:\s*none/i,"$1display:block");if(d.error)throw new AnyBalance.Error({incorrectCaptcha:"Неверно введены символы с картинки"}[d.error]||
d.error);e=getElement(a,/<form[^>]+j_security_check[^>]*>/i);if(!e)throw AnyBalance.trace(a),new AnyBalance.Error("Не удаётся найти форму передачи логина-пароля. Сайт изменен?");d=createFormParams(e,function(a,d,e,f){return/username/i.test(e)?b.login:/password/i.test(e)?b.password:/captcha/i.test(e)?c||"":f});return a=AnyBalance.requestPost(g_baseurl+"/scoring/j_security_check",d,addHeaders({Origin:g_baseurl,Referer:g_baseurl+"/scoring/protected/welcome.jsf"}))}
function findErrors(a){return getElements(a,/<(?:[^>](?!display:\s*none))+class="error"(?:[^>](?!display:\s*none))*>/ig,replaceTagsAndSpaces).join("\n")}function getCaptcha(a){var b="";hasCaptcha(a)&&(b=getParam(a,null,null,/<img[^>]+id="[^"]*:jcaptcha"[^>]*src="([^"]*)/i)||"");b&&(AnyBalance.trace("Надо капчу вводить..."),a=AnyBalance.requestGet(g_baseurl+b,g_headers),b=AnyBalance.retrieveCode("Пожалуйста, введите код с картинки",a));return b}
function checkForPasswordChange(a){if(!getElements(a,[/<form[^>]*>/ig,/<div[^>]+changePasswordBox/i])[0])return a;throw new AnyBalance.Error("Банк требует изменить параметры безопасности. Пожалуйста, войдите в интернет-банк "+g_baseurl+" через браузер, выполните требования банка, затем введите логин и новый пароль в настройки провайдера.",null,!0);}
function redirectIfNeeded(a){if(300<=AnyBalance.getLastStatusCode()){var b=getParam(a,null,null,/location.href\s*=\s*['"]([^'"]*)/);if(b)return AnyBalance.trace("redirect: "+b),a=joinUrl(g_baseurl,b),AnyBalance.requestGet(a,g_headers)}return a}
function login(){var a=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("windows-1251");checkEmpty(a.login,"Введите логин!");checkEmpty(a.password,"Введите пароль!");AnyBalance.trace("Region is "+a.region+": "+g_baseurl);var b=AnyBalance.requestGet(g_baseurl+"/scoring/protected/welcome.jsf",g_headers),b=redirectIfNeeded(b);if(isLoggedIn(b))return b=checkForPasswordChange(b);a=hasCaptcha(b);b=tryLogin(b);if(isLoggedIn(b))return b;form=getElements(b,[/<form[^>]+(?:login|submitForm)[^>]*>/ig,
/<input[^>]+name="otp_type"/i])[0];if(!form&&hasCaptcha(b)&&!a){b=tryLogin(b);if(isLoggedIn(b))return b=checkForPasswordChange(b);form=getElements(b,[/<form[^>]+(?:login|submitForm)[^>]*>/ig,/<input[^>]+name="otp_type"/i])[0]}if(!form){if(a=findErrors(b))throw new AnyBalance.Error(a,null,/Неверно указаны данные для входа/i.test(a));AnyBalance.trace(b);throw new AnyBalance.Error("Не удалось войти в интернет-банк. Сайт изменен?");}var c=getParam(form,null,null,/<input[^>]+name="otp_type"[^>]*value+"([^"]*)/i),
a=getElements(form,/<[^>]+id="(?:smsWasSentText|labelShortPassword)"/ig,replaceTagsAndSpaces).join(". "),e=AnyBalance.requestPost(g_baseurl+"/scoring/smsPasswordLoginAjaxServlet",{smsSentTime:(new Date).getTime()},addHeaders({Origin:g_baseurl,Referer:g_baseurl+"/scoring/j_security_check","X-Requested-With":"XMLHttpRequest"})),d=AnyBalance.retrieveCode(a||"Введите код подтверждения входа",null,{inputType:"number"}),a=createFormParams(form,function(a,g,h,k){return"otp"==h||"otp_type_"+c+"_input"==h?
d:"captcha"==h?getCaptcha(b):"session_id"==h?e:k}),b=AnyBalance.requestPost(g_baseurl+"/scoring/j_security_check",a,addHeaders({Origin:g_baseurl,Referer:g_baseurl+"/scoring/protected/welcome.jsf"}));if(!/logout/i.test(b)){if(a=findErrors(b))throw new AnyBalance.Error(a);AnyBalance.trace(b);throw AnyBalance.Error("Не удалось войти в интернет банк. Сайт изменен?");}return b=checkForPasswordChange(b)}
function processCards(a,b){if(AnyBalance.isAvailable("cards")){AnyBalance.trace("Читаем карты");var c=getElements(a,/<div[^>]+class="cardsBlock"[^>]*>/ig);if(0==c.length)AnyBalance.trace(a),AnyBalance.trace("Не удалось найти блок карт. Карты отсутствуют?");else{a=[];for(var e=0;e<c.length;++e)a=a.concat(getElements(c[e],/<div[^>]+productShort[^>]*>/ig));AnyBalance.trace("Найдено "+a.length+" карт");b.cards=[];for(e=0;e<a.length;++e){var c=a[e],d=getParam(c,null,null,/statement\/card\/(\d+)/i),f=getParam(c,
null,null,/<td[^>]*>\s*<span[^>]*>[^<]*<\/span>\s*<span[^>]*>[^<]*\d{4}\s*<\/span>\s*<\/td>/i),g=getParam(f,null,null,null,[replaceTagsAndSpaces,/\*[*\s]+\*/g,"*"]),h=getParam(c,null,null,/[\*\d]{4}\s+[\*\d]{4}\s+[\*\d]{4}\s+\d{4}/i,replaceTagsAndSpaces),d={__id:d,__name:g,num:h};__shouldProcess("cards",d)&&(getParam(f,d,"cards.type",/<span[^>]*>([^<]*)<\/span>/i,replaceTagsAndSpaces),processCard(c,d));b.cards.push(d)}}}}
function processInfo(a,b){if(AnyBalance.isAvailable("info")){b.info={};var c=AnyBalance.getPreferences();getParam(a,b.info,"info.io",/<div[^>]*class="clientName"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(c.login,b.info,"info.login");AnyBalance.isAvailable("info.fio")&&((c=getParam(a,null,null,/<a[^>]+href="([^"]*\/scoring\/protected\/statement\/account\/[^"]*)/i,replaceHtmlEntities))||(c=getParam(a,null,null,/<a[^>]+href="([^"]*\/scoring\/protected\/statement\/card\/[^"]*)/i,replaceHtmlEntities)),
a=AnyBalance.requestGet(joinUrl(g_baseurl,c),g_headers),a=getElement(a,/<form[^>]+detailsDialog:detailsDialog[^>]*>/i,replaceHtmlEntities),/account/i.test(c)?getParam(a,b.info,"info.fio",/Получатель платежа:[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces):getParam(a,b.info,"info.fio",/Назначение платежа:[\s\S]*?<td[^>]*>([\s\S]*?)(?:,|<\/td>)/i,replaceTagsAndSpaces))}}
function processCard(a,b){AnyBalance.trace("Обрабатываем карту "+b.__name);getParam(a,b,"cards.balance",/<span[^>]+amountBox[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"cards.currency",/<span[^>]+amountBox[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseCurrency);getParam(a,b,"cards.name",/<div[^>]+aliasBox[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);if(AnyBalance.isAvailable("cards.debt_late","cards.minpay","cards.minpay_till","cards.debt","cards.gracepay","cards.gracepay_till",
"cards.limit","cards.blocked","cards.sms","cards.till","cards.transactions")){a=AnyBalance.requestGet(g_baseurl+"/scoring/protected/statement/card/"+b.__id,g_headers);var c=getElement(a,/<table[^>]+bigCardShadow[^>]*>/i,replaceHtmlEntities);getParam(c,b,"cards.debt_late",/Просроченная задолженность:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"cards.minpay",/Минимальный платеж:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,
b,"cards.minpay_till",/погасить до:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseDate);getParam(c,b,"cards.debt",/Всего задолженность:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"cards.date_start",/Дата открытия карты:([^<]*)/i,replaceTagsAndSpaces,parseDate);getParam(c,b,"cards.pct",/Процентная ставка:([^<]*)/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"cards.blocked",/Заблокировано:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,
parseBalance);getParam(c,b,"cards.sms",/Подключено SMS-информирование на номера:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces);getParam(c,b,"cards.till",/Действительна до:([^<]*)/i,replaceTagsAndSpaces,parseDate);getParam(c,b,"cards.limit",/Кредитный лимит:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"cards.gracepay",/Сумма платежа в льготном периоде:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"cards.gracepay_till",
/Сумма платежа в льготном периоде:[\s\S]*?<span[^>]*>\s*до([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseDate);AnyBalance.isAvailable("cards.transactions")&&processCardTransactions(a,b)}}
function processAccounts(a,b){if(AnyBalance.isAvailable("accounts")){AnyBalance.trace("Читаем счета");var c=getElements(a,[/<div[^>]+productShort[^>]*>/ig,/statement\/account\/./i]);if(c.length)for(AnyBalance.trace("Найдено "+c.length+" счетов"),b.accounts=[],a=0;a<c.length;++a){var e=c[a],d=getParam(e,null,null,/statement\/account\/(\d+)/i),f=getParam(e,null,null,/(?:\d(?:\s+|&nbsp;|&#160;)*){20}/i,replaceTagsAndSpaces),d={__id:d,__name:f,num:f.replace(/\s+/g,"")};__shouldProcess("accounts",d)&&
processAccount(e,d);b.accounts.push(d)}else AnyBalance.trace(a),AnyBalance.trace("Не удалось найти блок счетов. счета отсутствуют?")}}
function processAccount(a,b){AnyBalance.trace("Обрабатываем счет "+b.__name);getParam(a,b,"accounts.balance",/<span[^>]+amountBox[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"accounts.currency",/<span[^>]+amountBox[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseCurrency);getParam(a,b,"accounts.name",/<div[^>]+aliasBox[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);if(AnyBalance.isAvailable("accounts.date_start","accounts.contract")){a=AnyBalance.requestGet(g_baseurl+
"/scoring/protected/statement/account/"+b.__id,g_headers);var c=getElement(a,/<table[^>]+productFull[^>]*>/i,replaceHtmlEntities);getParam(c,b,"accounts.date_start",/Дата открытия счета:([^<]*)/i,replaceTagsAndSpaces,parseDate);getParam(c,b,"accounts.contract",/Номер договора:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces);AnyBalance.isAvailable("accounts.transactions")&&processAccountTransactions(a,b)}}
function processCredits(a,b){if(AnyBalance.isAvailable("credits")){AnyBalance.trace("Читаем кредиты");var c=getElements(a,[/<div[^>]+productShort[^>]*>/ig,/statement\/credit\/./i]);if(c.length)for(AnyBalance.trace("Найдено "+c.length+" кредитов"),b.credits=[],a=0;a<c.length;++a){var e=c[a],d=getParam(e,null,null,/statement\/credit\/(\d+)/i),f=getElement(e,/<span[^>]+id="[^"]*:aliasText"[^>]*>/i,replaceTagsAndSpaces),g=getParam(e,null,null,/&#1044;&#1086;&#1075;&#1086;&#1074;&#1086;&#1088; [N№]([^<]*)/i,
replaceTagsAndSpaces),d={__id:d,__name:f+" "+g,num:g};__shouldProcess("credits",d)&&processCredit(e,d);b.credits.push(d)}else AnyBalance.trace(a),AnyBalance.trace("Не удалось найти блок кредитов. Кредиты отсутствуют?")}}
function processCredit(a,b){AnyBalance.trace("Обрабатываем кредит "+b.__name);getParam(a,b,"credits.balance",/<span[^>]+amountBox[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"credits.currency",/<span[^>]+amountBox[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseCurrency);getParam(a,b,"credits.name",/<div[^>]+aliasBox[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(a,b,"credits.minpay",/&#1045;&#1078;&#1077;&#1084;&#1077;&#1089;&#1103;&#1095;&#1085;&#1099;&#1081; &#1087;&#1083;&#1072;&#1090;&#1077;&#1078;:[\s\S]*?<span[^>]+amountBox[^>]*>([\s\S]*?)<\/span>/i,
replaceTagsAndSpaces,parseBalance);getParam(a,b,"credits.minpay_till",/&#1044;&#1072;&#1090;&#1072; &#1087;&#1083;&#1072;&#1090;&#1077;&#1078;&#1072;([^<]*)/i,replaceTagsAndSpaces,parseDate);AnyBalance.isAvailable("credits.debt_late","credits.pct","credits.date_start","credits.period","credits.cardnum","credits.accnum")&&(a=AnyBalance.requestGet(g_baseurl+"/scoring/protected/statement/credit/"+b.__id,g_headers),a=getElement(a,/<table[^>]+productFull[^>]*>/i,replaceHtmlEntities),getParam(a,b,"credits.debt_late",
/Просроченная задолженность:[\s\S]*?<span[^>]+amountBox[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance),getParam(a,b,"credits.pct",/Процентная ставка:([^<]*)/i,replaceTagsAndSpaces,parseBalance),getParam(a,b,"credits.date_start",/Дата выдачи кредита:([^<]*)/i,replaceTagsAndSpaces,parseDate),getParam(a,b,"credits.till",/Дата окончания кредита:([^<]*)/i,replaceTagsAndSpaces,parseDate),getParam(a,b,"credits.period",/Срок кредита:([^<]*)/i,replaceTagsAndSpaces,parseBalance),getParam(a,b,
"credits.contract",/Номер Договора: N?([^<]*)/i,replaceTagsAndSpaces),getParam(a,b,"credits.cardnum",/Карта для погашения кредита:[\s\S]*?<a[^>]*>([\s\S]*?)(?:\(|<\/a>)/i,replaceTagsAndSpaces),getParam(a,b,"credits.accnum",/Счет для погашения кредита:[\s\S]*?<a[^>]*>([\s\S]*?)(?:\(|<\/a>)/i,replaceTagsAndSpaces))}function getViewState(a){return getParam(a,null,null,/<input[^>]+name="javax.faces.ViewState"[^>]*value="([^"]*)/i)}
function transliterate(a){var b="",c={"Ё":"YO","Й":"I","Ц":"TS","У":"U","К":"K","Е":"E","Н":"N","Г":"G","Ш":"SH","Щ":"SCH","З":"Z","Х":"H","Ъ":"_","ё":"yo","й":"i","ц":"ts","у":"u","к":"k","е":"e","н":"n","г":"g","ш":"sh","щ":"sch","з":"z","х":"h","ъ":"_","Ф":"F","Ы":"I","В":"V","А":"a","П":"P","Р":"R","О":"O","Л":"L","Д":"D","Ж":"ZH","Э":"E","ф":"f","ы":"i","в":"v","а":"a","п":"p","р":"r","о":"o","л":"l","д":"d","ж":"zh","э":"e","Я":"Ya","Ч":"CH","С":"S","М":"M","И":"I","Т":"T","Ь":"_","Б":"B","Ю":"YU",
"я":"ya","ч":"ch","с":"s","м":"m","и":"i","т":"t","ь":"_","б":"b","ю":"yu"};for(i=0;i<a.length;++i)b+=void 0===c[a[i]]?a[i]:c[a[i]];return b}
function extractRegions(){for(var a=AnyBalance.requestGet(g_baseurl+"/private/web.jsf"),a=getElement(a,/<select[^>]+id="region"[^>]*>/i),a=getElements(a,/<option[^>]*>/ig),b=[],c=[],e={},d=0;d<a.length;++d){var f=getParam(a[d],null,null,null,replaceTagsAndSpaces),g=replaceAll(f,[/Республика\s*/i,"",/\s+.*$/,""]).substr(0,5),g=transliterate(g),h=getParam(a[d],null,null,/<option[^>]+value="([^"]*)/i);e[g]=h;b.push(f);c.push(g)}AnyBalance.setResult({success:!0,valsite:e,names:b.join("|"),values:c.join("|")})}
;
