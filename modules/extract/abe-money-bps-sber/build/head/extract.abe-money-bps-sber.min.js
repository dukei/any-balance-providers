var g_headers={Accept:"application/json; charset=UTF-8","X-Sbol-OS":"android","X-Sbol-Version":"1.3.1","X-Sbol-Id":"",Connection:"Keep-Alive","User-Agent":"okhttp/3.6.0","Accept-Encoding":"gzip",Origin:null},baseurl="https://digital.bps-sberbank.by/SBOLServer/";
function apiCall(b,a,c){var d=g_headers;"string"===typeof a&&(d=addHeaders({"Content-Type":"application/json; charset=UTF-8"}));b=AnyBalance.requestPost(baseurl+b,a,c?addHeaders(d,c):d,{HTTP_METHOD:a?"POST":"GET"});if(!b)throw AnyBalance.trace(b),new AnyBalance.Error("Не удалось получить ответ от сервера.");a=getJson(b);if(a.error||a.errorInfo&&+a.errorInfo.errorCode){if("new_device"===getLastResponseHeader("sbol-status"))return a;c=a.error_description||a.errorInfo&&a.errorInfo.errorDescription;AnyBalance.trace(b);
throw new AnyBalance.Error(c,null,/unauthorized/i.test(a.error+c));}return a}function getLastResponseHeader(b){var a=AnyBalance.getLastResponseHeaders();b=b.toLowerCase();for(var c=0;c<a.length;++c){var d=a[c];if(d[0].toLowerCase()===b)return d[1]}}
function login(){var b=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");checkEmpty(b.login,"Введите логин!");checkEmpty(b.password,"Введите пароль!");if(g_headers.Authorization&&/Bearer/i.test(g_headers.Authorization))AnyBalance.trace("Already logged in");else{g_headers["X-Sbol-Id"]=hex_md5(b.login).substr(0,16);g_headers.Authorization="Basic "+Base64.encode(b.login+":"+b.password);var a=apiCall("oauth/token",{client_id:b.login,client_secret:b.password,grant_type:"client_credentials"},
{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"});if(a.error)if("new_device"===getLastResponseHeader("sbol-status")){AnyBalance.trace("Требуется подтверждение устройства");a=getLastResponseHeader("sbol-udid");apiCall("rest/registration/prepareDevice",JSON.stringify({udId:a}));var c=AnyBalance.retrieveCode("Пожалуйста, подтвердите разрешение AnyBalance входить в интернет-банк БПС-Сбербанк, введя код из SMS",null,{inputType:"number",time:3E5});apiCall("rest/registration/trustedDevice",
JSON.stringify({smsCode:c,udId:a}));a=apiCall("oauth/token",{client_id:b.login,client_secret:b.password,grant_type:"client_credentials"},{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"})}else throw AnyBalance.trace(JSON.stringify(a)),new AnyBalance.Error("Неизвестная ошибка входа. Сайт изменен?");g_headers.Authorization="Bearer "+a.access_token;__setLoginSuccessful()}}
function getProducts(){getProducts.products||(getProducts.products=apiCall("rest/client/contracts"));return getProducts.products}
function processAccounts(b,a){if(AnyBalance.isAvailable("accounts")){var c=getProducts();if(b=c.contracts)for(AnyBalance.trace("Найдено "+b.length+" счетов"),a.accounts=[],c=0;c<b.length;++c){var d=b[c],e=d.contractId,f=d.account||d.contractNumber,g=d.name,h=g+" "+f.substr(-4),e={__id:e,__name:h,num:f,name:g};__shouldProcess("accounts",e)&&processAccount(d,e);a.accounts.push(e)}else AnyBalance.trace("Не удалось найти счета "+JSON.stringify(c))}}
function requestCardBalance(b,a){var c=requestCardBalance.hashes||{};if(c[b])return c[b];var d=new Date;a=joinObjects(g_baseparams,{CARDHASH:b,CURRENCY_NUM:a,CURTIME:""+d.getFullYear()+n2(d.getMonth()+1)+n2(d.getDate())+n2(d.getHours())+n2(d.getMinutes())+n2(d.getSeconds())});a=makeRequest("cardBalance",a);a=getElement(a,/<ns2:result[^>]*>/i,replaceTagsAndSpaces);AnyBalance.trace("Got card response: "+a);c[b]=a;requestCardBalance.hashes=c;return a}
function processAccount(b,a){AnyBalance.trace("Обработка счета "+a.__name);getParam(b.contractType,a,"accounts.type");getParam(b.currencyName,a,["accounts.currency","accounts.balance"]);getParam(b.dateStart,a,"accounts.date_start");getParam(b.percentRate,a,"accounts.pct");getParam(b.amount,a,"accounts.balance")}
function processCards(b,a){if(AnyBalance.isAvailable("cards")){var c=getProducts();b=c.contracts.filter(function(a){return a.cardList&&a.cardList.length});if(b.length)for(AnyBalance.trace("Найдено "+b.length+" карточных счетов"),a.cards=[],c=0;c<b.length;++c){var d=b[c];AnyBalance.trace("Счет "+d.account+" содержит "+d.cardList.length+" карт");for(var e=0;e<d.cardList.length;++e){var f=d.cardList[e],g=f.cardId,h=f.panCode,k=f.name,l=f.name+" "+h.substr(-4),g={__id:g,__name:l,num:h,accnum:d.account,
name:k,accid:d.contractId};__shouldProcess("cards",g)&&processCard(f,g,d);a.cards.push(g)}}else AnyBalance.trace(JSON.stringify(c)),AnyBalance.trace("Не удалось найти карточные счета")}}
function processCard(b,a,c){AnyBalance.trace("Обработка карты "+a.__name);getParam(b.name,a,"cards.type");getParam(b.status,a,"cards.status");getParam(b.monthEnd+"/"+b.yearEnd,a,"cards.till",null,replaceTagsAndSpaces,parseDate);getParam(c.currencyName,a,["cards.currency","cards.balance"]);getParam(c.amount,a,"cards.balance");if(AnyBalance.isAvailable("cards.balance"))try{var d=apiCall("rest/client/balance",JSON.stringify({cardExpire:b.yearEnd+"-"+b.monthEnd+"-15",cardId:b.cardId,currency:c.currencyCode}));
getParam(d.amount,a,"cards.balance")}catch(e){AnyBalance.trace("Невозможно получить актуальный баланс для карты "+a.__name+". Заблокирована? Получаем баланс из счета.")}isAvailable("cards.transactions")&&processCardTransactions(b,a)}function processDeposits(b,a){AnyBalance.isAvailable("deposits")}function processDeposit(b,a,c){AnyBalance.trace("Обработка депозита "+a.__name);isAvailable("deposits.transactions")&&processDepositTransactions(b,a)}
function processCredits(b,a){if(AnyBalance.isAvailable("credits"))throw AnyBalance.Error("Ошибка получения кредитов. Сайт изменен?");}
function processCredit(b,a){AnyBalance.trace("Обработка кредита "+a.__name);getParam(b,a,"credits.status",/<status[^>]*>([\s\S]*?)<\/status>/i,replaceTagsAndSpaces);getParam(b,a,"credits.date_start",/<contract_date[^>]*>([\s\S]*?)<\/contract_date>/i,replaceTagsAndSpaces,parseDateISO);getParam(b,a,"credits.till",/<contract_close_date[^>]*>([\s\S]*?)<\/contract_close_date>/i,replaceTagsAndSpaces,parseDateISO);getParam(b,a,["credits.currency","credits.balance"],/<currency[^>]*>([\s\S]*?)<\/currency>/i,
replaceTagsAndSpaces,CurrencyISO.digitsToLetters);getParam(b,a,"credits.balance",/<residualAmount[^>]*>([\s\S]*?)<\/residualAmount>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"credits.accid",/<relatedAccount[^>]*>([\s\S]*?)<\/relatedAccount>/i,replaceTagsAndSpaces);getParam(b,a,"credits.limit",/<overdraftLimit[^>]*>([\s\S]*?)<\/overdraftLimit>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"credits.pct",/<percRate[^>]*>([\s\S]*?)<\/percRate>/i,replaceTagsAndSpaces,parseBalance);AnyBalance.isAvailable("credits.transactions")&&
processCreditTransactions(b,a)}function processInfo(b,a){a=a.info={};b=apiCall("rest/user/updateProfile",JSON.stringify({}));getParam(b.lastName+" "+b.firstName+" "+b.middleName,a,"info.fio");getParam(b.passport,a,"info.passport");getParam(b.birthday,a,"info.birthday")};
