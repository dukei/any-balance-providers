var g_headers={Accept:"application/json; charset=UTF-8","X-Sbol-OS":"android","X-Sbol-Version":"1.0.5","X-Sbol-Id":"",Connection:"Keep-Alive","User-Agent":"okhttp/3.6.0","Accept-Encoding":"gzip",Origin:null},baseurl="https://digital.bps-sberbank.by/SBOLServer/";
function apiCall(a,b,c){var d=g_headers;"string"===typeof b&&(d=addHeaders({"Content-Type":"application/json; charset=UTF-8"}));a=AnyBalance.requestPost(baseurl+a,b,c?addHeaders(d,c):d,{HTTP_METHOD:b?"POST":"GET"});if(!a)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось получить ответ от сервера.");b=getJson(a);if(b.error)throw AnyBalance.trace(a),new AnyBalance.Error(b.error_description,null,/unauthorized/i.test(b.error));return b}
function login(){var a=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");checkEmpty(a.login,"Введите логин!");checkEmpty(a.password,"Введите пароль!");g_headers.Authorization&&/Bearer/i.test(g_headers.Authorization)?AnyBalance.trace("Already logged in"):(g_headers["X-Sbol-Id"]="96892da4c0d22530",g_headers.Authorization="Basic "+Base64.encode(a.login+":"+a.password),a=apiCall("oauth/token",{client_id:a.login,client_secret:a.password,grant_type:"client_credentials"},{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"}),
g_headers.Authorization="Bearer "+a.access_token,__setLoginSuccessful())}function getProducts(){getProducts.products||(getProducts.products=apiCall("rest/client/contracts"));return getProducts.products}
function processAccounts(a,b){if(AnyBalance.isAvailable("accounts")){var c=getProducts();if(a=c.contracts)for(AnyBalance.trace("Найдено "+a.length+" счетов"),b.accounts=[],c=0;c<a.length;++c){var d=a[c],e=d.contractId,f=d.account||d.contractNumber,g=d.name,h=g+" "+f.substr(-4),e={__id:e,__name:h,num:f,name:g};__shouldProcess("accounts",e)&&processAccount(d,e);b.accounts.push(e)}else AnyBalance.trace("Не удалось найти счета "+JSON.stringify(c))}}
function requestCardBalance(a,b){var c=requestCardBalance.hashes||{};if(c[a])return c[a];var d=new Date;b=joinObjects(g_baseparams,{CARDHASH:a,CURRENCY_NUM:b,CURTIME:""+d.getFullYear()+n2(d.getMonth()+1)+n2(d.getDate())+n2(d.getHours())+n2(d.getMinutes())+n2(d.getSeconds())});b=makeRequest("cardBalance",b);b=getElement(b,/<ns2:result[^>]*>/i,replaceTagsAndSpaces);AnyBalance.trace("Got card response: "+b);c[a]=b;requestCardBalance.hashes=c;return b}
function processAccount(a,b){AnyBalance.trace("Обработка счета "+b.__name);getParam(a.contractType,b,"accounts.type");getParam(a.currencyName,b,["accounts.currency","accounts.balance"]);getParam(a.dateStart,b,"accounts.date_start");getParam(a.percentRate,b,"accounts.pct");getParam(a.amount,b,"accounts.balance")}
function processCards(a,b){if(AnyBalance.isAvailable("cards")){var c=getProducts();a=c.contracts.filter(function(a){return a.cardList&&a.cardList.length});if(a.length)for(AnyBalance.trace("Найдено "+a.length+" карточных счетов"),b.cards=[],c=0;c<a.length;++c){var d=a[c];AnyBalance.trace("Счет "+d.account+" содержит "+d.cardList.length+" карт");for(var e=0;e<d.cardList.length;++e){var f=d.cardList[e],g=f.cardId,h=f.panCode,k=f.name,l=f.name+" "+h.substr(-4),g={__id:g,__name:l,num:h,accnum:d.account,
name:k,accid:d.contractId};__shouldProcess("cards",g)&&processCard(f,g,d);b.cards.push(g)}}else AnyBalance.trace(JSON.stringify(c)),AnyBalance.trace("Не удалось найти карточные счета")}}
function processCard(a,b,c){AnyBalance.trace("Обработка карты "+b.__name);getParam(a.name,b,"cards.type");getParam(a.status,b,"cards.status");getParam(a.monthEnd+"/"+a.yearEnd,b,"cards.till",null,replaceTagsAndSpaces,parseDate);getParam(c.currencyName,b,["cards.currency","cards.balance"]);AnyBalance.isAvailable("cards.balance")&&(c=apiCall("rest/client/balance",JSON.stringify({cardExpire:a.yearEnd+"-"+a.monthEnd+"-15",cardId:a.cardId,currency:c.currencyCode})),getParam(c.amount,b,"cards.balance"));
isAvailable("cards.transactions")&&processCardTransactions(a,b)}function processDeposits(a,b){AnyBalance.isAvailable("deposits")}function processDeposit(a,b,c){AnyBalance.trace("Обработка депозита "+b.__name);isAvailable("deposits.transactions")&&processDepositTransactions(a,b)}function processCredits(a,b){if(AnyBalance.isAvailable("credits"))throw AnyBalance.Error("Ошибка получения кредитов. Сайт изменен?");}
function processCredit(a,b){AnyBalance.trace("Обработка кредита "+b.__name);getParam(a,b,"credits.status",/<status[^>]*>([\s\S]*?)<\/status>/i,replaceTagsAndSpaces);getParam(a,b,"credits.date_start",/<contract_date[^>]*>([\s\S]*?)<\/contract_date>/i,replaceTagsAndSpaces,parseDateISO);getParam(a,b,"credits.till",/<contract_close_date[^>]*>([\s\S]*?)<\/contract_close_date>/i,replaceTagsAndSpaces,parseDateISO);getParam(a,b,["credits.currency","credits.balance"],/<currency[^>]*>([\s\S]*?)<\/currency>/i,
replaceTagsAndSpaces,CurrencyISO.digitsToLetters);getParam(a,b,"credits.balance",/<residualAmount[^>]*>([\s\S]*?)<\/residualAmount>/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"credits.accid",/<relatedAccount[^>]*>([\s\S]*?)<\/relatedAccount>/i,replaceTagsAndSpaces);getParam(a,b,"credits.limit",/<overdraftLimit[^>]*>([\s\S]*?)<\/overdraftLimit>/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"credits.pct",/<percRate[^>]*>([\s\S]*?)<\/percRate>/i,replaceTagsAndSpaces,parseBalance);AnyBalance.isAvailable("credits.transactions")&&
processCreditTransactions(a,b)}function processInfo(a,b){b=b.info={};a=apiCall("rest/user/updateProfile",JSON.stringify({}));getParam(a.lastName+" "+a.firstName+" "+a.middleName,b,"info.fio");getParam(a.passport,b,"info.passport");getParam(a.birthday,b,"info.birthday")};
