var g_headers={Accept:"*/*","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive",Origin:"https://www.citibank.ru","User-Agent":"Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/29.0.1547.76 Safari/537.36"},jsonHeaders={Accept:"application/json, text/javascript, */*; q=0.01",Origin:"https://www.citibank.ru","X-Requested-With":"XMLHttpRequest","User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.86 Safari/537.36",
"Accept-Language":"ru,en;q=0.8"},baseurl="https://www.citibank.ru/RUGCB/",JFP_TOKEN,SYNC_TOKEN,detailsEnabled=!1;
function login(b){AnyBalance.setDefaultCharset("utf-8");checkEmpty(b.login,"Введите логин!");checkEmpty(b.password,"Введите пароль!");detailsEnabled=b.detailsEnabled;if(JFP_TOKEN)AnyBalance.trace("Уже залогинены, отлично.");else{AnyBalance.trace("Нужно залогинится.");var a=AnyBalance.requestGet(baseurl,addHeaders({Referer:baseurl})),c=getParam(a,null,null,/window.location.href="\/RUGCB\/([^"]+)/i);c&&(a=AnyBalance.requestGet(baseurl+c,addHeaders({Referer:baseurl})));getElements(a,/<script[^>]*>/ig,
[/^<script[^>]*>|<\/script>$/ig,""],function(a){/XXX_Extra/.test(a)&&(AnyBalance.trace("XXX_Extra found, trying to evaluate"),safeEval(a,"jQuery,document",[jQueryLocal,""]));return a});AnyBalance.trace("XXX_Extra evaluate successfull");JFP_TOKEN=getJFPToken(a);SYNC_TOKEN=getToken(a);a=getParam(a,null,null,/XYZ_Extra[^>]*value=([^"'>]+)/i);c=getParam(g_append,null,null,/XXX_Extra[^>]*value=([^'">]+)/i);checkEmpty(JFP_TOKEN&&a&&c,"Не удалось найти один из важных параметров входа, сайт изменен?",!0);
a=AnyBalance.requestPost(baseurl+"JSO/signon/ProcessUsernameSignon.do?JFP_TOKEN="+JFP_TOKEN,{SYNC_TOKEN:SYNC_TOKEN,JFP_TOKEN:JFP_TOKEN,rsaDevicePrint:"version=2&pm_fpua=mozilla/5.0 (windows nt 10.0; wow64) applewebkit/537.36 (khtml, like gecko) chrome/46.0.2490.86 safari/537.36|5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.86 Safari/537.36|Win32&pm_fpsc=24|1920|1080|1040&pm_fpsw=&pm_fptz=3&pm_fpln=lang=ru|syslang=|userlang=&pm_fpjv=1&pm_fpco=1&pm_fpasw=widevinecdmadapter|mhjfbmdgcfjbbpaeojofohoefgiehjai|pepflashplayer|internal-nacl-plugin|internal-pdf-viewer&pm_fpan=Netscape&pm_fpacn=Mozilla&pm_fpol=true&pm_fposp=&pm_fpup=&pm_fpsaw=1920&pm_fpspd=24&pm_fpsbd=&pm_fpsdx=&pm_fpsdy=&pm_fpslx=&pm_fpsly=&pm_fpsfse=&pm_fpsui=",
username:b.login,password:b.password,x:"39",y:"10",XXX_Extra:c,XYZ_Extra:a},g_headers);b=getParam(a,null,null,/"sessionCheck"\s*,\s*['"]([^"']*)/,replaceSlashes);AnyBalance.trace("sessionCheck: "+b);AnyBalance.setCookie("www.citibank.ru","sessionCheck",b);/id="nonOtpLogonButton"|Otp-Warning-Skip/i.test(a)&&(a=AnyBalance.requestGet(baseurl+"JSO/signon/uname/HomepagePortal.do?SYNC_TOKEN="+getToken(a)+"&JFP_TOKEN="+JFP_TOKEN,addHeaders({Referer:baseurl+"JSO/signon/DisplayUsernameSignon.do"})));/выйти/i.test(a)||
(b=AnyBalance.getLastUrl(),b=b.replace(/HomePage.do/i,"HomepagePortal.do"),a=AnyBalance.requestGet(b,addHeaders({Referer:AnyBalance.getLastUrl()})));if(!/выйти/i.test(a)){if(b=getParam(a,null,null,/<span class="[^"]*error[^>]*>([\s\S]*?)<\//i,replaceTagsAndSpaces))throw new AnyBalance.Error(b,null,/неправильные данные|Неверный логин или пароль/i.test(b));AnyBalance.trace(a);throw new AnyBalance.Error("Не удалось зайти в личный кабинет. Сайт изменен?");}processSmsAuth(a)}__setLoginSuccessful();AnyBalance.trace("Успешно вошли, отлично.");
return a}
function processProfile(b,a){AnyBalance.trace("Получаем данные профиля");try{var c=AnyBalance.requestPost(baseurl+"REST/welcome/welcomeMsgContent?JFP_TOKEN="+getJFPToken(b),"",addHeaders(jsonHeaders,{Referer:baseurl+"JSO/signon/uname/HomePage.do?SYNC_TOKEN="+getToken(b)+"&JFP_TOKEN="+getJFPToken(b)})),d=getJson(c);a.info={};getParam(d.USERNAME,a.info,"info.fio",null,replaceTagsAndSpaces,capitalFirstLetters);getParam(d.EMAIL,a.info,"info.email",null,replaceTagsAndSpaces);getParam(d.MOBILENUMBER,a.info,
"info.mphone",null,replaceTagsAndSpaces);getParam(d.COMPANYNAMEPHRASE,a.info,"info.COMPANYNAMEPHRASE",null,replaceTagsAndSpaces);getParam(d.COMPANYNAME,a.info,"info.COMPANYNAME",null,replaceTagsAndSpaces);AnyBalance.trace("Получили данные профиля")}catch(e){}}var smsAlreadyEntered=!1,count=3;
function processSmsAuth(b){if(!smsAlreadyEntered&&detailsEnabled){b=AnyBalance.requestPost(baseurl+"COA/ain/accsumlit/flow.action?JFP_TOKEN="+getJFPToken(b),"",jsonHeaders);var a=AnyBalance.requestPost(baseurl+"REST/coa/ain/accsumlit/getAccounts?JFP_TOKEN="+getJFPToken(b),"",addHeaders(jsonHeaders,{Referer:baseurl+"JSO/signon/uname/HomePage.do?SYNC_TOKEN="+getToken(b)+"&JFP_TOKEN="+getJFPToken(b)})),a=getJson(a);if(a.accountDetailList)for(;0<a.accountDetailList.length;){checkSmsAuth(b,a.accountDetailList[0].instanceID);
break}else AnyBalance.trace("Нет ни одного счета, не будем ввходить смс-код.")}}
function checkSmsAuth(b,a){if(!smsAlreadyEntered){b=AnyBalance.requestPost(baseurl+"COA/common/accsel/flow.action?aai="+a+"&JFP_TOKEN="+getJFPToken(b),"",addHeaders({Referer:baseurl+"JSO/signon/uname/HomePage.do?SYNC_TOKEN="+getToken(b)+"&JFP_TOKEN="+getJFPToken(b),"X-Requested-With":"XMLHttpRequest"}));AnyBalance.trace("Пытаемся ввести смс-код");code=AnyBalance.retrieveCode("Пожалуйста, введите смс-код");AnyBalance.trace("Смс-код получен: "+code);b=AnyBalance.requestPost(baseurl+"JPS/apps/otpstc/StcMain.do?JFP_TOKEN="+
getJFPToken(b),{SYNC_TOKEN:getToken(b),JFP_TOKEN:getJFPToken(b),secureTxnFunction:"CodeEntry",secureTxnCode:code},addHeaders({Referer:baseurl+"JSO/signon/uname/HomePage.do","X-Requested-With":"XMLHttpRequest"}));if(/SMS-сообщение с одноразовым паролем было отправлено/i.test(b)){if(0==count)throw new AnyBalance.Error("Смс-код был введен неправильно три раза подряд, вы уверены, что вводите правильный код?");count--;AnyBalance.trace("Смс-код введен неверно, попробуем еще раз");checkSmsAuth(b,a)}smsAlreadyEntered=
!0}}
function processAccounts(b,a){b=AnyBalance.requestPost(baseurl+"COA/ain/accsumlit/flow.action?JFP_TOKEN="+getJFPToken(b),"",jsonHeaders);var c=AnyBalance.requestPost(baseurl+"REST/coa/ain/accsumlit/getAccounts?JFP_TOKEN="+getJFPToken(b),"",addHeaders(jsonHeaders,{Referer:baseurl+"JSO/signon/uname/HomePage.do?SYNC_TOKEN="+getToken(b)+"&JFP_TOKEN="+getJFPToken(b)})),d=getJson(c);if(!d.accountDetailList)return AnyBalance.trace(c),AnyBalance.trace("Не найдена информация о счетах."),b;c=d.accountDetailList;AnyBalance.trace("Найдено счетов: "+
c.length);a.accounts=[];for(d=0;d<c.length;++d){var e=c[d],f={__id:e.instanceID,__name:e.accountName};__shouldProcess("accounts",f)&&processAccount(b,e,f);a.accounts.push(f)}return b}
function processAccount(b,a,c){getParam(a.relatedAccountNumber,c,"accounts.relatedAccountNumber");getParam(a.productName,c,"accounts.productName");getParam(a.inactive,c,"accounts.inactive");getParam(a.accountType,c,"accounts.type");if(a.elementEntryMap)for(var d in a.elementEntryMap){var e=a.elementEntryMap[d];if(e&&0<e.length)for(var f=0;f<e.length;f++){var g=e[f];processPhrases(g.phrase,g.value+"",c)}}if(detailsEnabled){b=AnyBalance.requestPost(baseurl+"REST/ain/accdetact/exitMethod?JFP_TOKEN="+
getJFPToken(b),{exitMethod:1},addHeaders({Referer:baseurl+"JSO/signon/uname/HomePage.do?SYNC_TOKEN="+getToken(b)+"&JFP_TOKEN="+getJFPToken(b),"X-Requested-With":"XMLHttpRequest"}));b=AnyBalance.requestPost(baseurl+"COA/ain/accdetact/flow.action?JFP_TOKEN="+getJFPToken(b),{aai:a.instanceID},addHeaders({Referer:baseurl+"JSO/signon/uname/HomePage.do?SYNC_TOKEN="+getToken(b)+"&JFP_TOKEN="+getJFPToken(b),"X-Requested-With":"XMLHttpRequest"}));a=AnyBalance.requestPost(baseurl+"REST/ain/accdetact/getAccountDetailsAndActivities?JFP_TOKEN="+
getJFPToken(b),{detailReq:!0},addHeaders(jsonHeaders,{Referer:baseurl+"JSO/signon/uname/HomePage.do?SYNC_TOKEN="+getToken(b)+"&JFP_TOKEN="+getJFPToken(b)}));a=getJson(a);getParam(a.rewardPoints+"",c,"accounts.bonus",null,null,parseBalance);getParam(a.categoryCode,c,"accounts.categoryCode");getParam(a.ibanAccuntNo,c,"accounts.ibanAccuntNo");for(f=1;10>f;f++)if(d=a["tableList"+f],isset(d))for(e=0;e<d.length;e++)g=d[e],processPhrases(g.phrase,g.value+"",c);"undefined"!=typeof processAccountTransactions&&
processAccountTransactions(b,a,c)}}
function processPhrases(b,a,c){/Доступно сейчас/i.test(b)?(getParam(a,c,"accounts.available",null,replaceTagsAndSpaces,parseBalance),getParam(a,c,["accounts.currency","accounts.balance","accounts.available"],null,replaceTagsAndSpaces,parseCurrency)):/Текущий баланс/i.test(b)?(getParam(a,c,"accounts.balance",null,replaceTagsAndSpaces,parseBalance),getParam(a,c,["accounts.currency","accounts.balance","accounts.available"],null,replaceTagsAndSpaces,parseCurrency)):/Баланс по последней выписке/i.test(b)?
getParam(a,c,"accounts.balance_lastEx",null,replaceTagsAndSpaces,parseBalance):/Минимальный платеж/i.test(b)?getParam(a,c,"accounts.minpay",null,replaceTagsAndSpaces,parseBalance):/Дата оплаты минимального платежа/i.test(b)?getParam(a,c,"accounts.minpay_till",null,replaceTagsAndSpaces,parseDate):/Использованный кредит/i.test(b)?getParam(a,c,"accounts.loanUsed",null,replaceTagsAndSpaces,parseBalance):/Доступно для выдачи наличными/i.test(b)?getParam(a,c,"accounts.incash",null,replaceTagsAndSpaces,
parseBalance):/замороженные суммы/i.test(b)?getParam(a,c,"accounts.blocked",null,replaceTagsAndSpaces,parseBalance):/Кредитный лимит/i.test(b)&&getParam(a,c,"accounts.limit",null,replaceTagsAndSpaces,parseBalance)}function getFormattedDate(b){var a=new Date;isset(b)&&a.setDate(a.getDate()-b);b=10>a.getDate()?"0"+a.getDate():a.getDate();var c=10>a.getMonth()+1?"0"+(a.getMonth()+1):a.getMonth()+1,a=a.getFullYear();return b+"/"+c+"/"+a}var g_append="";
function jQueryLocal(b){jQueryLocal.fn={jquery:"1.11"};return{each:function(a){a()},append:function(a){return g_append+=a+"\n"},ready:function(a){a()},delegate:function(){},attr:function(){}}}function isValidUrl(){return!0}function getToken(b){return getParam(b,null,null,/<input[^>]+name="SYNC_TOKEN"[^>]*value="([^"]+)/i)||SYNC_TOKEN}function getJFPToken(b){return getParam(b,null,null,/JFP_TOKEN=([\w]+)/i)||JFP_TOKEN};
