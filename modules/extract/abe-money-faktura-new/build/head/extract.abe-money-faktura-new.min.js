var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.143 Safari/537.36","Accept-Language":"ru,en-US;q=0.8,en;q=0.6"},baseurl,g_Xml_Headers={Accept:"application/xml, text/xml, */*; q=0.01","X-Requested-With":"XMLHttpRequest","Wicket-Ajax":"true","Wicket-Ajax-BaseURL":".",Referer:baseurl+"main?main=priv"};
function login(a){AnyBalance.setDefaultCharset("utf-8");var b=AnyBalance.getPreferences();checkEmpty(b.login,"Введите логин!");checkEmpty(b.password,"Введите пароль!");if(!a)throw new AnyBalance.Error("Необходимо указать url банка!");baseurl=a;AnyBalance.trace("Extracting Faktura using baseurl "+baseurl);a=AnyBalance.requestGet(baseurl+"main?main=priv",g_headers);if(!a||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(a),new AnyBalance.Error("Ошибка при подключении к сайту провайдера! Попробуйте обновить данные позже.");
if(!/logout/i.test(a)){var c=findWicketActions(a),e=[],d=getParam(a,null,null,/<input[^>]*name="password"[^>]*id="([^"]+)/i),f=getParam(a,null,null,/<input[^>]*name="login"[^>]*id="([^"]+)/i),g=getParam(a,null,null,/<a[^>]*class="button[^>]*id="([^"]+)/i);c.forEach(function(a,b,c){a=getJson(a);b=(a.u||"").replace(/^.\/main/,"main").replace(/;jsessionid[^?]+/i,"");switch(a.c){case f:e[0]=b;break;case d:e[1]=b;break;case g:e[2]=b}});b=[{login:b.login},{password:b.password}];b[2]=joinObjects(b[0],b[1]);
for(c=0;c<e.length;c++)a=AnyBalance.requestPost(baseurl+e[c],b[c],addHeaders(g_Xml_Headers));!/logout/i.test(a)&&/<input[^>]+name="otp"/i.test(a)&&(AnyBalance.trace("Требуется ввести смс код"),b=getParam(a,/На мобильный телефон[\s\S]*?<\/div>/i,replaceTagsAndSpaces),b=AnyBalance.retrieveCode(b?b+" Введите смс-пароль.":"Введите одноразовый пароль для входа, высланный вам в смс",null,{inputType:"number",time:54E4}),requestGetWicketAction(a,/<input[^>]+name="otp"[^>]*id="([^"]*)/i,{otp:b}),c=getElement(a,
/<form[^>]+login-panel/i),c=createFormParams(c),c.otp=b,c.submitOtp="1",a=requestGetWicketAction(a,/<a[^>]+\bbutton\b[^>]*id="([^"]*)/i,c));if(!/logout/i.test(a)){(b=getElement(a,/<div[^>]+feedbackPanelERROR/i,AB.replaceTagsAndSpaces))||(b=getElement(a,/<[^>]+class="warning"/i,replaceTagsAndSpaces));if(b)throw new AnyBalance.Error(b,null,/парол/i.test(b)&&!/одноразов/i.test(b));AnyBalance.trace(a);throw new AnyBalance.Error("Не удалось зайти в личный кабинет. Сайт изменен?");}__setLoginSuccessful()}return a}
function processProfile(a,b){isAvailable("info")&&(a=AnyBalance.requestGet(baseurl+"main?main=priv&replace=profile_view&item=0",g_headers),b.info={},getParam(a,b.info,"info.fio",/ФИО((?:[\s\S]*?<\/div[^>]*>){2})/i,replaceTagsAndSpaces),getParam(a,b.info,"info.birthday",/Дата рождения((?:[\s\S]*?<\/div[^>]*>){2})/i,replaceTagsAndSpaces),getParam(a,b.info,"info.mphone",/Телефон((?:[\s\S]*?<\/div[^>]*>){2})/i,replaceTagsAndSpaces),getParam(a,b.info,"info.address",/Адрес регистрации((?:[\s\S]*?<\/div[^>]*>){2})/i,
replaceTagsAndSpaces),getParam(a,b.info,"info.addressHome",/Домашний адрес((?:[\s\S]*?<\/div[^>]*>){2})/i,replaceTagsAndSpaces))}function findWicketActions(a){a=sumParam(a,null,null,/Wicket.Ajax.ajax\((\{[\s\S]*?\})\);/ig)||[];AnyBalance.trace("Found "+a.length+" Wicket-ajax actions");return a}
function findExactWickeAction(a,b,c){if(a){for(var e=[],d=0;d<a.length;d++){var f=getJson(a[d]);f.c===b&&e.push(f)}for(var g,d=0;d<e.length;++d)if(f=e[d],!g||c&&f.e==c)g=(f.u||"").replace(/^.\/main/,"main").replace(/;jsessionid[^?]+/i,"");return g}}
function requestGetWicketActionEx(a,b,c,e){a=requestGetWicketAction(a,b,c,e);do if(/<ajax-response><evaluate>/i.test(a)){b=getParam(a,/"u":"\.\/([^"]*)/);c=getParam(a,/\}\);\},\s*(\d+)/i,null,parseBalance);if(!b||!c)return AnyBalance.trace("Неизвестный отложенный запрос: "+a),a;AnyBalance.trace("Требуется отложить запрос на "+c+" мс. Спим...");AnyBalance.sleep(c);a=AnyBalance.requestGet(baseurl+b+"&_="+(new Date).getTime(),addHeaders(g_Xml_Headers))}else return a;while(1)}
function requestGetWicketAction(a,b,c,e){var d=getParam(a,b);if(!d)throw AnyBalance.trace(a),new AnyBalance.Error("Не нашли wicketId "+b.source);a=findWicketActions(a);e=findExactWickeAction(a,d,e);if(!e)throw new AnyBalance.Error("Не удалось найти action: "+d);return c?AnyBalance.requestPost(baseurl+e,c,addHeaders({"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},addHeaders(g_Xml_Headers))):AnyBalance.requestGet(baseurl+e+"&_="+(new Date).getTime(),addHeaders(g_Xml_Headers))}
function checkForRedirect(a){/<redirect>/i.test(a)&&((a=getParam(a,null,null,/main;[^\]]+/i))||AnyBalance.trace("Запрошен редиретк, но ссылка на него не найдена, сайт изменен?"),a=AnyBalance.requestGet(baseurl+a,g_headers));return a}
function processCards(a,b){if(isAvailable("cards")){a=AnyBalance.requestGet(baseurl+"main?main=priv",g_headers);a=requestGetWicketActionEx(a,/wicket.event.add\([^"]*?"load"[\s\S]*?"c":"([^"]*)/i);a=requestGetWicketAction(a,/<div[^>]+class="inner\b[^>]+id="(id[^"]+)"/i);var c=getElements(a,/<div[^>]+class=['"]card inner['"][^>]*>/ig);AnyBalance.trace("Найдено карт: "+c.length);b.cards=[];for(var e=0;e<c.length;++e){var d=getParam(c[e],null,null,/<small[^>]+class="gray"[^>]*>([\s\S]*?)<\//i,replaceTagsAndSpaces),
f=getParam(c[e],null,null,/"card-name"[^>]*>([\s\S]*?)<\//i,replaceTagsAndSpaces),d={__id:d,num:d,__name:f+" "+d};__shouldProcess("cards",d)&&processCard(c[e],d,a);b.cards.push(d)}}}
function processCard(a,b,c){c=requestGetWicketAction(a+c,/<div[^>]+class="card inner"[^>]+id="(id[^"]+)"/i);a=getElement(c,/<h1[^>]+class="title"[^>]*>/i,replaceTagsAndSpaces);getParam(a,b,"cards.num",/[\d\*\s]{6,}/,replaceTagsAndSpaces);getParam(c,b,"cards.limit",/Кредитный лимит((?:[\s\S]*?<\/div[^>]*>){2})/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"cards.debt",/Общая задолженность((?:[\s\S]*?<\/div[^>]*>){2})/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"cards.ovedraft",/Текущий овердрафт((?:[\s\S]*?<\/div[^>]*>){2})/i,
replaceTagsAndSpaces,parseBalance);getParam(c,b,"cards.ovedraft_pcts",/Сумма начисленных процентов по овердрафту((?:[\s\S]*?<\/div[^>]*>){2})/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"cards.ovedraft_overdue",/Просроченный овердрафт((?:[\s\S]*?<\/div[^>]*>){2})/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"cards.overlimit",/Сверхлимитная задолженность((?:[\s\S]*?<\/div[^>]*>){2})/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"cards.commissions",/Cумма комиссий((?:[\s\S]*?<\/div[^>]*>){2})/i,
replaceTagsAndSpaces,parseBalance);getParam(c,b,"cards.penalty",/Сумма штрафов((?:[\s\S]*?<\/div[^>]*>){2})/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"cards.billing_date",/Расчетная дата((?:[\s\S]*?<\/div[^>]*>){2})/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"cards.minpay",/Минимальный платеж((?:[\s\S]*?<\/div[^>]*>){2})/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"cards.minpay_overdue",/в том числе просроченные минимальные платежи((?:[\s\S]*?<\/div[^>]*>){2})/i,replaceTagsAndSpaces,
parseBalance);getParam(c,b,"cards.till",/Срок действия((?:[\s\S]*?<\/div[^>]*>){2})/i,replaceTagsAndSpaces,parseDate);getParam(c,b,"cards.holder",/Имя владельца((?:[\s\S]*?<\/div[^>]*>){2})/i,replaceTagsAndSpaces);getParam(c,b,"cards.status",/Статус карты((?:[\s\S]*?<\/div[^>]*>){2})/i,replaceTagsAndSpaces);getParam(c,b,"cards.balance",/Сумма на карте((?:[\s\S]*?<\/div[^>]*>){2})/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,["cards.currency","cards.balance"],/Сумма на карте((?:[\s\S]*?<\/div[^>]*>){2})/i,
replaceTagsAndSpaces,parseCurrency);"undefined"!=typeof processCardTransactions&&processCardTransactions(c,b);AnyBalance.isAvailable("cards.accnum")&&(AnyBalance.trace("Запрашиваем номер счета"),c=requestGetWicketAction(c,/<small[^>]+id="([^"]*)[^>]*>\s*Реквизиты/i),getParam(c,b,"cards.accnum",/Номер[\s\S]*?<div[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces))}
function processAccounts(a,b){if(isAvailable("accounts")){a=AnyBalance.requestGet(baseurl+"main?main=priv",g_headers);a=requestGetWicketActionEx(a,/wicket.event.add\([^"]*?"load"[\s\S]*?"c":"([^"]*)/i);a=requestGetWicketAction(a,/<div[^>]+class="inner\b[^>]+id="(id[^"]+)"/i);var c=getElements(a,/<div[^>]+class=['"]account inner[^"]+single-account['"][^>]*>/ig);AnyBalance.trace("Найдено счетов: "+c.length);b.accounts=[];for(var e=0;e<c.length;++e){var d=requestGetWicketAction(c[e]+a,/id="(id[^"]+)"/i),
f=getParam(d,null,null,/№(?:\s|<[^>]*>)*(\d{20})/i,replaceTagsAndSpaces),g=getParam(d,null,null,/class="editable"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces),h=g+" "+f.substr(-4),f={__id:f,__name:h,num:f,name:g};__shouldProcess("accounts",f)&&processAccount(d,f);b.accounts.push(f)}}}
function processAccount(a,b){getParam(a,b,"accounts.balance",/class="[^"]*amounts"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,["accounts.currency","accounts"],/class="[^"]*amounts"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseCurrency);"undefined"!=typeof processAccountTransactions&&processAccountTransactions(a,b);AnyBalance.isAvailable("accounts.date_start")&&(a=requestGetWicketAction(a,/<small[^>]+id="([^"]*)[^>]*>\s*Реквизиты/i),getParam(a,b,"accounts.date_start",
/Открыт[\s\S]*?<div[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseDate))}
function processCredits(a,b){if(isAvailable("credits")){a=AnyBalance.requestGet(baseurl+"main?main=priv",g_headers);a=requestGetWicketActionEx(a,/wicket.event.add\([^"]*?"load"[\s\S]*?"c":"([^"]*)/i);var c=[];try{a=requestGetWicketAction(a,/<div[^>]+class="inner\b[^>]+id="(id[^"]+)"(?:[^>]*>){3,7}\s*Кредиты/i),c=getElements(a,/<div[^>]+class=['"]account inner[^>]*>/ig),AnyBalance.trace("Найдено кредитов: "+c.length)}catch(f){/Заявка на кредит/i.test(a)?AnyBalance.trace("Кредитов нет: "+f.message):
AnyBalance.trace("Не удалось найти ссылку на кредиты."+f.message)}b.credits=[];for(var e=0;e<c.length;++e){var d=getParam(c[e],null,null,/<span[^>]*class=['"]index['"](?:[^>]*>){2}([\s\S]*?)<\/div>/i,replaceTagsAndSpaces),d={__id:d,__name:d};__shouldProcess("credits",d)&&processCredit(c[e],d,a);b.credits.push(d)}}}
function processCredit(a,b,c){getParam(a,b,"credits.limit",/class="sum"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,["credits.currency","credits.limit","credits.balance"],/class="sum"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseCurrency);getParam(a,b,"credits.minpay_till",/К оплате([\s\S]*?)<\//i,replaceTagsAndSpaces,parseDate);getParam(a,b,"credits.minpay",/К оплате[\s\S]*?class="sum"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance);c=requestGetWicketAction(a+
c,/<div[^>]+class="account inner[^>]+id="(id[^"]+)"/i);getParam(c,b,"credits.balance",/Общая задолженность(?:[^>]*>){3}([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"credits.principal_debt",/Сумма основного долга(?:[^>]*>){3}([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"credits.pct_sum",/Cумма начисленных процентов(?:[^>]*>){3}([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"credits.debt_expired",/Сумма просроченного основного долга(?:[^>]*>){3}([\s\S]*?)<\/span>/i,
replaceTagsAndSpaces,parseBalance);getParam(c,b,"credits.pct_expired",/Сумма просроченных процентов(?:[^>]*>){3}([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"credits.penalty",/Штрафы(?:[^>]*>){3}([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"credits.minpay_till",/К оплате([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseDate);getParam(c,b,"credits.minpay",/К оплате[\s\S]*?<div[^>]+total-amounts[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance);
getParam(c,b,"credits.minpay_main_debt",/К оплате[\s\S]*?Сумма основного долга([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"credits.minpay_pct",/К оплате[\s\S]*?Сумма процентов([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"credits.minpay_others",/К оплате[\s\S]*?Другие комиссии([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"credits.minpay_penalty",/К оплате[\s\S]*?Пеня за([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,
b,"credits.minpay_pct_expired",/К оплате[\s\S]*?Сумма просроченных процентов([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"credits.minpay_debt_expried",/К оплате[\s\S]*?Сумма просроченного основного долга([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);a=requestGetWicketAction(c,/<small[^>]+id="([^"]*)[^>]*>\s*Условия договора/i);getParam(a,b,"credits.contract",/Договор №\s*<span[^>]*>([^<]*)<\/span>/i,replaceTagsAndSpaces);getParam(a,b,"credits.date_start",/Договор №[\s\S]*?от\s*<span[^>]*>([^<]*)<\/span>/i,
replaceTagsAndSpaces,parseDate);getParam(a,b,"credits.till",/Дата планового закрытия[\s\S]*?<div[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseDate);getParam(a,b,"credits.payment",/Размер ежемесячного платежа[\s\S]*?<div[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"credits.pct",/Процентная ставка[\s\S]*?<div[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"credits.accnum",/Счет для погашения[\s\S]*?<div[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);
getParam(a,b,"credits.pct_effective",/Полная стоимость кредита[\s\S]*?<div[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance);"undefined"!=typeof processCreditSchedule&&processCreditSchedule(c,b)}
function processDeposits(a,b){if(isAvailable("deposits")){a=AnyBalance.requestGet(baseurl+"main?main=priv",g_headers);a=requestGetWicketActionEx(a,/wicket.event.add\([^"]*?"load"[\s\S]*?"c":"([^"]*)/i);var c=[];try{a=requestGetWicketAction(a,/<div[^>]+class="inner\b[^>]+id="(id[^"]+)"(?:[^>]*>){3,7}\s*Вклады/i),c=getElements(a,/<div[^>]+account-deposit[^>]*>/ig),AnyBalance.trace("Найдено депозитов: "+c.length)}catch(f){/Открыть вклад/i.test(a)?AnyBalance.trace("Депозитов нет: "+f.message):AnyBalance.trace("Не удалось найти ссылку на депозиты."+
f.message)}b.deposits=[];for(var e=0;e<c.length;++e){var d=getParam(c[e],/<span[^>]*class=['"]index['"](?:[^>]*>){2}([\s\S]*?)<\/div>/i,replaceTagsAndSpaces),d={__id:d,__name:d};__shouldProcess("deposits",d)&&processDeposit(c[e],d,a);b.deposits.push(d)}}}
function processDeposit(a,b,c){getParam(a,b,"deposits.balance",/class="sum"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,["deposits.currency","deposits.balance"],/class="sum"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseCurrency);getParam(a,b,"deposits.pct_next",/Поступление %\s*<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseDate);getParam(a,b,"deposits.pct_next_sum",/Поступление %[\s\S]*?<span[^>]+sum[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);
c=requestGetWicketAction(a+c,/<div[^>]+account-deposit[^>]+id="(id[^"]+)"/i);getParam(c,b,"deposits.pct",/Процентная ставка[\s\S]*?<div[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"deposits.pct_sum",/Сумма выплаченных процентов[\s\S]*?<div[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"deposits.available",/Возможная сумма снятия[\s\S]*?<div[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,"deposits.balance_start",/Сумма вклада на начало[\s\S]*?<div[^>]*>([\s\S]*?)<\/div>/i,
replaceTagsAndSpaces,parseBalance);getParam(c,b,"deposits.till",/Дата окончания вклада[\s\S]*?<div[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseDate);getParam(c,b,"deposits.accnum",/№\s*<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces);getParam(c,b,"deposits.topup_period",/Пополнение вклада возможно[\s\S]*?<div[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);"undefined"!=typeof processDepositsTransactions&&processDepositsTransactions(c,b);a=requestGetWicketAction(c,/<small[^>]+id="([^"]*)[^>]*>\s*Условия договора/i);
getParam(a,b,"deposits.contract",/Договор №\s*<span[^>]*>([^<]*)<\/span>/i,replaceTagsAndSpaces);getParam(a,b,"deposits.date_start",/Договор №[\s\S]*?от\s*<span[^>]*>([^<]*)<\/span>/i,replaceTagsAndSpaces,parseDate);getParam(a,b,"deposits.period",/Срок действия вклада[\s\S]*?<div[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"deposits.can_topup",/Возможность пополнения[\s\S]*?<div[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(a,b,"deposits.can_withdraw",/Возможность частичного снятия[\s\S]*?<div[^>]*>([\s\S]*?)<\/div>/i,
replaceTagsAndSpaces);getParam(a,b,"deposits.accnum_pct",/Счет для перечисления процентов[\s\S]*?<div[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(a,b,"deposits.accnum_return",/Счет для возврата по вкладу[\s\S]*?<div[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(a,b,"deposits.type",/Тип договора вклада[\s\S]*?<div[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance)};
