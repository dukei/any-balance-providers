var myReplaceTagsAndSpaces=[replaceTagsAndSpaces,/(\d)\-(\d)/g,"$1.$2"],g_baseurl="https://lite.faktura.ru/lite/app";
function login(){var a=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");var c=AnyBalance.requestGet(g_baseurl+"/pub/Login"),e=/"u":".\/([^"]+)[^}]*"f":"(id\w+)/i.exec(c);if(!e){if(getParam(c,null,null,/<title>(Профилактические работы)<\/title>/i))throw new AnyBalance.Error("В настоящее время в системе Интернет-банк проводятся профилактические работы. Пожалуйста, попробуйте ещё раз позже.");throw new AnyBalance.Error("Не удаётся найти форму входа в интернет-банк! Сайт недоступен или изменения на сайте.");
}var c=e[1],b={};b[e[2]+"_hf_0"]="";b.hasData="X";b.login=a.login;b.password=a.password;b["p::submit"]="1";c=AnyBalance.requestPost(g_baseurl+"/pub/"+c,b);if(a=getParam(c,null,null,/<span[^>]*class="feedbackPanelERROR"[^>]*>([\s\S]*?)(<script|<\/span>)/i,replaceTagsAndSpaces))throw new AnyBalance.Error(a,null,/Неверно указан логин/i.test(a));if(getParam(c,null,null,/(sms-message-panel|Введите SMS-код)/i))throw new AnyBalance.Error("Для работы этого провайдера требуется отключить в настройках интернет-банка подтверждение входа по СМС. Это безопасно, для совершения операций все равно будет требоваться подтверждение по СМС.");
AnyBalance.trace("We seem to enter the bank...");return c}
function getCards(a,c){var e=getElements(a,/<div[^>]+class="card"[^>]*>/ig);AnyBalance.trace("Найдено "+e.length+" карт");e.length&&(c.cards=[]);a=getElement(a,/<div[^>]+grouped-amount[^>]*>/i);for(var b=0;b<e.length;++b){var g={},h=e[b];getParam(h,g,"accounts.cards.__id",/<div[^>]+class="card-info"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces);getParam(h,g,"accounts.cards.num",/<div[^>]+class="card-info"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces);getParam(h,g,"accounts.cards.name",/<div[^>]+class="card-info"[^>]*>([\s\S]*?)<\/div>/i,
replaceTagsAndSpaces);getParam(h,g,"accounts.cards.balance",/<span[^>]+class="amount"[^>]*>([\s\S]*?)<\/span>/i,myReplaceTagsAndSpaces,parseBalance);getParam(h,g,["accounts.cards.currency","accounts.cards.balance"],/<span[^>]+class="currency"[^>]*>([\s\S]*?)<\/span>/i,myReplaceTagsAndSpaces);getParam(a,g,"accounts.cards.balance",null,myReplaceTagsAndSpaces,parseBalance);getParam(a,g,["accounts.cards.currency","accounts.cards.balance"],null,myReplaceTagsAndSpaces,parseCurrency);getParam(h,g,"accounts.cards.balance",
/<span[^>]+class="amount"[^>]*>([\s\S]*?)<\/span>/i,myReplaceTagsAndSpaces,parseBalance);getParam(h,g,["accounts.cards.currency","accounts.cards.balance"],/<span[^>]+class="currency"[^>]*>([\s\S]*?)<\/span>/i,myReplaceTagsAndSpaces,parseCurrency);c.cards.push(g)}}function getAccountsPage(){return getAccountsPage.html?getAccountsPage.html:getAccountsPage.html=AnyBalance.requestGet(g_baseurl+"/priv/accounts")}
function processAccounts(a,c){a=getAccountsPage();getParam(a,c,"total",/<span[^>]+class="total-block"[^>]*>([\s\S]*?)<\/span>/i,myReplaceTagsAndSpaces,parseBalance);AnyBalance.isAvailable("total","currency")&&(c.currency=getElement(a,/<span[^>]+class="total-block"[^>]*>/i,myReplaceTagsAndSpaces,parseCurrency));if(AnyBalance.isAvailable("accounts","info.address")){var e=getElements(a,/<div[^>]+class="account-(?:block|history)"[^>]*>/ig);e.length&&(c.accounts=[]);for(var b=0;b<e.length;b+=2){var g=
e[b],h=e[b+1],f=getParam(h,null,null,/<div[^>]+id="acc_([^"_]*)/i,replaceHtmlEntities),d=getParam(h,null,null,/<span[^>]+class="editable-name-block"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces),f={__id:f,__name:d+" ("+f+")"};getCards(h,f);if(__shouldProcess("accounts",f)&&(processAccount(h,f,a),AnyBalance.isAvailable("accounts.minpay","accounts.minpay_till","accounts.transactions","accounts.address","info.address")))try{processAccountTransactions(g,f,c)}catch(k){AnyBalance.trace("Выписка не получена: "+
k.message)}c.accounts.push(f)}}}function num2(a){return n2(a)}
function processAccountTransactions(a,c,e){var b=getParam(a,null,null,/div[^>]+class="more-operations[\s\S]*?href="([^"]*)/i,replaceHtmlEntities);if(!b)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти ссылку на выписку, сайт изменен?");a=AnyBalance.requestGet(g_baseurl+"/priv/"+b);getParam(a,c,"accounts.minpay",/<td[^>]*>Оплатить до[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,[replaceTagsAndSpaces,/-/,","],parseBalance);getParam(a,c,"accounts.minpay_till",/<td[^>]*>Оплатить до([^<]+)/i,replaceTagsAndSpaces,
parseDate);if(AnyBalance.isAvailable("accounts.transactions","accounts.address","info.address")){var g=getElements(a,[/<form[^>]*>/ig,/Период выписки/i])[0];if(!g)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти форму выписки, сайт изменен?");var b=getParam(g,null,null,/<form[^>]+action="([^"]*)/i,replaceHtmlEntities),h=new Date;a=createFormParams(g,function(a,b,c,d){if(/start/i.test(c))return num2(h.getDate())+"."+num2(h.getMonth()+1)+"."+(h.getFullYear()-3);if(/end/i.test(c))return num2(h.getDate())+
"."+num2(h.getMonth()+1)+"."+h.getFullYear();/id[^_]+_hf_/i.test(c)&&(a["p::submit"]="x",d=void 0);return d});a.periodType="radio53";a=AnyBalance.requestPost(joinUrl(AnyBalance.getLastUrl(),b),a);b=getParam(a,null,null,/<a[^>]+href="([^"]*)"[^>]*class="[^"]*print/i,replaceHtmlEntities);if(!b)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти ссылку на печать выписки, сайт изменен?");a=AnyBalance.requestGet(joinUrl(AnyBalance.getLastUrl(),b));b=getParam(a,null,null,/<iframe[^>]+src="([^"]*)"[^>]*id="iframeId"/i,
replaceHtmlEntities);if(!b)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти ссылку на iframe выписки, сайт изменен?");a=AnyBalance.requestGet(joinUrl(AnyBalance.getLastUrl(),b));g=getElements(a,[/<table[^>]*>/ig,/Дата операции/i])[0];if(!g)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти ссылку таблицу выписки, сайт изменен?");getParam(a,c,"accounts.address",/<td[^>]*>Адрес регистрации[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);AnyBalance.isAvailable("info.address")&&
(e.info=e.info||{},getParam(a,e.info,"info.address",/<td[^>]*>Адрес регистрации[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces));c.transactions=[];e=getParam(g,null,null,/<thead[^>]*>([\s\S]*?)<\/thead>/i);e=getElements(e,/<th[^>]*>/ig,replaceTagsAndSpaces);b={};for(a=0;a<e.length;++a)/Документ/i.test(e[a])?b.doc=a:/Дата операции/i.test(e[a])?b.date=a:/Списание|Расходы/i.test(e[a])?b.off=a:/Зачисление|Расходы/i.test(e[a])?b.on=a:/Контрагент/i.test(e[a])?b.contra=a:/Назначение|Детали операции/i.test(e[a])&&
(b.descr=a);a=getParam(g,null,null,/<tbody[^>]*>([\s\S]*?)<\/tbody>/i);g=getElements(a,/<tr[^>]*>/ig);for(a=0;a<g.length;++a){var f=getElements(g[a],/<td[^>]*>/ig);if(!(f.length<e.length)){var d={};b.hasOwnProperty("doc")&&getParam(f[b.doc],d,"accounts.transactions.doc",null,replaceTagsAndSpaces);b.hasOwnProperty("date")&&getParam(f[b.date],d,"accounts.transactions.date",null,replaceTagsAndSpaces,parseDate);b.hasOwnProperty("off")&&getParam(f[b.off],d,"accounts.transactions.sum",null,replaceTagsAndSpaces,
function(a){a=parseBalance(a);return 0<a?-a:a});b.hasOwnProperty("on")&&getParam(f[b.on],d,"accounts.transactions.sum",null,replaceTagsAndSpaces,parseBalance);b.hasOwnProperty("contra")&&getParam(f[b.contra],d,"accounts.transactions.contra",null,replaceTagsAndSpaces);b.hasOwnProperty("descr")&&getParam(f[b.descr],d,"accounts.transactions.descr",null,replaceTagsAndSpaces);c.transactions.push(d)}}}}
function followAjaxUrl(a,c){a=getParam(c,null,null,new RegExp('Wicket.Ajax.ajax\\(([^)]*"c":"'+a+'"[\\s\\S]*?\\})\\)'),null,getJsonEval);c=getParam(c,null,null,/Wicket.Ajax.baseUrl="([^"]*)/,replaceSlashes);c=AnyBalance.requestGet(g_baseurl+"/priv/"+a.u,{"Wicket-Ajax":"true","Wicket-Ajax-BaseURL":c||"priv/accounts?wicket-crypt=f6I5BkYr3fk","X-Requested-With":"XMLHttpRequest"});(a=getParam(c,null,null,/<redirect>\s*<!\[CDATA\[([\s\S]*?)\]\]>/i))&&(c=AnyBalance.requestGet(g_baseurl+"/priv/"+a));return c}
function processAccount(a,c,e){var b=getElements(a,[/<div[^>]+class="closed"[^>]*>/ig,/Дополнительно/i])[0];b&&(b=getParam(b,null,null,/<div[^>]+id="([^"]*)/i,replaceHtmlEntities),b=followAjaxUrl(b,e),a+=b);getParam(a,c,"accounts.balance",[/Средств на счете[\s\S]*?<span[^>]+class="amount"[^>]*>([\s\S]*?)<\/span>/i,/<div[^>]+class="card-amounts"[^>]*>([\s\S]*?)<\/div>/i],myReplaceTagsAndSpaces,parseBalance);getParam(a,c,["accounts.currency","accounts.own","accounts.credit_used","accounts.debt","accounts.limit"],
/<span[^>]+class="currency"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces);getParam(a,c,"accounts.own",/Остаток собственных средств[\s\S]*?<span[^>]+class="amount"[^>]*>([\s\S]*?)<\/span>/i,myReplaceTagsAndSpaces,parseBalance);getParam(a,c,"accounts.credit_used",/Использованный кредит[\s\S]*?<span[^>]+class="amount"[^>]*>([\s\S]*?)<\/span>/i,myReplaceTagsAndSpaces,parseBalance);getParam(a,c,"accounts.debt",/Начисленная задолженность[\s\S]*?<span[^>]+class="amount"[^>]*>([\s\S]*?)<\/span>/i,myReplaceTagsAndSpaces,
parseBalance);getParam(a,c,"accounts.limit",/Кредитный лимит[\s\S]*?<span[^>]+class="amount"[^>]*>([\s\S]*?)<\/span>/i,myReplaceTagsAndSpaces,parseBalance);getParam(a,c,"accounts.name",/<span[^>]+class="editable-name-block"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces);getParam(a,c,"accounts.num",/<td>Номер:[\s\S]*?<td[^>]*>([\s\S]*?)(?:\(|<\/td>)/i,replaceTagsAndSpaces);getParam(a,c,"accounts.currencyISO",/<td>Валюта:[\s\S]*?<td[^>]*>([\s\S]*?)(?:\(|<\/td>)/i,replaceTagsAndSpaces);getParam(a,c,
"accounts.fio",/<td>Владелец:[\s\S]*?<td[^>]*>([\s\S]*?)(?:\(|<\/td>)/i,replaceTagsAndSpaces);getParam(a,c,"accounts.opened",/<td>Открыт:[\s\S]*?<td[^>]*>([\s\S]*?)(?:\(|<\/td>)/i,replaceTagsAndSpaces,parseDate)}
function processInfo(a,c){AnyBalance.isAvailable("info")&&(c.info=c.info||{},AnyBalance.isAvailable("info.fio_if")&&(c.info.fio_if=getElement(a,/<span[^>]+class="name"[^>]*>/i,replaceTagsAndSpaces)),AnyBalance.isAvailable("info.fio")&&(a=getAccountsPage(),getParam(a,c.info,"info.fio",/<td>Владелец:[\s\S]*?<td[^>]*>([\s\S]*?)(?:\(|<\/td>)/i,replaceTagsAndSpaces)))}
function processTemplates(a,c){var e=getElement(a,/<div[^>]+class="templates"[^>]*>/i);e&&(c.templates=[]);for(var e=getElements(e,/<li[^>]*>/ig),b=0;b<e.length;++b){var g=e[b];if(!/<li[^>]+class="create"/i.test(g)){var h=getParam(g,null,null,/<a[^>]+class="template-name[^>]*>([\s\S]*?)<\/a>/i,replaceTagsAndSpaces),h={__id:h,__name:h};__shouldProcess("templates",h)&&processTemplate(g,h,a);c.templates.push(h)}}}
function processTemplate(a,c,e){if(AnyBalance.isAvailable("templates"))for(a=getParam(a,null,null,/<a[^>]+class="template-name"[^>]*id="([^"]*)/i,replaceHtmlEntities),a=followAjaxUrl(a,e),getParam(a,c,"type",/<h1[^>]*>([\s\S]*?)<\/h1>/i,replaceTagsAndSpaces),e=getElements(a,/<fieldset[^>]*>/ig),e.length&&(c.fieldsets=[]),a=0;a<e.length;++a){var b=e[a];if(!/<fieldset[^>]+class="submit"/i.test(b)&&!/<span>Имя платежа<\/span>/i.test(b)){var g={};getParam(b,g,"templates.fieldsets.name",/<legend[^>]*>([\s\S]*?)<\/legend>/i,
replaceTagsAndSpaces);b=getElements(b,/<(?:label|div)[^>]*>/ig);if(b.length){g.fields=[];for(var h=0;h<b.length;h+=2){var f=b[h],d=b[h+1];/^<div/i.test(f)&&(h--,d=getElement(f,/<div[^>]+inside-div[^>]*>/i),f=getElement(f,/<label[^>]+inside-div[^>]*>/i));if(!/^<[^>]*display:none/i.test(d)||!/^<[^>]*display:none/i.test(f)){var k={};getParam(f,k,"templates.fieldsets.fields.name",null,replaceTagsAndSpaces);getParam(f,k,"templates.fieldsets.fields.required",/<label[^>]+required/i,null,function(a){return!!a});
if(/<input[^>]+type="radio"/i.test(d))for(getParam(d,k,"templates.fieldsets.fields.id",/<input[^>]+type="radio"[^>]*name="([^"]*)/i,replaceHtmlEntities),f=sumParam(d,null,null,/<(?:input|label)[\s\S]*?<\/(?:span|div)/ig),d=0;d<f.length;++d){var l={};getParam(f[d],l,"templates.fieldsets.fields.options.value",/<input[^>]+type="radio"[^>]*value="([^"]*)/i,replaceHtmlEntities);getParam(f[d],l,"templates.fieldsets.fields.options.name",/<label[^>]*>[\s\S]*?<\/label>/i,replaceTagsAndSpaces);getParam(f[d],
l,"templates.fieldsets.fields.extra_id",/<input[^>]+type="text"[^>]*name="([^"]*)/i,replaceHtmlEntities);getParam(f[d],l,"templates.fieldsets.fields.extra_value",/<input[^>]+type="text"[^>]*value="([^"]*)/i,replaceHtmlEntities);getParam(f[d],l,"templates.fieldsets.fields.extra_comment",/<input[^>]+type="text"[^>]*title="([^"]*)/i,replaceHtmlEntities);/checked/i.test(f[d])&&(getParam(f[d],l,"templates.fieldsets.fields.options.value",/<input[^>]+type="radio"[^>]*value="([^"]*)/i,replaceHtmlEntities),
getParam(f[d],l,"templates.fieldsets.fields.options.value_name",/<label[^>]*>[\s\S]*?<\/label>/i,replaceTagsAndSpaces),getParam(f[d],k,"templates.fieldsets.fields.extra_id",/<input[^>]+type="text"[^>]*name="([^"]*)/i,replaceHtmlEntities),getParam(f[d],k,"templates.fieldsets.fields.extra_value",/<input[^>]+type="text"[^>]*value="([^"]*)/i,replaceHtmlEntities),getParam(f[d],k,"templates.fieldsets.fields.extra_comment",/<input[^>]+type="text"[^>]*title="([^"]*)/i,replaceHtmlEntities));AnyBalance.isAvailable("templates.fieldsets.fields.options")&&
(k.options||(k.options=[]),k.options.push(l))}else if(/<select/i.test(d))for(getParam(d,k,"id",/<select[^>]+name="([^"]*)/i,replaceHtmlEntities),f=getElements(d,/<option[^>]*>/ig),d=0;d<f.length;++d)l={},getParam(f[d],l,"templates.fieldsets.fields.options.name",null,replaceTagsAndSpaces),getParam(f[d],l,"templates.fieldsets.fields.options.value",/<option[^>]+value="([^"]*)/i,replaceHtmlEntities),/selected/i.test(f[d])&&(getParam(f[d],k,"templates.fieldsets.fields.options.value_name",null,replaceTagsAndSpaces),
getParam(f[d],k,"templates.fieldsets.fields.options.value",/<option[^>]+value="([^"]*)/i,replaceHtmlEntities)),AnyBalance.isAvailable("templates.fieldsets.fields.options")&&(k.options||(k.options=[]),k.options.push(l));else/<input[^>]+type="text"/i.test(d)?(getParam(d,k,"templates.fieldsets.fields.id",/<input[^>]+name="([^"]*)/i,replaceHtmlEntities),getParam(d,k,"templates.fieldsets.fields.value",/<input[^>]+value="([^"]*)/i,replaceHtmlEntities),getParam(d,k,"templates.fieldsets.fields.comment",/<input[^>]+title="([^"]*)/i,
replaceHtmlEntities)):/<textarea/i.test(d)?(getParam(d,k,"templates.fieldsets.fields.id",/<textarea[^>]+name="([^"]*)/i,replaceHtmlEntities),getParam(d,k,"templates.fieldsets.fields.value",/<textarea[^>]*>([\s\S]*)<\/textarea>/i,replaceTagsAndSpaces),getParam(d,k,"templates.fieldsets.fields.comment",/<input[^>]+title="([^"]*)/i,replaceHtmlEntities)):getParam(d,k,"templates.fieldsets.fields.value",null,replaceTagsAndSpaces);g.fields.push(k)}}checkDescriptiveFieldSet(g,c)||c.fieldsets.push(g)}}}}
function checkDescriptiveFieldSet(a,c){var e=a.fields.length;if(e&&2>=e){for(var b={},g=0;g<e;++g){var h=a.fields[g];if(h.id||0>["Услуга","Поставщик"].indexOf(h.name))return!1;b[h.name]=h.value}getParam(b["Услуга"],c,"templates.service");getParam(b["Поставщик"],c,"templates.provider");return!0}return!1};
