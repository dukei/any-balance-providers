var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:35.0) Gecko/20100101 Firefox/35.0"},baseurl="https://mybank.fortebank.com/";
function login(){var c=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");checkEmpty(c.login,"Введите логин!");checkEmpty(c.password,"Введите пароль!");var a=AnyBalance.requestGet(baseurl+"retail/Folder/",g_headers);if(!a||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(a),new AnyBalance.Error("Ошибка при подключении к сайту интернет-банка! Попробуйте обновить данные позже.");if(/retail\/exit\.aspx/i.test(a))AnyBalance.trace("Уже залогинены, используем существующую сессию");
else{/SessionClose/i.test(a)&&(a=AnyBalance.requestGet(baseurl+"retail/",g_headers));var b=createFormParams(a,function(b,e,d,g){return"tbLogin"==d?c.login:"tbPassword"==d?c.password:"tbLoginImg"==d?(b=getParam(a,null,null,/Captcha\/JpegImage\.aspx[^"]+/i,replaceTagsAndSpaces))?(b=AnyBalance.requestGet(baseurl+"retail/"+b,addHeaders({Referer:baseurl})),AnyBalance.retrieveCode("Пожалуйста, введите код с картинки",b,{time:18E4})):"":g});b.loginType="textLogin";a=AnyBalance.requestPost(baseurl+"retail/",
b,addHeaders({Referer:baseurl+"retail/"}))}if(!/retail\/exit\.aspx/i.test(a)){if(b=getParam(a,null,null,/<div[^>]+id="errMessage"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces))throw new AnyBalance.Error(b,null,/Проверьте правильность указания Логина и Пароля/i.test(b));AnyBalance.trace(a);throw new AnyBalance.Error("Не удалось зайти в интернет-банк. Сайт изменен?");}__setLoginSuccessful();return a}
function processCards(c,a){if(AnyBalance.isAvailable("cards")){c=AnyBalance.requestGet(baseurl+"retail/Folder/Default.aspx?fld=CardAccount",g_headers);var b=getParam(c,null,null,/<table[^>]* class="prodlist"[^>]*>[^]*?<\/table>/i);if(b=c){b=sumParam(b,null,null,/<a\s+href="\?fld=CardInfo&id=[^"]+">[\s\S]*?<\/a>/ig);AnyBalance.trace("Найдено карт: "+b.length);a.cards=[];for(var f=0;f<b.length;++f){var e=b[f],d=getParam(e,null,null,/CardInfo&id=([^"]+)/i,replaceTagsAndSpaces),g=getParam(e,null,null,
/>([\s\S]*?)<\/a>/i,replaceTagsAndSpaces),d={__id:d,__name:g};__shouldProcess("cards",d)&&processCard(e,d);a.cards.push(d)}}else/У вас нет карт/i.test(c)?(AnyBalance.trace("У вас нет карт"),a.cards=[]):(AnyBalance.trace(c),AnyBalance.trace("Не удалось найти таблицу с картами."))}}
function processCard(c,a){AnyBalance.trace("Обработка карты "+a.__name);var b=AnyBalance.requestGet(baseurl+"retail/Folder/Default.aspx?fld=CardInfo&id="+a.__id,g_headers);a.num=getParam(b,null,null,/\w+\s+№\s*([\d\*]+),/i,replaceTagsAndSpaces);getParam(b,a,"cards.balance",/Доступный баланс:(?:[^>]*>){4}([^<]+)/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"cards.limit",/Кредитный лимит:(?:[^>]*>){4}([^<]+)/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,["cards.currency","cards"],/Валюта карточного счета:(?:[^>]*>){4}([^<]+)/i,
replaceTagsAndSpaces);getParam(b,a,"cards.accnum",/Номер карточного счета:(?:[^>]*>){5}([^<]+)/i,replaceTagsAndSpaces);getParam(b,a,"cards.status",/Состояние карты:(?:[^>]*>){4}([^<]+)/i,replaceTagsAndSpaces);getParam(b,a,"cards.till",/Срок действия:(?:[^>]*>){4}([^<]+)/i,replaceTagsAndSpaces,parseDateWord);getParam(b,a,"cards.owner",/\d+[*]+\d{4}\s*,([^<]+)/i,replaceTagsAndSpaces);isAvailable("cards.transactions")&&processCardTransactions(b,a)};
