var g_headers={Accept:"application/json, text/plain, */*","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"close","User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:35.0) Gecko/20100101 Firefox/35.0"},g_baseurl="https://api2.homebank.kz/hbapi/api/v1/",g_oauth_url="https://oauth.homebank.kz/",g_token,g_fingerprint,oauth_default_client_id="hb3halyk",oauth_default_secret="F8aE1wqIUhWazLYs6qVuSwrWhglfET1r";
function callApi(b,a){if(!g_token&&"oauth2/token"!=b)throw new AnyBalance.Error("Внутренняя ошибка, сайт изменен?");var d,c,e;d=g_token?addHeaders({Authorization:"Bearer "+g_token}):addHeaders({Authorization:"Basic aGIzaGFseWs6MjE4QzIzRTItOUQ2NC00NUQ0LUJCQ0YtNUJENkNDMzE2NDg0"});a&&(d["Content-Type"]="application/json");c=g_baseurl;e=a&&JSON.stringify(a);"oauth2/token"===b&&(c=g_oauth_url,d["Content-Type"]="application/x-www-form-urlencoded; charset=UTF-8","password"===a.grant_type&&(d.Fingerprint=
getFingerprint()),e=a);a=AnyBalance.requestPost(c+b,e,d,{HTTP_METHOD:a?"POST":"GET"});if(400<=AnyBalance.getLastStatusCode()){AnyBalance.trace(a);if((a=getJson(a))&&a.UserMessage)throw new AnyBalance.Error(a.UserMessage,null,/(Вы не зарегистрированы|неверный логин)/i.test(a.UserMessage));throw new AnyBalance.Error("Ошибка вызова API "+b+": "+AnyBalance.getLastStatusCode());}return a=getJson(a)}
function login(b){b=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");AnyBalance.setOptions({SSL_ENABLED_PROTOCOLS:["TLSv1.2"]});checkEmpty(b.login,"Введите логин1!");checkEmpty(b.password,"Введите пароль2!");if(!g_token){var a=callApi("oauth2/token",{grant_type:"client_credentials",scope:"webapi sms_send verification email_send",client_id:oauth_default_client_id,client_secret:oauth_default_secret});g_token=a.access_token}a=callApi("oauth2/token",{grant_type:"password",username:b.login,
password:b.password,scope:"webapi sms_send verification email_send openapi",client_id:oauth_default_client_id,client_secret:oauth_default_secret});g_token=a.access_token}function getFingerprint(){g_fingerprint||(g_fingerprint=AnyBalance.getData("fingerprint"));if(!g_fingerprint){for(var b="",a=0;32>a;++a)b+="abcdef1234567890".charAt(Math.floor(16*Math.random()));g_fingerprint=b;AnyBalance.setData("fingerprint",b);AnyBalance.saveData()}return g_fingerprint}
function processInfo(b){if(AnyBalance.isAvailable("info")){var a=callApi("users");b.info=info={};getParam([a.lastName,a.firstName,a.middleName].join(" "),info,"info.fio");getParam(a.phone,info,"info.mphone");getParam(a.iin,info,"info.iin")}}
function processAccounts(b){if(isAvailable("accounts")){var a=callApi("accounts");AnyBalance.trace("Найдено счетов: "+a.length);b.accounts=[];for(var d=0;d<a.length;++d){var c=a[d],c={__id:c.systemAttributeId,__name:c.aliasName?c.aliasName:c.accName+" "+c.currency+" "+c.iban,num:c.iban};__shouldProcess("accounts",c)&&processAccount(a[d],c);b.accounts.push(c)}}}
function processAccount(b,a){getParam(b.balance,a,"accounts.balance");getParam(b.blockedAmount,a,"accounts.blocked");getParam(b.currency,a,["accounts.currency","accounts.blocked","accounts.balance"]);getParam(b.iban,a,"accounts.num");getParam(b.openDate,a,"accounts.date_start",null,null,parseDateISO);"undefined"!=typeof processAccountTransactions&&processAccountTransactions(b,a)}
function processCards(b){if(isAvailable("cards")){var a=callApi("cards");AnyBalance.trace("Найдено карт: "+a.length);b.cards=[];for(var d=0;d<a.length;++d){var c=a[d];if("C"===c.cardInfo.accountType){var e=c.systemAttributeId,c=resolveCardAlias(c)+" "+c.cardInfo.cardMask.substr(-4),e={__id:e,__name:c};__shouldProcess("cards",e)&&processCard(a[d],e);b.cards.push(e)}}}}
function processCard(b,a){b=b.cardInfo;for(var d=0;d<b.balances.length;d++){var c=b.balances[d];sumParam(c.amount,a,"cards.balance_"+c.curr.toLowerCase(),null,null,null,aggregate_sum)}getParam(b.currency,a,["cards.currency"]);getParam(b.creditLimit,a,"cards.limit");getParam(b.blockedAmount,a,"cards.blocked");getParam(b.cardMask,a,"cards.num");getParam(b.iban,a,"cards.accnum");getParam("01."+b.expirationDates.expMonth+"."+b.expirationDates.expYear,a,"cards.till",null,replaceTagsAndSpaces,parseDate)}
function resolveCardAlias(b){if(b.aliasName&&b.aliasName.length)return b.aliasName;if("444482_729246"===b.cardInfo.contrSubtypeCode||"510145_735174"===b.cardInfo.contrSubtypeCode)return"Homebank Wallet";var a;switch(getCardType(b.cardInfo.cardNum||b.cardInfo.cardMask)){case "visa":a="VISA";break;case "mastercard":a="MasterCard";break;case "unionpay":a="Union Pay";break;default:a="Карта"}return b.cardInfo.isMultiCurrency?a+" Мультивалютная":a}
function getCardType(b){var a={electron:/^(4026|417500|440564|4508|4844|4913|4917)\d*$/,maestro:/^(5018|5020|5038|5612|5893|6304|6759|6761|6762|6763|0604|6390)\d*$/,dankort:/^(5019)\d*$/,interpayment:/^(636)\d+$/,unionpay:/^(62|88)\d+$/,visa:/^4\d+$/,mastercard:/^5[1-5]\d+$/,diners:/^3(?:0[0-5]|[68][0-9])\d+$/,discover:/^6(?:011|5[0-9]{2})\d+$/,jcb:/^(?:2131|1800|35\d{3})\d{11}$/,amex:/^3[47]\d+$/};b=(""+b).substr(0,4);for(var d in a)if(a[d].test(b))return d}
function processDeposits(b){if(isAvailable("deposits")){var a=callApi("deposits");AnyBalance.trace("Найдено депозитов: "+a.length);b.deposits=[];for(var d=0;d<a.length;++d){var c=a[d],c={__id:c.systemAttributeId,__name:c.aliasName?c.aliasName:c.depositAccounts[0].depName,num:c.depositAccounts[0].iban};__shouldProcess("deposits",c)&&processDeposit(a[d],c);b.deposits.push(c)}}}
function processDeposit(b,a){getParam(b.depositAccounts[0].iban,a,"deposits.num");getParam(b.depositAccounts[0].balance,a,"deposits.balance");getParam(b.depositAccounts[0].currency,a,["deposits.currency","deposits.balance","deposits.pcts"]);getParam(b.depositAccounts[0].rate,a,"deposits.pct");getParam(b.depositAccounts[0].interest,a,"deposits.pcts");getParam(b.closeDate,a,"deposits.till",null,null,parseDateISO);getParam(b.openDate,a,"deposits.date_start",null,null,parseDateISO);getParam(b.depositAccounts[0].depName,
a,"deposits.name")}
function processCredits(b){if(AnyBalance.isAvailable("credits")){var a=getElement(html,/<li[^>]+data-menu-value="loan_accounts"[^>]*>/i);if(a){var d=getElements(a,/<div[^>]+class="item"[^>]*>/ig);AnyBalance.trace("Найдено кредитов: "+d.length);b.credits=[];(a=getElement(a,/<div[^>]+error_box[^>]*>/i,replaceTagsAndSpaces))&&AnyBalance.trace("!!!!!! "+a);for(var c=0;c<d.length;++c){var e=d[c],f=getElementsByClassName(e,"account_mask",replaceTagsAndSpaces)[0],g=getElement(e,/<div[^>]+account_name[^>]*>/i,replaceTagsAndSpaces),
f={__id:f,__name:g+" "+f.substr(-4),num:f,error:a};__shouldProcess("credits",f)&&!a&&(getParam(g,b,"credits.name"),processCredit(e,f));b.credits.push(f)}}else/<li[^>]+loan_accounts/i.test(html)?(AnyBalance.trace(html),AnyBalance.trace("Не удалось найти перечень кредитов.")):(AnyBalance.trace("У вас нет кредитов"),b.credits=[])}}
function processCredit(b,a){AnyBalance.trace("Обработка кредита "+a.__name);getParam(b,a,"credits.balance",/<span[^>]+class="account_amount_val"[\s\S]*?<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,["credits.currency","credits.balance"],/<span[^>]+class="account_amount_val"[\s\S]*?<\/span>/i,replaceTagsAndSpaces,parseCurrency);b=getParam(b,null,null,/fid=([^&"'\s]+)/i,replaceHtmlEntities);AnyBalance.isAvailable("credits.limit","credits.till","credits.date_start","credits.pct","credits.pct_kok",
"credits.status")&&(b=AnyBalance.requestGet(baseurl+"finance/accounts/overview.htm?fid="+b,g_headers),getParam(b,a,"credits.limit",/Общая сумма кредита[\s\S]*?<div[^>]+class="cell"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces),getParam(b,a,"credits.till",/Дата завершения договора[\s\S]*?<div[^>]+class="cell"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseDate),getParam(b,a,"credits.date_start",/Дата заключения договора[\s\S]*?<div[^>]+class="cell"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,
parseDate),getParam(b,a,"credits.pct",/Процентная ставка(?:\s|<[^>]*>)*:[\s\S]*?<div[^>]+class="cell"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance),getParam(b,a,"credits.pct_kok",/Процентная ставка КОК[\s\S]*?<div[^>]+class="cell"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance),getParam(b,a,"credits.status",/Статус счета(?:\s|<[^>]*>)*:[\s\S]*?<div[^>]+class="cell"[^>]*>([\s\S]*?)<\/div>/i,[/<a[^>]*>[\s\S]*?<\/a>/i,"",replaceTagsAndSpaces]),isAvailable("credits.schedule")&&
processCreditSchedule(b,a))}function processBonuses(b){if(AnyBalance.isAvailable("bonus")){for(var a=callApi("go-bonuses"),d=!1,c=0;c<a.length;++c){var e=a[c];if(12===e.bonusInfo.clients.pool){b.bonus=e.bonusInfo.clients.client.amount;d=!0;break}}if(!d)throw new AnyBalance.Error("Не удаётся получить информацию о бонусах");}};
