var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.3; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.116 Safari/537.36"},baseurl="https://kaspi.kz";
function login(){var c=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");if(AnyBalance.getData){var a=AnyBalance.getData("kaspi-tag"),b=AnyBalance.getData("kaspi-uid");a&&b&&(AnyBalance.setCookie("kaspi.kz","kaspi-tag",a),AnyBalance.setCookie("kaspi.kz","kaspi-uid",b))}checkEmpty(c.login,"Введите логин!");checkEmpty(c.password,"Введите пароль!");AnyBalance.requestGet(baseurl,g_headers);a=AnyBalance.requestGet(baseurl+"/entrance?ref=startHeader",g_headers);if(!a||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(a),
new AnyBalance.Error("Ошибка при подключении к сайту интернет-банка! Попробуйте обновить данные позже.");if(/logout/i.test(a))AnyBalance.trace("Уже залогинены, используем существующую сессию");else{b=getElement(a,/<form[^>]+LoginForm/i);if(!b)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось получить форму авторизации. Сайт изменен?");a=AB.createFormParams(b,function(a,b,d,e){return"Login"==d?c.login:"Password"==d?c.password:e});a=AnyBalance.requestPost(baseurl+"/entrance/SignIn",a,addHeaders({Referer:baseurl+
"/entrance"}));if(b=getParam(a,null,null,/<div[^>]+class="entrance__inputErrorMessage[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces))throw new AnyBalance.Error(b,null,/Пароль введен неверно/i.test(b));if(/SMSCodeForm/i.test(a)){AnyBalance.trace("Отправляем запрос на сервер для получения SMS-кода");var b=AnyBalance.requestPost(baseurl+"/entrance/SendEntranceOtp",null,addHeaders({"X-Requested-With":"XMLHttpRequest",Accept:"application/json, text/javascript, */*; q=0.01",Referer:baseurl+"/entrance/SignIn"})),
d=getJson(b);if("OK"!==d.status)throw AnyBalance.trace(b),AnyBalance.trace("Сервер должен был отправить SMS с кодом, но вернул ошибку"),new AnyBalance.Error("Не удалось отправить SMS с кодом. Сайт изменен?");var e=AnyBalance.retrieveCode("Вам отправлено SMS-сообщение с кодом для входа в личный кабинет Каспи банка. Введите код из SMS",null,{inputType:"number",minLength:4,maxLength:4,time:3E5}),b=AnyBalance.requestPost(baseurl+"/entrance/CheckEntranceOtp",{otp:e},addHeaders({"X-Requested-With":"XMLHttpRequest",
Accept:"application/json, text/javascript, */*; q=0.01","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Referer:baseurl+"/entrance/SignIn"})),d=getJson(b);if("INVALID_OTP"===d.status)throw AnyBalance.trace("Введен некорректный код из SMS"),new AnyBalance.Error("Вы ввели некорректный код из SMS. Попробуйще ещё раз.");if("OK"!==d.status)throw AnyBalance.trace(b),AnyBalance.trace("При проверке кода из SMS произошла неизвестная ошибка."),new AnyBalance.Error("Не удалось проверить код из SMS. Сайт изменен?");
b=getElement(a,/<form[^>]+SMSCodeForm/i);if(!b)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось получить форму ввода кода из SMS. Сайт изменен?");a=AB.createFormParams(b,function(a,b,d,h){return"Otp"==d?e:"Login"==d?c.login:h});a=AnyBalance.requestPost(baseurl+"/entrance/SignIn",a,addHeaders({Referer:baseurl+"/entrance/SignIn"}))}if(!/logout/i.test(a))throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось зайти в интернет-банк. Сайт изменен?");AnyBalance.setData&&(AnyBalance.setData("kaspi-tag",
AnyBalance.getCookie("kaspi-tag")),AnyBalance.setData("kaspi-uid",AnyBalance.getCookie("kaspi-uid")),AnyBalance.saveData())}a=AnyBalance.requestGet(baseurl+"/bank",g_headers);__setLoginSuccessful();return a}
function processCards(c,a){if(AnyBalance.isAvailable("cards")){var b=[],d=getParam(c,null,null,/<a[^>]+class="myProductsMenu__link[^>]+href="([^>]*?)"[^>]*>\s*Kaspi Gold/i);if(d){AnyBalance.trace("Нашли карту Kaspi Gold, получаем базовую информацию.");c=AnyBalance.requestGet(baseurl+d,g_headers);var e=AB.getParam(c,null,null,/<div[^>]+bankProducts__item--gold[\s\S]*?bankProducts__title[^>]*?>([\s\S]*?)<div/i,AB.replaceTagsAndSpaces);b.push({url:d,type:"gold",title:e,html:c})}if(b.length)for(AnyBalance.trace("Найдено карт: "+
b.length),a.cards=[],c=0;c<b.length;++c)d=b[c],e={__id:d.title,__name:d.title,num:d.title},__shouldProcess("cards",e)&&processCard(d,e),a.cards.push(e);else AnyBalance.trace(c),AnyBalance.trace("У вас нет карт.")}}
function processCard(c,a){AnyBalance.trace("Обработка карты "+a.__name);var b=c.html;AB.getParam(b,a,"cards.balance",/Доступно(?:[^>]*>){2}([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseBalanceSilent);AB.getParam(b,a,["cards.currency","cards.balance"],/Доступно(?:[^>]*>){2}([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseCurrency);(b=AB.getParam(b,null,null,/<a[^>]+href="([^"]*)"[^>]+class="[^"]+productsMainMenu__item--card[^"]+"/i))?(b=AnyBalance.requestGet(baseurl+b,g_headers),AB.getParam(b,
a,"cards.num",/Номер карты(?:[^>]*>){2}([^<]*)/i,AB.replaceTagsAndSpaces),AB.getParam(b,a,"cards.status",/Статус(?:[^>]*>){2}([^<]*)/i,AB.replaceTagsAndSpaces),AB.getParam(b,a,"cards.till",/Срок действия(?:[^>]*>){2}([^<]*)/i,AB.replaceTagsAndSpaces,AB.parseDateWord)):(AnyBalance.trace(c),AnyBalance.trace("Не удалось найты ссылку на страницу с информацией о карте. Сайт изменён?"))}
function processDeposits(c,a){if(AnyBalance.isAvailable("deposits")){var b=getParam(c,null,null,/<a[^>]+class="myProductsMenu__link[^>]+href="([^>]*?)"[^>]*>\s*Депозиты/i);c=AnyBalance.requestGet(baseurl+b,g_headers);b=AB.getElements(c,/<a[^>]+myProductsSubMenu__link[^>]*\/bank\/Deposit\/\d+"[^>]*>/ig);!b.length&&/\/Deposit\/\d+\/History$/i.test(AnyBalance.getLastUrl())&&(AnyBalance.trace("Депозит, видимо, только один. Оказались на его странице"),b=['<a href="'+AnyBalance.getLastUrl().replace(/\/History$/i,
"")+'">']);b.length||(AnyBalance.trace(c),AnyBalance.trace("Не удалось найти депозиты. Сайт изменён?"));AnyBalance.trace("Найдено депозитов: "+b.length);a.deposits=[];for(var d=0;d<b.length;d++)if(c=AB.getParam(b[d],null,null,/<a[^>]+href="([^"]*)"[^>]*>/i)){c=AnyBalance.requestGet(joinUrl(baseurl,c+"/About"),g_headers);var e=AB.getParam(c,null,null,/Номер счета Депозита:(?:[^>]*>){2}([^<]*)/i,AB.replaceTagsAndSpaces),f=AB.getParam(c,null,null,/Номер счета Депозита:(?:[^>]*>){2}([^<]*)/i,AB.replaceTagsAndSpaces),
g=AB.getParam(c,null,null,/Название(?:[^>]*>){2}([^<]*)/i,AB.replaceTagsAndSpaces),e={__id:e,__name:g,num:f};__shouldProcess("deposits",e)&&processDeposit(b[d],e,c);a.deposits.push(e)}else AnyBalance.trace("Не удалось найти ссылку на страницу с информацией о депозите. Сайт изменён?")}}
function processDeposit(c,a,b){AB.getParam(b,a,"deposits.balance",/Накоплено(?:[^>]*>){2}([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseBalance);AB.getParam(b,a,"deposits.agreement",/Номер договора(?:[^>]*>){2}([^<]*)/i,AB.replaceTagsAndSpaces);AB.getParam(b,a,"deposits.date_start",/Вы открыли вклад(?:[^>]*>){2}([^<]*)/i,AB.replaceTagsAndSpaces,AB.parseDate);AB.getParam(b,a,"deposits.dvk_till",/Дата будущего продления(?:[^>]*>){2}([^<]*)/i,AB.replaceTagsAndSpaces,AB.parseDate);AB.getParam(b,
a,"deposits.pct",/Эффективная ставка(?:[^>]*>){2}([^<]*)/i,AB.replaceTagsAndSpaces,AB.parseBalance);AB.getParam(b,a,"deposits.withdraw",/Доступно для снятия(?:[\s\S]*?<span[^>]*>)([^<]*)/i,AB.replaceTagsAndSpaces,AB.parseBalance);AB.getParam(b,a,"deposits.currency",/Валюта Депозита(?:[^>]*>){2}([^<]*)/i,[AB.replaceTagsAndSpaces,/(.*?)/i,"0$1"],AB.parseCurrency);AB.getParam(b,a,"deposits.dvk_status",/<div[^>]+class="text dvk_status"(?:[^>]*>){4}([^<]*)/i,AB.replaceTagsAndSpaces);AB.getParam(b,a,"deposits.dvk_num",
/<div[^>]+class="dvkcard_number"[^>]*>([^<]*)/i,AB.replaceTagsAndSpaces);AB.getParam(b,a,"deposits.dvk_till",/<div[^>]+class="card_valid_thru"[^>]*>([^<]*)/i,AB.replaceTagsAndSpaces,AB.parseDate)}function processCredits(c,a){throw new AnyBalance.Error("Получение информации о кретидах ещё не реализовано. Обратитесь к разработчику программы.");}
function processCredit(c,a){AnyBalance.trace("Обработка кредита "+a.__name);AB.getParam(c,a,"credits.balance",/<span[^>]+"e-limit__info__amount"[^>]*>([\s\S]*?)<div/i,AB.replaceTagsAndSpaces,AB.parseBalance);AB.getParam(c,a,["credits.currency","credits.balance"],/<span[^>]+"e-limit__info__amount"[^>]*>([\s\S]*?)<div/i,AB.replaceTagsAndSpaces,AB.parseCurrency);AB.getParam(c,a,"credits.paid",/<span[^>]+"e-limit__subtext e-funds__amount"[^>]*>([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseBalance);
AB.getParam(c,a,"credits.next_pay",/<span[^>]+"e-plan__info__amount"[^>]*>([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseBalance);AB.getParam(c,a,"credits.pay_till",/<span[^>]+"e-transfer__day"[^>]*>([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseDateWord);AB.getParam(c,a,"credits.date_start",/Вы взяли кредит([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseDate);AB.getParam(c,a,"credits.period",/На срок([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseBalance);AB.getParam(c,a,"credits.period_left",
/Осталось выплачивать([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseBalance);AnyBalance.isAvailable("credits.schedule")&&processCreditSchedule(c,a)}
function processWallet(c,a){if(AnyBalance.isAvailable("info.wallet")){var b=getParam(c,null,null,/<a[^>]+class="myProductsMenu__link[^>]+href="([^>]*?)"[^>]*>\s*Kaspi Кошелек/i);b?(c=AnyBalance.requestGet(baseurl+b,g_headers),a=a.info,getParam(c,a,"info.wallet",/Доступно(?:[^>]*>){2}([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseBalance),getParam(c,a,["info.currency","info.wallet"],/Доступно(?:[^>]*>){2}([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseCurrency)):(AnyBalance.trace(c),AnyBalance.trace("Не удалось найти ссылку на страницу Kaspi Кошелька."))}}
function processBonuses(c,a){AnyBalance.isAvailable("info.bonus")&&(c=AnyBalance.requestGet(baseurl+"/bonus",g_headers),getParam(c,a.info,"info.bonus",/Доступно(?:[^>]*>){2}([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseBalance))}function processInfo(c,a){var b=a.info={};getParam(getElement(c,/<span[^>]+headerAuth__user/i),b,"info.fio",null,AB.replaceTagsAndSpaces);processWallet(c,a);processBonuses(c,a)};
