var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.3; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.116 Safari/537.36"},baseurl="https://kaspi.kz";
function login(){var b=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");if(AnyBalance.getData){var a=AnyBalance.getData("kaspi-tag");a&&AnyBalance.setCookie("kaspi.kz","kaspi-tag",a)}checkEmpty(b.login,"Введите логин!");checkEmpty(b.password,"Введите пароль!");var a=AnyBalance.requestGet(baseurl+"/entrance",g_headers),c;if(!a||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(a),new AnyBalance.Error("Ошибка при подключении к сайту интернет-банка! Попробуйте обновить данные позже.");
if(/logout/i.test(a))AnyBalance.trace("Уже залогинены, используем существующую сессию");else{c=getElement(a,/<form[^>]+LoginForm/i);if(!c)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось получить форму авторизации. Сайт изменен?");a=AB.createFormParams(c,function(a,c,d,e){return"Login"==d?b.login:"Password"==d?b.password:e});a=AnyBalance.requestPost(baseurl+"/SignIn",a,addHeaders({Referer:baseurl+"/entrance"}));if(c=getParam(a,null,null,/<div[^>]+class="entrance__inputErrorMessage[^>]*>([\s\S]*?)<\/div>/i,
replaceTagsAndSpaces))throw new AnyBalance.Error(c,null,/Пароль введен неверно/i.test(c));if(/SMSCodeForm/i.test(a)){AnyBalance.trace("Отправляем запрос на сервер для получения SMS-кода");var d=AnyBalance.requestPost(baseurl+"/SendEntranceOtp",null,addHeaders({"X-Requested-With":"XMLHttpRequest",Accept:"application/json, text/javascript, */*; q=0.01",Referer:baseurl+"/SignIn"}));c=getJson(d);if("OK"!==c.status)throw AnyBalance.trace(d),AnyBalance.trace("Сервер должен был отправить SMS с кодом, но вернул ошибку"),
new AnyBalance.Error("Не удалось отправить SMS с кодом. Сайт изменен?");var e=AnyBalance.retrieveCode("Вам отправлено SMS-сообщение с кодом для входа в личный кабинет Каспи банка. Введите код из SMS",null,{inputType:"number",minLength:4,maxLength:4,time:3E5}),d=AnyBalance.requestPost(baseurl+"/CheckEntranceOtp",{otp:e},addHeaders({"X-Requested-With":"XMLHttpRequest",Accept:"application/json, text/javascript, */*; q=0.01","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Referer:baseurl+
"/SignIn"}));c=getJson(d);if("INVALID_OTP"===c.status)throw AnyBalance.trace("Введен некорректный код из SMS"),new AnyBalance.Error("Вы ввели некорректный код из SMS. Попробуйще ещё раз.");if("OK"!==c.status)throw AnyBalance.trace(d),AnyBalance.trace("При проверке кода из SMS произошла неизвестная ошибка."),new AnyBalance.Error("Не удалось проверить код из SMS. Сайт изменен?");c=getElement(a,/<form[^>]+SMSCodeForm/i);if(!c)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось получить форму ввода кода из SMS. Сайт изменен?");
a=AB.createFormParams(c,function(a,c,d,h){return"Otp"==d?e:"Login"==d?b.login:h});a=AnyBalance.requestPost(baseurl+"/SignIn",a,addHeaders({Referer:baseurl+"/SignIn"}))}if(!/logout/i.test(a))throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось зайти в интернет-банк. Сайт изменен?");AnyBalance.setData&&(AnyBalance.setData("kaspi-tag",AnyBalance.getCookie("kaspi-tag")),AnyBalance.saveData())}__setLoginSuccessful();return a}
function processCards(b,a){if(AnyBalance.isAvailable("cards")){var c=[],d=getParam(b,null,null,/<a[^>]+class="myProductsMenu__link[^>]+href="([^>]*?)"[^>]*>\s*Kaspi Gold/i);if(d){AnyBalance.trace("Нашли карту Kaspi Gold, получаем базовую информацию.");b=AnyBalance.requestGet(baseurl+d,g_headers);var e=AB.getParam(b,null,null,/<div[^>]+bankProducts__item--gold[\s\S]*?bankProducts__title[^>]*?>([\s\S]*?)<div/i,AB.replaceTagsAndSpaces);c.push({url:d,type:"gold",title:e,html:b})}if(c.length)for(AnyBalance.trace("Найдено карт: "+
c.length),a.cards=[],b=0;b<c.length;++b)d=c[b],e={__id:d.title,__name:d.title,num:d.title},__shouldProcess("cards",e)&&processCard(d,e),a.cards.push(e);else AnyBalance.trace(b),AnyBalance.trace("У вас нет карт.")}}
function processCard(b,a){AnyBalance.trace("Обработка карты "+a.__name);var c=b.html;AB.getParam(c,a,"cards.balance",/Доступно(?:[^>]*>){2}([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseBalanceSilent);AB.getParam(c,a,["cards.currency","cards.balance"],/Доступно(?:[^>]*>){2}([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseCurrency);(c=AB.getParam(c,null,null,/<a[^>]+href="([^"]*)"[^>]+class="[^"]+productsMainMenu__item--card[^"]+"/i))?(c=AnyBalance.requestGet(baseurl+c,g_headers),AB.getParam(c,
a,"cards.num",/Номер карты(?:[^>]*>){2}([^<]*)/i,AB.replaceTagsAndSpaces),AB.getParam(c,a,"cards.status",/Статус(?:[^>]*>){2}([^<]*)/i,AB.replaceTagsAndSpaces),AB.getParam(c,a,"cards.till",/Срок действия(?:[^>]*>){2}([^<]*)/i,AB.replaceTagsAndSpaces,AB.parseDateWord)):(AnyBalance.trace(b),AnyBalance.trace("Не удалось найты ссылку на страницу с информацией о карте. Сайт изменён?"))}
function processDeposits(b,a){if(AnyBalance.isAvailable("deposits")){var c=getParam(b,null,null,/<a[^>]+class="myProductsMenu__link[^>]+href="([^>]*?)"[^>]*>\s*Депозиты/i);b=AnyBalance.requestGet(baseurl+c,g_headers);c=AB.getElements(b,/<a[^>]+myProductsSubMenu__link[^>]*>/ig);c||(AnyBalance.trace(b),AnyBalance.trace("Не удалось найти депозиты. Сайт изменён?"));AnyBalance.trace("Найдено депозитов: "+c.length);a.deposits=[];for(var d=0;d<c.length;d++)if(b=AB.getParam(c[d],null,null,/<a[^>]+href="([^"]*)"[^>]*>/i)){b=
AnyBalance.requestGet(baseurl+b+"/About",g_headers);var e=AB.getParam(b,null,null,/Номер счета Депозита:(?:[^>]*>){2}([^<]*)/i,AB.replaceTagsAndSpaces),f=AB.getParam(b,null,null,/Номер счета Депозита:(?:[^>]*>){2}([^<]*)/i,AB.replaceTagsAndSpaces),g=AB.getParam(b,null,null,/Название(?:[^>]*>){2}([^<]*)/i,AB.replaceTagsAndSpaces),e={__id:e,__name:g,num:f};__shouldProcess("deposits",e)&&processDeposit(c[d],e,b);a.deposits.push(e)}else AnyBalance.trace("Не удалось найти ссылку на страницу с информацией о депозите. Сайт изменён?")}}
function processDeposit(b,a,c){AB.getParam(c,a,"deposits.balance",/Накоплено(?:[^>]*>){2}([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseBalance);AB.getParam(c,a,"deposits.agreement",/Номер договора(?:[^>]*>){2}([^<]*)/i,AB.replaceTagsAndSpaces);AB.getParam(c,a,"deposits.date_start",/Вы открыли вклад(?:[^>]*>){2}([^<]*)/i,AB.replaceTagsAndSpaces,AB.parseDate);AB.getParam(c,a,"deposits.pct",/Эффективная ставка(?:[^>]*>){2}([^<]*)/i,AB.replaceTagsAndSpaces,AB.parseBalance);AB.getParam(c,a,"deposits.withdraw",
/Доступно для снятия(?:[\s\S]*?<span[^>]*>)([^<]*)/i,AB.replaceTagsAndSpaces,AB.parseBalance);AB.getParam(c,a,"deposits.currency",/Валюта Депозита(?:[^>]*>){2}([^<]*)/i,[AB.replaceTagsAndSpaces,/(.*?)/i,"0$1"],AB.parseCurrency);AB.getParam(c,a,"deposits.dvk_status",/<div[^>]+class="text dvk_status"(?:[^>]*>){4}([^<]*)/i,AB.replaceTagsAndSpaces);AB.getParam(c,a,"deposits.dvk_num",/<div[^>]+class="dvkcard_number"[^>]*>([^<]*)/i,AB.replaceTagsAndSpaces);AB.getParam(c,a,"deposits.dvk_till",/<div[^>]+class="card_valid_thru"[^>]*>([^<]*)/i,
AB.replaceTagsAndSpaces,AB.parseDate)}function processCredits(b,a){throw new AnyBalance.Error("Получение информации о кретидах ещё не реализовано. Обратитесь к разработчику программы.");}
function processCredit(b,a){AnyBalance.trace("Обработка кредита "+a.__name);AB.getParam(b,a,"credits.balance",/<span[^>]+"e-limit__info__amount"[^>]*>([\s\S]*?)<div/i,AB.replaceTagsAndSpaces,AB.parseBalance);AB.getParam(b,a,["credits.currency","credits.balance"],/<span[^>]+"e-limit__info__amount"[^>]*>([\s\S]*?)<div/i,AB.replaceTagsAndSpaces,AB.parseCurrency);AB.getParam(b,a,"credits.paid",/<span[^>]+"e-limit__subtext e-funds__amount"[^>]*>([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseBalance);
AB.getParam(b,a,"credits.next_pay",/<span[^>]+"e-plan__info__amount"[^>]*>([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseBalance);AB.getParam(b,a,"credits.pay_till",/<span[^>]+"e-transfer__day"[^>]*>([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseDateWord);AB.getParam(b,a,"credits.date_start",/Вы взяли кредит([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseDate);AB.getParam(b,a,"credits.period",/На срок([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseBalance);AB.getParam(b,a,"credits.period_left",
/Осталось выплачивать([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseBalance);AnyBalance.isAvailable("credits.schedule")&&processCreditSchedule(b,a)}
function processWallet(b,a){if(AnyBalance.isAvailable("info.wallet")){var c=getParam(b,null,null,/<a[^>]+class="myProductsMenu__link[^>]+href="([^>]*?)"[^>]*>\s*Kaspi Кошелек/i);c?(b=AnyBalance.requestGet(baseurl+c,g_headers),a=a.info,getParam(b,a,"info.wallet",/Доступно(?:[^>]*>){2}([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseBalance),getParam(b,a,["info.currency","info.wallet"],/Доступно(?:[^>]*>){2}([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseCurrency)):(AnyBalance.trace(b),AnyBalance.trace("Не удалось найти ссылку на страницу Kaspi Кошелька."))}}
function processBonuses(b,a){AnyBalance.isAvailable("info.bonus")&&(b=AnyBalance.requestGet(baseurl+"/bonus",g_headers),getParam(b,a.info,"info.bonus",/Доступно(?:[^>]*>){2}([\s\S]*?)<\/div>/i,AB.replaceTagsAndSpaces,AB.parseBalance))}function processInfo(b,a){var c=a.info={};getParam(b,c,"info.fio",/<span[^>]+headerAuth__user[^>]*>([^<]*)/i,AB.replaceTagsAndSpaces);processWallet(b,a);processBonuses(b,a)};
