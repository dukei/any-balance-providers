function encryptPass(b,c){if(c){var a;c=c.split(",");for(var d="";""!=b;)a=b.substr(0,1),a=a.charCodeAt(0),255<a&&(a-=848),7622==a&&(a=185),b=1<b.length?b.substr(1,b.length):"",""!=d&&(d+=";"),d+=c[a];return d}return b}var g_headers={"Accept-Language":"ru, en",BSSHTTPRequest:1,"User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/21.0.1180.60 Safari/537.1"},g_baseurl,g_jsonInfo;
function login(b){var c=AnyBalance.getPreferences();g_baseurl=b;if(g_jsonInfo)AnyBalance.trace("Сессия уже начата, используем её"),c=g_jsonInfo;else{var a=AnyBalance.requestGet(b+"T=RT_2Auth.BF"),d=getParam(a,null,null,/<input[^>]*name="MapID"[^>]*value="([^"]*)"/i),a=getParam(a,null,null,/var\s+PassTemplate\s*=\s*new\s+Array\s*\(([^\)]*)/i),a=encryptPass(c.password,a),a=AnyBalance.requestPost(b,{tic:0,T:"RT_2Auth.CL",A:c.login,B:a,L:"russian",C:"",IdCaptcha:"",IMode:"",sTypeInterface:"default",MapID:d||
""},g_headers);if(c=getParam(a,null,null,/<BSS_ERROR>\d*\|?([\s\S]*?)<\/BSS_ERROR>/i,replaceTagsAndSpaces))throw new AnyBalance.Error(c,null,/парол/i.test(c));c=getJsonObject(a,/ClientInfo=/i);if(!c)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти информацию о сессии в ответе банка.");AnyBalance.requestPost(b,{SID:c.SID,tic:1,T:"rt_0clientupdaterest.doheavyupd"},g_headers);d=0;do{AnyBalance.trace("Ожидание обновления данных: "+(d+1));a=AnyBalance.requestPost(b,{SID:c.SID,tic:1,T:"rt_0clientupdaterest.CheckForAcyncProcess"},
addHeaders({Referer:b+"T=RT_2Auth.BF"}));if(a=getParam(a,null,null,/^\s*(?:<BSS_ERROR>([\s\S]*?)<\/BSS_ERROR>)?([\s\S]*>)?\d+\s*$/i,replaceTagsAndSpaces)){AnyBalance.trace("Обновление данных закончено. "+a);break}if(10<++d){AnyBalance.trace("Не удалось за 10 попыток обновить баланс, получаем старое значение...");break}AnyBalance.sleep(3E3)}while(1);g_jsonInfo=c;__setLoginSuccessful()}return c}
function processCredits(b,c){var a=AnyBalance.requestPost(g_baseurl,{WidgetID:"CREDITS",Action:"Default",Template:"Simple",SchemeName:"",BlockName:""},addHeaders({BSSHTTPRequest:"1","X-Requested-With":"XMLHttpRequest",BSSHTTPRequestExt:"1","RTS-Request":"SID="+b.SID+"&T=bss_plugins_core.widget&tic=1&isNewCore=1",Referer:g_baseurl})),d=getParam(a,/Всего\s*<strong[^>]*>([\s\S]*?)<\/strong>\s*кредит/i,replaceTagsAndSpaces,parseBalance);if(d)for(AnyBalance.trace("Заявлено "+d+" кредитов"),a=getElements(a,
/<div[^>]+credit-item/ig),c.credits=[],AnyBalance.trace("Найдено "+a.length+" кредитов"),d=0;d<a.length;++d){var f=a[d],e=getParam(f,/getFormNickName\s*\([^),],\s*'([^']*)/i,replaceHtmlEntities),g=getElement(f,/<div[^>]+credit_name/i,replaceTagsAndSpaces),e={__id:e,__name:g,num:e};__shouldProcess("credits",e)&&processCredit(b,f,e);c.credits.push(e)}else AnyBalance.trace("Похоже, кредитов нет...\n"+(isset(d)?"":a))}
function processAccounts(b,c){var a=AnyBalance.requestPost(g_baseurl,{SID:b.SID,tic:1,T:"RT_2IC.form",nvgt:1,SCHEMENAME:"STM",XACTION:"NEW"},addHeaders({Referer:g_baseurl})),d=getElement(a,/<table[^>]+id="SCROLLER"[^>]*>/i);if(d){d=getElements(d,/<(?:thead|tbody)[^>]*>/ig);if(!/<thead/i.test(""+d[0]))throw AnyBalance.trace(a),new AnyBalance.Error("Не удаётся найти заголовок таблицы счетов. Сайт изменен?");if(!/<tbody/i.test(""+d[1]))throw AnyBalance.trace(a),new AnyBalance.Error("Не удаётся найти тело таблицы счетов. Сайт изменен?");
c.accounts=[];for(var a=getColsAccount(d[0]),d=getElements(d[1],/<tr[^>]*>/ig),f=0;f<d.length;++f){var e=d[f],g=getElements(e,/<td[^>]*>/ig),e=getParam(e,null,null,/<input[^>]+type="checkbox"[^>]*STM="([^"]*)/i,replaceHtmlEntities),h=getParam(g[a.name],null,null,null,replaceTagsAndSpaces),e={__id:e,__name:h,num:e};__shouldProcess("accounts",e)&&(processAccount(a,g,e),processAccountTransactions(b,e));c.accounts.push(e)}}else AnyBalance.trace("Похоже, счетов нет...\n"+a)}
function getColsAccount(b){var c={};b=getElements(b,/<th\b[^>]*>/ig);for(var a=0;a<b.length;++a){var d=getParam(b[a],null,null,null,replaceTagsAndSpaces);/Название счета/i.test(d)?c.name=a:/Сч[её]т/i.test(d)?c.num=a:/Остаток/i.test(d)?c.balance=a:/Валюта/i.test(d)&&(c.currency=a)}return c}function processInfo(b,c){c.info||(c.info={});getParam(b.USR,c.info,"info.fio")}
function processAccount(b,c,a){isset(b.currency)&&getParam(c[b.currency],a,["accounts.currency","accounts.balance"],null,replaceTagsAndSpaces);isset(b.balance)&&getParam(c[b.balance],a,"accounts.balance",null,replaceTagsAndSpaces,parseBalance);getParam(a.__id,a,"accounts.num",/^\d+/);isset(b.name)&&getParam(c[b.name],a,"accounts.name",null,replaceTagsAndSpaces)}
function processCredit(b,c,a){getParam(c,a,"credits.limit",/Первоначальная сумма кредита:[\s\S]*?<\/li>/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"credits.balance",/<div[^>]+"sum"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,["credits.currency","credits.limit","credits.balance","credits.min_pay"],/<div[^>]+"sum"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseCurrency);getParam(c,a,"credits.date_end",/Дата окончательных расчетов по кредиту:[\s\S]*?<\/li>/i,replaceTagsAndSpaces,
parseDate);getParam(c,a,"credits.min_pay_till",/Ближайший платеж:([^<]*)/i,replaceTagsAndSpaces,parseDateWord);getParam(c,a,"credits.min_pay",/на сумму([^<]*)/i,replaceTagsAndSpaces,parseBalance);processCreditExtra(b,c,a)}
function processCreditExtra(b,c,a){if(AnyBalance.isAvailable("credits.type","credits.agreement","credits.agreement_date","credits.date_start","credits.min_pay_till","credits.peni","credits.min_early","credits.min_pay_debt","credits.min_pay_pct","credits.min_pay_pct_due","credits.min_pay_debt_due","credits.pct_due","credits.peni_debt","credits.peni_pct","credits.other_payments","credits.min_pay","credits.pct","credits.tranzactions","credits.schedule")){var d=getParam(c,/IDR:([0-9a-f\-]+)/i);if(!d)throw AnyBalance.trace(c),
new AnyBalance.Error("Не удалось найти ссылку на расширенную информацию по кредиту. Сайт изменен?");b=AnyBalance.requestPost(g_baseurl,{WidgetID:"CREDITS",Action:"CreditInfoData",Template:"info",IDR:d,SchemeName:"",BlockName:""},addHeaders({BSSHTTPRequest:"1","X-Requested-With":"XMLHttpRequest",BSSHTTPRequestExt:"1","RTS-Request":"SID="+b.SID+"&T=bss_plugins_core.widget&tic=1&isNewCore=1",Referer:g_baseurl}));getParam(b,a,"credits.type",/>\s*Тип кредита[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);
getParam(b,a,"credits.agreement",/>\s*Номер договора[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(b,a,"credits.agreement_date",/>\s*Дата договора[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseDateWord);getParam(b,a,"credits.date_start",/>\s*Дата выдачи[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseDate);getParam(b,a,"credits.pct",/>\s*Расчетная процентная ставка[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"credits.pct_sum",
/>\s*Сумма начисленных процентов:[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"credits.debt",/>\s*Сумма просроченной задолженности[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"credits.pct_debt",/>\s*Процентная ставка на просроченную задолженность[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"credits.period",/>\s*Периодичность платежей[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);
getParam(b,a,"credits.min_pay_pct_due",/>\s*Сумма начисленных процентов по просроченной задолженности[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"credits.min_pay_pct",/>\s*Сумма срочных процентов к уплате[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"credits.pct_due",/>\s*Сумма просроченных процентов[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"credits.peni",/>\s*Сумма неустойки[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,
replaceTagsAndSpaces,parseBalance);getParam(b,a,"credits.min_early",/>\s*Минимальная сумма досрочного погашения[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"credits.min_pay_debt",/>\s*Сумма погашения срочного основного долга по кредиту[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"credits.min_pay_debt_due",/>\s*Сумма погашения просроченного долга по кредиту[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);
getParam(b,a,"credits.peni_debt",/>\s*Неустойка за основной долг[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"credits.peni_pct",/>\s*Неустойка за проценты[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"credits.other_payments",/>\s*Иные платежи[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);AnyBalance.isAvailable("credits.transactions")&&processCreditTransactions(b,a);AnyBalance.isAvailable("credits.schedule")&&
processCreditSchedule(b,a)}}function getColsAccountTransactions(b){var c={};b=getElements(b,/<th\b[^>]*>/ig);for(var a=0;a<b.length;++a){var d=getParam(b[a],null,null,null,replaceTagsAndSpaces);/Дата/i.test(d)?c.date=a:/Номер операции/i.test(d)?c.opnum=a:/Сумма/i.test(d)?c.sum=a:/Корреспондирующий счет/i.test(d)?c.corrnum=a:/Наименование корреспондента/i.test(d)?c.corrname=a:/Назначение платежа/i.test(d)&&(c.descr=a)}return c}
function processAccountTransactions(b,c){if(AnyBalance.isAvailable("accounts.transactions")){var a=new Date,d=new Date(a.getFullYear()-1,a.getMonth(),a.getDate()+1);do{var f=AnyBalance.requestPost(g_baseurl,{SID:b.SID,tic:1,BDate:d.getFullYear()+"-"+n2(d.getMonth()+1)+"-"+n2(d.getDate()),EDate:a.getFullYear()+"-"+n2(a.getMonth()+1)+"-"+n2(a.getDate()),T:"RT_2IC.view",Accounts:c.__id,CUSTOMVIEW:1,PERIOD:3,SCHEMENAME:"STM",FORMACTION:"view",PulfAccess:"",ShowStatRecDoc:"0"},addHeaders({Referer:g_baseurl})),
e=getElement(f,/<table[^>]+id="SCROLLER"[^>]*>/i);if(!e){var g=getParam(f,null,null,/<BSS_ERROR>([\s\S]*?)<\/BSS_ERROR>/i,replaceTagsAndSpaces);if(g&&(AnyBalance.trace("Не получили транзакции с ошибкой: "+g),g=getParam(g,null,null,/Выписка будет доступна через\s*(\d+)\s*сек/i,null,parseBalance))){AnyBalance.trace("Ждем "+g+" сек...");AnyBalance.sleep(1E3*g);continue}}if(!e){AnyBalance.trace("Похоже, транзакций по счету "+c.__id+" нет...\n"+f);return}break}while(1);b=getElements(e,/<(?:thead|tbody)[^>]*>/ig);
if(!/<thead/i.test(""+b[0]))throw AnyBalance.trace(f),new AnyBalance.Error("Не удаётся найти заголовок таблицы транзакций счета. Сайт изменен?");if(!/<tbody/i.test(""+b[1]))throw AnyBalance.trace(f),new AnyBalance.Error("Не удаётся найти тело таблицы транзакций счета. Сайт изменен?");c.transactions=[];f=getColsAccountTransactions(b[0]);b=getElements(b[1],/<tr[^>]*>/ig);for(a=0;a<b.length;++a)d=b[a],/colspan/i.test(d)||(d=getElements(d,/<td[^>]*>/ig),e={},isset(f.date)&&getParam(d[f.date],e,"accounts.transactions.date",
null,replaceTagsAndSpaces,parseDate),isset(f.sum)&&getParam(d[f.sum],e,"accounts.transactions.sum",null,replaceTagsAndSpaces,parseBalance),isset(f.opnum)&&getParam(d[f.opnum],e,"credits.transactions.opnum",null,replaceTagsAndSpaces),isset(f.corrnum)&&getParam(d[f.corrnum],e,"credits.transactions.corrnum",null,replaceTagsAndSpaces),isset(f.corrname)&&getParam(d[f.corrname],e,"credits.transactions.corrname",null,replaceTagsAndSpaces),isset(f.descr)&&getParam(d[f.descr],e,"credits.transactions.descr",
null,replaceTagsAndSpaces),c.transactions.push(e))}};
