var g_headers={Accept:"application/json","X-Test-UIDM":"true","X-Client-Type":"mobile","X-Client-Version":"a2.35 (672)","User-Agent":"okhttp/3.12.3",Connection:"Keep-Alive"};
function callApi(a,b){var c=g_headers;b&&(b.__post?delete b.__post:(b=JSON.stringify(b),c=addHeaders({"Content-Type":"application/json"})));a=AnyBalance.requestPost("https://api1.open.ru/np/2-40/"+a,b,c,{HTTP_METHOD:b?"POST":"GET"});b=JSON.parse(a);if(!b.success&&!b.execution&&!b.authenticated)throw AnyBalance.trace(a),a=b.message||"Ошибка обращения к API",new AnyBalance.Error(a,null,/правильно ввели номер карты/i.test(a));return b.data||b}
function createPass(a){for(var b="",c=0;c<a;++c)b+="0123456789abcdef".charAt(Math.floor(16*Math.random()));return b}
function register(){var a=AnyBalance.getPreferences();checkEmpty(a.login,"Введите номер карты!");var b=callApi("api/v1.0/auth/registration/pan/?pan="+encodeURIComponent(a.login),{__post:!0}),c=b.sessionId,d=AnyBalance.retrieveCode("Пожалуйста, введите код, высланный на "+b.phone+" для привязки мобильного банка к телефону",null,{inputType:"number",time:1E3*b.otpLifeTime}),b=callApi("api/v1.0/auth/registration/otp/validate",{otp:d,sessionId:c}),d=createPass(40),e=createPass(16),b=callApi("api/v1.0/auth/registration/register",
{deviceOS:"Android",sessionId:c,imprint:b.imprint,password:d,deviceId:e,deviceName:"AnyBalance",deviceOSVersion:"9",root:!1,appVersion:"2.35"}),c=b.login;AnyBalance.setData("pan",a.login);AnyBalance.setData("login",c);AnyBalance.setData("pass",d);AnyBalance.setData("deviceid",e);AnyBalance.saveData()}
function loginInner(){var a=callApi("sso/oauth2/access_token?realm=/customer&service=dispatcher&client_id=mobilebank&form_type=pin&client_secret=password&grant_type=urn:roox:params:oauth:grant-type:m2m",{__post:!0,device_info:JSON.stringify({device_id:AnyBalance.getData("deviceid"),device_locale:"ru",device_os:2,device_os_version:"9",app_version:672,device_root:0})}),a=callApi("sso/oauth2/access_token?_eventId=next&realm=/customer&service=dispatcher&client_id=mobilebank&form_type=pin&client_secret=password&grant_type=urn:roox:params:oauth:grant-type:m2m",
{__post:!0,execution:a.execution,username:AnyBalance.getData("login"),password:AnyBalance.getData("pass")});if(!a.authenticated)throw new AnyBalance.Error("Не удалось авторизоваться. Надо заново регистрироваться?");AnyBalance.setCookie("api1.open.ru","at",a.access_token)}
function login(){var a=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");AnyBalance.getData("login")&&a.login===AnyBalance.getData("pan")||register();try{loginInner()}catch(b){AnyBalance.trace(b.message),clearAllCookies(),register(),loginInner()}__setLoginSuccessful()}
function processAccounts(a,b){if(AnyBalance.isAvailable("accounts")){var c=callApi("api/v1.0/account/product/account/current/list/");AnyBalance.trace("Найдено текущих счетов: "+c.length);a=c;c=callApi("api/v1.0/account/accumulation/");AnyBalance.trace("Найдено накопительных счетов: "+c.length);a.push.apply(a,c);b.accounts=[];for(c=0;c<a.length;c++){var d=a[c].accNum,e=(a[c].accName||a[c].name)+" "+a[c].balance.currency+" x"+d.substr(-4);AnyBalance.trace("Найден счет "+e+" ("+a[c]["@type"]+")")}for(c=
0;c<a.length;c++){var f=a[c].accNum,d=a[c].accNum,e=(a[c].accName||a[c].name)+" "+a[c].balance.currency+" x"+d.substr(-4),d={__id:f,__name:e,num:d};__shouldProcess("accounts",d)&&processAccount(a[c],d);b.accounts.push(d)}}}
function processAccount(a,b){AnyBalance.trace("Обработка счета "+b.__name);getParam(a.balance.amount,b,"accounts.balance");getParam(a.balance.currency,b,["accounts.currency","accounts.balance"]);getParam(a.openDate,b,"accounts.date_start",null,null,parseDateISO);getParam(a.currentPercent,b,"accounts.pct");getParam(a.contractName,b,"deposits.agreement");getParam(a.status.value,b,"deposits.status");AnyBalance.isAvailable("accounts.transactions")}
function processCards(a,b){if(AnyBalance.isAvailable("cards")){a=callApi("api/v1.3/card/product/card/");AnyBalance.trace("Найдено карт: "+a.length);b.cards=[];for(var c=0;c<a.length;++c){var d={__id:a[c].cardId,__name:a[c].tariffPlan.name,num:a[c].maskCardNum};__shouldProcess("cards",d)&&processCard(a[c],d);b.cards.push(d)}}}
function processCard(a,b){AnyBalance.trace("Обработка карты "+b.__name);getParam(a.accNum,b,"cards.accnum");getParam(a.cardExpDate,b,"cards.till",null,null,parseDateISO);getParam(a.startDate,b,"cards.date_start",null,null,parseDateISO);getParam(a.status.value,b,"cards.status");getParam(a.balance.amount,b,"cards.balance");getParam(a.creditLimit,b,"cards.limit");getParam(a.loyaltyInfo&&a.loyaltyInfo.bonusInfo&&a.loyaltyInfo.bonusInfo.totalValue,b,"cards.bonus");getParam(a.balance.currency,b,"cards.currency cards.balance cards.limit cards.debt cards.oPCT cards.accuredPct cards.overduePct cards.paySum cards.blocked".split(" "));
getParam(a.tariffPlan.name,b,"cards.__tariff");isAvailable("cards.transactions")}function processDeposits(a,b){if(AnyBalance.isAvailable("deposits"))throw new AnyBalance.Error("Обработка кредитов на данный момент не поддерживается. Пожалуйста, обратитесь к разработчику.");}
function processDeposit(a,b){AnyBalance.trace("Обработка депозита "+b.__name);var c=getElement(a,/<span[^>]+class="data"/i,replaceTagsAndSpaces);getParam(c,b,"deposits.balance",null,null,parseBalance);getParam(c,b,["deposits.currency","deposits.balance"],null,null,parseCurrency);getParam(a,b,"deposits.accnum",/Номер счета([^<]*)/i,replaceTagsAndSpaces);AnyBalance.isAvailable("deposits.pct","deposits.agreement","deposits.status","deposits.till","deposits.date_start","deposits.transactions")&&((c=getParam(a,
null,null,/location\.href\s*=\s*['"]\/?([^'"]*)/i))?(a=AnyBalance.requestGet(baseurl+c,g_headers),getParam(a,b,"deposits.pct",/Ставка:(?:[^>]*>){1}([^%]*)/i,replaceTagsAndSpaces,parseBalance),getParam(a,b,"deposits.agreement",/Договор(?:[^>]*>){1}([\s\S]*?)<\//i,replaceTagsAndSpaces),getParam(a,b,"deposits.status",/Статус(?:[^>]*>){1}([\s\S]*?)<\//i,replaceTagsAndSpaces),getParam(a,b,"deposits.till",/остаток на(?:[^>]*>){1}([\s\S]*?)<\//i,replaceTagsAndSpaces,parseDate),getParam(a,b,"deposits.date_start",
/Дата открытия(?:[^>]*>){1}([\s\S]*?)<\//i,replaceTagsAndSpaces,parseDate),isAvailable("deposits.transactions")&&processDepositTransactions(c,b)):(AnyBalance.trace(a),AnyBalance.trace("Не удалось найти ссылку на выписку по депозиту"+b.__name)))}function processCredits(a,b){if(AnyBalance.isAvailable("credits"))throw new AnyBalance.Error("Обработка кредитов на данный момент не поддерживается. Пожалуйста, обратитесь к разработчику.");}
function processInfo(a,b){a=b.info={};b=callApi("api/v1.0/client-info/client/info/");getParam(b.clientFullName,a,"info.fio")};
