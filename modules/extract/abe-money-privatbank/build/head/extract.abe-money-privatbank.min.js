var g_headers={"User-Agent":"Dalvik/2.1.0 (Linux; U; Android 6.0.1; D6503 Build/23.5.A.1.291)",Connection:"Keep-Alive",AppMode:"NFC"},g_appKey="afhgfgfdg56ujdj6rtymr67yjrt76tyherhdbryj6r46df57",g_baseurl="https://napi.privatbank.ua/",g_login_hash="",g_imei="35374906******L",g_simsn="897010266********L",g_session="";
function requestJson(b,c,d){var a=[],e;for(e in b)a.push(encodeURIComponent(e)+"="+encodeURIComponent(b[e]));a.push(encodeURIComponent("cookie")+"="+encodeURIComponent(g_session));a.push(encodeURIComponent("imei")+"="+encodeURIComponent(g_login_hash));a.push(encodeURIComponent("appkey")+"="+encodeURIComponent(g_appKey));a.push(encodeURIComponent("language")+"=ru");a.push(encodeURIComponent("lon")+"=0.0");a.push(encodeURIComponent("ireal")+"="+encodeURIComponent(g_imei));a.push(encodeURIComponent("device")+
"="+encodeURIComponent("D6503|sony"));a.push(encodeURIComponent("version")+"="+encodeURIComponent("5.20.02"));a.push(encodeURIComponent("versionOS")+"="+encodeURIComponent("5.0"));a.push(encodeURIComponent("lat")+"="+encodeURIComponent("0.0"));b=g_baseurl+"iapi2/"+c+"?"+a.join("&");c=AnyBalance.requestGet(b,g_headers);clearAllCookies();c=getJson(c);if("ok"!=c.st&&(AnyBalance.trace("Error getting "+b+": "+JSON.stringify(c)),d))throw new AnyBalance.Error(d+": "+(c.err||"").replace(/:\s[^&]&/,": "),
null,/Неверный логин или пароль/i.test(c.err));return c}
function login(b,c){b=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");checkEmpty(b.login,"Введите логин!");checkEmpty(b.password,"Введите пароль!");var d="+"+b.login.replace(/\D+/g,"");g_session=AnyBalance.getData("session");var a=hex_md5(d);AnyBalance.trace(a+" "+typeof a);g_login_hash=getParam(a,null,null,null,[/([\s\S]{8})([\s\S]{4})([\s\S]{4})([\s\S]{4})([\s\S]{12})/,"$1-$2-$3-$4-$5"]);AnyBalance.trace("Login imei param is: "+g_login_hash);g_imei=generateImei(d,g_imei);g_simsn=
generateSimSN(d,g_simsn);g_session&&(AnyBalance.trace("Найдена активная сессия, проверим её."),a=requestJson({},"props_full"),"ok"!=a.st?(AnyBalance.trace("Сессия испорчена, будем заново авторизовываться"),g_session=""):AnyBalance.trace("Сессия действует, используем её."));if(!g_session){a=requestJson({},"props_full");if(/phone not linked to imei/i.test(a.err)){AnyBalance.trace("Устройство нужно привязать.");requestJson({},"unlink_phone");a=requestJson({login:d},"auth_phone","Не удалось начать процесс привязки");
d=a.id;a=requestJson({id:d,pass:b.password},"auth_pass","Не удалось зайти с паролем");for(b=0;"redirect"!=a.nextCmd;)if(a=performNextCmd(a.nextCmd,d),5<++b)throw AnyBalance.trace(JSON.stringify(a)),new AnyBalance.Error("Слишком много подтверждений на вход. Сайт изменен?");g_session=a.cookie;AnyBalance.trace("Успешно привязали устройство: "+JSON.stringify(a))}else if(/CODE104: need auth/i.test(a.err)){AnyBalance.trace("Похоже что устройство уже привязано.");a=requestJson({pass:b.password,bank:""},
"chpass");if(/CODE194/.test(a.err))throw AnyBalance.trace("Аккаунт оказался заблокирован, отвязываем устройство и пробуем ещё раз"),c=AnyBalance.Error(a.err,!0),requestJson({},"unlink_phone"),c;if("ok"!==a.st)throw new AnyBalance.Error(a.err,null,/парол/i.test(a.err));g_session=a.cookie}else throw AnyBalance.trace(JSON.stringify(a)),new AnyBalance.Error(a.err);AnyBalance.setData("session",g_session);AnyBalance.saveData();__setLoginSuccessful()}if(!g_session)throw new AnyBalance.Error("Не удалось получить токен авторизации!");
requestJson({},"banks");a=requestJson({},"props_full","Банк не отдал данные");AnyBalance.isAvailable("info.mphone")&&(c.info={},getParam(a.phone,c.info,"info.mphone"));return a}
function performShowIvr(b){AnyBalance.trace("Понадобилось подтверждение по звонку");for(var c=0;25>c;++c){AnyBalance.sleep(5E3);var d=requestJson({id:b},"auth_get_confirm_status","Не удалось проверить статус подтверждения звонком");AnyBalance.trace("Попытка "+(c+1)+"/25 подтвердить вход звонком: "+JSON.stringify(d));if(d.nextCmd)return d}throw new AnyBalance.Error("Вход не был подтвержден звонком");}
function performAuthOtp(b){AnyBalance.trace("Понадобилось подтверждение по SMS");var c=AnyBalance.retrieveCode("Пожалуйста, введите код из смс для привязки данного устройства.",null,{time:3E5});b=requestJson({id:b,otp:c},"auth_otp","Не удалось привязать устройство");AnyBalance.trace("Введен код из СМС: "+JSON.stringify(b));return b}
function performNextCmd(b,c){switch(b){case "show_ivr_form":return performShowIvr(c);case "show_otp_password_form":return performAuthOtp(c);default:throw new AnyBalance.Error("Неизвестный следующий этап подтверждения входа: "+b+". Сайт изменен?");}}
function processCards(b,c){if(AnyBalance.isAvailable("cards")){b=b.cards;AnyBalance.trace("Найдено карт: "+b.length);c.cards=[];for(var d=0;d<b.length;++d){var a=b[d],e={__id:a.cardid,__name:a.alias+" "+a.number,num:a.number};__shouldProcess("cards",e)&&processCard(a,e);c.cards.push(e)}}}
function processCard(b,c,d){getParam(b.holded+"",c,"cards.balance",null,null,parseBalanceSilent);getParam(b.ccy,c,"cards.currency");getParam(b.is_nfc,c,"cards.is_nfc",null,null,parseBoolean);getParam(b.is_acc_foreign,c,"cards.is_foreign",null,null,parseBoolean);getParam(b.rate+"",c,"cards.pct",null,null,parseBalanceSilent);getParam(b.status,c,"cards.status");getParam(b.type,c,"cards.type");getParam(b.is_credit,c,"cards.is_credit");getParam(b.finlimit+"",c,"cards.limit",null,null,parseBalanceSilent);
getParam(b.min_pay+"",c,"cards.minpay",null,null,parseBalanceSilent);AnyBalance.isAvailable("cards.transactions")&&processCardTransactions(b,c)}function parseBoolean(b){return"1"==b}function findCardDetails(b,c){for(var d=0;d<c.length;d++){var a=c[d];if(b==a.cardid)return a}return null};
