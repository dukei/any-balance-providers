var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","User-Agent":"android-async-http/1.4.1 (http://loopj.com/android-async-http)"},g_appKey="afhgfgfdg56ujdj6rtymr67yjrt76tyherhdbryj6r46df57",g_baseurl="https://napi.privatbank.ua/",g_login_hash="",g_imei="35374906******L",g_simsn="897010266********L",g_session="";
function requestJson(a,c,d){var b=[],e;for(e in a)b.push(encodeURIComponent(e)+"="+encodeURIComponent(a[e]));b.push(encodeURIComponent("cookie")+"="+encodeURIComponent(g_session));b.push(encodeURIComponent("simSN")+"="+encodeURIComponent(g_simsn));b.push(encodeURIComponent("imei")+"="+encodeURIComponent(g_login_hash));b.push(encodeURIComponent("appkey")+"="+encodeURIComponent(g_appKey));b.push(encodeURIComponent("language")+"=ru");b.push(encodeURIComponent("lon")+"=0.0");b.push(encodeURIComponent("device")+
"="+encodeURIComponent("SM-G900F|samsung"));b.push(encodeURIComponent("version")+"="+encodeURIComponent("5.11.02"));b.push(encodeURIComponent("versionOS")+"="+encodeURIComponent("5.0"));b.push(encodeURIComponent("lat")+"="+encodeURIComponent("0.0"));b.push(encodeURIComponent("ireal")+"="+encodeURIComponent(g_imei));a=g_baseurl+"iapi2/"+c+"?"+b.join("&");c=AnyBalance.requestGet(a,g_headers);c=getJson(c);if("ok"!=c.st&&(AnyBalance.trace("Error getting "+a+": "+JSON.stringify(c)),d))throw new AnyBalance.Error(d+
": "+(c.err||"").replace(/:\s[^&]&/,": "),null,/Неверный логин или пароль/i.test(c.err));return c}
function login(a,c){a=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");checkEmpty(a.login,"Введите логин!");checkEmpty(a.password,"Введите пароль!");var d="+"+a.login.replace(/\D+/g,"");if(g_session){AnyBalance.trace("Найдена активная сессия, проверим её.");var b=requestJson({},"props_full");"ok"!=b.st?(AnyBalance.trace("Сессия испорчена, будем заново авторизовываться"),g_session=""):AnyBalance.trace("Сессия действует, используем её.")}if(g_session)AnyBalance.trace();else{b=hex_md5(d);
AnyBalance.trace(b+" "+typeof b);g_login_hash=getParam(b,null,null,null,[/([\s\S]{8})([\s\S]{4})([\s\S]{4})([\s\S]{4})([\s\S]{12})/,"$1-$2-$3-$4-$5"]);AnyBalance.trace("Login imei param is: "+g_login_hash);g_imei=generateImei(d,g_imei);g_simsn=generateSimSN(d,g_simsn);b=requestJson({},"props_full");if(/phone not linked to imei/i.test(b.err)){AnyBalance.trace("Устройство нужно привязать.");requestJson({},"unlink_phone");b=requestJson({login:d},"auth_phone","Не удалось начать процесс привязки");d=b.id;
b=requestJson({id:d,pass:a.password},"auth_pass","Не удалось зайти с паролем");for(a=0;"redirect"!=b.nextCmd;)if(b=performNextCmd(b.nextCmd,d),5<++a)throw AnyBalance.trace(JSON.stringify(b)),new AnyBalance.Error("Слишком много подтверждений на вход. Сайт изменен?");g_session=b.cookie;AnyBalance.trace("Успешно привязали устройство: "+JSON.stringify(b))}else AnyBalance.trace("Похоже что устройство уже привязано."),b=requestJson({pass:a.password,bank:""},"chpass","Не удалось авторизоваться, проверьте логин и пароль."),
g_session=b.cookie;__setLoginSuccessful()}if(!g_session)throw new AnyBalance.Error("Не удалось получить токен авторизации!");requestJson({},"banks");b=requestJson({},"props_full");AnyBalance.isAvailable("info.mphone")&&(c.info={},getParam(b.phone,c.info,"info.mphone"));return b}
function performShowIvr(a){AnyBalance.trace("Понадобилось подтверждение по звонку");for(var c=0;25>c;++c){AnyBalance.sleep(5E3);var d=requestJson({id:a},"auth_get_confirm_status","Не удалось проверить статус подтверждения звонком");AnyBalance.trace("Попытка "+(c+1)+"/25 подтвердить вход звонком: "+JSON.stringify(d));if(d.nextCmd)return d}throw new AnyBalance.Error("Вход не был подтвержден звонком");}
function performAuthOtp(a){AnyBalance.trace("Понадобилось подтверждение по SMS");var c=AnyBalance.retrieveCode("Пожалуйста, введите код из смс для привязки данного устройства.",null,{time:3E5});a=requestJson({id:a,otp:c},"auth_otp","Не удалось привязать устройство");AnyBalance.trace("Введен код из СМС: "+JSON.stringify(a));return a}
function performNextCmd(a,c){switch(a){case "show_ivr_form":return performShowIvr(c);case "show_otp_password_form":return performAuthOtp(c);default:throw new AnyBalance.Error("Неизвестный следующий этап подтверждения входа: "+a+". Сайт изменен?");}}
function processCards(a,c){if(AnyBalance.isAvailable("cards")){a=a.cards;AnyBalance.trace("Найдено карт: "+a.length);c.cards=[];for(var d=0;d<a.length;++d){var b=a[d],e={__id:b.cardid,__name:b.alias+" "+b.number,num:b.number};__shouldProcess("cards",e)&&processCard(b,e);c.cards.push(e)}}}
function processCard(a,c,d){getParam(a.holded+"",c,"cards.balance",null,null,parseBalanceSilent);getParam(a.ccy,c,"cards.currency");getParam(a.is_nfc,c,"cards.is_nfc",null,null,parseBoolean);getParam(a.is_acc_foreign,c,"cards.is_foreign",null,null,parseBoolean);getParam(a.rate+"",c,"cards.pct",null,null,parseBalanceSilent);getParam(a.status,c,"cards.status");getParam(a.type,c,"cards.type");getParam(a.is_credit,c,"cards.is_credit");getParam(a.finlimit+"",c,"cards.limit",null,null,parseBalanceSilent);
getParam(a.min_pay+"",c,"cards.minpay",null,null,parseBalanceSilent);AnyBalance.isAvailable("cards.transactions")&&processCardTransactions(a,c)}function parseBoolean(a){return"1"==a}function findCardDetails(a,c){for(var d=0;d<c.length;d++){var b=c[d];if(a==b.cardid)return b}return null};
