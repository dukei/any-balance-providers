var g_headers={Accept:"*/*","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/29.0.1547.76 Safari/537.36","X-MicrosoftAjax":"Delta=true","X-Requested-With":"XMLHttpRequest"},g_baseurl="https://retail.payment.ru";
function getViewState(a){return getParam(a,null,null,[/name="__VIEWSTATE"[^>]*value="([^"]*)"/i,/__VIEWSTATE\|([^|]*)/i],replaceHtmlEntities)}function getEventValidation(a){return getParam(a,null,null,[/name="__EVENTVALIDATION"[^>]*value="([^"]*)"/i,/__EVENTVALIDATION\|([^|]*)/i],replaceHtmlEntities)}function getViewStateGenerator(a){return getParam(a,null,null,[/name="__VIEWSTATEGENERATOR[^>]*value="([^"]*)"/i,/__VIEWSTATEGENERATOR\|([^|]*)/i],replaceHtmlEntities)}
function requestAndCheckForErrors(a,b,c,d,e){a=/POST/.test(a)?AnyBalance.requestPost(b,c,d):AnyBalance.requestGet(b,d);if(e&&!/pageRedirect/i.test(a))throw AnyBalance.trace(a),new AnyBalance.Error("Не удаётся войти в интернет банк (внутренняя ошибка сайта)");if(/KeyAuth/i.test(a))throw new AnyBalance.Error("Для входа в интернет-банк требуются одноразовые пароли. Зайдите в интернет-банк с компьютера и отключите в Настройках требование одноразовых паролей при входе. Это безопасно, для операций по переводу денег пароли всё равно будут требоваться.");
if(/UpdateContactInfo.aspx/i.test(a))throw new AnyBalance.Error("Для входа в интернет-банк требуются обновить контактную информацию. Зайдите в интернет-банк с компьютера и следуйте инструкциям.");e&&(e=getParam(a,null,null,/pageRedirect\|\|([^\|]*)/i,replaceTagsAndSpaces,decodeURIComponent),AnyBalance.trace("Нашли ссылку "+e),a=AnyBalance.requestGet(g_baseurl+e,g_headers));if(e=getParam(a,null,null,/<div[^>]*class="errorMessage"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces))throw new AnyBalance.Error(e,
null,/Неверные учетные данные/i.test(e));return a}
function login(){var a=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");checkEmpty(a.login,"Пожалуйста, укажите логин для входа в интернет-банк Промсвязбанка!");checkEmpty(a.password,"Пожалуйста, укажите пароль для входа в интернет-банк Промсвязбанка!");var b=AnyBalance.requestGet(g_baseurl+"/n/Main/Home.aspx",g_headers);if(/logout/i.test(b))AnyBalance.trace("Уже внутри. Используем существующую сессию.");else{var c=getEventValidation(b),d=getViewState(b),b=getViewStateGenerator(b);
AnyBalance.setCookie("retail.payment.ru","__dp_rsa","version%3D3%2E4%2E1%2E0%5F1%26pm%5Ffpua%3Dmozilla%2F5%2E0%20%28windows%20nt%206%2E1%3B%20wow64%29%20applewebkit%2F537%2E36%20%28khtml%2C%20like%20gecko%29%20chrome%2F42%2E0%2E2311%2E90%20safari%2F537%2E36%7C5%2E0%20%28Windows%20NT%206%2E1%3B%20WOW64%29%20AppleWebKit%2F537%2E36%20%28KHTML%2C%20like%20Gecko%29%20Chrome%2F42%2E0%2E2311%2E90%20Safari%2F537%2E36%7CWin32%26pm%5Ffpsc%3D24%7C1440%7C900%7C900%26pm%5Ffpsw%3D%26pm%5Ffptz%3D3%26pm%5Ffpln%3Dlang%3Dru%7Csyslang%3D%7Cuserlang%3D%26pm%5Ffpjv%3D1%26pm%5Ffpco%3D1%26pm%5Ffpasw%3Dwidevinecdmadapter%7Cmhjfbmdgcfjbbpaeojofohoefgiehjai%7Cpepflashplayer%7Cinternal%2Dremoting%2Dviewer%7Cinternal%2Dnacl%2Dplugin%7Cinternal%2Dpdf%2Dviewer%26pm%5Ffpan%3DNetscape%26pm%5Ffpacn%3DMozilla%26pm%5Ffpol%3Dtrue%26pm%5Ffposp%3D%26pm%5Ffpup%3D%26pm%5Ffpsaw%3D1440%26pm%5Ffpspd%3D24%26pm%5Ffpsbd%3D%26pm%5Ffpsdx%3D%26pm%5Ffpsdy%3D%26pm%5Ffpslx%3D%26pm%5Ffpsly%3D%26pm%5Ffpsfse%3D%26pm%5Ffpsui%3D%26pm%5Fos%3DWindows%26pm%5Fbrmjv%3D42%26pm%5Fbr%3DChrome%26pm%5Finpt%3D%26pm%5Fexpt%3D");
requestAndCheckForErrors("POST",g_baseurl+"/n/Default.aspx?v3=true",{ctl00$ScriptManager:"ctl00$mainArea$upLogin|ctl00$mainArea$btnLogin",__EVENTTARGET:"",__EVENTARGUMENT:"",__VIEWSTATE:d,__VIEWSTATEENCRYPTED:"",__EVENTVALIDATION:c,__VIEWSTATEGENERATOR:b,ctl00$mainArea$LoginInput$vtcLogin:a.login,ctl00$mainArea$vtcPassword:a.password,__ASYNCPOST:!0,ctl00$mainArea$btnLogin:"Войти"},addHeaders({Referer:"https://retail.payment.ru/n/Default.aspx"}),!0);b=requestAndCheckForErrors("GET",g_baseurl+"/n/Main/Home.aspx",
"",g_headers);if(!/logout/i.test(b))throw AnyBalance.trace(b),new AnyBalance.Error("Не удалось войти в интернет-банк. Сайт изменен?");__setLoginSuccessful()}return b}
function processAccounts(a,b){if(AnyBalance.isAvailable("accounts")){var c=getEventValidation(a),d=getViewState(a);/<div[^>]*isDetExpandBtn[^>]*accountList[^>]*>\s*подробно/i.test(a)&&(a=AnyBalance.requestPost(g_baseurl+"/n/Main/Home.aspx",{ctl00$ctl00$ScriptManager:"ctl00$ctl00$mainArea$main$upAccounts|ctl00$ctl00$mainArea$main$accountList",__EVENTTARGET:"ctl00$ctl00$mainArea$main$accountList",__EVENTARGUMENT:"_det_exp",__VIEWSTATE:d,__VIEWSTATEENCRYPTED:"",__EVENTVALIDATION:c,ctl00$ctl00$mainArea$right$OperationSearchRightColumn$OperationSearch$tbSearch:"",
ctl00_ctl00_mainArea_right_OperationSearchRightColumn_OperationSearch_tbSearch_InitialTextMode:"True",__ASYNCPOST:"true","":""},addHeaders({Referer:g_baseurl+"/n/Main/Home.aspx"})));a=getElements(a,/<div[^>]+class="infoUnit"[^>]*>/ig);AnyBalance.trace("Найдено счетов: "+a.length);b.accounts||(b.accounts=[]);for(c=0;c<a.length;++c){var d=a[c],e=getElement(d,/<div[^>]+"infoUnitCaption[^>]*>/i,replaceTagsAndSpaces),g=getElement(d,/<a[^>]+"infoUnitObject[^>]*>/i,[replaceTagsAndSpaces,/\s+/g,""]),e={__id:g,
__name:e+" *"+g.substr(-4),num:g};__shouldProcess("accounts",e)&&processAccount(d,e);b.accounts.push(e)}}}
function processAccount(a,b){AnyBalance.trace("Обработка счета "+b.__name);getParam(a,b,"accounts.balance",/"balanceAmountM"[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,["accounts.currency","accounts.balance","accounts.blocked","accounts.own"],/"balanceAmountCurrencyM"[^>]*>([^<]*)/i,replaceTagsAndSpaces);AnyBalance.isAvailable("accounts.blocked","accounts.own","accounts.unused_credit","accounts.minpay","accounts.minpay_till","accounts.gracepay","accounts.gracepay_till","accounts.contract",
"accounts.limit","accounts.pct","accounts.transactions")&&processAccountDetails(a,b)}
function processAccountDetails(a,b){AnyBalance.trace("Получаем детальную информацию по счету "+b.__name);a=getParam(a,null,null,/"infoUnitObject"[^>]*href="([^"]*)/i);a=AnyBalance.requestGet(g_baseurl+a,g_headers);getParam(a,b,"accounts.own",/"ctl00_ctl00_mainArea_main_lblAccountBalance"[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"accounts.blocked",/"ctl00_ctl00_mainArea_main_lblReserved"[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"accounts.unused_credit",/"ctl00_ctl00_mainArea_main_lblUnusedCredit"[^>]*>([^<]*)/i,
replaceTagsAndSpaces,parseBalance);getParam(a,b,"accounts.minpay",/"ctl00_ctl00_mainArea_main_CreditNextRepayment_lblNextRepaymentSum"[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"accounts.minpay_till",/"ctl00_ctl00_mainArea_main_CreditNextRepayment_lblConditionDate"[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseDateWord);getParam(a,b,"accounts.gracepay",/"ctl00_ctl00_mainArea_main_lblGraceRepaymentSum"[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"accounts.gracepay_till",
/"ctl00_ctl00_mainArea_main_lblGraceRepaymentDate"[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseDateWord);getParam(a,b,"accounts.contract",/"ctl00_ctl00_mainArea_right_lblContract"[^>]*>([^<]*)/i,replaceTagsAndSpaces);getParam(a,b,"accounts.limit",/"ctl00_ctl00_mainArea_right_lblCreditLimit"[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"accounts.pct",/"ctl00_ctl00_mainArea_right_lblInterest"[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseBalance);AnyBalance.isAvailable("accounts.transactions")&&
processAccountTransactions(a,b)}
function processAccountsPreliminaryDetails(a,b,c){var d=getElement(a,/<div[^>]+accountDetailTextBlock[^>]*>/i);if(d)for(var e=getElement(a,/<div[^>]+accountDetailValueBlock[^>]*>/i),d=getElements(d.substr(1),/<div[^>]*>/ig),e=getElements(e.substr(1),/<div[^>]*>/ig),g=0;g<d.length;g++){var f=d[g],h=e[g];/ИТОГО/i.test(f)?(getParam(h,b,[c+"currency",c+"balance",c+"blocked",c+"own"],/<div[^>]+curNameISO[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces),getParam(h,b,c+"balance",null,replaceTagsAndSpaces,
parseBalance)):/собственные средства/i.test(f)?getParam(h,b,c+"own",null,replaceTagsAndSpaces,parseBalance):/кредитные средства/i.test(f)&&getParam(h,b,c+"unused_credit",null,replaceTagsAndSpaces,parseBalance)}getParam(a,b,c+"balance",/"balanceAmountM"[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,[c+"currency",c+"balance",c+"blocked",c+"own"],/"balanceAmountCurrencyM"[^>]*>([^<]*)/i,replaceTagsAndSpaces);"cards."==c?(getParam(a,b,c+"accnum",/<a[^>]+class="infoUnitObject[^>]*>([\s\S]*?)<\/a>/i,
[replaceTagsAndSpaces,/\D/g,""]),getParam(a,b,c+"accname",/<div[^>]+class="infoUnitCaption[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces)):getParam(a,b,c+"name",/<div[^>]+class="infoUnitCaption[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(a,b,c+"minpay_till",/ближайший платеж:([^>,]*)/i,replaceTagsAndSpaces,parseDate);getParam(a,b,c+"minpay",/ближайший платеж:[^>]*сумма:([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance)}
function processCards(a,b){function c(a){if(AnyBalance.isAvailable("accounts")&&a){var c=getElement(a,/<div[^>]+"infoUnitCaption[^>]*>/i,replaceTagsAndSpaces),d=getElement(a,/<a[^>]+"infoUnitObject[^>]*>/i,[replaceTagsAndSpaces,/\s+/g,""]),c={__id:d,__name:c+" *"+d.substr(-4),num:d};__shouldProcess("accounts",c)&&(processAccountsPreliminaryDetails(a,c,"accounts."),processAccount(a,c));b.accounts.push(c)}}if(AnyBalance.isAvailable("cards","accounts")){b.cards=[];b.accounts||(b.accounts=[]);a=AnyBalance.requestGet(g_baseurl+
"/n/Main/CardsAndAccounts.aspx",addHeaders({Referer:g_baseurl+"/n/Main/Home.aspx"}));a=getElements(a,/<div[^>]+class="(?:cardAccountBlock|card)"/ig);AnyBalance.trace("Найдено карт и карточных счетов: "+a.length);for(var d=null,e=0;e<a.length;++e){var g=a[e];if(/cardAccountBlock/i.test(g))c(d),d=g;else if(AnyBalance.isAvailable("cards"))if(/emptyAccount/i.test(g))AnyBalance.trace("Пустая карта, пропускаем");else{var f=getParam(g,null,null,/<span[^>]+class="cardnumber[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces),
h=getParam(g,null,null,/<a[^>]+class="cardStandAloneCaption[^>]*>([\s\S]*?)<\/a>/i,replaceTagsAndSpaces),f={__id:f,num:f,__name:h+" *"+f.substr(-4)};__shouldProcess("cards",f)&&(processAccountsPreliminaryDetails(d,f,"cards."),processCard(g,f));b.cards.push(f)}}c(d)}}
function processCard(a,b){getParam(a,b,"cards.status",/<span[^>]+class="cardStatus[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces);getParam(a,b,"cards.name",/<a[^>]+class="cardStandAloneCaption[^>]*>([\s\S]*?)<\/a>/i,replaceTagsAndSpaces);getParam(a,b,"cards.ps",/<div[^>]+class="cardIconBlock[^>]*>[\s\S]*?<img[^>]+title="([^"]*)/i,replaceHtmlEntities);AnyBalance.isAvailable("cards.limit_cash_day","cards.limit_cash_month","cards.limit_pay_day","cards.limit_pay_month","cards.blocked","cards.till","cards.transactions")&&
(a=getParam(a,null,null,/<a[^>]+class="cardStandAloneCaption"[^>]*href="([^"]*)/i,replaceHtmlEntities),AnyBalance.trace("Запрашиваем детали по карте"),a=AnyBalance.requestGet(g_baseurl+a,g_headers),getParam(a,b,"cards.limit_cash_day",/Снятие наличных в день:[\s\S]*?<span[^>]+class="limit"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance),getParam(a,b,"cards.limit_cash_month",/Снятие наличных в месяц:[\s\S]*?<span[^>]+class="limit"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance),
getParam(a,b,"cards.limit_pay_day",/Другие расходные операции в день:[\s\S]*?<span[^>]+class="limit"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance),getParam(a,b,"cards.limit_pay_month",/Другие расходные операции в месяц:[\s\S]*?<span[^>]+class="limit"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance),getParam(a,b,"cards.blocked",/"ctl00_ctl00_mainArea_main_lblReserved"[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseBalance),getParam(a,b,"cards.till",/"ctl00_ctl00_mainArea_main_lblExpireDate"[^>]*>([^<]*)/i,
replaceTagsAndSpaces,parseDate),AnyBalance.isAvailable("cards.transactions")&&processCardsTransactions(a,b))}
function processDeposits(a,b){if(AnyBalance.isAvailable("deposits")){a=AnyBalance.requestGet(g_baseurl+"/n/Main/Deposits.aspx",addHeaders({Referer:g_baseurl+"/n/Main/Home.aspx"}));var c=getElement(a,/<div[^>]*infoSectionContents[^>]*>/i);if(c)for(a=getElements(c,/<div[^>]+infoUnit[^>]*>/ig),AnyBalance.trace("Найдено депозитов: "+a.length),b.deposits=[],c=0;c<a.length;++c){var d=a[c],e=getParam(d,null,null,/<a[^>]+?infoUnitObject[^>]*?href="([^"]*)/i,replaceHtmlEntities),e=joinUrl(g_baseurl,e),g=getElement(d,
/<a[^>]+infoUnitObject[^>]*>/i,replaceTagsAndSpaces),d=AnyBalance.requestGet(e,addHeaders({Referer:g_baseurl+"/n/Main/Deposits.aspx"})),f=getElement(d,/<span[^>]+lblContract\b[^>]*>/i,replaceTagsAndSpaces),h=getParam(d,null,null,/Депозитный счет[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces),g=g+" "+f.substr(-4),f={__id:f,__name:g,num:h,contract:f};__shouldProcess("deposits",f)&&processDeposit(d,f,e);b.deposits.push(f)}else/У вас нет депозитов/i.test(a)?(AnyBalance.trace("У вас нет депозитов"),
b.deposits=[]):(AnyBalance.trace(a),AnyBalance.trace("Не удалось найти таблицу с депозитами."))}}
function processDeposit(a,b,c){AnyBalance.trace("Обработка депозита "+b.__name);getParam(a,b,"deposits.balance",/<span[^>]+balanceMainAmountR[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,["deposits.currency","deposits.balance"],/<span[^>]+balanceMainCurrencyS[^>]*>([\s\S]*?)<\/span>/,replaceTagsAndSpaces);getParam(a,b,"deposits.date_start",/<span[^>]+lblContractDates[^>]*>([\s\S]*?)<\/span>/,replaceTagsAndSpaces,parseDateWord);getParam(a,b,"deposits.period",/<span[^>]+lblDepositPeriod[^>]*>([\s\S]*?)<\/span>/,
replaceTagsAndSpaces,parseBalance);getParam(a,b,"deposits.till",/<span[^>]+lblContractDates[^>]*>[^\-]*([\s\S]*?)<\/span>/,replaceTagsAndSpaces,parseDateWord);getParam(a,b,"deposits.name",/<span[^>]+lblCaption[^>]*>([\s\S]*?)<\/span>/,replaceTagsAndSpaces);getParam(a,b,"deposits.balance_start",/Первоначальный взнос[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"deposits.add",/>\s*Пополнение\s*<[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);
getParam(a,b,"deposits.add_till",/Последняя дата возможного пополнения[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseDateWord);getParam(a,b,"deposits.sub",/Списание[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"deposits.pcts",/Капитализация[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"deposits.pct",/Годовая ставка[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"deposits.pct_condition",
/Тип выплаты[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(a,b,"deposits.pct_period",/Период выплаты[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(a,b,"deposits.estimated_value",/Ожидаемый доход[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);isAvailable("deposits.transactions")&&processDepositTransactions(a,b,c)}
function processInfo(a,b){b=b.info={};getParam(a,b,"info.fio",/<div[^>]+id="[^"]*divUserName"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);AnyBalance.isAvailable("info.mphone","info.smsphone","info.email","info.alias")&&(a=AnyBalance.requestGet(g_baseurl+"/n/Settings/Settings.aspx",g_headers),getParam(a,b,"info.mphone",/Номер телефона:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces),getParam(a,b,"info.email",/E-mail:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,[replaceTagsAndSpaces,/<не заполнено>/i,
""]),getParam(a,b,"info.smsphone",/<span[^>]+id="[^"]*lblSmsPhone"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces),getParam(a,b,"info.alias",/<input[^>]+vtcUserAlias[^>]*value="([^"]*)/i,replaceHtmlEntities))}
function processBonuses(a,b){isAvailable(["bonuses","bonuses_grade"])&&(a=AnyBalance.requestGet(g_baseurl+"/n/Services/BonusProgram.aspx"),getParam(a,b,"bonuses",[/class="bonusAmount"[^>]*>([^<]*)/i,/"ctl00_ctl00_mainArea_main_lblBonusAmount"[^>]*>([^<]*)/i],replaceTagsAndSpaces,parseBalance),getParam(a,b,"bonuses_grade",[/Уровень\s*"([^"]*)/i,/"ctl00_ctl00_mainArea_main_lblStatus"[^>]*>([^<]*)/i],replaceTagsAndSpaces))};
