var g_headers={Accept:"application/json, text/plain, */*","Accept-Charset":"UTF-8","Accept-Language":"ru",Connection:"Keep-Alive","User-Agent":"Dalvik/1.6.0 (Linux; U; Android 4.1.1; Android SDK built for x86 Build/JRO03H)","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-ApiVersion":appVersion},baseurl="https://ibank.rncb.ru/prest-api/",g_token,appVersion="1.9.1",device_name="AnyBalance API",errorsDesc={invalid_grant:"Неверный логин или пароль!"};
function apiCall(b,a){var c=b.split(":"),d=c[1],c="POST"==c[0]?AnyBalance.requestPost(baseurl+d,a,g_token?addHeaders({Authorization:"Bearer "+g_token}):g_headers):AnyBalance.requestGet(baseurl+d,addHeaders({Authorization:"Bearer "+g_token})),d=AnyBalance.getLastStatusCode();if(400<=d){AnyBalance.trace(c);if(401==d)throw new AnyBalance.Error("Ошибка авторизации, проверьте логин и пароль.");if(c&&(c=getJson(c),d=c.error,"invalid_grant"==d?(setToken(),d="Неверный логин или пароль"):d=c.error_description||
(c.error?errorsDesc[c.error]:c.error),d))throw new AnyBalance.Error(d,null,/Неверный логин или пароль/i.test(d));throw new AnyBalance.Error("Ошибка при подключении к сайту провайдера! Попробуйте обновить данные позже.");}return c=getJson(c)}function checkSetToken(b){if(!b)throw new AnyBalance.Error("Не пришел токен в ответе банка, сайт изменен?");setToken(b)}function setToken(b){AnyBalance.setData("access_token",g_token=b);AnyBalance.saveData()}
function setCredentials(b,a){if(!b||!a)throw new AnyBalance.Error("Неудалось сохранить данные авторизации. web_mobile_login: "+b+" web_mobile_password: "+a);AnyBalance.setData("credentials",{web_mobile_login:b,web_mobile_password:a});AnyBalance.saveData()}function getCredentials(){return AnyBalance.getData("credentials")}function getToken(){return g_token=AnyBalance.getData("access_token")}
function login(b){AnyBalance.setDefaultCharset("utf-8");checkEmpty(b.login,"Введите логин!");checkEmpty(b.password,"Введите пароль!");if(getToken()){AnyBalance.trace("Устройство уже привязано, отлично, используем существующую сессию");b=getCredentials();if(!b)throw setToken(),new AnyBalance.Error("Устройство привязано неправильно, сбрасываем сессию.");a=apiCall("POST:authentication/oauth2",{platform:"Android",model:device_name,osVersion:"5.0",password:b.web_mobile_password,appVersion:appVersion,uuid:"ee5ba11cfba9170c",
web_mobile_login:b.web_mobile_login,jailBreak:"false",grant_type:"password"});checkSetToken(a.access_token)}else{var a=apiCall("POST:authentication/oauth2",[["grant_type","password"],["password",b.password],["username",b.login]]);checkSetToken(a.access_token);"otp"==a.scope&&(AnyBalance.trace("Необходимо ввести код для привязки устройства."),b=AnyBalance.retrieveCode("Пожалуйста, введите код из смс"),AnyBalance.trace("Код получен: "+b),a=apiCall("POST:authentication/otp",[["grant_type","password"],
["password",b],["device_name",device_name]]),b=a.username,a=a.password,setCredentials(b,a),a=apiCall("POST:authentication/oauth2",{platform:"Android",model:device_name,osVersion:"5.0",password:a,appVersion:appVersion,uuid:"ee5ba11cfba9170c",web_mobile_login:b,jailBreak:"false",grant_type:"password"}),checkSetToken(a.access_token),AnyBalance.trace("Устройство успешно привязано."),__setLoginSuccessful())}return a}
function processAccounts(b,a){if(AnyBalance.isAvailable("accounts")){var c=apiCall("GET:protected/accounts");AnyBalance.trace("Найдено счетов: "+c.length);a.accounts=[];for(var d=0;d<c.length;++d){var e=c[d],f=e.benefacc,e={__id:f,__name:e.acctype+" "+f+" "+e.curr};__shouldProcess("accounts",e);a.accounts.push(e)}}}
function processAccount(b,a){AnyBalance.trace("Обработка счета "+a.__name);getParam(b.acc,a,"accounts.num");getParam(b.acctype,a,"accounts.type");getParam(b.balance,a,"accounts.balance",null,null,parseBalance);getParam(b.currency,a,["accounts.currency","accounts.balance"],null,null,parseCurrency);getParam(b.date,a,"accounts.date_start",null,null,parseDateWord);AnyBalance.isAvailable("accounts.transactions")&&processAccountTransactions(html,a)}
function processCards(b,a){if(AnyBalance.isAvailable("cards")){var c=apiCall("GET:protected/cards");AnyBalance.trace("Найдено карт: "+c.length);a.cards=[];for(var d=0;d<c.length;++d){var e=c[d],f={__id:e.id,__name:e.alias};__shouldProcess("cards",f)&&processCard(e,f);a.cards.push(f)}}}
function processCard(b,a){getParam(b.balance+"",a,"cards.balance",null,replaceTagsAndSpaces,parseBalance);getParam(b.availableAmount+"",a,"cards.availableAmount",null,replaceTagsAndSpaces,parseBalance);getParam(b.lockedAmount+"",a,"cards.lockedAmount",null,replaceTagsAndSpaces,parseBalance);getParam(b.currencyCode,a,["cards.currency","cards"]);getParam(b.contractNumber,a,"cards.contractNumber");getParam(b.number,a,"cards.plainNumber");getParam(b.formattedName,a,"cards.formattedName");getParam(b.statusDescription,
a,"cards.statusDescription");getParam(b.type,a,"cards.type");getParam(1*b.expireDate,a,"cards.expireDate");"undefined"!=typeof processCardTransactions&&processCardTransactions(b,a)}function processInfo(b,a){var c=apiCall("GET:protected/client"),d=a.info={};getParam(c.fullName,d,"fio");getParam(c.phoneMobile,d,"mphone")};
