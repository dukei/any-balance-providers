var g_headers={Accept:"application/json, text/plain, */*","Accept-Charset":"UTF-8","Accept-Language":"ru",Connection:"Keep-Alive","User-Agent":"Dalvik/1.6.0 (Linux; U; Android 4.1.1; Android SDK built for x86 Build/JRO03H)","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-ApiVersion":appVersion},baseurl="https://online.rncb.ru/prest-api/",g_token,appVersion="1.9.1",device_name="AnyBalance API",errorsDesc={invalid_grant:"Неверный логин или пароль!"};
function setBaseurl(a){baseurl=a}
function apiCall(a,b){a=a.split(":");var c=a[1];b="POST"==a[0]?AnyBalance.requestPost(baseurl+c,b,g_token?addHeaders({Authorization:"Bearer "+g_token}):g_headers):AnyBalance.requestGet(baseurl+c,addHeaders({Authorization:"Bearer "+g_token}));a=AnyBalance.getLastStatusCode();if(400<=a){AnyBalance.trace(b);if(401==a)throw new AnyBalance.Error("Ошибка авторизации, проверьте логин и пароль.");if(b&&(b=getJson(b),a=b.error,"invalid_grant"==a?(setToken(),a="Неверный логин или пароль"):a=b.error_description||
(b.error?errorsDesc[b.error]:b.error),a))throw new AnyBalance.Error(a,null,/Неверный логин или пароль/i.test(a));throw new AnyBalance.Error("Ошибка при подключении к сайту провайдера! Попробуйте обновить данные позже.");}return b=getJson(b)}function checkSetToken(a){if(!a)throw new AnyBalance.Error("Не пришел токен в ответе банка, сайт изменен?");setToken(a)}function setToken(a){AnyBalance.setData("access_token",g_token=a);AnyBalance.saveData()}
function setCredentials(a,b){if(!a||!b)throw new AnyBalance.Error("Неудалось сохранить данные авторизации. web_mobile_login: "+a+" web_mobile_password: "+b);AnyBalance.setData("credentials",{web_mobile_login:a,web_mobile_password:b});AnyBalance.saveData()}function getCredentials(a){return a.__debugData?(AnyBalance.trace("Используем данные из преференсов..."),a.__debugData.credentials):AnyBalance.getData("credentials")}
function getToken(a){return a.__debugData?(AnyBalance.trace("Используем данные из преференсов..."),g_token=a.__debugData.access_token):g_token=AnyBalance.getData("access_token")}
function login(a){AnyBalance.setDefaultCharset("utf-8");checkEmpty(a.login,"Введите логин!");checkEmpty(a.password,"Введите пароль!");if(getToken(a)){AnyBalance.trace("Устройство уже привязано, отлично, используем существующую сессию");a=getCredentials(a);if(!a)throw setToken(),new AnyBalance.Error("Устройство привязано неправильно, сбрасываем сессию.");b=apiCall("POST:authentication/oauth2",{platform:"Android",model:device_name,osVersion:"5.0",password:a.web_mobile_password,appVersion:appVersion,
uuid:"ee5ba11cfba9170c",web_mobile_login:a.web_mobile_login,jailBreak:"false",grant_type:"password"});checkSetToken(b.access_token)}else{var b=apiCall("POST:authentication/oauth2",[["grant_type","password"],["password",a.password],["username",a.login]]);checkSetToken(b.access_token);"otp"==b.scope&&(AnyBalance.trace("Необходимо ввести код для привязки устройства."),a=AnyBalance.retrieveCode("Пожалуйста, введите код из смс"),AnyBalance.trace("Код получен: "+a),b=apiCall("POST:authentication/otp",[["grant_type",
"password"],["password",a],["device_name",device_name]]),a=b.username,b=b.password,setCredentials(a,b),b=apiCall("POST:authentication/oauth2",{platform:"Android",model:device_name,osVersion:"5.0",password:b,appVersion:appVersion,uuid:"ee5ba11cfba9170c",web_mobile_login:a,jailBreak:"false",grant_type:"password"}),checkSetToken(b.access_token),AnyBalance.trace("Устройство успешно привязано."),__setLoginSuccessful())}return b}
function processAccounts(a,b){if(AnyBalance.isAvailable("accounts")){a=apiCall("GET:protected/accounts");AnyBalance.trace("Найдено счетов: "+a.length);b.accounts=[];for(var c=0;c<a.length;++c){var d=a[c],e=d.benefacc,d={__id:e,__name:d.acctype+" "+e+" "+d.curr};__shouldProcess("accounts",d);b.accounts.push(d)}}}
function processAccount(a,b){AnyBalance.trace("Обработка счета "+b.__name);getParam(a.acc,b,"accounts.num");getParam(a.acctype,b,"accounts.type");getParam(a.balance,b,"accounts.balance",null,null,parseBalance);getParam(a.currency,b,["accounts.currency","accounts.balance"],null,null,parseCurrency);getParam(a.date,b,"accounts.date_start",null,null,parseDateWord);AnyBalance.isAvailable("accounts.transactions")&&processAccountTransactions(html,b)}
function processCards(a,b){if(AnyBalance.isAvailable("cards")){a=apiCall("GET:protected/cards");AnyBalance.trace("Найдено карт: "+a.length);b.cards=[];for(var c=0;c<a.length;++c){var d=a[c],e={__id:d.id,__name:d.contractNumber};__shouldProcess("cards",e)&&processCard(d,e);b.cards.push(e)}}}
function processCard(a,b){getParam(a.balance+"",b,"cards.balance",null,replaceTagsAndSpaces,parseBalance);getParam(a.availableAmount+"",b,"cards.availableAmount",null,replaceTagsAndSpaces,parseBalance);getParam(a.lockedAmount+"",b,"cards.lockedAmount",null,replaceTagsAndSpaces,parseBalance);getParam(a.currencyCode,b,["cards.currency","cards"]);getParam(a.contractNumber,b,"cards.contractNumber");getParam(a.number,b,"cards.plainNumber");getParam(a.formattedName,b,"cards.formattedName");getParam(a.statusDescription,
b,"cards.statusDescription");getParam(a.type,b,"cards.type");getParam(1*a.expireDate,b,"cards.expireDate");"undefined"!=typeof processCardTransactions&&processCardTransactions(a,b)}function processInfo(a,b){a=apiCall("GET:protected/client");b=b.info={};getParam(a.fullName,b,"fio");getParam(a.phoneMobile,b,"mphone")};
