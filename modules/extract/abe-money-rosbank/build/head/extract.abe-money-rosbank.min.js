var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8","Accept-Language":"ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36"},g_baseurl="https://online.rosbank.ru/";
function findWicketActions(c){c=sumParam(c,null,null,/Wicket.Ajax.ajax\((\{[\s\S]*?\})\);/ig)||[];AnyBalance.trace("Found "+c.length+" Wicket-ajax actions");return c}
function requestWicketAction(c,a,b,d){var e=getParam(c,null,null,/c":"([^"]*)/i);c=getParam(c,null,null,/u":"\.\/([^"]*)/i);return AnyBalance.requestPost(g_baseurl+"ibank/"+c,a,addHeaders({"X-Requested-With":"XMLHttpRequest",Accept:"application/xml, text/xml, */*; q=0.01","Wicket-Ajax":"true",Referer:b,"Wicket-Ajax-BaseURL":d,"Wicket-FocusedElementId":e}))}
function login(){var c=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");var a=AnyBalance.requestGet(g_baseurl+"ibank",g_headers);if(/actionLogout/i.test(a))AnyBalance.trace("Найдена активная сессия. Используем её.");else{var b=getElement(a,/<form[^>]+operation/i);if(!b)throw new AnyBalance.Error("Не удалось найти форму входа. Сайт изменен?");b=AB.createFormParams(b,function(a,b,d,e){if(!/actionComponent/i.test(d))return/login/i.test(d)?c.login:/password/i.test(d)?c.password:e});b["actions:list:2:actionComponent"]=
"1";var d=findWicketActions(a),e=AnyBalance.getLastUrl(),f=getParam(a,null,null,/Wicket.Ajax.baseUrl="([^"]*)/i)||"home?0",a=requestWicketAction(d[4],{"fields:field:1:login":c.login,"":""},e,f),a=requestWicketAction(d[5],{"fields:field:2:password":c.password,"":""},e,f),a=requestWicketAction(d[2],b,e,f);if(/AcceptTerms/i.test(a))throw new AnyBalance.Error("Вы ещё ни разу не входили в интернет-банк или вам требуется сменить пароль. Зайдите в интернет банк через браузер на https://ibank.rosbank.ru/, затем попробуйте выполнить провайдер ещё раз");
if(!/redirect|<button[^>]*>\s*Готово\s*<\/button>/i.test(a)){if(b=getParam(a,null,null,/<span[^>]*error[^>]*>([\s\S]*?)<\/span>/i))throw new AnyBalance.Error(b,null,!0);AnyBalance.trace(a);throw new AnyBalance.Error("Не удаётся войти в интернет банк. Сайт изменен?");}__setLoginSuccessful()}return a}
function processAccounts(c){if(AnyBalance.isAvailable("accounts")){var a=AnyBalance.requestGet(g_baseurl+"ibank/main",g_headers),b=findWicketActions(a),d=AnyBalance.getLastUrl(),a=getParam(a,null,null,/Wicket.Ajax.baseUrl="([^"]*)/i)||"main?1",b=getParam(b[b.length-1],null,null,/u":"\.\/([^"]*)/i),a=AnyBalance.requestPost(g_baseurl+"ibank/"+b,null,addHeaders({"Wicket-Ajax":"true","Wicket-Ajax-BaseURL":a,Referer:d}));if(d=getElements(a,/<div[^>]*product account/ig).join("\n"))for(c.accounts=[],d=getElements(d,
/<div[^>]*mainInfo[^>]*>/ig),AnyBalance.trace("Нашли "+d.length+" счетов"),a=0;a<d.length;++a){var b=d[a],e=getParam(b,null,null,/<div[^>]*class="number"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces),f=getParam(b,null,null,/<a[^>]*class="name[^"]*"[^>]*>([\s\S]*?)<\/a>/i,replaceTagsAndSpaces),e={__id:e,__name:f+" "+e.substr(-4),num:e};__shouldProcess("accounts",e)&&processAccount(b,e);c.accounts.push(e)}else AnyBalance.trace(a),AnyBalance.trace("Не удалось получить таблицу счетов")}}
function processAccount(c,a){AnyBalance.trace("Обработка счета "+a.__name);getParam(c,a,"accounts.balance",/<span[^>]*class="sum"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"accounts.currency",/<span[^>]*class="currency"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseCurrency);if(AnyBalance.isAvailable("accounts.num","accounts.type","accounts.owner")){var b=getParam(c,null,null,/<a[^>]*href="\.\/([^"]*)/i,replaceHtmlEntities),b=AnyBalance.requestGet(g_baseurl+"ibank/"+
b,g_headers),d=findWicketActions(b);c=AnyBalance.getLastUrl();var e=getParam(b,null,null,/Wicket.Ajax.baseUrl="([^"]*)/i),d=getParam(d[d.length-1],null,null,/u":"\.\/([^"]*)/i);c=AnyBalance.requestPost(g_baseurl+"ibank/"+d,null,addHeaders({"Wicket-Ajax":"true","Wicket-Ajax-BaseURL":e,Referer:c}));getParam(c,a,"accounts.num",/Номер счёта:(?:[\s\S]*?)<div[^>]*class="stringField[^"]*[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(c,a,"accounts.type",/Тип счёта:(?:[\s\S]*?)<div[^>]*class="stringField[^"]*[^>]*>([\s\S]*?)<\/div>/i,
replaceTagsAndSpaces);getParam(c,a,"accounts.owner",/Наименование счёта:(?:[\s\S]*?)<div[^>]*class="stringField[^"]*[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces)}AnyBalance.isAvailable("accounts.transactions")&&processTransactions(b,a)}
function processTransactions(c,a){AnyBalance.trace("Получаем транзакции для "+a.__name);var b=findWicketActions(c),d=AnyBalance.getLastUrl();c=getParam(c,null,null,/Wicket.Ajax.baseUrl="([^"]*)/i);b=getParam(b[7],null,null,/u":"\.\/([^"]*)/i);c=AnyBalance.requestPost(g_baseurl+"ibank/"+b,{ida2_hf_0:"ida2_hf_0","fields:field:1:dateRangeName:select":"CUSTOM","fields:field:2:dateRange:dateFrom:date":getFormattedDate({format:"DD.MM.YYYY",offsetYear:1}),"fields:field:2:dateRange:dateTo:date":getFormattedDate({format:"DD.MM.YYYY"}),
"fields:field:3:filter":"",filterAction:"1"},addHeaders({"Wicket-Ajax":"true","Wicket-Ajax-BaseURL":c,Referer:d}));/загрузка/i.test(c)&&((b=findWicketActions(c))?(b=getParam(b[0],null,null,/u":"\.\/([^"]*)/i),AnyBalance.sleep(5E3),c=AnyBalance.requestGet(g_baseurl+"ibank/"+b+"&_="+(new Date).getTime(),addHeaders({"X-Requested-With":"XMLHttpRequest","Wicket-Ajax-BaseURL":d,"Wicket-Ajax":"true"}))):(AnyBalance.trace(c),AnyBalance.trace("Не удалось найти ссылку для запроса транзакций")));d=getElements(c,
/<div[^>]*class="statementTransaction[^"]*"[^>]*>/ig);a.transactions=[];for(c=0;c<d.length;c++)b={},getParam(d[c],b,"transactions.sum",/<span[^>]*class="sum"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance),getParam(d[c],b,"transactions.descr",/<div[^>]*class="description"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces),getParam(d[c],b,"transactions.type",/<div[^>]*class="name"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces),getParam(d[c],b,"transactions.date",/<div[^>]*class="date"[^>]*>([\s\S]*?)<\/div>/i,
replaceTagsAndSpaces,parseDate),a.transactions.push(b)}
function processCards(c){if(AnyBalance.isAvailable("cards")){var a=AnyBalance.requestGet(g_baseurl+"ibank/main",g_headers),b=findWicketActions(a),d=AnyBalance.getLastUrl(),a=getParam(a,null,null,/Wicket.Ajax.baseUrl="([^"]*)/i)||"main?1",b=getParam(b[b.length-1],null,null,/u":"\.\/([^"]*)/i),a=AnyBalance.requestPost(g_baseurl+"ibank/"+b,null,addHeaders({"Wicket-Ajax":"true","Wicket-Ajax-BaseURL":a,Referer:d}));if(d=getElement(a,/<div[^>]*cards listView[^>]*>/i))for(c.cards=[],d=getElements(d,/<div[^>]*accountCard[^>]*>/ig),
AnyBalance.trace("Нашли "+d.length+" карт"),a=0;a<d.length;++a){var b=d[a],e=getParam(b,null,null,/<div[^>]*class="number"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces),f=getParam(b,null,null,/<a[^>]*class="name[^"]*"[^>]*>([\s\S]*?)<\/a>/i,replaceTagsAndSpaces),e={__id:e,__name:f+" "+e.substr(-4),num:e};__shouldProcess("cards",e)&&processCard(b,e);c.cards.push(e)}else AnyBalance.trace(a),AnyBalance.trace("Не удалось получить таблицу счетов")}}
function processCard(c,a){AnyBalance.trace("Обработка карты "+a.__name);getParam(c,a,"cards.till",/<div[^>]*class="term"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseDate);if(AnyBalance.isAvailable("cards.balance","cards.currency","cards.num","cards.type","cards.blocked","cards.cardholder","cards.date_start")){var b=getParam(c,null,null,/<a[^>]*href="\.\/([^"]*)/i,replaceHtmlEntities),b=AnyBalance.requestGet(g_baseurl+"ibank/"+b,g_headers),d=findWicketActions(b);c=AnyBalance.getLastUrl();var e=
getParam(b,null,null,/Wicket.Ajax.baseUrl="([^"]*)/i),d=getParam(d[d.length-1],null,null,/u":"\.\/([^"]*)/i);AnyBalance.requestPost(g_baseurl+"ibank/"+d,null,addHeaders({"Wicket-Ajax":"true","Wicket-Ajax-BaseURL":e,Referer:c}));getParam(b,a,"cards.balance",/Доступный остаток(?:[\s\S]*?)<span[^>]*class="sum"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"cards.blocked",/Заблокировано(?:[\s\S]*?)<span[^>]*class="sum"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);
getParam(b,a,"cards.currency",/Доступный остаток(?:[\s\S]*?)<span[^>]*class="currency"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces);getParam(b,a,"cards.type",/Тип карты(?:[\s\S]*?)<div[^>]*formcontrol[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(b,a,"cards.cardholder",/Держатель карты(?:[\s\S]*?)<div[^>]*formcontrol[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(b,a,"cards.date_start",/Дата выпуска(?:[\s\S]*?)<span[^>]*formcontrol[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,
parseDate);getParam(b,a,"cards.accnum",/Привязанные счета(?:[\s\S]*?)<div[^>]*class="number"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces)}AnyBalance.isAvailable("cards.transactions")&&processTransactions(b,a)}
function processInfo(c){if(AnyBalance.isAvailable("info")){c=c.info={};var a=AnyBalance.requestGet(g_baseurl+"ibank/profile",g_headers);getParam(a,c,"info.fio",/Имя пользователя(?:[\s\S]*?)<div[^>]*class="value"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(a,c,"info.phone",/Отправка SMS на номер телефона(?:[\s\S]*?)<div[^>]*class="description[^"]*"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(a,c,"info.notify",/Отправка SMS на номер телефона(?:[\s\S]*?)<div[^>]*class="value[^"]*"[^>]*>([\s\S]*?)<\/div>/i,
replaceTagsAndSpaces)}};
