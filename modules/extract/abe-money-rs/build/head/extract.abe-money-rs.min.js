var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:35.0) Gecko/20100101 Firefox/35.0"},baseurl="https://online.rsb.ru/";
function callApi(b,a,c){var e="GET",d={DateValue:""+(new Date).getTime(),Expires:"0",Referer:baseurl,Origin:baseurl.replace(/\/$/,"")};isset(c)&&(e="POST",d=addHeaders({"Content-Type":"application/json"},d));b=AnyBalance.requestPost(baseurl+"rest/"+b+(a?"?"+createUrlEncodedParams(a):""),c&&JSON.stringify(c),addHeaders(d),{HTTP_METHOD:e});if(!b)return{__empty:!0};a=getJson(b);if(a.error)throw AnyBalance.trace(b),new AnyBalance.Error(a.error.description,null,/парол|Unauthorized/i.test(a.error.description));
if(a.errors)throw a=a.errors.join("\n"),AnyBalance.trace(b),new AnyBalance.Error(a,null,/парол|Unauthorized/i.test(a));return a}
function login(){var b=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");var a;try{return callApi("session/status"),AnyBalance.trace("Используем существующую сессию..."),getProductsJson()}catch(e){AnyBalance.trace("Автологин не получился: "+e.message)}a=callApi("biz/auth/login",null,{device:hex_md5(b.login),password:b.password,sysName:"internetbank",userName:b.login});if(a.otpId){AnyBalance.trace("потребовалось подтверждение по "+a.confirmType);var c=AnyBalance.retrieveCode("Пожалуйста, введите подтверждение, полученное по "+
a.confirmType+". Если Вы не хотите вводить код каждый раз, отмените запрос кода на вход в настройках интернет-банка https://online.rsb.ru",null,{inputType:"number",time:18E4});a=callApi("biz/auth/login",null,{confirmation:{otpId:a.otpId,otpValue:c},device:hex_md5(b.login),password:b.password,sysName:"internetbank",userName:b.login})}if(!a.authorized)throw AnyBalance.trace(JSON.stringify(a)),new AnyBalance.Error("Не удалось войти в интернет банк. Сайт изменен?");return getProductsJson()}
function getProductsJson(){if(getProductsJson.cached_json)return getProductsJson.cached_json;var b=callApi("biz/client-products");return getProductsJson.cached_json=b}
function processAccounts(b,a){if(AnyBalance.isAvailable("accounts")){b=b.ACCOUNT||[];AnyBalance.trace("Найдено счетов: "+b.length);a.accounts=[];for(var c=0;c<b.length;++c){var e=b[c],d=e.productId.contractId,f=e.productNumber,g=e.label+" "+f.substr(-4),d={__id:d,__name:g,num:f};__shouldProcess("accounts",d)&&processAccount(e,d);a.accounts.push(d)}}}
function processAccount(b,a){AnyBalance.trace("Обработка счета "+a.__name);getParam(b.label,a,"accounts.name");var c=callApi("biz/account/detail",{id:b.productId.contractId});getParam(jspath1(c,"$.availableBalance.amount"),a,"accounts.balance",null,null,parseBalance);getParam(jspath1(c,"$.availableBalance.currency"),a,["accounts.currency","accounts.balance"]);getParam(c.contractDate,a,"accounts.date_start");getParam(c.tariffPlanName,a,"accounts.tariff");getParam(c.contractNumber,a,"accounts.contract");
getParam(c.currentRate,a,"accounts.pct");isAvailable("accounts.num")&&(c=callApi("biz/account/account-requisites/"+b.productId.contractId),getParam(c[0].accountNumber,a,"accounts.num"));AnyBalance.isAvailable("accounts.transactions")}
function processCards(b,a){if(AnyBalance.isAvailable("cards")){b=b.CARD||[];AnyBalance.trace("Найдено карт: "+b.length);a.cards=[];for(var c=0;c<b.length;++c){var e=b[c],d=e.productId.cardId,f=e.productNumber,g=e.label+" "+f.substr(-4),d={__id:d,__name:g,num:f};__shouldProcess("cards",d)&&processCard(e,d);a.cards.push(d)}}}
function processCard(b,a){AnyBalance.trace("Обработка карты "+a.__name);var c=callApi("biz/card/detail",{id:b.productId.cardId});getParam(jspath1(c,"$.cardAccountBalanceDetailList[0].availableAmount.value.amount"),a,"cards.balance");getParam(jspath1(c,"$.cardAccountBalanceDetailList[0].blockedAmount.value.amount"),a,"cards.blocked");getParam(c.cardNumber,a,"cards.num");getParam(jspath1(c,"$.creditLimit.value.amount"),a,"cards.limit");getParam(c.currency,a,["cards.currency","cards.balance","cards.blocked",
"cards.own"]);getParam(c.expiryDate,a,"cards.till");getParam(c.contractSignDate,a,"cards.date_start",null,null,parseDateISO);getParam(c.tariffPlan,a,"cards.tariff");getParam(c.status,a,"cards.status");getParam(jspath1(c,"$.gracePeriodAmount.value.amount"),a,"cards.gracepay");getParam(jspath1(c,"$.minPaymentAmount.value.amount"),a,"cards.minpay");getParam(c.gracePeriodDate,a,"cards.gracepay_till");getParam(c.productId.contractId,a,"cards.contract");getParam(!b.isAdditionalCard,a,"cards.main");isAvailable("cards.accnum")&&
(c=callApi("biz/account/account-requisites/"+b.productId.contractId),getParam(c[0].accountNumber,a,"accounts.accnum"));AnyBalance.isAvailable("cards.transactions")}function processDeposits(b,a){if(AnyBalance.isAvailable("deposits"))throw new AnyBalance.Error("Депозиты временно не поддерживаются. Обращайтесь к разработчику.");}
function processDeposit(b,a,c){AnyBalance.trace("Обработка депозита "+a.__name);getParam(b.acc[0].available,a,"deposits.balance",null,null,parseBalance);getParam(b.acc[0].currency,a,["deposits.currency","deposits.balance"]);getParam(b.date_create,a,"deposits.date_start",null,null,parseDate);getParam(b.end,a,"deposits.till",null,null,parseDate);getParam(b.rate,a,"deposits.pct",null,null,parseBalance);getParam(b.title,a,"deposits.name");b=AB.getElement(c,/<table[^>]+prod-balance_var2[^>]*>/,replaceHtmlEntities);
getParam(b,a,"deposits.prolong",/Автоматическое возобновление[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBool);getParam(b,a,"deposits.prolong_times",/Количество свершившихся автоматических возобновлений[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance)}function processCredits(b,a){if(AnyBalance.isAvailable("credits"))throw new AnyBalance.Error("Кредиты временно не поддерживаются. Обращайтесь к разработчику.");}
function processCredit(b,a,c){AnyBalance.trace("Обработка кредита "+a.__name);getParam(b.loan.amount,a,"credits.limit",null,replaceTagsAndSpaces,parseBalance);getParam(b.acc[0].available,a,"credits.balance",null,replaceTagsAndSpaces,parseBalance);getParam(b.acc[0].currency,a,"credits.currency",null,replaceTagsAndSpaces);getParam(b.title,a,"credits.name");getParam(b.next.amount,a,"credits.minpay",null,replaceTagsAndSpaces,parseBalance);getParam(b.next.date,a,"credits.minpay_till",null,replaceTagsAndSpaces,
parseDate);c||(c=getActionUrl(/Информация по кредиту/i,p.actions),c=AnyBalance.requestGet(c,g_headers));c=getElement(c,/<div[^>]+h-content-inner[^>]*>/i,replaceHtmlEntities);getParam(c,a,"credits.own",/Остаток на счёте[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"credits.date_start",/Дата заключения договора[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseDate);getParam(c,a,"credits.accnum",/Номер счета в банке:([\s\S]*?)<\/p>/i,replaceTagsAndSpaces);
AnyBalance.isAvailable("credits.schedule")&&(c=getActionUrl(/График платежей/i,b.actions),processCreditSchedule(c,a))}function processBonus(b,a){AnyBalance.isAvailable("bonus")&&(b=callApi("biz/bonus-list"),getParam(jspath1(b[0],"$.balance.value.amount"),a,"bonus"))}function processInfo(b,a){AnyBalance.isAvailable("info")&&(b=callApi("biz/user-settings/personal"),a=a.info={},getParam(jspath1(b,"$.fullName.value"),a,"info.fio"),getParam(jspath1(b,"$.email.value"),a,"info.email"))};
