var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:35.0) Gecko/20100101 Firefox/35.0"},baseurl="https://online.rsb.ru/hb/faces/";
function login(){var a=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");var b=getProductsJson();if(b)AnyBalance.trace("Используем существующую сессию...");else{a=AnyBalance.requestPost(baseurl+"security_check",{j_username:a.login,j_password:a.password,systemid:"hb"},g_headers);(b=getParam(a,null,null,/window.location\s*=\s*"faces\/([^"]*)/i,replaceSlashes))&&(a=AnyBalance.requestGet(baseurl+b,g_headers));if(!/<div[^>]+class="b-login"[^>]*>/i.test(a))for(;/Ввод пароля из SMS-сообщения/i.test(a);){var b=
getParam(a,null,null,/<div[^>]+class="b-errors-message"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces),d=getParam(a,null,null,/<label[^>]+for="temp_pass"[^>]*>([\s\S]*?)<\/label>/i,replaceTagsAndSpaces),d=b?b+"\n\n"+d:d+"\n\nДля пользования провайдером удобно отключить одноразовый пароль на вход в настройках интернет-банка. Это безопасно, для проведения любых операций SMS-пароль всё равно будет требоваться.",a=getParam(a,null,null,/<form[^>]+action="[^"]*sms.jsp[\s\S]*?<\/form>/i);if(!a)throw new AnyBalance.Error("Не удаётся найти форму ввода одноразового смс кода на вход.\n\nДля пользования провайдером удобно отключить одноразовый пароль на вход в настройках интернет-банка. Это безопасно, для проведения любых операций SMS-пароль всё равно будет требоваться.");
a=createFormParams(a,function(a,b,f,g){if(/submit_by_enth?er/i.test(b))return AnyBalance.retrieveCode(d,null,{time:3E5,inputType:"number"});if(/type="submit"/i.test(b))/&#1042;&#1086;&#1081;&#1090;&#1080;/.test(b)&&(a.source=f);else return g});a=AnyBalance.requestPost(baseurl+"system/login/sms/sms.jsp",a)}if(!/<div[^>]+class="b-login"[^>]*>/i.test(a)){if(b=getParam(a,null,null,/window.location\s*=\s*"([^"]*)/i,replaceSlashes))AnyBalance.trace("Переходим на "+b),a=AnyBalance.requestGet(joinUrl(baseurl,
b));if(/Ввод пароля из SMS-сообщения/i.test(a))throw new AnyBalance.Error("У вас настроен вход по паролю из SMS сообщения. Для пользования провайдером удобно отключить этот пароль в настройках интернет-банка. Это безопасно, для проведения любых операций SMS-пароль всё равно будет требоваться.");(b=getParam(a,null,null,/<div[^>]+class="b-frm-warning2"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces))||(b=getParam(a,null,null,/<h2[^>]+class="b-auth-error[^>]*>([\s\S]*?)<\/h2>/i,replaceTagsAndSpaces));
b||(b=getParam(a,null,null,/<div[^>]+class="b-auth-blocked"[^>]*>\s*<p>([\s\S]*?)<\/p>/i,replaceTagsAndSpaces));/необходимо задать новый пароль/i.test(""+b)&&(b+=" Зайдите в интернет-банк https://online.rsb.ru через браузер, задайте новый пароль и введите новый пароль в настройки провайдера.");if(b)throw new AnyBalance.Error(b,null,/новый пароль|или пароль|Доступ в систему заблокирован/i.test(b));AnyBalance.trace(a);throw new AnyBalance.Error("Ошибка авторизации. Проверьте логин и пароль");}b=getProductsJson()}return b}
function getProductsJson(){if(getProductsJson.cached_json)return getProductsJson.cached_json;var a=AnyBalance.requestGet(baseurl+"request.json",g_headers);if(/'data'/.test(a))return!1;try{var b=getJson(a);if(!b.data)throw AnyBalance.trace(a),new AnyBalance.Error("Ошибка получения списка продуктов. Сайт изменен?");}catch(d){if(a=getElement(a,/<h1/i,replaceTagsAndSpaces))throw new AnyBalance.Error(a);throw new AnyBalance.Error("Ошибка соединения с интернет-банком. Сайт изменен?");}return getProductsJson.cached_json=
b}function processAccounts(a,b){if(AnyBalance.isAvailable("accounts")){for(var d=[],c=0;c<a.data.length;++c){var e=a.data[c];"account"==e.type&&d.push(e)}AnyBalance.trace("Найдено счетов: "+d.length);b.accounts=[];for(c=0;c<d.length;++c){e=d[c];a=e.id;var f=e.num,g=e.title+" "+f.substr(-4);a={__id:a,__name:g,num:f};__shouldProcess("accounts",a)&&processAccount(e,a);b.accounts.push(a)}}}
function processAccount(a,b){AnyBalance.trace("Обработка счета "+b.__name);getParam(a.title,b,"accounts.name");getParam(a.acc[0].available,b,"accounts.balance",null,null,parseBalance);getParam(a.acc[0].currency,b,["accounts.currency","accounts.balance"]);getParam(a.date_create,b,"accounts.date_start",null,null,parseDate);if(AnyBalance.isAvailable("accounts.transactions","accounts.status","accounts.tariff")){a=AnyBalance.requestGet(joinUrl(baseurl,a.link),g_headers);if(AnyBalance.isAvailable("accounts.status",
"accounts.tariff")){var d=getElement(a,/<table[^>]+prod-balance_var2[^>]*>/i,replaceHtmlEntities);getParam(d,b,"accounts.status",/Состояние[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(d,b,"accounts.tariff",/Тарифный план[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,[/Тарифный план\s*-/i,"",replaceTagsAndSpaces])}AnyBalance.isAvailable("accounts.transactions")&&processAccountTransactions(a,b)}}
function processCards(a,b){if(AnyBalance.isAvailable("cards")){for(var d=[],c=0;c<a.data.length;++c){var e=a.data[c];"card"==e.type&&d.push(e)}AnyBalance.trace("Найдено карт: "+d.length);b.cards=[];for(c=0;c<d.length;++c)if(e=d[c],e.acc){a=e.id;var f=e.num,g=e.title+" "+f.substr(-4);a={__id:a,__name:g,num:f};__shouldProcess("cards",a)&&processCard(e,a);b.cards.push(a)}}}function followDetailsLink(a,b){if(b=getParam(a,null,null,b))return followDetailsLinkStr(a,b)}
function followDetailsLinkStr(a,b,d){var c=getElement(a,/<form[^>]+name="mainform"[^>]*>/i);a=createFormParams(c);a.source=getParam(b,null,null,/source\s*:\s*'([^']*)/);b=getParam(c,null,null,/<form[^>]+action="([^"]*)/i,replaceHtmlEntities);b=joinUrl(baseurl,b);return a=AnyBalance.requestPost(b,a,g_headers,d)}
function processCard(a,b){function d(a){return/основная/i.test(a)}AnyBalance.trace("Обработка карты "+b.__name);getParam(a.acc[0].available,b,"cards.balance",null,null,parseBalance);getParam(a.acc[0].lock,b,"cards.blocked",null,null,parseBalance);getParam(a.acc[0].own,b,"cards.own",null,null,parseBalance);getParam(a.acc[0].credit,b,"cards.limit",null,null,parseBalance);getParam(a.acc[0].currency,b,["cards.currency","cards.balance","cards.blocked","cards.own"]);getParam(a.enddate,b,"cards.till",null,
replaceTagsAndSpaces,parseDate);getParam(a.date_create,b,"cards.date_start",null,replaceTagsAndSpaces,parseDate);getParam(a.tarif,b,"cards.tariff");a=joinUrl(baseurl,a.link);a=AnyBalance.requestGet(a,g_headers);var c=getElement(a,/<div[^>]+b-cash_back[^>]*>/i,replaceHtmlEntities);c?getParam(c,b,"cards.bonus",/Доступный баланс[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance):getParam(a,b,"cards.bonus",/<td[^>]+cashback-card-block__block-bonus[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,
parseBalance);(c=getElements(a,[/<table[^>]+prod-balance[^>]*>/ig,/ьготного периода/i],replaceHtmlEntities)[0])?(getParam(c,b,"cards.gracepay",/Сумма для реализации Льготного периода[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),getParam(c,b,"cards.gracepay_till",/Дата окончания Льготного периода[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseDate)):AnyBalance.trace("Данные о льготном периоде отсуствуют");AnyBalance.isAvailable("cards.transactions")&&processCardTransactions(a,
b);AnyBalance.isAvailable("cards.accnum","cards.main","cards.status","cards.contract","cards.excerpt")&&(c=getElement(a,/<div[^>]+b-prod-props[^>]*>/i,replaceHtmlEntities),c||(a=followDetailsLink(a,/<table[^>]+prod-balance_var2[\s\S]*?(<a[^>]+link_more[^>]*>)/i),c=getElement(a,/<div[^>]+b-prod-props[^>]*>/i,replaceHtmlEntities)),getParam(c,b,"cards.accnum",/Номер счета в банке:([\s\S]*?)<\/p>/i,replaceTagsAndSpaces),c=getElement(a,/<table[^>]+prod-balance_var2[^>]*>/i,replaceHtmlEntities),getParam(c,
b,"cards.main",/>\s*Тип[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,d),getParam(c,b,"cards.status",/>\s*Статус[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces),getParam(c,b,"cards.contract",/>\s*Договор[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,[/№/ig,"",replaceTagsAndSpaces]),AnyBalance.isAvailable("cards.excerpt")&&processCardExerpt(a,b))}
function processDeposits(a,b){if(AnyBalance.isAvailable("deposits")){for(var d=[],c=0;c<a.data.length;++c){var e=a.data[c];"deposit"==e.type&&d.push(e)}AnyBalance.trace("Найдено депозитов: "+d.length);b.deposits=[];for(c=0;c<d.length;++c){e=d[c];a=e.id;var f=joinUrl(baseurl,e.link);AnyBalance.trace("Детали по депозиту находятся по ссылке "+f);var f=AnyBalance.requestGet(f,g_headers),g=AB.getElement(f,/<table[^>]+prod-balance_var2[^>]*>/,replaceHtmlEntities),h=getParam(g,null,null,/Номер депозитного счета[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,
replaceTagsAndSpaces),g=getParam(g,null,null,/Номер договора[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces),k=e.title+" "+h.substr(-4);a={__id:a,__name:k,num:h,contract:g};__shouldProcess("deposits",a)&&processDeposit(e,a,f);b.deposits.push(a)}}}
function processDeposit(a,b,d){AnyBalance.trace("Обработка депозита "+b.__name);getParam(a.acc[0].available,b,"deposits.balance",null,null,parseBalance);getParam(a.acc[0].currency,b,["deposits.currency","deposits.balance"]);getParam(a.date_create,b,"deposits.date_start",null,null,parseDate);getParam(a.end,b,"deposits.till",null,null,parseDate);getParam(a.rate,b,"deposits.pct",null,null,parseBalance);getParam(a.title,b,"deposits.name");a=AB.getElement(d,/<table[^>]+prod-balance_var2[^>]*>/,replaceHtmlEntities);
getParam(a,b,"deposits.prolong",/Автоматическое возобновление[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBool);getParam(a,b,"deposits.prolong_times",/Количество свершившихся автоматических возобновлений[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance)}
function processCredits(a,b){if(AnyBalance.isAvailable("credits")){for(var d=[],c=0;c<a.data.length;++c){var e=a.data[c];"loan"==e.type&&d.push(e)}AnyBalance.trace("Найдено кредитов: "+d.length);b.credits=[];for(c=0;c<d.length;++c){e=d[c];a=e.id;var f=e.num,g;f||(g=getActionUrl(/Информация по кредиту/i,e.actions),g=AnyBalance.requestGet(g,g_headers),f=getElement(g,/<div[^>]+h-content-inner[^>]*>/i,replaceHtmlEntities),f=getParam(f,null,null,/Номер договора[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces));
var h=e.title+" "+f.substr(-4);a={__id:a,__name:h,num:f};__shouldProcess("credits",a)&&processCredit(e,a,g);b.credits.push(a)}}}function getActionUrl(a,b){for(var d=0;d<b.length;++d){var c=b[d];if(a.test(c.title))return joinUrl(baseurl,c.link)}}function parseBool(a){return/включено/i.test(a)}
function processCredit(a,b,d){AnyBalance.trace("Обработка кредита "+b.__name);getParam(a.loan.amount,b,"credits.limit",null,replaceTagsAndSpaces,parseBalance);getParam(a.acc[0].available,b,"credits.balance",null,replaceTagsAndSpaces,parseBalance);getParam(a.acc[0].currency,b,"credits.currency",null,replaceTagsAndSpaces);getParam(a.title,b,"credits.name");getParam(a.next.amount,b,"credits.minpay",null,replaceTagsAndSpaces,parseBalance);getParam(a.next.date,b,"credits.minpay_till",null,replaceTagsAndSpaces,
parseDate);d||(d=getActionUrl(/Информация по кредиту/i,p.actions),d=AnyBalance.requestGet(d,g_headers));d=getElement(d,/<div[^>]+h-content-inner[^>]*>/i,replaceHtmlEntities);getParam(d,b,"credits.own",/Остаток на счёте[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(d,b,"credits.date_start",/Дата заключения договора[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseDate);getParam(d,b,"credits.accnum",/Номер счета в банке:([\s\S]*?)<\/p>/i,replaceTagsAndSpaces);
AnyBalance.isAvailable("credits.schedule")&&(d=getActionUrl(/График платежей/i,a.actions),processCreditSchedule(d,b))}
function processInfo(a,b){AnyBalance.isAvailable("info")&&(a=AnyBalance.requestGet(baseurl+"rs/settings/Settings.jspx",g_headers),b=b.info={},getParam(a,b,"info.fio",/&#1048;&#1084;&#1103; ([^<]*)/i,replaceTagsAndSpaces),getParam(a,b,"info.login",/<input[^>]+name="mainform:login"[^>]*value="([^"]*)/i,replaceHtmlEntities),getParam(a,b,"info.email",/<input[^>]+name="mainform:email"[^>]*value="([^"]*)/i,replaceHtmlEntities))};
