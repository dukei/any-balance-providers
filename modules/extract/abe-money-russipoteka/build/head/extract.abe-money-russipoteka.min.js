var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.87 Safari/537.36"},baseurl="https://online.russipoteka.ru/web_banking/";
function login(){var c=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");checkEmpty(c.login,"Введите логин!");checkEmpty(c.password,"Введите пароль!");var a=AnyBalance.requestGet(baseurl+"protected/welcome.jsf",g_headers);if(!a||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(a),new AnyBalance.Error("Ошибка при подключении к сайту интернет-банка! Попробуйте обновить данные позже.");if(/logout/i.test(a))AnyBalance.trace("Уже залогинены, используем существующую сессию");else{var b=
getElement(a,/<form[^>]+loginForm/i);if(!b)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти форму входа. Сайт изменен?");var d=getParam(b,null,null,/<form[^>]+id="(\w+):/i,replaceHtmlEntities);getParam(b,null,null,/<form[^>]+action="([^"]*)/i,replaceHtmlEntities);a=createUrlEncodedParams({"*PREFIX*:login":c.login,"*PREFIX*:password":c.password,"*PREFIX*:captchaText":"","*PREFIX*:loginForm_SUBMIT":1,"javax.faces.ViewState":getParam(a,null,null,/<input[^>]+name="javax.faces.ViewState"[^>]+value="([^"]*)/i),
"javax.faces.behavior.event":"action","javax.faces.partial.event":"click","javax.faces.source":"*PREFIX*:loginBtn","javax.faces.partial.ajax":!0,"javax.faces.partial.execute":"*PREFIX*:login *PREFIX*:captchaText","*PREFIX*:loginForm":"*PREFIX*:loginForm"}).replace(/\*PREFIX\*/g,d);a=AnyBalance.requestPost(baseurl+"login.jsf",a,addHeaders({Referer:baseurl+"protected/welcome.jsf","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}));getJson(getParam(a,null,null,/(\{[^<]*)<\/message/i)).showCaptcha&&
AnyBalance.trace("Капчунька нужна...");a=AnyBalance.requestPost(baseurl+"j_security_check",{j_username:c.login,j_password:c.password,device_id:"",captcha:"",activation_code:"",locale:"ru"},addHeaders({Referer:baseurl+"protected/welcome.jsf"}))}if(/<input[^>]+otp_type_3_input[^>]*>/i.test(a)){b=getParam(a,null,null,/<input[^>]+emvSessionid[^>]+value="([^"]*)/i);a=AnyBalance.requestPost(baseurl+"smsPasswordLoginAjaxServlet",{smsSentTime:(new Date).getTime()},addHeaders({Referer:baseurl+"j_security_check"}));
d=getParam(a,null,null,/(\d+)/i);if(!d||!b)throw new AnyBalance.Error("Не удалось найти ID сессии. Сайт изменён?");var e=AnyBalance.retrieveCode("Пожалуйста, введите код из SMS для входа в интернет-банк. (ID: "+d+")",null,{inputType:"number",time:18E4});try{if(a=AnyBalance.requestPost(baseurl+"j_security_check",{session_id:d,register_computer:"",otp_type_7_input:"",otp_type_6_input:"",otp_type_4_input:"",otp_type_3_input:e,otp_type_1_input:"",otp_type:"3",otp:e,os_name:"",locale:"ru",j_username:c.login,
emvSessionId:b,device_id:"",computer_name:"",browser_name:""},addHeaders({Referer:baseurl+"j_security_check"})),400==AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Криворукие переадресовали на http, хотя сами его не понимают");}catch(f){AnyBalance.trace(f.message+"\n"+a),a=AnyBalance.requestGet(baseurl+"protected/welcome.jsf",g_headers)}}if(!/logout/i.test(a)){if(c=getElement(a,/<(?:[\s\S](?!display:\s*none|>))+class="error"(?:[\s\S](?!display:\s*none|>))*.>/i,replaceTagsAndSpaces))throw new AnyBalance.Error(c,
null,/Неверно указаны данные для входа в систему|парол/i.test(c));AnyBalance.trace(a);throw new AnyBalance.Error("Не удалось зайти в интернет-банк. Сайт изменен?");}__setLoginSuccessful();return a}
function processCards(c,a){if(AnyBalance.isAvailable("cards")){c=AnyBalance.requestGet(baseurl+"protected/cards/index",g_headers);var b=getElements(c,/<div[^>]+productShort["\s>]/ig);if(b.length){AnyBalance.trace("Найдено карт: "+b.length);a.cards=[];for(var d=0;d<b.length;++d){var e=getParam(b[d],/\/statement\/card\/(\d+)/i),f=getElement(b[d],/<table[^>]+w100Pc/i),g=getParam(f,/<td[^>]*>([^<]*)/i,replaceTagsAndSpaces),f=getElement(f,/<span[^>]+block/i,replaceTagsAndSpaces),e={__id:e,__name:g+" *"+
f.substr(-4),num:f};getParam(g,e,"cards.name");__shouldProcess("cards",e)&&processCard(b[d],e,c);a.cards.push(e)}}else AnyBalance.trace(c),AnyBalance.trace("Карты не найдены.")}}
function processCard(c,a,b){AnyBalance.trace("Обработка карты "+a.__name);getParam(getElement(c,/<span[^>]+amountBox/i),a,"cards.balance",null,replaceTagsAndSpaces,parseBalance);getParam(getElement(c,/<span[^>]+amountBox/i),a,["cards.currency","cards.balance"],null,replaceTagsAndSpaces,parseCurrency);AnyBalance.isAvailable("cards.till","cards.holder","cards.accnum","cards.agreement","cards.transactions")&&(b=AnyBalance.requestGet(baseurl+"protected/statement/card/"+a.__id,addHeaders({Referer:baseurl})),
b=replaceAll(b,replaceHtmlEntities),getParam(b,a,"cards.holder",/Держатель:([^<]*)/i,replaceTagsAndSpaces),getParam(b,a,"cards.accnum",/Карточный счет\s*([^<]*)/i,replaceTagsAndSpaces),getParam(b,a,"cards.till",/Действительна до:([^<]*)/i,replaceTagsAndSpaces,parseDate),getParam(b,a,"cards.agreement",/Номер договора:([^<]*)/i,replaceTagsAndSpaces),getParam(b,a,"cards.limit",/Лимит овердрафта:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance),getParam(b,a,"cards.balance_min",
/Неснижаемый остаток на счете:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance),isAvailable("cards.transactions")&&processCardTransactions(b,a))}function processInfo(c,a){a=a.info={};getParam(c,a,"info.fio",/<div[^>]+clientName[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces)}function processDeposits(c,a){throw new AnyBalance.Error("Обработка депозитов пока не поддерживается. Пожалуйста, обратитесь к разработчикам.");}
function processCredits(c,a){throw new AnyBalance.Error("Обработка кредитов пока не поддерживается. Пожалуйста, обратитесь к разработчикам.");}function processAccounts(c,a){throw new AnyBalance.Error("Обработка счетов пока не поддерживается. Пожалуйста, обратитесь к разработчикам.");};
