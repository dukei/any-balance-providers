var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.112 Safari/537.36"},baseurl="https://smponbank.ru/";
function login(){var a=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");checkEmpty(a.login,"Введите логин!");checkEmpty(a.password,"Введите пароль!");var b=AnyBalance.requestGet(baseurl,g_headers);if(!b||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(b),new AnyBalance.Error("Ошибка при подключении к сайту интернет-банка! Попробуйте обновить данные позже.");var c=AB.getElement(b,/<form[^>]+LogOn[^>]*>/i);if(!c)throw AnyBalance.trace(b),new AnyBalance.Error("Не удаётся найти форму входа! Сайт изменен?");
c=AB.createFormParams(c,function(b,c,f,g){return"Login"==f?a.login:"Password"==f?a.password:g});/logout/i.test(b)?AnyBalance.trace("Уже залогинены, используем существующую сессию"):b=AnyBalance.requestPost(baseurl+"Authorize/LogOn",c,addHeaders({Referer:baseurl+"Authorize/LogOn"}));if(!/logout/i.test(b)){if(c=getParam(b,null,null,/<div[^>]+(?:summary-errors|warningText)[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces))throw new AnyBalance.Error(c,null,/парол/i.test(c));AnyBalance.trace(b);throw new AnyBalance.Error("Не удалось зайти в интернет-банк. Сайт изменен?");
}b=AnyBalance.requestPost(baseurl+"Update/RunCustomerUpdate",addHeaders({Accept:"application/json, text/javascript, */*; q=0.01","X-Requested-With":"XMLHttpRequest"}));try{AnyBalance.trace("Обновляем данные...");if(!getJson(b).isSuccessful)throw new AnyBalance.Error(b);AnyBalance.trace("Обновление данных произведено успешно!")}catch(d){AnyBalance.trace("Обновление данных не удалось: "+d.message)}__setLoginSuccessful();return b}
function processAccounts(a,b){if(AnyBalance.isAvailable("accounts")){a=AnyBalance.requestGet(baseurl+"Ib/ViewAccounts",g_headers);var c=getElements(a,/<td[^>]+(?:blckListAccountsCurrent|blckListAccountSmpTrader|blckListAccountCard)[^>]*>/ig);if(c.length){for(var d=[],e=0;e<c.length;e++){var f=getElements(c[e],/<tr[^>]*>/ig);0==e&&f.splice(2,1);d=d.concat(f)}if(d.length)for(AnyBalance.trace("Найдено счетов: "+d.length),b.accounts=[],e=0;e<d.length;++e)a=getParam(d[e],null,null,/(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)<br/i,
replaceTagsAndSpaces),c=getParam(d[e],null,null,/(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)<br/i,replaceTagsAndSpaces),f=getParam(d[e],null,null,/(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)<br/i,replaceTagsAndSpaces),a={__id:a,__name:f,num:c},__shouldProcess("accounts",a)&&processAccount(d[e],a),b.accounts.push(a);else AnyBalance.trace(a),AnyBalance.trace("Не удалось найти счета.")}else AnyBalance.trace(a),AnyBalance.trace("Не удалось найти таблицы со счетами.")}}
function processAccount(a,b){AnyBalance.trace("Обработка счета "+b.__name);getParam(a,b,"accounts.balance",/<td[^>]+td-last nowrap(?:[^>]*>){2}([\s\S]*?)<span/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,["accounts.currency","accounts.balance"],/<td[^>]+td-last nowrap(?:[^>]*>){2}([\s\S]*?)<span/i,replaceTagsAndSpaces,parseCurrency);var c=getParam(a,null,null,/<a[^>]+class="details"[^>]+href="\/([^"]*)/i);c?(a=AnyBalance.requestGet(baseurl+c,g_headers),getParam(a,b,"accounts.type",/Тип счёта(?:[^>]*>){2}([^<]*)/i,
replaceTagsAndSpaces),getParam(a,b,"accounts.date_start",/Дата открытия(?:[^>]*>){3}([^<]*)/i,replaceTagsAndSpaces,parseDate),getParam(a,b,"accounts.status",/Статус счёта(?:[^>]*>){2}([^<]*)/i,replaceTagsAndSpaces),AnyBalance.isAvailable("accounts.transactions")&&processAccountTransactions(a,b)):(AnyBalance.trace(a),AnyBalance.trace("Не удалось найти ссылку на подробную информацию о счёте."))}
function processCards(a,b){if(AnyBalance.isAvailable("cards")){a=AnyBalance.requestGet(baseurl+"Ib/ViewAccounts",g_headers);var c=getElement(a,/<div[^>]+id="blckListCard"[^>]*>/i),d=getElements(c,/<tr[^>]*>/ig);if(d.length)for(AnyBalance.trace("Найдено карт: "+d.length),b.cards=[],a=0;a<d.length;++a){var c=getParam(d[a],null,null,/(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)(?:<\/td>|<br)/i,replaceTagsAndSpaces),e=getParam(d[a],null,null,/(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)(?:<\/td>|<br)/i,replaceTagsAndSpaces),
f=getParam(d[a],null,null,/(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)(?:<\/td>|<br)/i,replaceTagsAndSpaces),c={__id:c,__name:f,num:e};__shouldProcess("cards",c)&&processCard(d[a],c);b.cards.push(c)}else/У вас нет карт/i.test(c)?(AnyBalance.trace("У вас нет карт"),b.cards=[]):(AnyBalance.trace(a),AnyBalance.trace("Не удалось найти карты."))}}
function processCard(a,b){AnyBalance.trace("Обработка карты "+b.__name);getParam(a,b,"cards.balance",/(?:[\s\S]*?<td[^>]*>){4}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,["cards.currency","cards.balance"],/(?:[\s\S]*?<td[^>]*>){4}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseCurrency);getParam(a,b,"cards.accnum",/(?:[\s\S]*?<td[^>]*>){3}([\s\S]*?)(?:<br|<\/td>)/i,replaceTagsAndSpaces);getParam(a,b,"cards.till",/(?:[\s\S]*?<td[^>]*>){4}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,
parseDate);(a=getParam(a,null,null,/Ib\/GetCardDetail\?cardId=(\d+)/i))?(a=AnyBalance.requestGet(baseurl+"Ib/GetCardDetail?cardId="+a,g_headers),getParam(a,b,"cards.bonus",/<i[^>]*>СМП Трансаэро Бонус(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),getParam(a,b,"cards.minpay",/Сумма минимального платежа(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),getParam(a,b,"cards.minpay_till",/Минимальный платёж необходимо внести до(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)<\/td>/i,
replaceTagsAndSpaces,parseDate),getParam(a,b,"cards.blocked",/Зарезервированные суммы по расходным операциям(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),getParam(a,b,"cards.till",/Срок действия(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseDate),getParam(a,b,"cards.type",/Тип карты(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces)):AnyBalance.trace("Не удалось найти ссылку на дополнительную информацию по карте. Сайт изменен?")}
function processDeposits(a,b){throw new AnyBalance.Error("Обработка депозитов пока не поддерживается. Пожалуйста, обратитесь к разработчикам.");}function processCredits(a,b){throw new AnyBalance.Error("Обработка кредитов пока не поддерживается. Пожалуйста, обратитесь к разработчикам.");}
function processInfo(a,b){a=AnyBalance.requestGet(baseurl+"Authorize/Profile",g_headers);b=b.info={};getParam(a,b,"info.fio",/<span[^>]+user-name[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces);getParam(a,b,"info.mphone",/<input[^>]+primarytxtPhoneView[^>]+value="([^"]*)/i,replaceHtmlEntities);getParam(a,b,"info.email",/<input[^>]+txtemail[^>]+value="([^"]*)/i,replaceHtmlEntities)};
