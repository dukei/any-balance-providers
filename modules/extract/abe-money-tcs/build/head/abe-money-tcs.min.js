var g_headers={"User-Agent":"User-Agent: Sony D6503/android: 5.1.1/TCSMB/3.1.0"},g_baseurl="https://api.tcsbank.ru/v1/",g_deviceid,g_sessionid;
function requestJson(b,a,c){var d=[];c||(c={});g_sessionid&&d.push(encodeURIComponent("sessionid")+"="+encodeURIComponent(g_sessionid));if(a)for(var e in a)d.push(encodeURIComponent(e)+"="+encodeURIComponent(a[e]));d.push(encodeURIComponent("appVersion")+"="+encodeURIComponent("3.1.0"));d.push(encodeURIComponent("platform")+"="+encodeURIComponent("android"));d.push(encodeURIComponent("origin")+"="+encodeURIComponent("mobile,ib5,loyalty"));g_deviceid&&d.push(encodeURIComponent("deviceId")+"="+encodeURIComponent(g_deviceid));
a=c.post?AnyBalance.requestPost(g_baseurl+b+"?"+d.join("&"),c.post,g_headers):AnyBalance.requestGet(g_baseurl+b+"?"+d.join("&"),g_headers);a=getJson(a);if("OK"!=a.resultCode&&!c.noException)throw AnyBalance.trace("Ошибка: "+b+", "+a.errorMessage),new AnyBalance.Error((c.scope?c.scope+": ":"")+(a.plainMessage||a.errorMessage));return a}var g_accountsJson,g_accountTransactions={};function requestAccountsJson(){g_accountsJson||(g_accountsJson=requestJson("accounts_flat"));return g_accountsJson}
function login(){var b=AnyBalance.getPreferences();checkEmpty(b.login,"Введите логин в интернет-банк!");checkEmpty(b.password,"Введите пароль в интернет-банк!");if(g_sessionid)AnyBalance.trace("сессия уже установлена. Используем её.");else{var a=hex_md5(b.login),b=requestJson("mobile_session",{deviceId:a},{post:{username:b.login,password:b.password,screen_size:"1080x1920x32",timezone:-(new Date).getTimezoneOffset()},noException:!0});g_deviceid=a;if("DEVICE_LINK_NEEDED"==b.resultCode){a=b.payload.sessionid;
AnyBalance.trace("Необходимо привязать устройство...");var c=AnyBalance.retrieveCode("Пожалуйста, введите код подтверждения из смс",null,{inputType:"number",time:18E4});AnyBalance.trace("Получили код: "+c);requestJson("confirm",{initialOperationTicket:b.payload.confirmationData.operationTicket,confirmationData:'{"SMSBYID":"'+c+'"}',initialOperation:"mobile_link_device",sessionid:a});g_sessionid=a}else if("OK"==b.resultCode)g_sessionid=b.payload.sessionid;else throw new AnyBalance.Error(b.plainMessage||
b.errorMessage,null,"AUTHENTICATION_FAILED"==b.resultCode);__setLoginSuccessful()}return g_sessionid}
function processCards(b){if(AnyBalance.isAvailable("cards")){for(var a=requestAccountsJson(),c=[],d=0;d<a.payload.length;d++){var e=a.payload[d];/Current|Credit/i.test(e.accountType)&&e.cardNumbers&&c.push(e)}AnyBalance.trace("Найдено "+c.length+" счетов с картами");b.cards=[];for(d=0;d<c.length;d++)for(e=c[d],a=0;a<e.cardNumbers.length;a++){var f=e.cardNumbers[a],g={__id:f.id,__name:f.name+", "+f.value,num:f.value,accid:e.id};__shouldProcess("cards",g)&&processCard(f,e,g);b.cards.push(g)}}}
function processCard(b,a,c){AnyBalance.trace("Обработка карты "+c.__name);getParam(jspath1(b,"$.availableBalance.value"),c,"cards.balance");getParam(jspath1(b,"$.availableBalance.currency.name"),c,"cards.currency");getParam(jspath1(b,"$.expiration.milliseconds"),c,"cards.till");getParam(jspath1(b,"$.activated"),c,"cards.active");getParam(jspath1(b,"$.primary"),c,"cards.primary");getParam(jspath1(b,"$.reissued"),c,"cards.reissued");getParam(jspath1(b,"$.status"),c,"cards.status");getParam(jspath1(b,
"$.statusCode"),c,"cards.status_code");getParam(jspath1(b,"$.name"),c,"cards.name");getParam(jspath1(a,"$.externalAccountNumber"),c,"cards.accnum");AnyBalance.isAvailable("cards.transactions")&&processCardsTransactions(c)}
function processAccounts(b){if(AnyBalance.isAvailable("accounts")){for(var a=requestAccountsJson(),c=[],d=0;d<a.payload.length;d++){var e=a.payload[d];/Current|Credit/i.test(e.accountType)&&c.push(e)}AnyBalance.trace("Найдено "+c.length+" счетов");b.accounts=[];for(d=0;d<c.length;d++)e=c[d],a={__id:e.id,__name:e.marketingName+(e.externalAccountNumber?", "+e.externalAccountNumber:""),num:e.externalAccountNumber},__shouldProcess("accounts",a)&&processAccount(e,a),b.accounts.push(a)}}
function processAccount(b,a){AnyBalance.trace("Обработка счета "+a.__name);getParam(jspath1(b,"$.accountBalance.value"),a,"accounts.balance");getParam(jspath1(b,"$.accountBalance.currency.name"),a,"accounts.currency");getParam(jspath1(b,"$.creationDate.milliseconds"),a,"accounts.date_start");getParam(jspath1(b,"$.accountGroup"),a,"accounts.type");getParam(jspath1(b,"$.accountType"),a,"accounts.type_code");getParam(jspath1(b,"$.authorizationsAmount.value"),a,"accounts.blocked");getParam(jspath1(b,
"$.defaultMonthlyCashLimit.value"),a,"accounts.free_cash_limit");getParam(jspath1(b,"$.defaultRenewalAmountLeft.value"),a,"accounts.free_add_limit");getParam(jspath1(b,"$.monthlyCashLimit.value"),a,"accounts.free_cash_left");getParam(jspath1(b,"$.renewalAmountLeft.value"),a,"accounts.free_add_left");getParam(jspath1(b,"$.rate"),a,"accounts.pct");getParam(jspath1(b,"$.status"),a,"accounts.status_code");getParam(jspath1(b,"$.creditLimit.value"),a,"accounts.limit");getParam(jspath1(b,"$.debtAmount.value"),
a,"accounts.debt");getParam(jspath1(b,"$.currentRecommendedPayment.value"),a,"accounts.recompay");getParam(jspath1(b,"$.currentMinimalPayment.value"),a,"accounts.minpay");getParam(jspath1(b,"$.duedate.milliseconds"),a,"accounts.minpaytill");getParam(jspath1(b,"$.marketingName"),a,"accounts.name");getParam(jspath1(b,"$.loyalty[0].amount"),a,"accounts.cashback");AnyBalance.isAvailable("accounts.transactions")&&processAccountsTransactions(a)}
function processDeposits(b){if(AnyBalance.isAvailable("deposits")){for(var a=requestAccountsJson(),c=[],d=0;d<a.payload.length;d++){var e=a.payload[d];/Deposit/i.test(e.accountType)&&c.push(e)}AnyBalance.trace("Найдено "+c.length+" депозитов");b.deposits=[];for(d=0;d<c.length;d++)e=c[d],a={__id:e.id,__name:(e.marketingName||e.name)+(e.externalAccountNumber?", "+e.externalAccountNumber:""),num:e.externalAccountNumber},__shouldProcess("deposits",a)&&processDeposit(e,a),b.deposits.push(a)}}
function processSavings(b){if(AnyBalance.isAvailable("savings")){for(var a=requestAccountsJson(),c=[],d=0;d<a.payload.length;d++){var e=a.payload[d];/Saving/i.test(e.accountType)&&c.push(e)}AnyBalance.trace("Найдено "+c.length+" сберегательных счетов");b.savings=[];for(d=0;d<c.length;d++)e=c[d],a={__id:e.id,__name:e.marketingName||e.name},__shouldProcess("savings",a)&&processSaving(e,a),b.savings.push(a)}}
function processDeposit(b,a){AnyBalance.trace("Обработка депозита "+a.__name);getParam(jspath1(b,"$.accountType"),a,"deposits.type_code");getParam(jspath1(b,"$.marketingName"),a,"deposits.name");getParam(jspath1(b,"$.openDate.milliseconds"),a,"deposits.date_start");getParam(jspath1(b,"$.plannedCloseDate.milliseconds"),a,"deposits.till");getParam(jspath1(b,"$.lastBonusDate.milliseconds"),a,"deposits.date_bonus");getParam(jspath1(b,"$.lastReceiptDate.milliseconds"),a,"deposits.date_receipt");getParam(jspath1(b,
"$.lastRenewalDate.milliseconds"),a,"deposits.date_renewal");getParam(jspath1(b,"$.depositRate"),a,"deposits.pct");getParam(jspath1(b,"$.effectiveRate"),a,"deposits.pct_cap");getParam(jspath1(b,"$.replenishRate"),a,"deposits.pct_topup");getParam(jspath1(b,"$.interest.value"),a,"deposits.pct_sum");getParam(jspath1(b,"$.typeOfInterest"),a,"deposits.pct_condition");getParam(jspath1(b,"$.moneyAmount.value"),a,"deposits.balance");getParam(jspath1(b,"$.moneyAmount.currency.name"),a,"deposits.currency");
getParam(jspath1(b,"$.startAmount"),a,"deposits.balance_start");getParam(jspath1(b,"$.period"),a,"deposits.period");getParam(jspath1(b,"$.status"),a,"deposits.status_code");if(AnyBalance.isAvailable("deposits.accnum")){var c=findAccountById(jspath1(b,"$.currentLinkedAccount"));c&&getParam(jspath1(c,"$.externalAccountNumber"),a,"deposits.accnum")}AnyBalance.isAvailable("deposits.transactions")&&processDepositsTransactions(a)}
function processSaving(b,a){AnyBalance.trace("Обработка накопительного счета "+a.__name);getParam(jspath1(b,"$.accountType"),a,"savings.type_code");getParam(jspath1(b,"$.marketingName"),a,"savings.name");getParam(jspath1(b,"$.creationDate.milliseconds"),a,"savings.date_start");getParam(jspath1(b,"$.interest.value"),a,"savings.pct_sum");getParam(jspath1(b,"$.moneyAmount.value"),a,"savings.balance");getParam(jspath1(b,"$.moneyAmount.currency.name"),a,"savings.currency");getParam(jspath1(b,"$.status"),
a,"savings.status_code");AnyBalance.isAvailable("savings.transactions")&&processSavingsTransactions(a)}function findAccountById(b){for(var a=requestAccountsJson(),c=0;c<a.payload.length;c++){var d=a.payload[c];if(d.id==b)return d}}function findCardById(b){for(var a=requestAccountsJson(),c=0;c<a.payload.length;c++)for(var d=a.payload[c],e=0;d.cardNumbers&&e<d.cardNumbers.length;e++){var f=d.cardNumbers[e];if(f.id==b)return f}}
function fetchSaving(b,a,c){AnyBalance.getPreferences();b=b.payload.reduce(function(a,b){return a.concat(b.accounts.filter(function(a){return/Saving/i.test(a.accountType)}))},[]);if(!b.length)throw new AnyBalance.Error("У вас нет ни одного накопительного счета!");b=b[0];a={success:!0};getParam(b.moneyAmount.value,a,"balance");getParam(b.moneyAmount.currency.name,a,["currency","balance"]);getParam(b.nextStatementDate.milliseconds,a,"nextStatementDate");getParam(b.name,a,"name");getParam(b.name,a,"__tariff");
AnyBalance.setResult(a)};
