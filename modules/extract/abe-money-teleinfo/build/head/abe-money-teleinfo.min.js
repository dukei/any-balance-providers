function trace(a){AnyBalance.trace(stringifyCircular(a))}function stringifyCircular(a){var b=[];return JSON.stringify(a,function(a,d){if("object"===typeof d&&null!==d){var e=b.indexOf(d);if(-1!==e)return e;d.__reference__id=b.length;b.push(d)}return d})}
function Message(a,b,c){this.__type="com.mobiletransport.messaging.DefaultMessageImpl";this.correlationId=""+Math.floor(-2147483647+4294967294*Math.random());this.id=""+Math.floor(-2147483647+4294967294*Math.random());this.payload=a;this.sendTimestamp=(new Date).getTime();this.theme=b||"Default theme";this.timeToLive=3E4;this.properties=new Properties(c||{})}function Properties(a){this.__type="java.util.Hashtable";for(var b in a)this[b]=a[b]}
function isDate(a){return"[object Date]"==Object.prototype.toString.call(a)}function getType(a,b,c){if(null===a)return"null";if("object"==typeof a&&isDate(a))return"date";if("object"==typeof a&&!isArray(a))return"map";if("object"==typeof a&&isArray(a))return"list";if("string"==typeof a)return"string";if("number"==typeof a)return c&&c.__types&&c.__types[b]||(0===a%1?"long":"double");if("boolean"==typeof a)return"boolean";throw new AnyBalance.Error("Unknown type for "+a+" ("+b+" of "+c+")");}
function fmt2pos(a){return 10>a?"0"+a:""+a}function fmt3pos(a){return 10>a?"00"+a:100>a?"0"+a:""+a}function encodeXML(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function putTypeVal(a,b,c){a.push("<",b,">",serialize(c),"</",b,">")}
function serialize(a){if(null===a)return"";if("object"==typeof a&&isDate(a))return""+a.getUTCFullYear()+fmt2pos(a.getUTCMonth()+1)+fmt2pos(a.getUTCDate())+"T"+fmt2pos(a.getUTCHours())+fmt2pos(a.getUTCMinutes())+fmt2pos(a.getUTCSeconds())+"."+fmt3pos(a.getUTCMilliseconds())+"Z";if("object"!=typeof a||isArray(a)){if("object"==typeof a&&isArray(a)){for(var b=["<type>",encodeXML(a.__type),"</type>","<length>",a.length,"</length>"],c=0;c<a.length;++c)d=getType(a[c],null,a),putTypeVal(b,d,a[c]);return b.join("")}if("string"==
typeof a)return encodeXML(a);if("boolean"==typeof a)return a?"1":"0";if("number"==typeof a)return""+a}else{var b=["<type>",encodeXML(a.__type),"</type>"];for(c in a)if(!/^__types?$/.test(c)){b.push("<string>",encodeXML(c),"</string>");var d=getType(a[c],c,a);putTypeVal(b,d,a[c])}return b.join("")}}
function request(a){var b="<map>"+serialize(a)+"</map>";AnyBalance.trace("Requesting "+getParam(a.payload.__type,null,null,/\.(\w+)$/));var c=CryptoJS.enc.Utf8.parse(b);a=CryptoJS.enc.Utf8.parse("2.5.0");var d=new CryptoJS.lib.WordArray.init([c.sigBytes+a.sigBytes+1,a.sigBytes<<24],5),e=d.sigBytes;d.concat(a).concat(c);c=AnyBalance.requestPost("https://mb.vtb24.ru/mobilebanking/burlap/",CryptoJS.enc.Base64.stringify(d),{"mb-protocol-version":"2.5.0","mb-app-version":"0.1.46",Connection:"Keep-Alive"});
d=CryptoJS.enc.Base64.parse(c);if(400<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Error requesting "+b+": "+CryptoJS.enc.Utf8.stringify(d));b=CryptoJS.enc.Utf8.stringify(d,e+a.sigBytes);AnyBalance.trace(b);b=deserialize(b);if("string"==typeof b.payload)throw new AnyBalance.Error(b.payload);AnyBalance.trace("Returned "+getParam(b.payload.__type,null,null,/\.(\w+)$/));trace(b);if(/ErrorResponse/.test(b.payload.__type))throw new AnyBalance.Error(b.payload.message,null,"invalid-credentials"==
b.payload.type);return b}
function deserialize(a){try{var b=function(a,b,c){if("list"==h)g.push(b(a));else if("map"==h)if(f)g[f]=b(a),f=null;else if(c)f=a;else throw new AnyBalance.Error("deserialize error: unexpected property without name: <"+elem+">"+a);else throw new AnyBalance.Error("deserialize error: unexpected value outside the container: <"+elem+">"+a);},c=new EasySAXParser,d=[],e=[],f=null,h=null,g=null,m=null,k=[],n=0;c.on("error",function(a){AnyBalance.trace(a)});c.on("startNode",function(a,b,c,p,q){m="";switch(a){case "map":g=
{};break;case "list":g=[];break;default:return}k[n++]=g;d.push(g);e.push(f);f=null;h=a});c.on("endNode",function(a,c,n,p){c=m;switch(a){case "type":g.__type=c;break;case "length":if("list"!=h)throw new AnyBalance.Error("deserialize error: unexpected length outside list: <"+a+">"+c);break;case "string":b(c,function(a){return a},!0);break;case "boolean":b(c,function(a){return"true"==a.toLowerCase()||"1"==a});break;case "null":b(c,function(a){return null});break;case "double":b(c,function(a){return parseFloat(a)});
break;case "long":case "int":b(c,function(a){return parseInt(a,10)});break;case "date":b(c,function(b){var c=b.match(/(\d{4})(\d\d)(\d\d)T(\d\d)(\d\d)(\d\d)\.(\d\d\d)Z/);if(!c)throw new AnyBalance.Error("deserialize error: unexpected date format: <"+a+">"+b);var d=new Date(0);d.setUTCFullYear(parseInt(c[1],10),parseInt(c[2],10)-1,parseInt(c[3],10));d.setUTCHours(parseInt(c[4],10),parseInt(c[5],10),parseInt(c[6],10),parseInt(c[7],10));if(isNaN(d.getTime()))throw new AnyBalance.Error("Failed to parse date: <"+
a+"> "+b);return d});break;case "map":case "list":c=d.pop();f=e.pop();0<d.length&&(g=d[d.length-1],h=isArray(g)?"list":"map","map"==h?g[f]=c:g.push(c),f=null);break;case "ref":b(c,function(a){a=parseInt(a,10);if(!k[a])throw new AnyBalance.Error("Inexistent reference: "+a+" of "+k.length);return k[a]});break;default:throw new AnyBalance.Error("deserialize error: unexpected tag: <"+a+">"+c);}});c.on("textNode",function(a,b){m=b(a)});c.parse(a);return g}catch(l){throw AnyBalance.trace("Error unserializing xml: "+
a),AnyBalance.trace("Exception: "+l.message+": "+l.stack),l;}}function isSessionValid(){if(!g_commonProperties["CLIENT-TOKEN"])return!1;try{request(new Message({__type:"ru.vtb24.mobilebanking.protocol.product.MainPageProductsRequest",portfolioTypeMto:{__type:"ru.vtb24.mobilebanking.protocol.product.PortfolioTypeMto",id:"ACCOUNTS_AND_CARDS"}},null,g_commonProperties))}catch(a){return!1}return!0}var g_objInfo,g_commonProperties;
function login(){var a=AnyBalance.getPreferences();AnyBalance.trace("Обновление из мобильного приложения");AnyBalance.setOptions({FORCE_CHARSET:"base64",REQUEST_CHARSET:"base64"});checkEmpty(a.login,"Введите логин!");checkEmpty(a.password,"Введите пароль!");var b=AnyBalance.getData("sessionId",a.sessionId||"");g_commonProperties={APP_VERSION:"5.3.8",DEVICE_PLATFORM:"ANDROID","CLIENT-TOKEN":b,DEVICE_OS:"Android OS 5.1.1"};if(isSessionValid())AnyBalance.trace("Пользуемся существующей сессией...");else{AnyBalance.trace("Необходимо авторизоваться...");
b=request(new Message({__type:"ru.vtb24.mobilebanking.protocol.security.StartSessionRequest",sessionContext:{__type:"ru.vtb24.mobilebanking.protocol.security.SessionContextMto",certificateNumber:null,clientIp:"192.168.1.51",outerSessionId:"VTB_TEST_APP",timeoutDuration:null,userAgent:null}})).payload.sessionId;g_commonProperties["CLIENT-TOKEN"]=b;a=request(new Message({__type:"ru.vtb24.mobilebanking.protocol.security.LoginRequest",login:a.login,password:a.password},"LoginRequest theme",g_commonProperties));
if(!a.payload.authorizationLevel||"IDENTIFIED"!=a.payload.authorizationLevel.id)throw trace(a),new AnyBalance.Error("Неизвестная ошибка. Сайт изменен?");"NONE"!=a.payload.authorization.type.id&&AnyBalance.trace("Придется, черт возьми, вводить код: "+a.payload.authorization.type.id);var c=a.payload.userInfo.unc;request(new Message({__type:"ru.vtb24.mobilebanking.protocol.security.SelectAuthorizationTypeRequest",authorizationType:a.payload.authorization.type},"SelectAuthorizationTypeRequest theme",
g_commonProperties));var a=request(new Message({__type:"ru.vtb24.mobilebanking.protocol.security.GetChallengeRequest"},"GetChallengeRequest theme",g_commonProperties)),d="";"NONE"!=a.payload.authorization.type.id&&(d=AnyBalance.retrieveCode(a.payload.authorization.message,null,{inputType:"number",time:3E5}));g_commonProperties.USER_ID=c;g_objInfo=request(new Message({__type:"ru.vtb24.mobilebanking.protocol.security.ConfirmLoginRequest",inChallengeResponse:d},"ConfirmLoginRequest theme",g_commonProperties));
AnyBalance.setData("sessionId",b);AnyBalance.saveData()}__setLoginSuccessful()}var g_cardsAndAccounts;
function getCardsAndAccounts(){if(g_cardsAndAccounts)return g_cardsAndAccounts;var a=request(new Message({__type:"ru.vtb24.mobilebanking.protocol.product.PortfolioRequest",refreshImmediately:!0,portfolioType:{__type:"ru.vtb24.mobilebanking.protocol.product.PortfolioTypeMto",id:"ACCOUNTS_AND_CARDS"}},null,g_commonProperties));a.payload.products=[];for(var b=0;b<a.payload.portfolio.productGroups.length;++b)for(var c=a.payload.portfolio.productGroups[b],d=0;d<c.items.length;d++)a.payload.products.push(c.items[d]);
AnyBalance.trace("Найдено "+a.payload.products.length+" карт и счетов");return g_cardsAndAccounts=a}
function processCards(a){if(AnyBalance.isAvailable("cards")){for(var b=getCardsAndAccounts(g_cardsAndAccounts),c=[],d=0;d<b.payload.products.length;++d){var e=b.payload.products[d];/Card/i.test(e.__type)&&c.push(e)}AnyBalance.trace("Найдено "+c.length+" карт");a.cards=[];for(d=0;d<c.length;d++)e=c[d],b={__id:e.id,__name:e.displayName+" "+e.baseCurrency.currencyCode+" "+e.number.substr(-4),num:e.number},__shouldProcess("cards",b)&&processCard(e,b),a.cards.push(b)}}
function processCard(a,b){getParam(a.displayName,b,"cards.name");getParam(a.balance.allowedSum,b,"cards.balance");getParam(a.balance.amountSum,b,"cards.own");getParam(a.baseCurrency.currencyCode,b,"cards.currency cards.balance cards.gracepay cards.minpay cards.limit cards.own cards.blocked".split(" "));getParam(a.balance.authorizedSum,b,"cards.blocked");getParam(a.embossed,b,"cards.holder");getParam(a.expireDate.getTime(),b,"cards.till");getParam(a.issueDate.getTime(),b,"cards.date_start");getParam(a.brandName,
b,"cards.ps");getParam(a.coBrandName,b,"cards.cobrand");getParam(a.isEmitedForOwner,b,"cards.for_owner");getParam(a.isMain,b,"cards.is_main");getParam(a.status.id,b,"cards.status");if(/Credit/.test(a.__type)&&AnyBalance.isAvailable("cards.limit","cards.pct","cards.minpay","cards.gracepay","cards.credit_till","cards.minpaytill","cards.gracetill")){var c=request(new Message({__type:"ru.vtb24.mobilebanking.protocol.ObjectRequest",identity:{__type:"ru.vtb24.mobilebanking.protocol.ObjectIdentityMto",id:a.id,
type:a.__type}},null,g_commonProperties)).payload.cardAccount,d=c&&c.loanInfo;c&&null!=c.creditLimit&&getParam(c.creditLimit,b,"cards.limit");d&&(null!=d.interestRate&&getParam(d.interestRate,b,"cards.pct"),null!=d.minAmountForRepayment&&getParam(d.minAmountForRepayment,b,"cards.minpay"),null!=d.graceAmountForRepayment&&getParam(d.graceAmountForRepayment,b,"cards.gracepay"),d.limitEndDate&&getParam(d.limitEndDate.getTime(),b,"cards.credit_till"),d.repaymentDate&&getParam(d.repaymentDate.getTime(),
b,"cards.minpay_till"),d.graceEndDate&&getParam(d.graceEndDate.getTime(),b,"cards.grace_till"))}AnyBalance.isAvailable("cards.transactions")&&processCardTransactions(a,b)}function processCardTransactions(a,b){processIdentityTransactions("cards.",a,b)}
function processAccounts(a){if(AnyBalance.isAvailable("accounts")){for(var b=getCardsAndAccounts(g_cardsAndAccounts),c=[],d=0;d<b.payload.products.length;++d){var e=b.payload.products[d];/Card/i.test(e.__type)||c.push(e)}AnyBalance.trace("Найдено "+c.length+" счетов");a.accounts=[];for(d=0;d<c.length;d++)e=c[d],b={__id:e.id,__name:e.displayName+" "+e.amount.currency.currencyCode+" "+e.number.substr(-4),num:e.number},__shouldProcess("accounts",b)&&processAccount(e,b),a.accounts.push(b)}}
function processAccount(a,b){getParam(a.name,b,"accounts.name");getParam(a.amount.sum,b,"accounts.balance");getParam(a.amount.currency.currencyCode,b,["accounts.currency","accounts.balance"]);getParam(a.status.id,b,"accounts.status");a.openDate&&getParam(a.openDate.getTime(),b,"accounts.date_start");a.closeDate&&getParam(a.closeDate.getTime(),b,"accounts.till");if(AnyBalance.isAvailable("accounts.last_op_date")){var c=request(new Message({__type:"ru.vtb24.mobilebanking.protocol.ObjectRequest",identity:{__type:"ru.vtb24.mobilebanking.protocol.ObjectIdentityMto",
id:a.id,type:a.__type}},null,g_commonProperties));c.lastOperationDate&&getParam(c.lastOperationDate.getTime(),b,"accounts.last_op_date")}AnyBalance.isAvailable("accounts.transactions")&&processAccountTransactions(a,b)}function processAccountTransactions(a,b){processIdentityTransactions("accounts.",a,b)}
function processIdentityTransactions(a,b,c){var d=new Date;AnyBalance.trace("openDate: "+b.openDate+", issueDate: "+b.issueDate+", currentDate: "+d);b={__type:"ru.vtb24.mobilebanking.protocol.statement.StatementRequest",endDate:d,startDate:b.openDate||b.issueDate||new Date(d.getFullYear()-2,d.getMonth(),d.getDate()),products:[{__type:"ru.vtb24.mobilebanking.protocol.ObjectIdentityMto",id:b.id,type:b.__type}]};b.products.__type="[ru.vtb24.mobilebanking.protocol.ObjectIdentityMto";b=request(new Message(b,
null,g_commonProperties));AnyBalance.trace("Найдено "+b.payload.transactions.length+" транзакций по "+c.__name);c.transactions=[];for(d=0;d<b.payload.transactions.length;d++){var e=b.payload.transactions[d],f={};getParam(e.id,f,a+"transactions.id");e.transactionDate&&getParam(e.transactionDate.getTime(),f,a+"transactions.date");e.processedDate&&getParam(e.processedDate.getTime(),f,a+"transactions.date_done");getParam(e.transactionAmount.sum,f,a+"transactions.sum");getParam(e.details,f,a+"transactions.descr");
getParam(e.status.id,f,a+"transactions.status");getParam(e.feeAmount.sum,f,a+"transactions.fee");getParam(e.transactionAmount.currency.currencyCode,f,a+"transactions.currency");c.transactions.push(f)}}
function processDeposits(a){if(AnyBalance.isAvailable("deposits")){var b=request(new Message({__type:"ru.vtb24.mobilebanking.protocol.product.MainPageProductsRequest",portfolioTypeMto:{__type:"ru.vtb24.mobilebanking.protocol.product.PortfolioTypeMto",id:"INVESTMENTS_AND_SAVINGS"}},null,g_commonProperties));AnyBalance.trace("Найдено "+b.payload.products.length+" депозитов");a.deposits=[];if(0==b.payload.products.length)AnyBalance.trace("У вас нет ни одного депозита!");else for(var c=0;c<b.payload.products.length;++c){var d=
b.payload.products[c],e={__id:d.id,__name:d.displayName,num:d.number};__shouldProcess("deposits",e)&&processDeposit(d,e);a.deposits.push(e)}}}
function processDeposit(a,b){a.account&&a.account.amount&&(getParam(a.account.amount.sum,b,"deposits.balance"),getParam(a.account.amount.currency.currencyCode,b,["deposits.currency","deposits.balance"]));a.amount&&(getParam(a.amount.sum,b,"deposits.balance"),getParam(a.amount.currency.currencyCode,b,["deposits.currency","deposits.balance"]));a.openDate&&getParam(a.openDate.getTime(),b,"deposits.date_start");(a.endDate||a.closeDate)&&getParam((a.endDate||a.closeDate).getTime(),b,"deposits.till");a.status&&
getParam(a.status.id,b,"deposits.status");if(AnyBalance.isAvailable("deposits.pct","deposits.own")){var c=request(new Message({__type:"ru.vtb24.mobilebanking.protocol.ObjectRequest",identity:{__type:"ru.vtb24.mobilebanking.protocol.ObjectIdentityMto",id:a.id,type:a.__type}},null,g_commonProperties)).payload.info;c?(getParam(c.interestRate,b,"deposits.pct"),getParam(c.depositSum,b,"deposits.own")):AnyBalance.trace("Не найдена доп. информация по депозиту")}}
function processInfo(a){AnyBalance.isAvailable("info")&&(g_objInfo?(a=a.info={},getParam(g_objInfo.payload.userInfo.id,a,"info.id"),getParam(g_objInfo.payload.userInfo.unc,a,"info.unc"),getParam(g_objInfo.payload.userInfo.firstName,a,"info.name"),getParam(g_objInfo.payload.userInfo.lastName,a,"info.name_last"),getParam(g_objInfo.payload.userInfo.patronymic,a,"info.name_patronymic"),getParam(g_objInfo.payload.userInfo.firstNameLatin,a,"info.name_lat"),getParam(g_objInfo.payload.userInfo.lastNameLatin,
a,"info.name_last_lat"),getParam(g_objInfo.payload.userInfo.sex,a,"info.sex"),getParam(g_objInfo.payload.userInfo.phoneWork,a,"info.wphone"),getParam(g_objInfo.payload.userInfo.phoneMobile,a,"info.mphone"),getParam(g_objInfo.payload.userInfo.email,a,"info.email"),getParam(g_objInfo.payload.userInfo.birthday&&g_objInfo.payload.userInfo.birthday.getTime(),a,"info.birthday")):AnyBalance.trace("Info can be obtained with fresh login only!"))}
function processCredits(a){if(AnyBalance.isAvailable("credits")){var b=request(new Message({__type:"ru.vtb24.mobilebanking.protocol.product.MainPageProductsRequest",portfolioTypeMto:{__type:"ru.vtb24.mobilebanking.protocol.product.PortfolioTypeMto",id:"CREDITS"}},null,g_commonProperties));AnyBalance.trace("Найдено "+b.payload.products.length+" кредитов");a.credits=[];if(0==b.payload.products.length)AnyBalance.trace("У вас нет ни одного кредита!");else for(var c=0;c<b.payload.products.length;++c){var d=
b.payload.products[c],e={__id:d.id,__name:d.displayName,num:d.number,accnum:d.account.number};__shouldProcess("credits",e)&&processCredit(d,e);a.credits.push(e)}}}
function processCredit(a,b){getParam(a.creditSum.sum,b,"credits.limit");getParam(a.creditSum.currency.currencyCode,b,["credits.currency","credits.balance","credits.limit"]);getParam(a.account.amount.sum,b,"credits.balance");getParam(a.account.contract.contractPeriod.unit.id,b,"credits.period_unit");getParam(a.account.contract.contractPeriod.value,b,"credits.period");a.issueDate&&getParam(a.issueDate.getTime(),b,"credits.date_start");a.endDate&&getParam(a.endDate.getTime(),b,"credits.till");getParam(a.status.id,
b,"credits.status");if(AnyBalance.isAvailable("credits.pct","credits.debt","credits.minpay_debt","credits.minpay_pct","credits.minpay","credits.minpay_till","credits.gracepay","credits.gracepay_till")){var c=request(new Message({__type:"ru.vtb24.mobilebanking.protocol.ObjectRequest",identity:{__type:"ru.vtb24.mobilebanking.protocol.ObjectIdentityMto",id:a.id,type:a.__type}},null,g_commonProperties)).payload.loan;getParam(c.interestRate,b,"credits.pct");getParam(c.totalLiability,b,"credits.debt");
getParam(c.currentLiability,b,"credits.minpay_debt");getParam(c.currentInterest,b,"credits.minpay_pct");getParam(c.repaymentSum,b,"credits.minpay");c.repaymentDate&&getParam(c.repaymentDate.getTime(),b,"credits.minpay_till");null!=c.graceAmountForRepayment&&getParam(c.graceAmountForRepayment,b,"credits.gracepay");null!=c.graceEndDate&&getParam(c.graceEndDate.getTime(),b,"credits.gracepay_till")}AnyBalance.isAvailable("credits.schedule")&&processCreditSchedule(a,b);AnyBalance.isAvailable("credits.transactions")&&
processCreditTransactions(a,b)}
function processCreditSchedule(a,b){var c=new Date,c=request(new Message({__type:"ru.vtb24.mobilebanking.protocol.product.LoanAcquittanceScheduleRequest",endDate:a.endDate||new Date(c.getFullYear()+5,c.getMonth(),c.getDate()),startDate:c,userObject:{__type:"ru.vtb24.mobilebanking.protocol.ObjectIdentityMto",id:a.id,type:a.__type}},null,g_commonProperties));AnyBalance.trace("Найдено "+c.payload.acquittances.length+" планируемых платежей по кредиту "+b.__name);b.schedule=[];for(var d=0;d<c.payload.acquittances.length;d++){var e=
c.payload.acquittances[d],f={};getParam(e.date.getTime(),f,"credits.schedule.date");getParam(e.number,f,"credits.schedule.id");getParam(e.total,f,"credits.schedule.sum");getParam(e.principal,f,"credits.schedule.debt");getParam(e.interest,f,"credits.schedule.pct");getParam(e.fee,f,"credits.schedule.fee");getParam(e.currency.currencyCode,f,"credits.schedule.currency");b.schedule.push(f)}}function processCreditTransactions(a,b){processIdentityTransactions("credits.",a,b)};
