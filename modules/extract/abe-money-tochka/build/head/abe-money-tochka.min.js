var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/48.0.2564.116 Safari/537.36"},baseurl="https://i.tochka.com";
function login(){var d=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");checkEmpty(d.login,"Введите логин!");checkEmpty(d.password,"Введите пароль!");var a=AnyBalance.requestGet(baseurl+"/summary",g_headers);if(!a||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(a),new AnyBalance.Error("Ошибка при подключении к сайту интернет-банка! Попробуйте обновить данные позже.");/logout/i.test(a)?AnyBalance.trace("Уже залогинены, используем существующую сессию"):(a=getElement(a,/<form[^>]+login-form[^>]*>/i),
a=createFormParams(a,function(a,b,c,g){return"name_mini_otp"==c?d.login:"passwd_mini_otp"==c?d.password:"captcha"==c?(a=AnyBalance.requestGet(baseurl+"/login/captcha.jpg",addHeaders({Referer:baseurl})),AnyBalance.retrieveCode("Пожалуйста, введите код с картинки",a,{time:18E4})):g}),a=AnyBalance.requestPost(baseurl+"/user/do_login",a,addHeaders({Referer:baseurl+"/user/login"})));if(/<input[^>]+name="MINI_OTP_GC"/i.test(a)){AnyBalance.trace("Потребовался ввод кода.");var b=getElement(a,/<label[^>]+otp[^>]*>([^<]*)/i,
replaceTagsAndSpaces),a=getElement(a,/<form[^>]+so_login_form[^>]*>/i),a=createFormParams(a,function(a,c,d,g){return"MINI_OTP_GC"==d?AnyBalance.retrieveCode(b||"Пожалуйста, введите код OTP/SMS для входа в интернет-банк.",null,{inputType:"number",time:18E4}):g}),a=AnyBalance.requestPost(baseurl+"/mini_otp/do_login",a,addHeaders({Referer:baseurl+"/mini_otp/login"}))}if(!/logout/i.test(a)){var c=getParam(a,null,null,/<div[^>]+errors-panel[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);if(c)throw new AnyBalance.Error(c,
null,/(Проверьте правильность указания Логина и Пароля|неправильный одноразовый ключ)/i.test(c));AnyBalance.trace(a);throw new AnyBalance.Error("Не удалось зайти в интернет-банк. Сайт изменен?");}a=AnyBalance.requestPost(baseurl+"/fraud_monitoring_ajax/send",{"time-zone":(new Date).getTimezoneOffset(),random:Math.random()});a=AnyBalance.requestGet(baseurl+"/summary",g_headers);__setLoginSuccessful();return a}
function processAccounts(d,a){if(AnyBalance.isAvailable("accounts")){d=AnyBalance.requestGet(baseurl+"/account/list",addHeaders({Referer:baseurl+"/summary"}));var b=getElement(d,/<table[^>]+class="action-list"[^>]*>/i),c=getElements(b,/<tr[^>]+data-row[^>]*>/ig);if(c.length){AnyBalance.trace("Найдено счетов: "+c.length);a.accounts=[];for(var e=0;e<c.length;++e){var f=getParam(c[e],null,null,/<br[^>]*>([^<]*)/i),h=getParam(c[e],null,null,/<br[^>]*>([^<]*)/i),g=getParam(c[e],null,null,/<tr(?:[^>]*>){2}([^<]*)/i,
replaceTagsAndSpaces),f={__id:f,__name:g,num:h};__shouldProcess("accounts",f)&&processAccount(c[e],b,f);a.accounts.push(f)}}else AnyBalance.trace(d),AnyBalance.trace("Не удалось найти счета.")}}
function processAccount(d,a,b){AnyBalance.trace("Обработка счета "+b.__name);(d=getParam(a,null,null,/request_customer_id=(\d*)/i))?(a=AnyBalance.requestGet(baseurl+"/account/edit/"+b.__id+"?request_customer_id="+d,g_headers),getParam(a,b,"accounts.type",/Тип счета(?:[^>]*>){2}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces),getParam(a,b,"accounts.__tariff",/Тарифный план(?:[^>]*>){2}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces),getParam(a,b,"accounts.status",/Статус(?:[^>]*>){2}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces),
getParam(a,b,"accounts.date_start",/Дата открытия(?:[^>]*>){2}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseDateWord),getParam(a,b,"accounts.balance",/Остаток(?:[^>]*>){2}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),getParam(a,b,"accounts.aBalance",/Доступный(?:[^>]*>){2}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),getParam(a,b,["accounts.currency","accounts.balance","accounts.availableBalance"],/Остаток(?:[^>]*>){2}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseCurrency),AnyBalance.isAvailable("accounts.transactions")&&
processAccountTransactions(a,b)):(AnyBalance.trace(a),AnyBalance.trace("Не удалось найти ID пользователя. Сайт изменён?"))}
function processCards(d,a){if(AnyBalance.isAvailable("cards")){d=AnyBalance.requestGet(baseurl+"/card/list??filter=on&account=&cardType=&cardStatus=",g_headers);var b=getElement(d,/<table[^>]+class="action-list"[^>]*>/i),b=getElements(b,/<tr[^>]+id="cc-\d+"[^>]+data-row[^>]*>/ig);if(b.length){AnyBalance.trace("Найдено карт: "+b.length);a.cards=[];for(var c=0;c<b.length;++c){var e=getParam(b[c],null,null,/<span[^>]+pan[^>]*>([\s\S]*?)<\/span>/i),f=getParam(b[c],null,null,/<span[^>]+pan[^>]*>([\s\S]*?)<\/span>/i,
replaceTagsAndSpaces),h=getParam(b[c],null,null,/<td[^>]+cc_brand[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces),e={__id:e,__name:h,num:f};__shouldProcess("cards",e)&&processCard(b[c],e);a.cards.push(e)}}else AnyBalance.trace(d),AnyBalance.trace("Не удалось найти карты.")}}
function processCard(d,a){AnyBalance.trace("Обработка карты "+a.__name);getParam(d,a,"cards.till",/(?:[\s\S]*?<td[^>]*>){3}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseDateWord);getParam(d,a,"cards.status",/(?:[\s\S]*?<td[^>]*>){4}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);var b=getParam(a.__id,null,null,/(.*)?/i,[/(\*|\s)/ig,""]),c=AnyBalance.requestGet(baseurl+"/card/view/"+b,g_headers);getParam(c,a,"cards.type",/тип карты(?:[^>]*>){2}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(c,a,"cards.cardholder",
/Владелец(?:[^>]*>){2}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(c,a,"cards.accnum",/Cчет(?:[^>]*>){1}([\s\S]*?)<\/span>/i,replaceTagsAndSpaces);getParam(c,a,"cards.balance",/Остаток(?:[^>]*>){2}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"cards.reserved",/Зарезервировано(?:[^>]*>){2}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"cards.credit",/Кредит(?:[^>]*>){2}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"cards.available",
/Доступно(?:[^>]*>){2}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,["cards.currency","cards.balance","cards.reserved","cards.credit","cards.available"],/Доступно(?:[^>]*>){2}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseCurrency);isAvailable("cards.transactions")&&processCardTransactions(a,b)}function processDeposits(d,a){throw new AnyBalance.Error("На данный момент обработка депозитов не поддерживается. Пожалуйста, обратитесь к разработчику.");}
function processCredits(d,a){throw new AnyBalance.Error("На данный момент обработка кредитов не поддерживается. Пожалуйста, обратитесь к разработчику.");}function processInfo(d,a){d=AnyBalance.requestGet(baseurl+"/requisites/show",g_headers);var b=a.info={};getParam(d,b,"info.inn",/"#inn"[^]*?text\("([^"]*)"/i,replaceTagsAndSpaces);getParam(d,b,"info.name",/"#name"[^]*?text\("([^"]*)"/i,replaceHtmlEntities);getParam(d,b,"info.kpp",/"#kpp"[^]*?text\("([^"]*)"/i,replaceHtmlEntities)};
