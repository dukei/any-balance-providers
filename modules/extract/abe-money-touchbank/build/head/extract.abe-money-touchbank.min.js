var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.110 Safari/537.36"},baseurl="https://www.touchbank.com",csrf_token;
function login(a){AnyBalance.setDefaultCharset("utf-8");checkEmpty(a.login,"Введите логин!");checkEmpty(a.password,"Введите пароль!");var c=AnyBalance.requestGet(baseurl+"/lk/dashboard",g_headers);if(!c||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(c),new AnyBalance.Error("Ошибка при подключении к сайту интернет-банка! Попробуйте обновить данные позже.");if(/bb-module="account"/i.test(c))AnyBalance.trace("Уже залогинены, используем существующую сессию");else{csrf_token=getToken();c=AnyBalance.requestPost(baseurl+
"/j_spring_security_check",{j_username:a.login,j_password:a.password,captcha_challenge:""},addHeaders({Referer:baseurl+"/lk/login",Accept:"application/json, text/plain, */*","X-CSRF-TOKEN":csrf_token}));a=getJson(c);if(!a.success){if(a=a.errors[0]?a.errors[0].message:void 0)throw new AnyBalance.Error(a,null,/Вы ввели неверные логин или пароль/i.test(a));AnyBalance.trace(c);throw new AnyBalance.Error("Не удалось зайти в интернет-банк. Сайт изменен?");}csrf_token=getToken();__setLoginSuccessful()}return c}
function processAccounts(a,c){if(AnyBalance.isAvailable("accounts")){a=AnyBalance.requestPost(baseurl+"/lk/proxy/userDataPipe/products",{syncOff:!0},addHeaders({Referer:baseurl+"/lk/dashboard","X-CSRF-TOKEN":csrf_token}));var b=getJson(a);if(b.data||b.data.accounts)for(a=isArray(b.data.accounts)?b.data.accounts:[b.data.accounts],AnyBalance.trace("Найдено счетов: "+a.length),c.accounts=[],b=0;b<a.length;++b){var d=a[b].id,d={__id:d,__name:(a[b].alias||"")+" "+d,num:a[b].number};__shouldProcess("accounts",
d)&&processAccount(a[b],d);c.accounts.push(d)}else AnyBalance.trace(a),AnyBalance.trace("Не удалось найти ни одного счёта."),c.cards=[]}}
function processAccount(a,c){AnyBalance.trace("Обработка счета "+c.__name);getParam(a.info,c,"accounts.type",/([\s\S]*?)\./i);getParam(a.balance+"",c,"accounts.balance",null,null,parseBalanceSilent);getParam(a.currency,c,["accounts.currency","accounts.balance"]);getParam(a.openDate,c,"accounts.date_start",null,null,parseDateWord);getParam(a.statusLocale,c,"accounts.status");AnyBalance.isAvailable("accounts.transactions")&&processAccountTransactions(a,c)}
function processCards(a,c){if(AnyBalance.isAvailable("cards")){a=AnyBalance.requestPost(baseurl+"/lk/proxy/userDataPipe/products",{syncOff:!0},addHeaders({Referer:baseurl+"/lk/dashboard","X-CSRF-TOKEN":csrf_token}));var b=getJson(a);if(b.data||b.data.cards)for(a=isArray(b.data.cards)?b.data.cards:[b.data.cards],AnyBalance.trace("Найдено карт: "+a.length),c.cards=[],b=0;b<a.length;++b){var d={__id:a[b].id,__name:a[b].formattedNumber,num:a[b].cardNumber};__shouldProcess("cards",d)&&processCard(a[b],
d);c.cards.push(d);searchMultiCards(a[b],c)}else AnyBalance.trace(a),AnyBalance.trace("Не удалось найти карты."),c.cards=[]}}
function processCard(a,c){getParam(a.balance+"",c,"cards.balance",null,replaceTagsAndSpaces,parseBalanceSilent);getParam(a.ownSum+"",c,"cards.own",null,replaceTagsAndSpaces,parseBalanceSilent);getParam(a.borrowedSum+"",c,"cards.borrowed",null,replaceTagsAndSpaces,parseBalanceSilent);getParam(a.limit+"",c,"cards.limit",null,replaceTagsAndSpaces,parseBalanceSilent);getParam(a.currency,c,["cards.currency","cards.balance","cards.own","cards.borrowed","cards.limit"],null,replaceTagsAndSpaces);getParam(a.endDate+
"",c,"cards.till",null,replaceTagsAndSpaces,parseDateISO);getParam(a.openDate+"",c,"cards.date_start",null,replaceTagsAndSpaces,parseDateISO);getParam(a.number,c,"cards.accnum",null,replaceTagsAndSpaces);getParam(a.info,c,"cards.agreement",/дог\.\s*([\s\S]+)/i);isAvailable("cards.transactions")&&processCardTransactions(a,c)}
function searchMultiCards(a,c){AnyBalance.trace("Ищем мультикарты по карте "+a.cardNumber);var b=AnyBalance.requestPost(baseurl+"/lk/proxy/multicardPipe/get_multicard_data",{cardId:a.id},addHeaders({Referer:baseurl+"/lk/cards/multicard","X-CSRF-TOKEN":csrf_token})),d=getJson(b);if(d.data&&d.data.multiCardList&&d.data.multiCardList.extCard.length)for(b=isArray(d.data.multiCardList.extCard)?d.data.multiCardList.extCard:[d.data.multiCardList.extCard],AnyBalance.trace("Найдено мультикарт: "+b.length),
d=0;d<b.length;++d){var e={};getParam(b[d].extCardId,e,"cards.id");getParam(a.cardNumber,e,"cards.primaryCardNumber");getParam(b[d].maskedPAN,e,"cards.num");getParam(b[d].extCardName,e,"cards.name");getParam(b[d].extCardOptionStatus,e,"cards.optionStatus",null,[/NOTSPECIFIED/i,"Специальная карта",/FALLBACK/i,"Резервная карта"]);getParam(b[d].extCardStatus,e,"cards.status");getParam(b[d].extCardMonthExpiry+"."+b[d].extCardYearExpiry,e,"cards.till",null,null,parseDateSilent);c.cards.push(e)}else AnyBalance.trace(b),
AnyBalance.trace("Не удалось найти мультикарты!")}
function processDeposits(a,c){if(AnyBalance.isAvailable("deposits")){a=AnyBalance.requestPost(baseurl+"/lk/proxy/userDataPipe/products",{syncOff:!0},addHeaders({Referer:baseurl+"/lk/dashboard","X-CSRF-TOKEN":csrf_token}));var b=getJson(a);if(b.data||b.data.deposits)for(a=isArray(b.data.deposits)?b.data.deposits:[b.data.deposits],AnyBalance.trace("Найдено депозитов: "+a.length),c.deposits=[],b=0;b<a.length;++b){var d=a[b].id,e=a[b].number,f=getParam(a[b].info,null,null,/кл\.([^\d]*\d+)/i,replaceTagsAndSpaces),
d={__id:d,__name:f,num:e};__shouldProcess("deposits",d)&&processDeposit(a[b],d);c.deposits.push(d)}else AnyBalance.trace(a),AnyBalance.trace("Не удалось найти депозиты."),c.deposits=[]}}
function processDeposit(a,c){getParam(a.balance,c,"deposits.balance",null,replaceTagsAndSpaces,parseBalanceSilent);getParam(a.limit,c,"deposits.limit",null,replaceTagsAndSpaces,parseBalanceSilent);getParam(a.chargesAmountForMonth,c,"deposits.chargesAmountForMonth",null,replaceTagsAndSpaces,parseBalanceSilent);getParam(a.currency,c,["deposits.currency","deposits.balance","deposits.chargesAmountForMonth","deposits.limit"]);getParam(a.interestRate,c,"deposits.pct");getParam(a.depositBeginDate,c,"deposits.date_start",
null,null,parseDateSilent);getParam(a.closeDate,c,"deposits.till",null,null,parseDateSilent);getParam(a.info,c,"deposits.agreement",/дог\.[^\d]*(\d+)/i);getParam(a.info,c,"deposits.period",/Депозит[\s\S]*?\./i);getParam(a.statusLocale,c,"deposits.status");isAvailable("deposits.transactions")&&processDepositTransactions(a,c)}
function processInfo(a,c){a=AnyBalance.requestGet(baseurl+"/lk/proxy/userDataPipe/person_data",g_headers);var b=getJson(a),d=c.info={};if(b.data&&b.data.personData){a=b.data.personData;getParam((a.surname+" "||"")+(a.firstName+" "||"")+(a.patronymic||""),d,"info.fio");getParam(a.personId,d,"info.personID");getParam(a.mobilePhone,d,"info.mphone");for(d=0;a.addressList&&d<a.addressList.length;d++){var e,b=a.addressList[d];/адрес постоянной регистрации/i.test(b.type)?e="raddress":/Адрес фактического проживания/i.test(b.type)&&
(e="faddress");e?c.info[e]=(b.postIndex+", "||"")+(b.regionName+", "||"")+(b.city+", "||"")+(b.street+", "||"")+(b.house+", "||"")+(b.apartment||""):AnyBalance.trace("Неизвестный тип адреса: "+a.addressList[d].type)}if(a.emailList){e=[];b=isArray(a.emailList)?a.emailList:[a.emailList];for(d=0;d<b.length;d++)e.push(b[d].email);c.info.email=e.join(", ")}else AnyBalance.trace("Не удалось получить список email'ов.");if(a.documentList)for(a=isArray(a.documentList)?a.documentList:[a.documentList],d=0;d<
a.length;d++)1==a[d].docTypeId?(AnyBalance.trace("Нашли паспорт..."),c.info.passport=a[d].serial+a[d].number):AnyBalance.trace("Неизвестный тип документа "+JSON.stringify(a[d]));else AnyBalance.trace("Не удалось получить список документов.")}else AnyBalance.trace(a),AnyBalance.trace("Не удалось получить персональную информацию. Сайт изменён?")}function processCredits(a,c){throw new AnyBalance.Error("Обработка кредитов пока не поддерживается. Пожалуйста, обратитесь к разработчикам.");}
function processBonuses(a,c){if(AnyBalance.isAvailable("bonuses")){a=AnyBalance.requestGet(baseurl+"/lk/proxy/loyaltyPipe/operations_history");var b=getJson(a);b.data&&b.data.operations?getParam(b.data.operations[0]?b.data.operations[0].bonusAvailable+"":void 0,c,"bonuses",null,null,parseBalance):(AnyBalance.trace(a),AnyBalance.trace("Не удалось найти бонусы."))}}
function getToken(){var a=AnyBalance.requestPost(baseurl+"/lk/proxy/dummyPipe/get_csrf_token",{},addHeaders({"X-Requested-With":"XMLHttpRequest",Referer:baseurl+"/lk/login"})),a=getJson(a),a=a.data?a.data.token:void 0;if(!a)throw new AnyBalance.Error("Не удалось найти токен авторизации. Сайт изменён?");return a};
