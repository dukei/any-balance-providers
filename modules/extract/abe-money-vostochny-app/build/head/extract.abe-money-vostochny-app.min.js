var g_domain="mobws.faktura.ru",g_baseurl="https://"+g_domain+"/",g_headers={"User-Agent":"Dalvik/2.1.0 (Linux; U; Android 8.0.0; ONEPLUS A3010 Build/OPR6.170623.013)",Connection:"Keep-Alive"},g_bankId=11991,g_deviceSecret;
function callApi(b,a){a.appver="3.10";a.locale="ru";a.reqId||(a.reqId=Math.ceil(99999*Math.random()));a=AnyBalance.requestPost(g_baseurl+"mobws/3.0/json/"+b,a,g_headers);var c=getJson(a);if(0!=c.response.result&&1!=c.response.result)throw AnyBalance.trace(a),a=c.response.message&&Base64.decode(c.response.message),new AnyBalance.Error(a||"Ошибка выполнения запроса "+b,null,/парол/i.test(a));return c.response}
function login(){g_deviceSecret=AnyBalance.getData("deviceSecret",Math.random().toString());if(!AnyBalance.getCookie("JSESSION")){var b=AnyBalance.getPreferences(),a=AnyBalance.getData("instanceId"),c=AnyBalance.getData("pin"),d=!(a&&c);try{if(!d){var e=joinObjects(createParams(),{login:b.login,instanceId:a,pin:c}),g=callApi("loginByPin",e);__setLoginSuccessful();return g}}catch(h){AnyBalance.trace("Ошибка входа по пин: "+h.message),d=!0}if(d)return loginNew()}}
function createParams(){var b=AnyBalance.getPreferences(),a=hex_md5(b.login+g_deviceSecret);return{deviceType:"android",osId:a.substr(0,16),deviceId:Math.abs(crc32(a)),deviceName:"AnyBalance",wifiMacAddress:"02:00:00:00:00:00",osVersion:26,vendor:"OnePlus",hasHceModule:!0,root:!1,pushEnabled:!0,imei:generateImei(b.login+g_deviceSecret,"86256103******L"),model:"msm8996",applicationCode:"express-bank"}}
function loginNew(){var b=AnyBalance.getPreferences(),a=Math.ceil(99999*Math.random()),c,b=joinObjects(createParams(),{publicKey:"MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAN25xe6Nfp0FDB9aL1Ncj18UWnhzS/LqLoTeLXR4VQvATM2P9aX6sc9XgUbAC8t55LLqTxlybtuZROrE4q6/Sp8CAwEAAQ==",login:b.login,applicationStage:"production",reqId:a,verificationCode:c,password:b.password,applicationId:"ru.ftc.faktura.expressbank"});c=callApi("login",b);1==c.result&&(AnyBalance.trace("OTP required..."),c=AnyBalance.retrieveCode("Пожалуйста, введите смс код для привязки к устройству",
null,{inputType:"number",time:3E5}),b.verificationCode=c,c=callApi("login",b));if(!c.object.session.instanceId)throw AnyBalance.trace(JSON.stringify(c)),new AnyBalance.Error("Ошибка получения идентификатора привязки");AnyBalance.setData("instanceId",c.object.session.instanceId);c=1E3+Math.floor(8999*Math.random());callApi("setPin",{pin:c});AnyBalance.setData("pin",c);AnyBalance.saveData();__setLoginSuccessful()}
function processCards(b){if(isAvailable("cards")){for(var a=callApi("getMyFinancesPage",{bankId:g_bankId,type:"ACCOUNTS"}),c=a.object.accounts&&a.object.accounts.accounts||[],a=[],d=0;d<c.length;++d)for(var e=c[d],g=0;e.limits&&g<e.limits.length;++g)for(var h=e.limits[g],k=0;h.cards&&k<h.cards.length;++k){var f=h.cards[k];f.account=e;f.limit=h;a.push(f)}AnyBalance.trace("Найдено карт: "+a.length);b.cards=[];for(d=0;d<a.length;++d)f=a[d],c=f.num.substr(-4)+"_"+f.account.number,e=f.name+" ("+f.num.substr(-4)+
")",f={__id:c,num:f.num,__name:e},__shouldProcess("cards",f)&&processCard(a[d],f),b.cards.push(f)}}
function processCard(b,a){getParam(b.num,a,"cards.num");getParam(b.limit.limit,a,"cards.limit");getParam(b.expireDate,a,"cards.till");getParam(b.cardHolderName,a,"cards.holder");getParam(b.status,a,"cards.status");getParam(b.account.availableWhenPay,a,"cards.balance");getParam(b.account.currencyCode,a,["cards.currency","cards.balance"]);getParam(b.account.number,a,"cards.accnum");"undefined"!=typeof processCardTransactions&&processCardTransactions(b,a)}
function processAccounts(b){if(isAvailable("accounts")){var a=callApi("getMyFinancesPage",{bankId:g_bankId,type:"ACCOUNTS"}),a=a.object.accounts&&a.object.accounts.accounts||[];AnyBalance.trace("Найдено счетов: "+a.length);b.accounts=[];for(var c=0;c<a.length;++c){var d=a[c],e=d.number,g=d.name,h=g+" "+e.substr(-4),e={__id:e,__name:h,num:e,name:g};__shouldProcess("accounts",e)&&processAccount(d,e);b.accounts.push(e)}}}
function processAccount(b,a){getParam(b.availableWhenPay,a,"accounts.balance");getParam(b.currencyCode,a,["accounts.currency","accounts"]);"undefined"!=typeof processAccountTransactions&&processAccountTransactions(b,a)}function processCredits(b){if(isAvailable("credits"))throw new AnyBalance.Error("Кредиты пока не поддерживаются. Обращайтесь к разработчикам.");}
function processDeposits(b){if(isAvailable("deposits")){var a=callApi("getMyFinancesPage",{bankId:g_bankId,type:"DEPOSITS"}),a=a.object.depositList&&a.object.depositList.deposits||[];AnyBalance.trace("Найдено депозитов: "+a.length);b.deposits=[];for(var c=0;c<a.length;++c){var d=a[c],e=d.contractAccounts&&d.contractAccounts[0]&&d.contractAccounts[0].account.number||d.number,g=d.productName+" "+e.substr(-4),e={__id:d.id,__name:g,num:e};__shouldProcess("deposits",e)&&processDeposit(d,e);b.deposits.push(e)}}}
function processDeposit(b,a){var c=b.contractAccounts&&b.contractAccounts[0];c&&(getParam(c.currentAmount,a,"deposits.balance"),getParam(c.account.currency.code,a,["deposits.currency","deposits.balance"]),getParam(c.nextInterestAmount,a,"deposits.pct_next_sum",/Поступление %[\s\S]*?<span[^>]+sum[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance),getParam(c.interestRate,a,"deposits.pct"),getParam(c.interestPaid,a,"deposits.pct_sum"),getParam(c.availableWithdrawalAmount,a,"deposits.available"),
getParam(c.amount,a,"deposits.balance_start"),getParam(c.actions.depositIn,a,"deposits.can_topup"),getParam(c.actions.depositOut,a,"deposits.can_withdraw"),getParam(c.account.number,a,"deposits.accnum"),getParam(c.interestAccountNumber,a,"deposits.accnum_pct"),getParam(c.returnAccountNumber,a,"deposits.accnum_return"));getParam(b.term.nextInterestPayDate,a,"deposits.pct_next");getParam(b.term.expiryDate,a,"deposits.till");getParam(b.openDate,a,"deposits.date_start");getParam(b.number,a,"deposits.contract");
getParam(b.term.contractPeriod,a,"deposits.period");"undefined"!=typeof processDepositsTransactions&&processDepositsTransactions(deposit,a)}function processInfo(b,a){AnyBalance.isAvailable("info")&&b&&(a.info||(a.info={}),getParam(b.object.user.name,a.info,"info.fio"))};
