var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 5.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/28.0.1500.72 Safari/537.36"},baseurl="https://money.yandex.ru/";
function loginAndGetBalance(a,c){checkEmpty(a.login,"Введите логин в Яндекс.Деньги!");checkEmpty(a.password,"Введите пароль, используемый для входа в систему Яндекс.Деньги. Не платежный пароль, а именно пароль для входа!");AnyBalance.setDefaultCharset("UTF-8");var b=AnyBalance.requestGet("https://passport.yandex.ru",g_headers),b=loginYandex(a.login,a.password,b,baseurl+"index.xml","money");if(!/logout-url/i.test(b))throw new AnyBalance.Error("Не удалось зайти. Проверьте логин и пароль.");if(a=getJsonObject(b,
/window.__layoutData__\s*=/))AnyBalance.trace("Загружаем из layoutData"),getParam(a.user.accountId,c,"number"),getParam(a.balance.rub.availableAmount,c,"balance"),b=a.secretKey,a.balance.bonus?getParam(a.balance.bonus.availableAmount,c,"bonus"):(b=AnyBalance.requestGet(baseurl+"ajax/layout/accounts?sk="+encodeURIComponent(b),addHeaders({Accept:"application/json, text/plain, */*",Referer:baseurl})),b=getJson(b),getParam(b.balances.bonus.availableAmount,c,"bonus"));else{AnyBalance.trace("Загружаем по-старинке");
getParam(b,c,"number",/Номер кошелька(?:[^>]*>){2}(\d{10,20})/i,replaceTagsAndSpaces);(a=getElements(b,[/<button/ig,/balance__icon/i])[0])&&(a=replaceAll(a,replaceTagsAndSpaces));AnyBalance.trace("Предположительно баланс где-то здесь: "+a);if(!a||/\*{3}/.test(a))if(AnyBalance.trace("Сумма спрятана. Будем пытаться найти..."),a=getParam(b,null,null,/<div[^>]+class="[^>]*\bbalance\b[^>]+data-bem=[']([^']*)/i,replaceHtmlEntities,getJson),AnyBalance.trace("Получаем баланс из "+JSON.stringify(a)),a&&a.balance&&
a.balance.amount&&isset(a.balance.amount.sum))getParam(a.balance.amount.sum,c,"balance");else throw AnyBalance.trace(b),new AnyBalance.Error("Не удаётся найти спрятанный баланс! Сайт изменен?");else getParam(a,c,"balance",null,replaceTagsAndSpaces,parseBalance);getParam(b,c,"bonus",/Сколько у вас баллов[\s\S]*?<div[^>]+balance__item[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance)}}
function processHistory(a){if(AnyBalance.isAvailable("transactions")){var c=0;a.transactions=[];for(var b=1;10>=b;b++){var d=AnyBalance.requestGet(baseurl+"ajax/history/partly?ncrnd=72010&history_shortcut=history_all&start-record="+c+"&record-count=100",addHeaders({"X-Requested-With":"XMLHttpRequest"})),c=c+100,d=getJson(d);AnyBalance.trace("Найдено транзакций: "+d.history.length);for(var e=0;e<d.history.length;++e){var f={};getParam((2==d.history[e].type?"-":"")+d.history[e].sum+"",f,"transactions.sum",
null,replaceTagsAndSpaces,parseBalance);getParam(d.history[e].name,f,"transactions.name",null,replaceTagsAndSpaces);getParam(d.history[e].date,f,"transactions.time",null,replaceTagsAndSpaces,parseDateISO);a.transactions.push(f)}if(!d.hasMore){AnyBalance.trace("Транзакций больше нет...");break}}}}
function getCombinedHistory(){var a=AnyBalance.requestGet(baseurl+"ajax/load-bonus-history?recordCount=100",addHeaders({"X-Requested-With":"XMLHttpRequest"})),c=AnyBalance.requestGet(baseurl+"ajax/history/partly?ncrnd=72010&history_shortcut=history_all&start-record=0&record-count=100",addHeaders({"X-Requested-With":"XMLHttpRequest"})),a=getJson(a),c=getJson(c);combineHistory(c,a);return c.history}
function combineHistory(a,c){for(var b=0,d=0;b<c.items.length;++b){var e=c.items[b],f=parseDateISOSilent(e.date),g;/за пятый|в категории месяца/i.test(e.name)?g="card":/за плат[её]ж в интернете/i.test(e.name)?g="internet":!1===e.isIncoming?g="balls":(AnyBalance.trace("Тип начисления баллов неизвестен: "+e.name+"\n"+JSON.stringify(e)),g="unknown");if("balls"!==g){for(;d<a.history.length&&parseDateISOSilent(a.history[d].date)>f;++d);if(d>=a.history.length)break;for(var k=d;k<a.history.length;++k){var h=
a.history[d],l=parseDateISOSilent(h.date);if(3E5<f-l)break;if("card"!==g||h.flags["is-meta-ycard-operation"])if("internet"!==g||h.flags["is-out-shop"]){h.__balls=e;d=k+1;break}}h.__balls||AnyBalance.trace("Не удалось найти транзакцию для баллов "+JSON.stringify(e))}}AnyBalance.trace(b+"/"+c.items.length+" баллов поставлены в соответствие транзакциям")};
