var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.120 Safari/537.36"},baseurl="https://yoomoney.ru/",g_csrf,g_savedData;
function callApi(a,b){if(!g_csrf)throw new AnyBalance.Error("CSRF token not set!");var c=AnyBalance.requestPost(baseurl+a,JSON.stringify(b),addHeaders({Referer:baseurl,"Content-Type":"application/json;charset=UTF-8","x-csrf-token":g_csrf}));if("yooid/signin/api/process/start/standard"==a&&404==AnyBalance.getLastStatusCode())return callApi("yooid/signin/api/process/start",b);a=JSON.parse(c);if("error"===a.status)throw AnyBalance.trace(c),c=a.message||a.errors&&JSON.stringify(a.errors),new AnyBalance.Error(c,
null,/PASSWORD|ACCOUNT/i.test(c));return a}
function login(){var a=AnyBalance.getPreferences();checkEmpty(a.login,"Введите логин в ЮMoney!");checkEmpty(a.password,"Введите пароль, используемый для входа в систему ЮMoney.");g_savedData||(g_savedData=new SavedData("yoomoney",a.login));g_savedData.restoreCookies();var b=AnyBalance.requestGet(baseurl,g_headers),c=getJsonObject(b,/window.__layoutData__\s*=/);if(c&&c.user&&c.user.uid)AnyBalance.trace("Already logged in to "+c.user.userName+" ("+c.user.maskedPhone+")");else{var e=function(d){if(!d.result)return d.result;
if(d.result.nextStepData)return d.result.nextStepData;if(d.result.nextStep)return d.result};AnyBalance.trace("Logging in anew");b=AnyBalance.requestGet(baseurl+"yooid/signin?origin=Wallet&returnUrl=https%3A%2F%2Fyoomoney.ru%2F",g_headers);g_csrf=getParam(b,/__secretKey__="([^"]*)/);if(!g_csrf)throw AnyBalance.trace(b),new AnyBalance.Error("Не удаётся найти информацию для входа. Сайт изменен?");c=getJsonObject(b,/__data__=/);b=callApi("yooid/signin/api/process/start/standard",{sessionId:c.tmx.sessionId,
login:a.login,origin:"Wallet"});for(a=callApiProgress("yooid/signin/api/login/set",{login:a.login,processId:b.result.processId,loginType:b.result.loginType});a.result&&e(a);)a=processStep(b.result,e(a));b=AnyBalance.requestGet(baseurl)}g_savedData.setCookies();g_savedData.save();return b}
function callApiProgress(a,b){do{c&&AnyBalance.sleep(1E3);var c=callApi(a,b);AnyBalance.trace(a+": "+JSON.stringify(c))}while("progress"===c.status);if((a=c.result&&c.result.status)&&!/^(SUCCESS|ok)$/i.test(a))throw c=c.result.message||c.result.status,new AnyBalance.Error(c,null,/ACCOUNT|PASSWORD/i.test(c));return c}
function processStep(a,b){var c=AnyBalance.getPreferences();AnyBalance.trace("Processing step "+b.nextStep);if("SetPassword"===b.nextStep)a=callApiProgress("yooid/signin/api/password/set",{processId:a.processId,loginType:a.loginType,password:c.password});else if("SetConfirmationCode"===b.nextStep){b=AnyBalance.retrieveCode("Пожалуйста, введите код, который послан вам на "+b.maskedRecipient,null,{inputType:"number",time:17E4});c={PhoneNumber:"otp/check/phone",Email:"otp/check/mail"};if(!c[a.loginType])throw new AnyBalance.Error("Неизвестный тип входа: "+
a.loginType);a=callApiProgress("yooid/signin/api/"+c[a.loginType],{contextId:a.processId,answer:b})}else if("Complete"===b.nextStep)a=callApiProgress("yooid/signin/api/process/complete",{processId:a.processId,loginType:a.loginType});else if("SelectAccount"===b.nextStep){AnyBalance.trace("Multiple accounts found: "+JSON.stringify(b.accounts));b=b.accounts.filter(function(e){return"NotRequired"===e.migrationRequirement});if(!b[0])throw new AnyBalance.Error("Не удалось найти готовый для входа аккаунт!");
a=callApiProgress("yooid/signin/api/account/select",{processId:a.processId,loginType:a.loginType,uid:b[0].uid})}else throw new AnyBalance.Error("Неизвестный шаг");return a}
function loginAndGetBalance(a,b){checkEmpty(a.login,"Введите логин в Яндекс.Деньги!");checkEmpty(a.password,"Введите пароль, используемый для входа в систему Яндекс.Деньги. Не платежный пароль, а именно пароль для входа!");AnyBalance.setDefaultCharset("UTF-8");a=login();var c=getJsonObject(a,/window.__layoutData__\s*=/),e={identified:"Идентифицированный",anonymous:"Анонимный",named:"Именной"};if(c){AnyBalance.trace("Загружаем из layoutData");getParam(c.user.accountId,b,"number");getParam(c.user.accountId,
b,"__tariff");getParam(c.user.userName,b,"userName");getParam(e[c.user.accountStatus]||c.user.accountStatus,b,"accountStatus");getParam(c.balance.rub.availableAmount,b,"balance",null,null,parseBalance);e=c.secretKey;if(c.balance.bonus)getParam(c.balance.bonus.availableAmount,b,"bonus",null,null,parseBalance);else{a=AnyBalance.requestGet(baseurl+"ajax/layout/accounts?sk="+encodeURIComponent(e),addHeaders({Accept:"application/json, text/plain, */*",Referer:baseurl}));var d=getJson(a);getParam(d.balances.bonus.availableAmount,
b,"bonus",null,null,parseBalance)}try{a=AnyBalance.requestGet(baseurl+"ajax/layout/curtain-cards?sk="+encodeURIComponent(e),addHeaders({Accept:"application/json, text/plain, */*",Referer:baseurl})),(d=getJson(a).ownCards)&&0<d.length&&(d=d[0],getParam(d.cardNumber.substr(-8),b,"cardNumber"),getParam(d.expirationDate,b,"cardDate",null,null,parseDate))}catch(f){AnyBalance.trace("Ошибка получения информации по доп.картам"+f.message)}}else{AnyBalance.trace("Загружаем по-старинке");getParam(a,b,"number",
/Номер кошелька(?:[^>]*>){2}(\d{10,20})/i,replaceTagsAndSpaces);(d=getElements(a,[/<button/ig,/balance__icon/i])[0])&&(d=replaceAll(d,replaceTagsAndSpaces));AnyBalance.trace("Предположительно баланс где-то здесь: "+d);if(!d||/\*{3}/.test(d))if(AnyBalance.trace("Сумма спрятана. Будем пытаться найти..."),d=getParam(a,null,null,/<div[^>]+class="[^>]*\bbalance\b[^>]+data-bem=[']([^']*)/i,replaceHtmlEntities,getJson),AnyBalance.trace("Получаем баланс из "+JSON.stringify(d)),d&&d.balance&&d.balance.amount&&
isset(d.balance.amount.sum))getParam(d.balance.amount.sum,b,"balance",null,null,parseBalance);else throw AnyBalance.trace(a),new AnyBalance.Error("Не удаётся найти спрятанный баланс! Сайт изменен?");else getParam(d,b,"balance",null,replaceTagsAndSpaces,parseBalance);getParam(a,b,"bonus",/Скол`ько у вас баллов[\s\S]*?<div[^>]+balance__item[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance)}}
function processHistory(a){if(AnyBalance.isAvailable("transactions")){var b=0;a.transactions=[];for(var c=1;10>=c;c++){var e=AnyBalance.requestGet(baseurl+"ajax/history/partly?ncrnd=72010&history_shortcut=history_all&start-record="+b+"&record-count=100",addHeaders({"X-Requested-With":"XMLHttpRequest"}));b+=100;e=getJson(e);AnyBalance.trace("Найдено транзакций: "+e.history.length);for(var d=0;d<e.history.length;++d){var f={};getParam((2==e.history[d].type?"-":"")+e.history[d].sum,f,"transactions.sum",
null,replaceTagsAndSpaces,parseBalance);getParam(e.history[d].name,f,"transactions.name",null,replaceTagsAndSpaces);getParam(e.history[d].date,f,"transactions.time",null,replaceTagsAndSpaces,parseDateISO);a.transactions.push(f)}if(!e.hasMore){AnyBalance.trace("Транзакций больше нет...");break}}}}function getCombinedHistory(){return[]}
function combineHistory(a,b){for(var c=0,e=0;c<b.items.length;++c){var d=b.items[c],f=parseDateISOSilent(d.date);if(/за пятый|в категории месяца/i.test(d.name))var g="card";else/за плат[её]ж в интернете/i.test(d.name)?g="internet":!1===d.isIncoming?g="balls":(AnyBalance.trace("Тип начисления баллов неизвестен: "+d.name+"\n"+JSON.stringify(d)),g="unknown");if("balls"!==g){for(;e<a.history.length&&parseDateISOSilent(a.history[e].date)>f;++e);if(e>=a.history.length)break;for(var k=e;k<a.history.length;++k){var h=
a.history[e],l=parseDateISOSilent(h.date);if(3E5<f-l)break;if("card"!==g||h.flags["is-meta-ycard-operation"])if("internet"!==g||h.flags["is-out-shop"]){h.__balls=d;e=k+1;break}}h.__balls||AnyBalance.trace("Не удалось найти транзакцию для баллов "+JSON.stringify(d))}}AnyBalance.trace(c+"/"+b.items.length+" баллов поставлены в соответствие транзакциям")};
