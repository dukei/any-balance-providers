var baseurl="https://online.jugra.ru:2443",g_html_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:35.0) Gecko/20100101 Firefox/35.0"},g_headers=addHeaders({"Content-Type":"application/json;charset=utf-8",Accept:"application/json, text/plain, */*","X-Requested-With":"XMLHttpRequest",
Referer:baseurl+"/",Origin:baseurl},g_html_headers);
function login(c){AnyBalance.setDefaultCharset("utf-8");checkEmpty(c.login,"Введите логин!");checkEmpty(c.password,"Введите пароль!");var b=AnyBalance.requestGet(baseurl+"/",g_html_headers),a=AnyBalance.getCookie("XSRF-TOKEN"),b=AnyBalance.requestPost(baseurl+"/client/controller/?action=1","",addHeaders({"X-XSRF-TOKEN":a}));if(!b||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(b),new AnyBalance.Error("Ошибка при подключении к сайту интернет-банка! Попробуйте обновить данные позже.");var d=
getJson(b);if(d.ok)AnyBalance.trace("Уже залогинены, используем существующую сессию");else if(a=AnyBalance.getCookie("XSRF-TOKEN"),b=AnyBalance.requestPost(baseurl+"/main/controller/?action=2",JSON.stringify({pkn:c.login,password:c.password}),addHeaders({"X-XSRF-TOKEN":a,Referer:baseurl+"/auth"})),d=getJson(b),d.ok&&d.data.sms_confirm_login){AnyBalance.trace("Требуется подтверждение по SMS. Запрашиваем...");for(var e=0;3>e;++e){var f=AnyBalance.retrieveCode("Пожалуйста, введите код подтверждения входа в интернет-банк, посланный вам по SMS"+
(0<e?" (осталось "+(3-e)+" попытки)":""),null,{inputType:"number",time:18E4}),b=AnyBalance.requestPost(baseurl+"/main/controller/?action=6",JSON.stringify({pkn:c.login,code:f}),addHeaders({"X-XSRF-TOKEN":a,Referer:baseurl+"/auth"})),d=getJson(b);if(!d.ok&&/SMS-код должен содержать|INVALID_CONFIRM_CODE/i.test(d.error+d.msg))AnyBalance.trace("Попытка "+(e+1)+", код "+f+": "+d.msg),msg=d.msg+"\n";else break}}if(!d.ok){if(c=isArray(d.msg)?d.msg.join(", "):d.msg)throw new AnyBalance.Error(c,null,/PKN_NOT_FOUND|INVALID_PASSWORD|ПКН должен содержать/i.test(d.error+
c));AnyBalance.trace(b);throw new AnyBalance.Error("Не удалось зайти в интернет-банк. Сайт изменен?");}__setLoginSuccessful();return d}function processAccounts(c,b){if(AnyBalance.isAvailable("accounts")){AnyBalance.trace("Обработка счетов");b.accounts=[];for(var a=0;a<c.data.tools.length;a++){var d=c.data.tools[a];if(d.account){var e={__id:d.id,__name:d.client_tool_name,num:d.account.number};__shouldProcess("accounts",e)&&processAccount(d,e);b.accounts.push(e)}}}}
function n(c){if(null!==c)return c}function getToolById(c,b){for(var a=0;a<c.length;a++){var d=c[a];if(d.id==b)return d}}
function processAccount(c,b){AnyBalance.trace("Обработка счета "+b.__name);var a=c.account;getParam(a.currency,b,"accounts.currency_iso");getParam(CurrencyISO.getCurrencySymbol(a.currency),b,"accounts.currency");getParam(a.type,b,"accounts.type");getParam(a.status,b,"accounts.status_code");getParam(a.saldo,b,"accounts.balance");getParam(a.free_limit,b,"accounts.available");getParam(n(a.min_balance),b,"accounts.balance_min");getParam(n(a.date_open),b,"accounts.date_start",null,null,parseDateISO);getParam(n(a.date_close),
b,"accounts.date_end",null,null,parseDateISO);getParam(n(a.replenish),b,"accounts.replenish");getParam(n(a.partial_withdrawal),b,"accounts.withdrawal");getParam(n(a.rate),b,"accounts.rate");getParam(n(a.tariff_code),b,"accounts.tariff_code");getParam(n(a.tariff_name),b,"accounts.tariff_name");AnyBalance.isAvailable("accounts.transactions")&&processAccountTransactions(c,b)}
function processCards(c,b){if(AnyBalance.isAvailable("cards")){AnyBalance.trace("Обработка карт");b.cards=[];for(var a=0;a<c.data.tools.length;a++){var d=c.data.tools[a];if(d.card){var e={__id:d.id,__name:d.client_tool_name,num:d.card.number};if(__shouldProcess("cards",e)){if(d.parent_id){var f=getToolById(c.data.tools,d.parent_id);getParam(f&&f.account&&f.account.number,e,"accnum")}processCard(d,e)}b.cards.push(e)}}}}
function processCard(c,b){AnyBalance.trace("Обработка карты "+b.__name);var a=c.card;getParam(a.currency,b,"cards.currency_iso");getParam(CurrencyISO.getCurrencySymbol(a.currency),b,"cards.currency");getParam(a.card_type,b,"cards.type");getParam(a.status,b,"cards.status_code");getParam(a.saldo,b,"cards.balance");getParam(a.free_limit,b,"cards.available");getParam(n(a.summ_blocked),b,"cards.blocked");getParam(n(a.date_expired),b,"cards.till",null,null,parseDate);getParam(n(a.owner),b,"cards.holder");
getParam(n(a.sms_notice),b,"cards.sms_notice");getParam(n(a.cashback_sum),b,"cards.cashback");getParam(n(a.tariff_code),b,"cards.tariff_code");getParam(n(a.tariff_name),b,"cards.tariff_name");isAvailable("cards.transactions")&&processCardTransactions(c,b);a.summ_blocked&&isAvailable("cards.transactions_blocked")&&processBlockedCardTransactions(c,b)}
function processInfo(c,b){if(AnyBalance.isAvailable("info")){var a=b.info={};getParam(n(c.data.person.name),a,"info.name");getParam(n(c.data.person.surname),a,"info.surname");getParam(n(c.data.person.patronymic),a,"info.patronymic");getParam(n(c.data.person.date_birth),a,"info.birthday",null,null,parseDateISO);getParam(n(c.data.person.pass_seria),a,"info.pass_seria");getParam(n(c.data.person.pass_number),a,"info.pass_number");getParam(n(c.data.person.pass_description),a,"info.pass_descr");getParam(n(c.data.person.address),
a,"info.address");getParam(n(c.data.email||c.data.person.email),a,"info.email")}};
