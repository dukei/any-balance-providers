var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.76 Safari/537.36"},g_apiHeaders={Accept:"application/json, text/javascript, */*; q=0.01",Origin:"https://www.gosuslugi.ru","X-Requested-With":"XMLHttpRequest","User-Agent":"Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.76 Safari/537.36",
"Content-Type":"application/json",Referer:"https://www.gosuslugi.ru/pgu/personcab"},g_betaApiHeaders={Accept:"application/json, text/javascript, */*; q=0.01","User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.157 Safari/537.36","Accept-Language":"ru,en;q=0.8"},g_baseurl="https://www.gosuslugi.ru/",g_betaBaseurl="https://beta.gosuslugi.ru/",g_replaceSpacesAndBrs=[/^\s+|\s+$/g,"",/<br\/><br\/>$/i,""],g_max_plates_num=10,g_max_inns_num=3;
function login(a){AnyBalance.setDefaultCharset("utf-8");var b=getParam(a.login||"",null,null,/^\d{11}$/,[/^(\d{3})(\d{3})(\d{3})(\d{2})$/i,"$1-$2-$3 $4"]),d="snils";isset(b)&&b||(b=getParam(a.login||"",null,null,/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/),d="email");"snils"==d?checkEmpty(b,'Введите СНИЛС (без пробелов и разделителей, 11 символов подряд). Вы ввели: "'+(a.login||"пустое поле")+'"!'):checkEmpty(b,
'Введите правильный Email. Вы ввели: "'+(a.login||"пустое поле")+'"!');checkEmpty(a.password,"Введите пароль!");var c=AnyBalance.requestGet(g_baseurl+"pgu/personcab",g_headers);if(!isLoggedIn(c)){var c=checkForRedirect(c),e=getParam(c,null,null,/new\s+LoginViewModel\((?:[^,]+,){1,2}'([^"']+)'/i);if(!e)throw AnyBalance.trace(c),new AnyBalance.Error("Не удалось найти идентификатор команды для входа.");c=AnyBalance.requestPost("https://esia.gosuslugi.ru/idp/login/pwd/do",{login:b,password:a.password,
idType:d,command:e},addHeaders({Referer:"https://esia.gosuslugi.ru/idp/rlogin?cc=bp"}));if(a=getParam(c,null,null,/authn\.error\.([^"']+)/i))throw c=getParam(c,null,null,/var jsonLocalizationMsg\s*=\s*(\{[\s\S]*?\})\s*;/i,null,getJson),c=getParam(c.authn.error[a],null,null,null,replaceTagsAndSpaces),new AnyBalance.Error(c,null,/invalidCredentials/i.test(a));/<h1[^>]*>\s*Выбор роли\s*<\/h1>|Войти как/i.test(c)&&AnyBalance.requestGet("https://esia.gosuslugi.ru/idp/globalRoleSelection?orgID=P",g_headers);
c=checkForRedirect(AnyBalance.requestGet("https://www.gosuslugi.ru/pgu/personcab",g_headers));c=checkForJsOff(c)}if(!isLoggedIn(c)){if(a=getParam(c,null,null,[/span\s*>\s*(Ошибка авторизации(?:[^>]*>){4})/i,/<div class="error[^>]*>([\s\S]*?)<\/div>/i],[replaceTagsAndSpaces,/Вернуться назад/i,""],html_entity_decode))throw new AnyBalance.Error(a,null,/Ошибка авторизации/i.test(a));AnyBalance.trace(c);throw new AnyBalance.Error("Не удалось зайти в личный кабинет. Сайт изменен?");}return c}
function processProfile(a,b){b.profile={};getParam(a,b.profile,"profile.fio",/title="Личный кабинет"(?:[^>]*>){3}([^<]+)</i,replaceTagsAndSpaces);isAvailable("profile.mails")&&getParam(getUnreadMsgJson(),b.profile,"profile.mails",/"msgCount"\D*(\d+)/i,replaceTagsAndSpaces,parseBalance);a=checkForRedirect(AnyBalance.requestGet("https://esia.gosuslugi.ru/profile/user/",g_headers));getParam(a,b.profile,"profile.fio",/ФИО(?:[\s\S]*?<dd[^>]*>)([\s\S]*?)<\/dd>/i,replaceTagsAndSpaces);getParam(a,b.profile,
"profile.birth_place",/Место рождения(?:[\s\S]*?<dd[^>]*>)([\s\S]*?)<\/dd>/i,replaceTagsAndSpaces);getParam(a,b.profile,"profile.birth_day",/Дата рождения(?:[\s\S]*?<dd[^>]*>)([\s\S]*?)<\/dd>/i,replaceTagsAndSpaces,parseDate);getParam(a,b.profile,"profile.document",/Документ, удостоверяющий личность(?:[\s\S]*?<dd[^>]*>)([\s\S]*?)<\/dd>/i,replaceTagsAndSpaces);getParam(a,b.profile,"profile.snils",/Страховой номер индивидуального лицевого счёта(?:[\s\S]*?<dd[^>]*>)([\s\S]*?)<\/dd>/i,replaceTagsAndSpaces);
getParam(a,b.profile,"profile.inn",/id="person:innInf[^>]*>([\s\S]*?)<\//i,replaceTagsAndSpaces);getParam(a,b.profile,"profile.adress_fakt",/id="person:liveAddrInf"[^>]*>([\s\S]*?)<\//i,replaceTagsAndSpaces);getParam(a,b.profile,"profile.adress",/id="person:regAddrInf"[^>]*>([\s\S]*?)<\//i,replaceTagsAndSpaces);getParam(a,b.profile,"profile.email",/Адрес электронной почты(?:[\s\S]*?<dd[^>]*>)([\s\S]*?)<\//i,replaceTagsAndSpaces);getParam(a,b.profile,"profile.phone",/Мобильный телефон(?:[\s\S]*?<dd[^>]*>)([\s\S]*?)<\//i,
replaceTagsAndSpaces);var d=getParam(a,null,null,/id="person:drLicenseInf"[^>]*>([\s\S]*?)<\//i,replaceTagsAndSpaces);isset(d)&&(getParam(d,b.profile,"profile.license"),getParam(d,b.profile,"profile.license_till",/действительно до([^<]+)/i,null,parseDate));if(d=getElement(a,/<div[^>]+id="person:vehicleInf">/i)){d=getElements(d,/<dl[^>]+class="line-link">/ig);AnyBalance.trace("Найдено автомобилей: "+d.length);b.profile.vehicles=[];for(var c=0;c<d.length;++c){var e={};getParam(d[c],e,["profile.vehicles.name",
"fines"],/<dt>([^<]+)/i,replaceTagsAndSpaces);getParam(d[c],e,["profile.vehicles.plate","fines"],/государственный регистрационный знак\s*([^,]+)/i,[replaceTagsAndSpaces,/\s/g,""]);getParam(d[c],e,["profile.vehicles.plate_id","fines"],/свидетельство о регистрации\s*([^<]+)/i,[replaceTagsAndSpaces,/\s/g,""]);(isset(e.name)||isset(e.plate)||isset(e.plate_id))&&b.profile.vehicles.push(e)}}}
function processFines(a,b,d){if(b.gosnumber){AnyBalance.trace("Указан номер автомобиля, значит надо получать штрафы...");a.fines=[];var c=b.gosnumber.split(";");AnyBalance.trace("Автомобилей: "+c.length);if(a.profile&&a.profile.vehicles){AnyBalance.trace("Добавим автомобили из профиля: "+a.profile.vehicles.length);for(var e=0;e<a.profile.vehicles.length;e++){var f=a.profile.vehicles[e].plate.toLowerCase(),g=a.profile.vehicles[e].name;c.some(function(a,b){if(f===a.toLowerCase())return!0})?AnyBalance.trace("Автомобиль "+
g+" ("+f+") уже добавлен.."):(c.push(f),AnyBalance.trace("Добавили автомобиль "+g+" ("+f+")"))}}g=Math.min(c.length,g_max_plates_num);for(e=0;e<g;e++){var h=c[e];if(h){AnyBalance.trace("Получаем данные по автомобилю с номером "+h);try{processFinesForCurrentPlate(a,b,h,d)}catch(k){if(AnyBalance.trace("Не удалось получить данные по штрафам из-за ошибки: "+k.message),k.fatal)throw k;}}}}}
function processFinesForCurrentPlate(a,b,d,c){checkEmpty(d=getParam(d,null,null,/^\D?\d{3,4}\D{2}\d{2,3}$/),"Введите номер автомобиля в формате х123хх50 или 1234хх50!",!0);b.licensenumber&&checkEmpty(b.licensenumber=getParam(b.licensenumber,null,null,/^.{10}$/),"Введите серию и номер водительского удостоверения в формате 50км123456!",!0);var e=AnyBalance.requestGet("https://www.gosuslugi.ru/pgu/service/10000581563_26.html",g_headers),f=getJson(postAPICall("https://www.gosuslugi.ru/fed/service/10000581563_26/checkStatus.json",
{},"https://www.gosuslugi.ru/pgu/service/10000581563_26.html"));if(0!=f.errorCode)throw new AnyBalance.Error("Система ответила сообщением: "+f.errorMessage);for(f=3;0<f&&!(e=AnyBalance.requestGet("https://www.gosuslugi.ru/fed/services/s26/initForm?serviceTargetExtId=10000581563&userSelectedRegion=00000000000&rURL=https://www.gosuslugi.ru/pgu/personcab/orders&srcFormProviderId=9952354",addHeaders({Referer:"https://www.gosuslugi.ru/pgu/service/10000581563_26.html"})));f--);f=getParam(e,null,null,/'action'[^'"]*['"]\/([^'"]*)/i);
if(!f){if(a=getParam(e,null,null,/Услуга недоступна<(?:[^>]*>){3}([\s\S]*?)<\/div/i,replaceTagsAndSpaces))throw new AnyBalance.Error(a);AnyBalance.trace(e);throw new AnyBalance.Error("Не удалось найти форму для запроса штрафов, скорее всего услуга недоступна!");}e=createFormParams(e,function(a,c,e,f){return"tsRz"==e?d:"VU"==e?b.licensenumber:f});e=AnyBalance.requestPost(g_baseurl+f,e,addHeaders({Referer:"https://www.gosuslugi.ru/fed/services/s26/initForm?serviceTargetExtId=10000581563&userSelectedRegion=00000000000&rURL=https://www.gosuslugi.ru/pgu/personcab/orders&srcFormProviderId=9952354"}));
if(!/>\s*Исполнено\s*</i.test(e))throw new AnyBalance.Error("Не удалось обработать заявление, сайт изменен?");e=getXmlFileResult(e);e=getElements(e,/<div[^>]+class="[^"]*tabs-dd[^>]*>/ig);AnyBalance.trace("Найдено штрафов: "+e.length);for(f=0;f<e.length;f++){var g=e[f],h=getParam(g,null,null,/<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces),k=/Оплачено/i.test(g);AnyBalance.trace("Нашли "+(k?"оплаченный":"неоплаченный")+"оплаченный штраф: "+h);h=getParam(g,null,null,/Штраф,?\s*руб(?:[\s\S]*?<td[^>]*>)([\s\S]*?)<\/td>/i,
replaceTagsAndSpaces,parseBalance);k||sumParam(h,a,"fines_unpaid",null,null,null,aggregate_sum);sumParam(h,a,"fines_total",null,null,null,aggregate_sum);if(c||!k){var h=getParam(g,null,null,/Постановление\/протокол([\s\S]*?)от/i,replaceTagsAndSpaces),l=getParam(g,null,null,/Дата и номер постановления\/протокола(?:[\s\S]*?<td[^>]*>)([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);findIdInArray(a.fines,h)?AnyBalance.trace("Этот штраф привязан к номеру ВУ и уже был добавлен"):(h={__id:h,__name:l},__shouldProcess("fines",
h)&&(getParam(g,h,"fines.ammount",/Штраф,?\s*руб(?:[\s\S]*?<td[^>]*>)([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),getParam(g,h,"fines.break",/Нарушение(?:[\s\S]*?<td[^>]*>)([\s\S]*?)<\/td>/i,replaceTagsAndSpaces),getParam(g,h,"fines.time",/Дата и время нарушения(?:[\s\S]*?<td[^>]*>)([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseDate),getParam(g,h,"fines.fio",/Нарушитель(?:[\s\S]*?<td[^>]*>)([\s\S]*?)<\/td>/i,replaceTagsAndSpaces),getParam(g,h,"fines.place",/Место нарушения(?:[\s\S]*?<td[^>]*>)([\s\S]*?)<\/td>/i,
replaceTagsAndSpaces),getParam(g,h,"fines.vehicle",/Марка, модель ТС(?:[\s\S]*?<td[^>]*>)([\s\S]*?)<\/td>/i,replaceTagsAndSpaces),getParam(g,h,"fines.proto_place",/Место составления протокола(?:[\s\S]*?<td[^>]*>)([\s\S]*?)<\/td>/i,replaceTagsAndSpaces),getParam(g,h,"fines.department",/Подразделение(?:[\s\S]*?<td[^>]*>)([\s\S]*?)<\/td>/i,replaceTagsAndSpaces),getParam(k,h,"fines.paid")),a.fines.push(h))}}}
function findIdInArray(a,b){if(!a||1>a.length)return!1;for(var d=0;d<a.length;d++)if(b==a[d].__id)return!0}
function processNalogi(a,b,d){if(isAvailable(["nalog_balance","nalog_info"])){var c=g_baseurl+"pgu/service/10001761551_99.html";b=AnyBalance.requestGet(c,g_headers);var e=postAPICall(g_baseurl+"fed/service/10001761551_99/checkStatus.json",{},c),e=getJson(e);if(0!=e.errorCode)throw new AnyBalance.Error("Система ответила сообщением: "+e.errorMessage);for(var e=g_baseurl+"fed/services/s99/initForm?serviceTargetExtId=10001761551&userSelectedRegion=00000000000&rURL=https://www.gosuslugi.ru/pgu/personcab/orders&srcFormProviderId=9952354",f=
3;0<f&&!(b=AnyBalance.requestGet(e,addHeaders({Referer:c})));f--);c=0;f=g_baseurl+"fed/services/s99/s"+ ++c+"?serviceTargetExtId=10001761551";b=AnyBalance.requestPost(f,createFormParamsById(b,"99"),addHeaders({Referer:e}));b=createFormParamsById(b,"99");b.inn=d.inn;b["region[0]"]="99";f=g_baseurl+"fed/services/s99/s"+ ++c+"?serviceTargetExtId=10001761551";b=AnyBalance.requestPost(f,b,addHeaders({Referer:f}));if(!/>\s*Исполнено\s*</i.test(b))throw new AnyBalance.Error("Не удалось обработать заявление, сайт изменен?");
b=getXmlFileResult(b);d=sumParam(b,null,null,/<tr>(\s*<td>(?:[\s\S]*?<td[^>]*){4}[^<]*)<\/t/ig);AnyBalance.trace("Найдено налогов: "+d.length);b="";for(e=0;e<d.length;e++){var g=d[e],c=getParam(g,null,null,/<td(?:[^>]*>){1}([^<]*)/i)||"Неизвестный тип налога",f=getParam(g,null,null,/<td(?:[^>]*>){5}([^<]+)/i),g=getParam(g,null,null,/<td(?:[^>]*>){7}([^<]+)/i);sumParam(g,a,"nalog_balance",null,replaceTagsAndSpaces,parseBalance,aggregate_sum);b+=c+": "+f+" <b>"+g+"</b><br/><br/>"}getParam(b,a,"nalog_info",
null,g_replaceSpacesAndBrs)}}function getLocalizedMsg(a,b){for(var d=b.split(/\./g),c=0;c<d.length;++c)a=a[d[c]];return html_entity_decode(a)}function isLoggedIn(a){return/\/logout|title="Выход"/i.test(a)}function postAPICall(a,b,d){a=AnyBalance.requestPost(a,JSON.stringify(b),isset(d)?addHeaders({Referer:d}):g_apiHeaders);if(!a)throw AnyBalance.trace(html),new AnyBalance.Error("Не удалось получить информацию об услуге, сайт изменен?");return a}
function getUnreadMsgJson(){var a=AnyBalance.requestPost("https://www.gosuslugi.ru/pgu/wsapi/gepsIntegration/getUnreadMessageCount",JSON.stringify({}),g_apiHeaders);a&&/"operation completed"/i.test(a)||(AnyBalance.trace(a),AnyBalance.trace("Не удалось получить информацию о госпочте, сайт изменен?"));return a}
function checkForJsOff(a){if(/Since your browser does not support JavaScript,\s+you must press the Continue button once to proceed/i.test(a)){AnyBalance.trace("Since your browser does not support JavaScript, you must press the Continue button once to proceed...");var b=createFormParams(a),d=getParam(a,null,null,/<form[^>]+action="([^"]+)/i,replaceTagsAndSpaces);if(!d)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти форму переадресации, сайт изменен?");a=checkForRedirect(AnyBalance.requestPost(d,
b,addHeaders({Referer:g_baseurl+"idp/profile/SAML2/Redirect/SSO"})))}return a}function checkForRedirect(a){var b=getParam(a,null,null,/<meta[^>]+"refresh"[^>]+url=([^"]+)/);if(b)return AnyBalance.trace("checkForRedirect: Нашли ссылку "+b),checkForJsOff(AnyBalance.requestGet(b,addHeaders({Referer:g_baseurl+"pgu/personcab"})));AnyBalance.trace("Данная страница не требует переадресации.");return a}
function createFormParamsById(a,b){var d=getParam(a,null,null,new RegExp('<form[^>]*id="s'+b+'"[\\s\\S]*?</form>'));if(!d){if(d=getParam(a,null,null,/"popupText"([^>]*>){2}/i,replaceTagsAndSpaces))throw new AnyBalance.Error(d);AnyBalance.trace(a);throw new AnyBalance.Error("Не удалось найти форму с данными для id: "+b+", такое бывает, если услуга недоступна. Если эта ошибка появляется часто - свяжитесь, пожалуйста, с разработчиками.");}return createFormParams(d)}
function getXmlFileResult(a){var b=getParam(a,null,null,/\{\s*url:[^"]*"\/([^"]*)/i,[/\s/ig,"%20"]);if(!b)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти ссылку для загрузки файла результата, сайт изменен?");return AnyBalance.requestGet(g_baseurl+b,{Accept:"text/html, * /*","X-Requested-With":"XMLHttpRequest","User-Agent":"Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.76 Safari/537.36"})}
function processNalogiBeta(a,b,d){if(isAvailable(["nalog_balance","nalog_info"])){b=AnyBalance.requestGet(g_betaBaseurl+"10002",g_headers);var c=AnyBalance.getLastResponseHeader("X-Atmosphere-tracking-id");b=getParam(b,null,null,/fns\.requestTemplate\s*=\s*(?:[\s\S]*?{){2}\s*"mnemonic":\s*"([^"]+)/i);checkEmpty(c,"X-Atmosphere-tracking-id header missing",!0);d={type:"javaServiceTask",serviceName:"formProcessing",methodName:"process",parameter:'{"submitComponent":"Fns.FormStep1.Panel1.button","submitEventNumber":"0","submitEvent":"submit","userSelectedRegion":"00000000000","form":{"mnemonic":"'+
b+'","content":{"Fns.FormStep1.Panel1.userInn":{"value":"'+d+'"},"Fns.FormStep1.Panel1.emailSend":{"value":false},"Fns.FormStep1.Panel1.phoneSend":{"value":false},"Fns.FormStep1.Panel1.formatedResponse":{"value":false},"Fns.FormStep1.Panel1.requested":{"value":false},"Fns.FormStep1.Panel1.useFailoverCache":{"value":false}}},"context":{"context":{"groovy":{"Script":"groovy.fnsFetchBill"}}}}'};c=apiCallBetaCabinet("POST","a/wsapi/?_="+(new Date).getTime(),JSON.stringify(d),{Origin:"https://beta.gosuslugi.ru",
"X-Atmosphere-tracking-id":c,"X-Atmosphere-Framework":"1.0","Content-Type":"application/json","X-Cache-Date":"0","X-Atmosphere-Transport":"long-polling",Referer:"https://beta.gosuslugi.ru/10002/result"});sumParam(c.form.content.total.total+"",a,"nalog_balance",null,replaceTagsAndSpaces,parseBalance,aggregate_sum);d="";for(var e in c.form.content)c.form.content[e].vidnalog&&(d+=c.form.content[e].vidnalog+": <b>"+c.form.content[e].summa+"</b><br/><br/>");""!=d&&sumParam(d,a,"nalog_info",null,replaceTagsAndSpaces,
null,aggregate_join)}}
function apiCallBetaCabinet(a,b,d,c){if("GET"==a)a=AnyBalance.requestGet(g_betaBaseurl+b,isset(c)?addHeaders(g_betaApiHeaders,c):g_betaApiHeaders);else if("POST"==a)a=AnyBalance.requestPost(g_betaBaseurl+b,d,isset(c)?addHeaders(g_betaApiHeaders,c):g_betaApiHeaders);else throw new AnyBalance.Error("Unexpected type of method: "+a);a=getJson(a);b=isset(a.error.code)?a.error.code:a.error.errorCode;d=a.error.message||a.error.errorMessage;if(0!==b){if(d)throw new AnyBalance.Error(d);throw new AnyBalance.Error("Произошла неизвестная ошибка при выполнении запроса.");
}return a};
