var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.76 Safari/537.36"},g_apiHeaders={Accept:"application/json, text/javascript, */*; q=0.01",Origin:"https://www.gosuslugi.ru","X-Requested-With":"XMLHttpRequest","User-Agent":"Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.76 Safari/537.36",
"Content-Type":"application/json",Referer:"https://www.gosuslugi.ru/pgu/personcab"},g_betaApiHeaders={Accept:"application/json, text/javascript, */*; q=0.01","User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.157 Safari/537.36","Accept-Language":"ru,en;q=0.8"},g_baseurl="https://www.gosuslugi.ru/",g_betaBaseurl="https://beta.gosuslugi.ru/",g_replaceSpacesAndBrs=[/^\s+|\s+$/g,"",/<br\/><br\/>$/i,""],g_max_plates_num=10,g_max_inns_num=3;
function login(a){AnyBalance.setDefaultCharset("utf-8");var b=getParam(a.login||"",null,null,/^\d{11}$/,[/^(\d{3})(\d{3})(\d{3})(\d{2})$/i,"$1-$2-$3 $4"]),c="snils";/@/.test(a.login)&&(b=getParam(a.login||"",null,null,/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/),c="email");"snils"==c?checkEmpty(b,'Введите СНИЛС (без пробелов и разделителей, 11 символов подряд). Вы ввели: "'+(a.login||"пустое поле")+'"!'):checkEmpty(b,
'Введите правильный Email. Вы ввели: "'+(a.login||"пустое поле")+'"!');checkEmpty(a.password,"Введите пароль!");var d=AnyBalance.requestGet(g_baseurl+"pgu/personcab",g_headers);if(!isLoggedIn(d)){var d=checkForRedirect(d),e=getParam(d,null,null,/new\s+LoginViewModel\((?:[^,]+,){1,2}'([^"']+)'/i);if(!e)throw AnyBalance.trace(d),new AnyBalance.Error("Не удалось найти идентификатор команды для входа.");d=AnyBalance.requestPost("https://esia.gosuslugi.ru/idp/login/pwd/do",{login:b,password:a.password,
idType:c,command:e},addHeaders({Referer:"https://esia.gosuslugi.ru/idp/rlogin?cc=bp"}));if(!isLoggedIn(d)&&(a=getParam(d,null,null,[/new LoginViewModel\([^,]+,'([^']+)/i,/authn\.error\.([^"']+)/i])))throw d=getJsonObject(d,/var jsonLocalizationMsg/i),d=getParam(d.d.error[a],null,null,null,replaceTagsAndSpaces),new AnyBalance.Error(d,null,/account_is_locked|certificate_user_not_found|invalid_credentials|invalid_signature|no_subject_found/i.test(a));/<h1[^>]*>\s*Выбор роли\s*<\/h1>|Войти как/i.test(d)&&
AnyBalance.requestGet("https://esia.gosuslugi.ru/idp/globalRoleSelection?orgID=P",g_headers);d=checkForRedirect(AnyBalance.requestGet("https://www.gosuslugi.ru/pgu/personcab",g_headers));d=checkForJsOff(d)}if(!isLoggedIn(d)){if(a=getParam(d,null,null,[/span\s*>\s*(Ошибка авторизации(?:[^>]*>){4})/i,/<div class="error[^>]*>([\s\S]*?)<\/div>/i],[replaceTagsAndSpaces,/Вернуться назад/i,""],html_entity_decode))throw new AnyBalance.Error(a,null,/Ошибка авторизации/i.test(a));AnyBalance.trace(d);throw new AnyBalance.Error("Не удалось зайти в личный кабинет. Сайт изменен?");
}return d}
function processProfile(a){if(AnyBalance.isAvailable("profile","fines","nalog")){a.profile={};getParam(b,a.profile,"profile.fio",/title="Личный кабинет"(?:[^>]*>){3}([^<]+)</i,replaceTagsAndSpaces);isAvailable("profile.mails")&&getParam(getUnreadMsgJson(),a.profile,"profile.mails",/"msgCount"\D*(\d+)/i,replaceTagsAndSpaces,parseBalance);var b=checkForRedirect(AnyBalance.requestGet("https://esia.gosuslugi.ru/profile/user/",g_headers));getParam(b,a.profile,"profile.fio",/ФИО(?:[\s\S]*?<dd[^>]*>)([\s\S]*?)(?:<\/dd>|<span[^>]+status-verify)/i,replaceTagsAndSpaces);
getParam(b,a.profile,"profile.birth_place",/Место рождения(?:[\s\S]*?<dd[^>]*>)([\s\S]*?)(?:<\/dd>|<span[^>]+status-verify)/i,replaceTagsAndSpaces);getParam(b,a.profile,"profile.birth_day",/Дата рождения(?:[\s\S]*?<dd[^>]*>)([\s\S]*?)(?:<\/dd>|<span[^>]+status-verify)/i,replaceTagsAndSpaces,parseDate);getParam(b,a.profile,"profile.document",/Документ, удостоверяющий личность(?:[\s\S]*?<dd[^>]*>)([\s\S]*?)(?:<\/dd>|<span[^>]+status-verify)/i,replaceTagsAndSpaces);getParam(b,a.profile,"profile.snils",
/Страховой номер индивидуального лицевого счёта(?:[\s\S]*?<dd[^>]*>)([\s\S]*?)<\/dd>/i,replaceTagsAndSpaces);getParam(b,a.profile,["profile.inn","nalog"],/id="person:someInnLinkId[^>]*>([\s\S]*?)<\//i,replaceTagsAndSpaces);getParam(b,a.profile,"profile.adress_fakt",/openAltAddress[^<]+'PRG'[^>]*>([\s\S]*?)<\//i,replaceTagsAndSpaces);getParam(b,a.profile,"profile.adress",/openAltAddress[^<]+'PLV'[^>]*>([\s\S]*?)<\//i,replaceTagsAndSpaces);getParam(b,a.profile,"profile.email",/altEmailWgt[^>]*>([\s\S]*?)<\//i,
replaceTagsAndSpaces);getParam(b,a.profile,"profile.phone",/altMobileWgt[^>]*>([\s\S]*?)<\//i,replaceTagsAndSpaces);var c=getElement(b,/<[^>]+altDrLicenceWgt.show[^>]*>/i,replaceTagsAndSpaces);isset(c)&&(getParam(c,a.profile,["profile.license_number","fines"],/[^,]*/,[/\s+/g,""]),getParam(c,a.profile,"profile.license"),getParam(c,a.profile,"profile.license_till",/действительно до([^<]+)/i,null,parseDate));if(b=getElement(b,/<div[^>]+id="person:vehicleInf">/i))for(b=getElements(b,/<dl[^>]+class="line-link">/ig),
AnyBalance.trace("Найдено автомобилей: "+b.length),a.profile.vehicles=[],c=0;c<b.length;++c){var d={};getParam(b[c],d,["profile.vehicles.name","fines"],/<dt>([^<]+)/i,replaceTagsAndSpaces);var e=getElement(b[c],/<dd[^>]*>/i,replaceTagsAndSpaces);getParam(e,d,["profile.vehicles.plate","fines"],/([^,]+)/i,[/\s+/g,""]);getParam(e,d,["profile.vehicles.plate_id","fines"],/свидетельство о регистрации\s*([^<]+)/i,[/\s+/g,""]);(isset(d.name)||isset(d.plate)||isset(d.plate_id))&&a.profile.vehicles.push(d)}}}
function processFinesBeta(a,b,c){var d=[],e=[],f=[];b.gosnumber&&(d=(b.gosnumber||"").split(/\s*;[\s;]*/g));b.sts_num&&(e=(b.sts_num||"").split(";"));AnyBalance.trace("Автомобилей: "+d.length);AnyBalance.trace("Свидетельств о регистрации: "+e.length);if(d.length!=e.length)throw new AnyBalance.Error("Введите одинаковое количество номеров автомобилей и свидетельств о регистрации!",null,!0);for(var g=0;g<d.length;++g)f.push({plate:d[g],plate_id:e[g]});processFinesBetaVehicles(a,f,b.licensenumber,c)}
function processFinesBetaVehicles(a,b,c,d){if(!(b&&b.length||c))AnyBalance.trace("Нет автомобилей или прав, штрафы не получаем");else if(isAvailable(["fines","fines_total","fines_unpaid"])){AnyBalance.trace("Указан номер автомобиля, значит надо получать штрафы...");a.fines=[];a.fines_unpaid=0;a.fines_total=0;html=AnyBalance.requestGet(g_baseurl+"10001/form",g_headers);var e=AnyBalance.getLastResponseHeader("X-Atmosphere-tracking-id");checkEmpty(e,"X-Atmosphere-tracking-id header missing",!0);var f=
getJsonObject(html,/gibdd\.requestTemplate/);if(f.form.content)for(c&&(f.form.content["GibddFines.FormStep1.Panel1.vuNumber"]={value:c}),c=0;c<b.length;c++)f.form.content["GibddFines.FormStep1.Panel1.carNumber"+c]={value:b[c].plate.replace(/\s+/g,"")},f.form.content["GibddFines.FormStep1.Panel1.stsNumber"+c]={value:b[c].plate_id.replace(/\s+/g,"")};b={type:"javaServiceTask",serviceName:"formProcessing",methodName:"process",parameter:f};e=apiCallBetaCabinet("POST","a/wsapi/?_="+(new Date).getTime(),
JSON.stringify(b),{Origin:g_baseurl,"X-Atmosphere-tracking-id":e,"X-Atmosphere-Framework":"1.0","Content-Type":"application/json","X-Cache-Date":"0","X-Atmosphere-Transport":"long-polling",Referer:g_baseurl+"10001/result"});if(0!=e.error.code)throw AnyBalance.trace(html),new AnyBalance.Error("Не удалось запросить информацию о штрафах, ошибка в запросе!");var e=e.form.content||{total:0},g;for(g in e)if((b=e[g])&&b.billSource){c=b.bID||b.billId;var h=b.fkNumber,f=parseBool(b.isPaid);b.originalAmount||
(b.originalAmount=b.violationSum);f||(sumParam(b.violationSum+"",a,"fines_unpaid",null,null,parseBalance,aggregate_sum),sumParam(b.originalAmount+"",a,"fines_unpaid_full",null,null,parseBalance,aggregate_sum));sumParam(b.violationSum+"",a,"fines_total",null,null,parseBalance,aggregate_sum);sumParam(b.originalAmount+"",a,"fines_total_full",null,null,parseBalance,aggregate_sum);if(d||!f)c={__id:c,__name:h},__shouldProcess("fines",c)&&(getParam(b.violationSum+"",c,"fines.ammount",null,replaceTagsAndSpaces,
parseBalance),getParam(b.violationReason,c,"fines.break",null,replaceTagsAndSpaces),getParam(b.violationDate+" "+b.violationTime,c,"fines.time",null,replaceTagsAndSpaces,parseDate),getParam(b.reportPlace,c,"fines.place",null,replaceTagsAndSpaces),getParam(b.carModel,c,"fines.vehicle",null,replaceTagsAndSpaces),getParam(b.offense,c,"fines.proto_place",null,replaceTagsAndSpaces),getParam(b.carNumber,c,"fines.carNumber",null,replaceTagsAndSpaces),getParam(f,c,"fines.paid")),a.fines.push(c)}}}
function parseBool(a){return!/0/.test(a)}function isLoggedIn(a){return/\/logout|title="Выход"/i.test(a)}function postAPICall(a,b,c){a=AnyBalance.requestPost(a,JSON.stringify(b),isset(c)?addHeaders({Referer:c}):g_apiHeaders);if(!a)throw AnyBalance.trace(html),new AnyBalance.Error("Не удалось получить информацию об услуге, сайт изменен?");return a}
function getUnreadMsgJson(){var a=AnyBalance.requestPost("https://www.gosuslugi.ru/pgu/wsapi/gepsIntegration/getUnreadMessageCount",JSON.stringify({}),g_apiHeaders);a&&/"operation completed"/i.test(a)||(AnyBalance.trace(a),AnyBalance.trace("Не удалось получить информацию о госпочте, сайт изменен?"));return a}
function checkForJsOff(a){if(/Since your browser does not support JavaScript,\s+you must press the Continue button once to proceed/i.test(a)){AnyBalance.trace("Since your browser does not support JavaScript, you must press the Continue button once to proceed...");var b=createFormParams(a),c=getParam(a,null,null,/<form[^>]+action="([^"]+)/i,replaceTagsAndSpaces);if(!c)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти форму переадресации, сайт изменен?");a=checkForRedirect(AnyBalance.requestPost(c,
b,addHeaders({Referer:g_baseurl+"idp/profile/SAML2/Redirect/SSO"})))}return a}function checkForRedirect(a){var b=getParam(a,null,null,/<meta[^>]+"refresh"[^>]+url=([^"]+)/);if(b)return AnyBalance.trace("checkForRedirect: Нашли ссылку "+b),checkForJsOff(AnyBalance.requestGet(b,addHeaders({Referer:g_baseurl+"pgu/personcab"})));AnyBalance.trace("Данная страница не требует переадресации.");return a}
function createFormParamsById(a,b){var c=getParam(a,null,null,new RegExp('<form[^>]*id="s'+b+'"[\\s\\S]*?</form>'));if(!c){if(c=getParam(a,null,null,/"popupText"([^>]*>){2}/i,replaceTagsAndSpaces))throw new AnyBalance.Error(c);AnyBalance.trace(a);throw new AnyBalance.Error("Не удалось найти форму с данными для id: "+b+", такое бывает, если услуга недоступна. Если эта ошибка появляется часто - свяжитесь, пожалуйста, с разработчиками.");}return createFormParams(c)}
function getXmlFileResult(a){var b=getParam(a,null,null,/\{\s*url:[^"]*"\/([^"]*)/i,[/\s/ig,"%20"]);if(!b)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти ссылку для загрузки файла результата, сайт изменен?");return AnyBalance.requestGet(g_baseurl+b,{Accept:"text/html, * /*","X-Requested-With":"XMLHttpRequest","User-Agent":"Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.76 Safari/537.36"})}
function processNalogiBeta(a,b,c){if(!c)AnyBalance.trace("Не указан ИНН, налоги не получаем...");else if(isAvailable(["nalog"])){a.nalog={};b=AnyBalance.requestGet(g_baseurl+"10002/form",g_headers);var d=getJsonObject(b,/rootScope.fns.requestTemplate\s*=/);if(!d)throw AnyBalance.trace(b),new AnyBalance.Error("Не удалось найти форму ввода инн. Сайт изменен?");d=d.form.mnemonic;b=AnyBalance.getLastResponseHeader("X-Atmosphere-tracking-id");checkEmpty(b,"X-Atmosphere-tracking-id header missing",!0);
c={type:"javaServiceTask",serviceName:"formProcessing",methodName:"process",parameter:'{"submitComponent":"Fns.FormStep1.Panel1.button","submitEventNumber":"0","submitEvent":"submit","userSelectedRegion":"00000000000","form":{"mnemonic":"'+d+'","content":{"Fns.FormStep1.Panel1.userInn":{"value":"'+c+'"},"Fns.FormStep1.Panel1.emailSend":{"value":false},"Fns.FormStep1.Panel1.phoneSend":{"value":false},"Fns.FormStep1.Panel1.formatedResponse":{"value":false},"Fns.FormStep1.Panel1.requested":{"value":false},"Fns.FormStep1.Panel1.useFailoverCache":{"value":false}}},"context":{"context":{"groovy":{"Script":"groovy.fnsFetchBill"}}}}'};
c=apiCallBetaCabinet("POST","a/wsapi/?_="+(new Date).getTime(),JSON.stringify(c),{Origin:g_baseurl,"X-Atmosphere-tracking-id":b,"X-Atmosphere-Framework":"1.0","Content-Type":"application/json","X-Cache-Date":"0","X-Atmosphere-Transport":"long-polling",Referer:g_baseurl+"10002/result"});sumParam(c.form.content.total.total+"",a.nalog,"nalog.debt",null,replaceTagsAndSpaces,parseBalance,aggregate_sum);b="";for(var e in c.form.content)c.form.content[e].vidnalog&&(b+=c.form.content[e].vidnalog+": <b>"+
c.form.content[e].summa+"</b><br/><br/>");""!=b&&sumParam(b,a.nalog,"nalog.info",null,replaceTagsAndSpaces,null,aggregate_join)}}
function apiCallBetaCabinet(a,b,c,d){if("GET"==a)a=AnyBalance.requestGet(g_baseurl+b,isset(d)?addHeaders(g_betaApiHeaders,d):g_betaApiHeaders);else if("POST"==a)a=AnyBalance.requestPost(g_baseurl+b,c,isset(d)?addHeaders(g_betaApiHeaders,d):g_betaApiHeaders);else throw new AnyBalance.Error("Unexpected type of method: "+a);a=getJson(a);b=isset(a.error.code)?a.error.code:a.error.errorCode;c=a.error.message||a.error.errorMessage;if(0!==b){if(c)throw new AnyBalance.Error(c);throw new AnyBalance.Error("Произошла неизвестная ошибка при выполнении запроса.");
}return a};
