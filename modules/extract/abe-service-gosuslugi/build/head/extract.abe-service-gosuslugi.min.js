var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.76 Safari/537.36"},g_apiHeaders={Accept:"application/json, text/javascript, */*; q=0.01",Origin:"https://www.gosuslugi.ru","X-Requested-With":"XMLHttpRequest","User-Agent":"Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.76 Safari/537.36",
"Content-Type":"application/json",Referer:"https://www.gosuslugi.ru/pgu/personcab"},g_betaApiHeaders={Accept:"application/json, text/javascript, */*; q=0.01","User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.157 Safari/537.36","Accept-Language":"ru,en;q=0.8"},g_baseurl="https://www.gosuslugi.ru/",g_betaBaseurl="https://beta.gosuslugi.ru/",g_replaceSpacesAndBrs=[/^\s+|\s+$/g,"",/<br\/><br\/>$/i,""],g_max_plates_num=10,g_max_inns_num=3;
function login(a){AnyBalance.setDefaultCharset("utf-8");var b=getParam(a.login||"",null,null,/^\d{11}$/,[/^(\d{3})(\d{3})(\d{3})(\d{2})$/i,"$1-$2-$3 $4"]),d="snils";/@/.test(a.login)&&(b=getParam(a.login||"",null,null,/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/),d="email");"snils"==d?checkEmpty(b,'Введите СНИЛС (без пробелов и разделителей, 11 символов подряд). Вы ввели: "'+(a.login||"пустое поле")+'"!'):checkEmpty(b,
'Введите правильный Email. Вы ввели: "'+(a.login||"пустое поле")+'"!');checkEmpty(a.password,"Введите пароль!");var c=AnyBalance.requestGet(g_baseurl+"pgu/personcab",g_headers);if(!isLoggedIn(c)){var c=checkForRedirect(c),e=getParam(c,null,null,/new\s+LoginViewModel\((?:[^,]+,){1,2}'([^"']+)'/i);if(!e)throw AnyBalance.trace(c),new AnyBalance.Error("Не удалось найти идентификатор команды для входа.");c=AnyBalance.requestPost("https://esia.gosuslugi.ru/idp/login/pwd/do",{login:b,password:a.password,
idType:d,command:e},addHeaders({Referer:"https://esia.gosuslugi.ru/idp/rlogin?cc=bp"}));if(a=getElement(c,/<form[^>]+otpForm/i))AnyBalance.trace("Требуется смс для входа"),c=getElement(c,/<[^>]*code-is-sent/i,replaceTagsAndSpaces),c=AnyBalance.retrieveCode(c||"Введите код подтверждения из SMS",null,{inputType:"number"}),a=createFormParams(a),a.otp=c,c=AnyBalance.requestPost("https://esia.gosuslugi.ru/idp/login/otp/do",a,addHeaders({Referer:AnyBalance.getLastUrl()}));if(!isLoggedIn(c)){if(a=getParam(c,
null,null,[/new LoginViewModel\([^,]+,'([^']+)/i,/authn\.error\.([^"']+)/i]))throw c=getJsonObject(c,/var jsonLocalizationMsg/i),c=getParam(c.d.error[a],null,null,null,replaceTagsAndSpaces),new AnyBalance.Error(c,null,/account_is_locked|certificate_user_not_found|invalid_credentials|invalid_signature|no_subject_found/i.test(a));if(a=getElement(c,/<div[^>]+error/i,replaceTagsAndSpaces))throw new AnyBalance.Error(a,null,/парол/i.test(c));}/<h1[^>]*>\s*Выбор роли\s*<\/h1>|Войти как/i.test(c)&&AnyBalance.requestGet("https://esia.gosuslugi.ru/idp/globalRoleSelection?orgID=P",
g_headers);c=checkForRedirect(AnyBalance.requestGet("https://www.gosuslugi.ru/pgu/personcab",g_headers));c=checkForJsOff(c)}if(!isLoggedIn(c)){if(a=getParam(c,[/span\s*>\s*(Ошибка авторизации(?:[^>]*>){4})/i,/<div class="error[^>]*>([\s\S]*?)<\/div>/i],[replaceTagsAndSpaces,/Вернуться назад/i,""]))throw new AnyBalance.Error(a,null,/Ошибка авторизации/i.test(a));AnyBalance.trace(c);throw new AnyBalance.Error("Не удалось зайти в личный кабинет. Сайт изменен?");}return c}
function processProfile(a){if(AnyBalance.isAvailable("profile","fines","nalog")){a.profile={};getParam(b,a.profile,"profile.fio",/title="Личный кабинет"(?:[^>]*>){3}([^<]+)</i,replaceTagsAndSpaces);isAvailable("profile.mails")&&getParam(getUnreadMsgJson(),a.profile,"profile.mails",/"msgCount"\D*(\d+)/i,replaceTagsAndSpaces,parseBalance);var b;checkForRedirect(AnyBalance.requestGet("https://lk.gosuslugi.ru/info",g_headers));var d=AnyBalance.getLastUrl();b=AnyBalance.requestGet("https://www.gosuslugi.ru/api/lk/v1/users/data?_="+
Math.random(),addHeaders({Referer:d}));d=getJson(b);getParam(d.lastName+" "+d.firstName+" "+d.middleName,a.profile,"profile.fio");getParam(d.personCitizenship,a.profile,"profile.birth_place");getParam(d.birthDate,a.profile,"profile.birth_day",null,replaceTagsAndSpaces,parseDateISO);var c=jspath1(d,'$.person.docs[?(@.type == "RF_PASSPORT")]');c?getParam(c.series+" "+c.number+" выдан "+c.issueDate+" "+c.issuedBy,a.profile,"profile.document"):AnyBalance.trace("Паспорт не найден: "+b);getParam(d.personSnils,
a.profile,"profile.snils");getParam(d.personInn,a.profile,["profile.inn","nalog"]);if(c=jspath1(d,'$.person.addresses[?(@.type == "PLV")]')){var e=c.addressStr+", "+c.house;c.flat&&(e+="-"+c.flat);getParam(e,a.profile,"profile.adress_fakt")}if(c=jspath1(d,'$.person.addresses[?(@.type == "PRG")]'))e=c.addressStr+", "+c.house,c.flat&&(e+="-"+c.flat),getParam(e,a.profile,"profile.adress");(c=jspath1(d,'$.person.docs[?(@.type == "RF_DRIVING_LICENSE")]'))?(getParam(c.series+c.number,a.profile,["profile.license_number",
"fines"],/[^,]*/,[/\s+/g,""]),getParam(c.series+c.number+", до "+c.expiryDate,a.profile,"profile.license"),getParam(c.expiryDate,a.profile,"profile.license_till",null,null,parseDate)):AnyBalance.trace("Права не найдены: "+b);if(b=jspath1(d,"$.person.vehicles"))for(AnyBalance.trace("Найдено автомобилей: "+b.length),a.profile.vehicles=[],c=0;c<b.length;++c)e={},getParam(b[c].name,e,["profile.vehicles.name","fines"]),getParam(b[c].numberPlate,e,["profile.vehicles.plate","fines"]),getParam(b[c].regCertificate.series+
b[c].regCertificate.number,e,["profile.vehicles.plate_id","fines"]),(isset(e.name)||isset(e.plate)||isset(e.plate_id))&&a.profile.vehicles.push(e);getParam(d.personEmail,a.profile,"profile.email");getParam(d.personMobilePhone,a.profile,"profile.phone")}}
function processFinesBeta(a,b,d){var c=[],e=[],f=[];b.gosnumber&&(c=(b.gosnumber||"").split(/\s*;[\s;]*/g));b.sts_num&&(e=(b.sts_num||"").split(";"));AnyBalance.trace("Автомобилей: "+c.length);AnyBalance.trace("Свидетельств о регистрации: "+e.length);if(c.length!=e.length)throw new AnyBalance.Error("Введите одинаковое количество номеров автомобилей и свидетельств о регистрации!",null,!0);for(var g=0;g<c.length;++g)f.push({plate:c[g],plate_id:e[g]});processFinesBetaVehicles(a,f,b.licensenumber,d)}
function guid(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}
function processFinesBetaVehicles(a,b,d,c){if(!(b&&b.length||d))AnyBalance.trace("Нет автомобилей или прав, штрафы не получаем");else if(isAvailable(["fines","fines_total","fines_unpaid"])){AnyBalance.trace("Указан номер автомобиля, значит надо получать штрафы...");a.fines=[];a.fines_unpaid=0;a.fines_total=0;html=AnyBalance.requestGet(g_baseurl+"10001/form",g_headers);var e=guid(),f=getJsonObject(html,/gibdd\.requestTemplate/);if(f.form.content)for(d&&(f.form.content["GibddFines.FormStep1.Panel1.vuNumber"]=
{value:d}),d=0;d<b.length;d++)f.form.content["GibddFines.FormStep1.Panel1.carNumber"+d]={value:b[d].plate.replace(/\s+/g,"")},f.form.content["GibddFines.FormStep1.Panel1.stsNumber"+d]={value:b[d].plate_id.replace(/\s+/g,"")};b={type:"javaServiceTask",serviceName:"formProcessing",methodName:"process",parameter:f};e=apiCallBetaCabinet("POST","api/sf/v1/a/wsapi/?_="+(new Date).getTime(),JSON.stringify(b),{Origin:g_baseurl,"X-Atmosphere-tracking-id":e,"X-Atmosphere-Framework":"1.0","Content-Type":"application/json",
"X-Cache-Date":"0","X-Atmosphere-Transport":"long-polling",Referer:g_baseurl+"10001/result"});if(0!=e.error.code)throw AnyBalance.trace(html),new AnyBalance.Error("Не удалось запросить информацию о штрафах, ошибка в запросе!");var e=e.form.content||{total:0},g;for(g in e)if((b=e[g])&&b.billSource){d=b.bID||b.billId;var h=b.fkNumber,f=parseBool(b.isPaid);b.originalAmount||(b.originalAmount=b.violationSum);f||(sumParam(b.violationSum+"",a,"fines_unpaid",null,null,parseBalance,aggregate_sum),sumParam(b.originalAmount+
"",a,"fines_unpaid_full",null,null,parseBalance,aggregate_sum));sumParam(b.violationSum+"",a,"fines_total",null,null,parseBalance,aggregate_sum);sumParam(b.originalAmount+"",a,"fines_total_full",null,null,parseBalance,aggregate_sum);if(c||!f)d={__id:d,__name:h},__shouldProcess("fines",d)&&(getParam(b.violationSum+"",d,"fines.ammount",null,replaceTagsAndSpaces,parseBalance),getParam(b.violationReason,d,"fines.break",null,replaceTagsAndSpaces),getParam(b.violationDate+" "+b.violationTime,d,"fines.time",
null,replaceTagsAndSpaces,parseDate),getParam(b.reportPlace,d,"fines.place",null,replaceTagsAndSpaces),getParam(b.carModel,d,"fines.vehicle",null,replaceTagsAndSpaces),getParam(b.offense,d,"fines.proto_place",null,replaceTagsAndSpaces),getParam(b.carNumber,d,"fines.carNumber",null,replaceTagsAndSpaces),getParam(f,d,"fines.paid")),a.fines.push(d)}}}function parseBool(a){return!/0/.test(a)}function isLoggedIn(a){return/\/logout|title="Выход"/i.test(a)}
function postAPICall(a,b,d){a=AnyBalance.requestPost(a,JSON.stringify(b),isset(d)?addHeaders({Referer:d}):g_apiHeaders);if(!a)throw AnyBalance.trace(html),new AnyBalance.Error("Не удалось получить информацию об услуге, сайт изменен?");return a}
function getUnreadMsgJson(){var a=AnyBalance.requestPost("https://www.gosuslugi.ru/pgu/wsapi/gepsIntegration/getUnreadMessageCount",JSON.stringify({}),g_apiHeaders);a&&/"operation completed"/i.test(a)||(AnyBalance.trace(a),AnyBalance.trace("Не удалось получить информацию о госпочте, сайт изменен?"));return a}
function checkForJsOff(a){if(/Since your browser does not support JavaScript,\s+you must press the Continue button once to proceed/i.test(a)){AnyBalance.trace("Since your browser does not support JavaScript, you must press the Continue button once to proceed...");var b=createFormParams(a),d=getParam(a,null,null,/<form[^>]+action="([^"]+)/i,replaceTagsAndSpaces);if(!d)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти форму переадресации, сайт изменен?");a=checkForRedirect(AnyBalance.requestPost(d,
b,addHeaders({Referer:g_baseurl+"idp/profile/SAML2/Redirect/SSO"})))}return a}function checkForRedirect(a){var b=getParam(a,null,null,/<meta[^>]+"refresh"[^>]+url=([^"]+)/);if(b)return AnyBalance.trace("checkForRedirect: Нашли ссылку "+b),checkForJsOff(AnyBalance.requestGet(b,addHeaders({Referer:g_baseurl+"pgu/personcab"})));AnyBalance.trace("Данная страница не требует переадресации.");return a}
function createFormParamsById(a,b){var d=getParam(a,null,null,new RegExp('<form[^>]*id="s'+b+'"[\\s\\S]*?</form>'));if(!d){if(d=getParam(a,null,null,/"popupText"([^>]*>){2}/i,replaceTagsAndSpaces))throw new AnyBalance.Error(d);AnyBalance.trace(a);throw new AnyBalance.Error("Не удалось найти форму с данными для id: "+b+", такое бывает, если услуга недоступна. Если эта ошибка появляется часто - свяжитесь, пожалуйста, с разработчиками.");}return createFormParams(d)}
function getXmlFileResult(a){var b=getParam(a,null,null,/\{\s*url:[^"]*"\/([^"]*)/i,[/\s/ig,"%20"]);if(!b)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти ссылку для загрузки файла результата, сайт изменен?");return AnyBalance.requestGet(g_baseurl+b,{Accept:"text/html, * /*","X-Requested-With":"XMLHttpRequest","User-Agent":"Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.76 Safari/537.36"})}
function processNalogiBeta(a,b,d){if(!d)AnyBalance.trace("Не указан ИНН, налоги не получаем...");else if(isAvailable(["nalog"])){a.nalog={};b=AnyBalance.requestGet(g_baseurl+"10002/form",g_headers);var c=getJsonObject(b,/rootScope.fns.requestTemplate\s*=/);if(!c)throw AnyBalance.trace(b),new AnyBalance.Error("Не удалось найти форму ввода инн. Сайт изменен?");c=c.form.mnemonic;b=guid();d={type:"javaServiceTask",serviceName:"formProcessing",methodName:"process",parameter:'{"submitComponent":"Fns.FormStep1.Panel1.button","submitEventNumber":"0","submitEvent":"submit","userSelectedRegion":"00000000000","form":{"mnemonic":"'+
c+'","content":{"Fns.FormStep1.Panel1.userInn":{"value":"'+d+'"},"Fns.FormStep1.Panel1.emailSend":{"value":false},"Fns.FormStep1.Panel1.phoneSend":{"value":false},"Fns.FormStep1.Panel1.formatedResponse":{"value":false},"Fns.FormStep1.Panel1.requested":{"value":false},"Fns.FormStep1.Panel1.useFailoverCache":{"value":false}}},"context":{"context":{"groovy":{"Script":"groovy.fnsFetchBill"}}}}'};d=apiCallBetaCabinet("POST","api/sf/v1/a/wsapi/?_="+(new Date).getTime(),JSON.stringify(d),{Origin:g_baseurl,
"X-Atmosphere-tracking-id":b,"X-Atmosphere-Framework":"1.0","Content-Type":"application/json","X-Cache-Date":"0","X-Atmosphere-Transport":"long-polling",Referer:g_baseurl+"10002/result"});sumParam(d.form.content.total.total+"",a.nalog,"nalog.debt",null,replaceTagsAndSpaces,parseBalance,aggregate_sum);b="";for(var e in d.form.content)d.form.content[e].vidnalog&&(b+=d.form.content[e].vidnalog+": <b>"+d.form.content[e].summa+"</b><br/><br/>");""!=b&&sumParam(b,a.nalog,"nalog.info",null,replaceTagsAndSpaces,
null,aggregate_join)}}
function apiCallBetaCabinet(a,b,d,c){if("GET"==a)a=AnyBalance.requestGet(g_baseurl+b,isset(c)?addHeaders(g_betaApiHeaders,c):g_betaApiHeaders);else if("POST"==a)a=AnyBalance.requestPost(g_baseurl+b,d,isset(c)?addHeaders(g_betaApiHeaders,c):g_betaApiHeaders);else throw new AnyBalance.Error("Unexpected type of method: "+a);a=getJson(a);b=isset(a.error.code)?a.error.code:a.error.errorCode;d=a.error.message||a.error.errorMessage;if(0!==b){if(d)throw new AnyBalance.Error(d);throw new AnyBalance.Error("Произошла неизвестная ошибка при выполнении запроса.");}return a}
;
