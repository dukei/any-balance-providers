function encryptPass(d,b){if(b){for(var a="",a=0,c="",e=b.split(","),f="",c=d;""!=c;)a=c.substr(0,1),a=a.charCodeAt(0),255<a&&(a-=848),7622==a&&(a=185),c=1<c.length?c.substr(1,c.length):"",""!=f&&(f+=";"),f+=e[a];return f}return d}var g_headers={"Accept-Language":"ru, en",BSSHTTPRequest:1,"User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/21.0.1180.60 Safari/537.1"},g_bss_sessionId,g_bss_info;
function loginBSS(d){if(g_bss_info)AnyBalance.trace("Используем существующую сессию...");else{var b=AnyBalance.getPreferences();checkEmpty(b.login,"Введите логин!");checkEmpty(b.password,"Введите пароль!");var a=AnyBalance.requestGet(d+"T=RT_2Auth.BF");if(!a||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(a),new AnyBalance.Error("Ошибка при подключении к сайту интернет-банка! Попробуйте обновить данные позже.");var c=getParam(a,null,null,/<input[^>]*name="MapID"[^>]*value="([^"]*)"/i),
a=getParam(a,null,null,/var\s+PassTemplate\s*=\s*new\s+Array\s*\(([^\)]*)/i),a=encryptPass(b.password,a),a=AnyBalance.requestPost(d,{tic:0,T:"RT_2Auth.CL",A:b.login,B:a,L:"russian",C:"",IdCaptcha:"",IMode:"",sTypeInterface:"default",MapID:c||""},g_headers);if(b=getParam(a,null,null,/<BSS_ERROR>\d*\|?([\s\S]*?)<\/BSS_ERROR>/i,replaceTagsAndSpaces,html_entity_decode))throw new AnyBalance.Error(b,null,/логина или пароля/i.test(b));b=getParam(a,null,null,/ClientInfo=(\{[\s\S]*?\})\s*(?:<\/div>|$)/i);
if(!b)throw new AnyBalance.Error("Не удалось найти информацию о сессии в ответе банка.");b=JSON.parse(b);AnyBalance.requestPost(d,{SID:b.SID,tic:1,T:"rt_0clientupdaterest.doheavyupd"},g_headers);c=0;do{AnyBalance.trace("Ожидание обновления данных: "+(c+1));var a=AnyBalance.requestPost(d,{SID:b.SID,tic:1,T:"rt_0clientupdaterest.CheckForAcyncProcess"},g_headers),e=getParam(a,null,null,/^\s*(?:<BSS_ERROR>([\s\S]*?)<\/BSS_ERROR>)?\d+\s*$/i,replaceTagsAndSpaces,html_entity_decode);if(e){AnyBalance.trace("Обновление данных закончено. "+
e);break}if(e=getParam(a,null,null,/^\s*(?:<BSS_ERROR>([\s\S]*?)<\/BSS_ERROR>)\s*$/i,replaceTagsAndSpaces,html_entity_decode)){AnyBalance.trace("Обновление данных закончено с ошибкой: "+e);break}if(10<++c){AnyBalance.trace("Не удалось за 10 попыток обновить баланс, получаем старое значение...");break}AnyBalance.sleep(3E3)}while(1);g_bss_info=b;g_bss_sessionId=b.SID;__setLoginSuccessful()}return g_bss_info};
