var g_baseurlLogin="http://login.mts.ru";
function checkLoginError(a,e){function c(k){var h=sumParam(k,/var\s+(?:passwordErr|loginErr)\s*=\s*'([^']*)/g,replaceSlashes,null,aggregate_join);h||(h=getElement(k,/<[^>]+field-help/i,replaceTagsAndSpaces));if(h)throw new AnyBalance.Error(h,null,/логин|парол/i.test(h));if(h=getElement(k,/<div[^>]+b-page_error__msg[^>]*>/,replaceTagsAndSpaces))throw new AnyBalance.Error(h);}var g=AnyBalance.getPreferences(),b=e.url;c(a);var d=getElement(a,/<[^>]+captcha-wrapper/i);d&&(d=getParam(d,/data:image\/\w+;base64,([^'"]+)/i,
replaceHtmlEntities));d&&0<=d.indexOf("iVBORw0KGgoAAAANSUhEUgAAANMAAAA6CAIAAAClLvvEAAAeQElEQVR42u3de7yVVZkH8NTQSi3N7uUltQuaoGFp")&&(AnyBalance.trace("Капча спрятана. Ищем её в другом месте"),d=null);d||(d=getParam(a,/"(ZGF0YTppbWFnZS[^"]*)/))&&(d=Base64.decode(d));d||(d=getParam(a,/<img id="captchaImage"\s*?src="([^"]+)/));d&&(d=getParam(d,/data:image\/\w+?(?:png)?;base64,([^'"]+)/i));if(d){AnyBalance.trace("МТС решило показать капчу :( Жаль");var f=AnyBalance.retrieveCode("МТС требует ввести капчу для входа в личный кабинет, чтобы подтвердить, что вы не робот. Введите символы, которые вы видите на картинке.",
d);(d=getElement(a,/<form[^>]+name="Login"/i))||(d=getElementById(a,"captchaForm"));d=createFormParams(d,function(k,h,n,m){"IDToken1"==n&&(m=g.login);"IDToken2"==n&&(m=f);return m});AnyBalance.trace("Логинимся с заданным номером и капчей");a=AnyBalance.requestPost(b,d,addHeaders({Origin:g_baseurlLogin,Referer:b}));var l=getParam(a,/data-error="([^"]*)/);if(l)throw new AnyBalance.Error(l,!0);fixCookies();500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500 при попытке логина. Пробуем ещё разок..."),
a=AnyBalance.requestPost(b,d,addHeaders({Origin:g_baseurlLogin,Referer:b})),fixCookies());if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС при попытке зайти, сервер не смог обработать запрос! Можно попытаться позже...",allowRetry);isOnLogin()&&getOrdinaryLoginForm(a)&&(a=loginOrdinaryForm(a,e));0==AnyBalance.getLastUrl().indexOf(g_baseurlLogin)&&c(a)}else if(/МТС\s*-\s*Установка пароля/i.test(a)){AnyBalance.trace("МТС потребовало установить пароль. Установим старый");
d=getElement(a,/<form[^>]+name="Login"/i);d=createFormParams(d,function(k,h,n,m){"IDToken2"==n&&(m=f);return m});a=AnyBalance.requestPost(b,d,addHeaders({Origin:g_baseurlLogin,Referer:b}));fixCookies();if(/Ваш пароль успешно/i.test(a))throw AnyBalance.trace(a),new AnyBalance.Error("МТС потребовала установить новый пароль, автоматическая установка старого не удалась. Сайт изменен?");d=getElement(a,/<form[^>]+name="Login"/i);d=createFormParams(d);a=AnyBalance.requestPost(b,d,addHeaders({Origin:g_baseurlLogin,
Referer:b}));fixCookies()}else throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти капчу. Сайт изменен?");return a}
function redirectIfNeeded(a){if(/<body[^>]+onload[^>]+submit/i.test(a)){AnyBalance.trace("Потребовался редирект формой...");var e=createFormParams(a),c=getParam(a,/<form[^>]+action=['"]([^'"]*)/,replaceHtmlEntities);c=c.replace(/^https:\/\/login\.mts\.ru(?::443)?/,"http://login.mts.ru");a=AnyBalance.getLastUrl();a=AnyBalance.requestPost(joinUrl(a,c),e,addHeaders({Refefer:a}));fixCookies()}if(e=getParam(a,/<meta[^>]+http-equiv="REFRESH"[^>]*content="0;url=([^";]*)/i,replaceHtmlEntities))AnyBalance.trace("Потребовался get редирект..."),
e=e.replace(/^https:\/\/login\.mts\.ru/,"http://login.mts.ru"),a=AnyBalance.getLastUrl(),a=AnyBalance.requestGet(joinUrl(a,e),addHeaders({Refefer:a})),fixCookies();return a}function isOnLogin(){return 0==AnyBalance.getLastUrl().indexOf(g_baseurlLogin)}function getOrdinaryLoginForm(a){return getElement(a,/<form[^>]+name="Login"/i)}
function enterMtsLK(a){var e=a.url||g_baseurlLogin,c=AnyBalance.requestGet(e,g_headers);fixCookies()&&(AnyBalance.trace("Куки исправлены на входе..."),c=AnyBalance.requestGet(AnyBalance.getLastUrl(),g_headers),fixCookies());500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500. Пробуем ещё разок..."),c=AnyBalance.requestGet(e,g_headers),fixCookies());if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС, сервер не смог обработать запрос. Можно попытаться позже...");
/Произошла ошибка при попытке авторизации/i.test(c)&&(AnyBalance.trace("Куки протухли :( Придется авторизоваться заново"),clearAllCookies(),c=AnyBalance.requestGet(e,g_headers),fixCookies());fixCookies()&&(AnyBalance.trace("Куки исправлены, перезагружаем страницу. Пробуем ещё разок..."),c=AnyBalance.requestGet(AnyBalance.getLastUrl(),g_headers),fixCookies());c=redirectIfNeeded(c);if(e=getParam(c,/Продолжить вход с номером([\s\S]*?)<\/[bp]/i,replaceTagsAndSpaces)){AnyBalance.trace("Предлагает автоматически залогиниться на "+
e);c=getElement(c,/<form[^>]+name="Login"/i);if(endsWith(e.replace(/\D+/g,""),a.login)){AnyBalance.trace("А нам этот номер и нужен. Соглашаемся...");var g="Login"}else AnyBalance.trace("А нам нужен номер "+a.login+". Отказываемся..."),g="Ignore";c=createFormParams(c,function(b,d,f,l){"IDButton"==f&&(l=g);return l});c=AnyBalance.requestPost(AnyBalance.getLastUrl(),c,addHeaders({Referer:AnyBalance.getLastUrl()}));fixCookies()}isOnLogin()?(a.html=c,a.url||(a.url=AnyBalance.getLastUrl()),c=enterMTS(a)):
AnyBalance.trace("Мы не на странице логина. Внутри уже?");if(isOnLogin())throw AnyBalance.trace(c),new AnyBalance.Error("Не удаётся зайти в личный кабинет");return c}
function fixCookies(){for(var a=AnyBalance.getCookies(),e=!1,c=0;c<a.length;++c){var g=a[c];/^login|REDIRECT_BACK_SERVER_URL$/i.test(g.name)&&!/^"/.test(g.value)&&(e='"'+g.value+'"',AnyBalance.trace("Исправляем куки "+g.name+" на "+e),AnyBalance.setCookie(g.domain,g.name,e,g),e=!0)}AnyBalance.getCookie("login")||AnyBalance.setCookie("login.mts.ru","login",'"https://login.mts.ru:443/amserver/UI/Login?service=lk&goto=http%3A%2F%2Flk.mts.ru%2F"',{path:"/amserver/UI/Login"});return e}
function saveLoginCookies(){var a=AnyBalance.getPreferences();AnyBalance.setData("login",a.login+"-v1");AnyBalance.saveCookies();AnyBalance.saveData()}function restoreLoginCookies(){var a=AnyBalance.getPreferences();AnyBalance.getData("login")===a.login+"-v1"&&AnyBalance.restoreCookies()}
function loginOrdinaryForm(a,e){AnyBalance.getPreferences();AnyBalance.trace("Найдена обычная форма входа");var c=getOrdinaryLoginForm(a);a=createFormParams(c,function(g,b,d,f){"IDToken1"==d?f=e.login:"IDToken2"==d?f=e.password:"noscript"==d?f=void 0:"IDButton"==d&&(f="Submit");return f});if(c=getParam(c,/data-sitekey="([^"]*)/i,replaceHtmlEntities))AnyBalance.trace("МТС требует рекапчу :("),c=solveRecaptcha("МТС требует ввода рекапчи, как и при входе через браузер. Пожалуйста, докажите, что вы не робот.",
loginUrl,c),a.IDToken3=c;AnyBalance.trace("Логинимся с заданным номером");a=AnyBalance.requestPost(e.url,a,addHeaders({Origin:g_baseurlLogin,Referer:e.url}));fixCookies();return a}
function enterMTS(a){var e=a.baseurl||g_baseurl,c=a.url=a.url||g_baseurlLogin+"/amserver/UI/Login?goto="+e,g=a.allowRetry,b=a.html;fixCookies();if(!b||!getOrdinaryLoginForm(b))if(b=AnyBalance.requestGet(c,g_headers),fixCookies(),500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500. Пробуем ещё разок..."),b=AnyBalance.requestGet(c,g_headers),fixCookies()),500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС, сервер не смог обработать запрос. Можно попытаться позже...",
g);if(0==AnyBalance.getLastUrl().indexOf(e))return b;b=redirectIfNeeded(b);if(e=getOrdinaryLoginForm(b))b=loginOrdinaryForm(b,a);else if(e=getElement(b,/<form[^>]+id="login-phone-form"/i)){AnyBalance.trace("Найдена корп. форма входа");var d=createFormParams(e,function(f,l,k,h){"IDToken1"==k&&(h=a.login);return h});b=AnyBalance.requestPost(c,d,addHeaders({Origin:g_baseurlLogin,Referer:c}));fixCookies();e=getElement(b,/<form[^>]+id="enter-password-form"/i);if(!e){if(c=getElement(b,/<[^>]+intro-text/i,
replaceTagsAndSpaces))throw new AnyBalance.Error(c,null,/не существует/i.test(c));AnyBalance.trace(b);throw new AnyBalance.Error("Не удалось найти форму ввода пароля. Сайт изменен?");}d=createFormParams(e,function(f,l,k,h){"IDToken1"==k?h=a.login:"IDToken2"==k&&(h=a.password);return h});b=AnyBalance.requestPost(c,d,addHeaders({Origin:g_baseurlLogin,Referer:c}));fixCookies()}else{if(/bobcmn/i.test(b))throw new AnyBalance.Error("МТС ввел защиту от автоматического входа. Пожалуйста, обратитесь в поддержку МТС, составьте обращение о невозможности использования третьесторонних программ слежения за балансом. Напомните им, что вы можете перейти к другому оператору, который не противодействует отслеживанию баланса.");
if(!b)throw new AnyBalance.Error("Личный кабинет МТС временно недоступен. Попробуйте ещё раз позже");if(/<h1[^>]*>\s*Request Error/i.test(b))throw new AnyBalance.Error("Личный кабинет МТС временно не работает. Попробуйте ещё раз позже");AnyBalance.trace(b);throw new AnyBalance.Error("Не удаётся найти форму входа! Сайт изменен?",g);}500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500 при попытке логина. Пробуем ещё разок..."),b=AnyBalance.requestPost(c,d,addHeaders({Origin:g_baseurlLogin,
Referer:c})),fixCookies());if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС при попытке зайти, сервер не смог обработать запрос! Можно попытаться позже...",g);isOnLogin()&&(b=checkLoginError(b,a));if(isOnLogin())throw AnyBalance.trace(b),new AnyBalance.Error("Не удаётся зайти в личный кабинет. Он изменился или проблемы на сайте.",g);return b};g_baseurlLogin="https://login.mts.ru";
function enterLKNew(a){var e=a.url=a.url||g_baseurlLogin+"/amserver/json/authenticate?authIndexType=service&authIndexValue=login-spa",c=a.allowRetry,g=getParam(a.login,null,null,null,[/.*(\d{3})(\d{3})(\d{2})(\d{2})$/,"+7 ($1) $2-$3-$4"]);html=AnyBalance.requestPost(e,null,addHeaders({Accept:"*/*","Accept-API-Version":"resource=4.0, protocol=1.0","Content-Type":"application/json",Origin:"https://login.mts.ru",Referer:"https://login.mts.ru/amserver/NUI/"}));if(!html||500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Личный кабинет МТС временно недоступен. Попробуйте ещё раз позже.",
c);var b=getJson(html);if(!b.header)throw AnyBalance.trace(html),new AnyBalance.Error("Не удаётся зайти в личный кабинет. Он изменился или проблемы на сайте.",c);var d=b.authId,f=b.header;f&&AnyBalance.trace("Progress header: "+f);"trusted-network"==b.header&&(html=AnyBalance.requestPost(e,JSON.stringify({authId:d,template:"NetworkHeaderRedirect.jsp",stage:"login-nodes-dslnull",header:"trusted-network",infoText:null,callbacks:[{type:"ConfirmationCallback",output:[{name:"prompt",value:"Confirm"},{name:"messageType",
value:0},{name:"options",value:["IGNORE","OK"]},{name:"optionType",value:-1},{name:"defaultOption",value:1}],input:[{name:"IDToken1",value:1}]},{type:"MetadataCallback",output:[{name:"data",value:{acceptableOperators:["MTS","OTHER"],hiddenLogo:!1,restrictXTethered:!0,acceptableOperatorsErrorMessage:"Введен неверный номер телефона.",accessConditions:"https://static.ssl.mts.ru/mts_rf/images/usloviya-edinogo-dostupa-k-servisam-MTS.html",correlationID:"7cef4c35-5349-4fe6-8f0f-7db3237b8fad",label:"Введите номер телефона",
turnOffFeedbackService:!0,feedbackServiceUrl:"feedback-prod.stage2.websso.msk.mts.ru"}}]}]}),addHeaders({Accept:"*/*","Accept-API-Version":"resource=4.0, protocol=1.0","Content-Type":"application/json",Origin:"https://login.mts.ru",Referer:"https://login.mts.ru/amserver/NUI/"})),b=getJson(html),(f=b.header)&&AnyBalance.trace("Progress header: "+f));"network-header"==b.header&&(html=AnyBalance.requestPost(e,JSON.stringify({authId:d,template:"NetworkHeader.jsp",stage:"login-nodes-dslnull",header:"network-header",
infoText:null,callbacks:[{type:"TextInputCallback",output:[{name:"prompt",value:"UUID"},{name:"defaultText",value:""}],input:[{name:"IDToken1",value:""}]},{type:"ConfirmationCallback",output:[{name:"prompt",value:"Confirm"},{name:"messageType",value:0},{name:"options",value:["IGNORE","OK"]},{name:"optionType",value:-1},{name:"defaultOption",value:0}],input:[{name:"IDToken2",value:1}]},{type:"MetadataCallback",output:[{name:"data",value:{acceptableOperators:["MTS","OTHER"],hiddenLogo:!1,restrictXTethered:!0,
acceptableOperatorsErrorMessage:"Введен неверный номер телефона.",accessConditions:"https://static.ssl.mts.ru/mts_rf/images/usloviya-edinogo-dostupa-k-servisam-MTS.html",correlationID:"866453b2-21c9-4e6b-a112-b20aff8b695e",label:"Введите номер телефона",turnOffFeedbackService:!0,feedbackServiceUrl:"feedback-prod.stage2.websso.msk.mts.ru"}}]}]}),addHeaders({Accept:"*/*","Accept-API-Version":"resource=4.0, protocol=1.0","Content-Type":"application/json",Origin:"https://login.mts.ru",Referer:"https://login.mts.ru/amserver/NUI/"})),
b=getJson(html),(f=b.header)&&AnyBalance.trace("Progress header: "+f));"enter-phone"==b.header&&(html=AnyBalance.requestPost(e,JSON.stringify({authId:d,template:"EnterPhone.jsp",stage:"login-nodes-dslnull",header:"enter-phone",infoText:null,callbacks:[{type:"NameCallback",output:[{name:"prompt",value:"Введите номер телефона"}],input:[{name:"IDToken1",value:"7"+a.login}]},{type:"ConfirmationCallback",output:[{name:"prompt",value:"Confirm"},{name:"messageType",value:0},{name:"options",value:["IGNORE",
"OK"]},{name:"optionType",value:-1},{name:"defaultOption",value:0}],input:[{name:"IDToken2",value:1}]},{type:"MetadataCallback",output:[{name:"data",value:{acceptableOperators:["MTS","OTHER"],hiddenLogo:!1,restrictXTethered:!0,acceptableOperatorsErrorMessage:"Введен неверный номер телефона.",accessConditions:"https://static.ssl.mts.ru/mts_rf/images/usloviya-edinogo-dostupa-k-servisam-MTS.html",correlationID:"7cef4c35-5349-4fe6-8f0f-7db3237b8fad",label:"Введите номер телефона",turnOffFeedbackService:!0,
feedbackServiceUrl:"feedback-prod.stage2.websso.msk.mts.ru"}}]}]}),addHeaders({Accept:"*/*","Accept-API-Version":"resource=4.0, protocol=1.0","Content-Type":"application/json",Origin:"https://login.mts.ru",Referer:"https://login.mts.ru/amserver/NUI/"})),b=getJson(html),(f=b.header)&&AnyBalance.trace("Progress header: "+f));"verify-password"==b.header&&(html=AnyBalance.requestPost(e,JSON.stringify({authId:d,template:"VerifyPassword.jsp",stage:"login-nodes-dslnull",header:"verify-password",infoText:null,
callbacks:[{type:"PasswordCallback",output:[{name:"prompt",value:"Verify password"}],input:[{name:"IDToken1",value:a.password}]},{type:"ConfirmationCallback",output:[{name:"prompt",value:"Confirm"},{name:"messageType",value:0},{name:"options",value:["IGNORE","OK","RESTART","RESTORE"]},{name:"optionType",value:-1},{name:"defaultOption",value:0}],input:[{name:"IDToken2",value:1}]},{type:"MetadataCallback",output:[{name:"data",value:{lockoutCount:3,hiddenLogo:!1,numberType:"MOBILE",restrictXTethered:!0,
acceptableOperatorsErrorMessage:"Введен неверный номер телефона.",accessConditions:"https://static.ssl.mts.ru/mts_rf/images/usloviya-edinogo-dostupa-k-servisam-MTS.html",label:"Введите номер телефона",abonent:"mMTS",userId:"c25f25f0-588d-11ea-98aa-b9cf018c481e",acceptableOperators:["MTS","OTHER"],invalidCount:0,recipient:g,authUserLevel:"1",correlationID:"7cef4c35-5349-4fe6-8f0f-7db3237b8fad",turnOffFeedbackService:!0,feedbackServiceUrl:"feedback-prod.stage2.websso.msk.mts.ru"}}]}]}),addHeaders({Accept:"*/*",
"Accept-API-Version":"resource=4.0, protocol=1.0","Content-Type":"application/json",Origin:"https://login.mts.ru",Referer:"https://login.mts.ru/amserver/NUI/"})),b=getJson(html),(f=b.header)&&AnyBalance.trace("Progress header: "+f));"verify-otp"==b.header&&(AnyBalance.trace("МТС запросил проверку с помощью кода из SMS"),a=AnyBalance.retrieveCode("Пожалуйста, введите код подтверждения, высланный на номер "+g+'\n\nЕсли вы не хотите постоянно вводить SMS-пароли при входе, выберите способ входа "Пароль" в настройках безопасности вашего личного кабинета МТС',
null,{inputType:"number",time:3E5}),html=AnyBalance.requestPost(e,JSON.stringify({authId:d,template:"VerifyOTP.jsp",stage:"login-nodes-dslnull",header:"verify-otp",infoText:null,callbacks:[{type:"PasswordCallback",output:[{name:"prompt",value:"Verify otp"}],input:[{name:"IDToken1",value:a}]},{type:"ConfirmationCallback",output:[{name:"prompt",value:"Confirm"},{name:"messageType",value:0},{name:"options",value:["IGNORE","OK","RESTART","REFRESH","CANTGET"]},{name:"optionType",value:-1},{name:"defaultOption",
value:0}],input:[{name:"IDToken2",value:1}]},{type:"MetadataCallback",output:[{name:"data",value:{hiddenLogo:!1,numberType:"MOBILE",restrictXTethered:!0,retryCount:3,isAux:!1,acceptableOperatorsErrorMessage:"Введен неверный номер телефона.",channel:"SMS",accessConditions:"https://static.ssl.mts.ru/mts_rf/images/usloviya-edinogo-dostupa-k-servisam-MTS.html",label:"Введите номер телефона",abonent:"mMTS",userId:"dfcc9720-019a-11ea-88ba-339a25f0d609",acceptableOperators:["MTS","OTHER"],invalidCount:0,
recipient:g,authUserLevel:"0",correlationID:"01a59697-d872-4a42-a3b3-c86877ad4bc8",isRestoreMode:!1,turnOffFeedbackService:!0,feedbackServiceUrl:"feedback-prod.stage2.websso.msk.mts.ru"}}]}]}),addHeaders({Accept:"*/*","Accept-API-Version":"resource=4.0, protocol=1.0","Content-Type":"application/json",Origin:"https://login.mts.ru",Referer:"https://login.mts.ru/amserver/NUI/"})),b=getJson(html),(f=b.header)&&AnyBalance.trace("Progress header: "+f));if("verify-otp"==b.header)throw e=b.callbacks[2].output[0].value.retryCount-
b.callbacks[2].output[0].value.invalidCount,AnyBalance.trace(html),new AnyBalance.Error("Неверный код! Осталось попыток: "+e);if(b.tokenId&&b.successUrl)AnyBalance.trace("Успешно вошли: "+JSON.stringify(b)),html=AnyBalance.requestGet(b.successUrl,addHeaders({Referer:"https://login.mts.ru/"}));else throw AnyBalance.trace(html),new AnyBalance.Error("Неверный логин или пароль!",c);return html};
