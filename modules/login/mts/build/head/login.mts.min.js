var g_baseurlLogin="https://login.mts.ru";
function checkLoginError(a,c){function b(a){var b=sumParam(a,null,null,/var\s+(?:passwordErr|loginErr)\s*=\s*'([^']*)/g,replaceSlashes,null,aggregate_join);if(b)throw new AnyBalance.Error(b,null,/Неверный пароль/i.test(b));if(b=getElement(a,/<div[^>]+b-page_error__msg[^>]*>/,replaceTagsAndSpaces))throw new AnyBalance.Error(b);}b(a);var d=getParam(a,/<img[^>]+id="kaptchaImage"[^>]*/i);d&&(d=getParam(d,/data:image\/\w+;base64,([^"]+)/i,replaceHtmlEntities));d&&0<=d.indexOf("iVBORw0KGgoAAAANSUhEUgAAANMAAAA6CAIAAAClLvvEAAAeQElEQVR42u3de7yVVZkH8NTQSi3N7uUltQuaoGFp")&&
(AnyBalance.trace("Капча спрятана. Ищем её в другом месте"),d=null);if(!d&&(d=getParam(a,/var\s+_0x[\da-f]+\s*=\s*\[\s*"([^"]*)/))&&(d=getParam(Base64.decode(d),/data:image\/\w+;base64,([^"]+)/i),!d))throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти капчу. Сайт изменен?");if(d){AnyBalance.trace("МТС решило показать капчу :( Жаль");var e=AnyBalance.retrieveCode("МТС требует ввести капчу для входа в личный кабинет, чтобы подтвердить, что вы не робот. Введите символы, которые вы видите на картинке.",
d);a=getParam(a,null,null,/<form[^>]+name="Login"[^>]*>([\s\S]*?)<\/form>/i);d=createFormParams(a,function(a,b,d,c){"IDToken2"==d&&(c=e);return c});AnyBalance.trace("Логинимся с заданным номером и капчей");a=AnyBalance.requestPost(c,d,addHeaders({Origin:g_baseurlLogin,Referer:c}));500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500 при попытке логина. Пробуем ещё разок..."),a=AnyBalance.requestPost(c,d,addHeaders({Origin:g_baseurlLogin,Referer:c})));if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС при попытке зайти, сервер не смог обработать запрос! Можно попытаться позже...",
allowRetry);0==AnyBalance.getLastUrl().indexOf(g_baseurlLogin)&&b(a)}return a}
function redirectIfNeeded(a){if(/<body[^>]+onload[^>]+submit/i.test(a)){AnyBalance.trace("Потребовался редирект формой...");var c=createFormParams(a),b=getParam(a,/<form[^>]+action=['"]([^'"]*)/,replaceHtmlEntities);a=AnyBalance.getLastUrl();a=AnyBalance.requestPost(joinUrl(a,b),c,addHeaders({Refefer:a}))}if(c=getParam(a,/<meta[^>]+http-equiv="REFRESH"[^>]*content="0;url=([^";]*)/i,replaceHtmlEntities))AnyBalance.trace("Потребовался get редирект..."),a=AnyBalance.getLastUrl(),a=AnyBalance.requestGet(joinUrl(a,
c),addHeaders({Refefer:a}));return a}function isOnLogin(){return 0==AnyBalance.getLastUrl().indexOf(g_baseurlLogin)}
function enterMtsLK(a){var c=a.url||g_baseurlLogin,b=AnyBalance.requestGet(c,g_headers);fixCookies()&&(AnyBalance.trace("Куки исправлены на входе..."),b=AnyBalance.requestGet(AnyBalance.getLastUrl(),g_headers));500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500. Пробуем ещё разок..."),b=AnyBalance.requestGet(c,g_headers));if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС, сервер не смог обработать запрос. Можно попытаться позже...");/Произошла ошибка при попытке авторизации/i.test(b)&&
(AnyBalance.trace("Куки протухли :( Придется авторизоваться заново"),clearAllCookies(),b=AnyBalance.requestGet(c,g_headers));fixCookies()&&(AnyBalance.trace("Куки исправлены, перезагружаем страницу. Пробуем ещё разок..."),b=AnyBalance.requestGet(AnyBalance.getLastUrl(),g_headers));b=redirectIfNeeded(b);if(c=getParam(b,/Продолжить вход[^<]+с номером\s*<b[^>]*>([\s\S]*?)<\/b>/i,[replaceTagsAndSpaces,/\D+/g,""])){AnyBalance.trace("Предлагает автоматически залогиниться на "+c);var b=getElement(b,/<form[^>]+name="Login"/i),
d;c&&endsWith(c,a.login)?(AnyBalance.trace("А нам этот номер и нужен. Соглашаемся..."),d="Login"):(AnyBalance.trace("А нам нужен номер "+a.login+". Отказываемся..."),d="Ignore");b=createFormParams(b,function(a,b,c,g){"IDButton"==c&&(g=d);return g});b=AnyBalance.requestPost(AnyBalance.getLastUrl(),b,addHeaders({Referer:AnyBalance.getLastUrl()}))}isOnLogin()?(a.html=b,a.url||(a.url=AnyBalance.getLastUrl()),b=enterMTS(a)):AnyBalance.trace("Мы не на странице логина. Внутри уже?");if(isOnLogin())throw AnyBalance.trace(b),
new AnyBalance.Error("Не удаётся зайти в личный кабинет");return b}
function fixCookies(){for(var a=AnyBalance.getCookies(),c=!1,b=0;b<a.length;++b){var d=a[b];/^login|REDIRECT_BACK_SERVER_URL$/i.test(d.name)&&!/^"/.test(d.value)&&(c='"'+d.value+'"',AnyBalance.trace("Исправляем куки "+d.name+" на "+c),AnyBalance.setCookie(d.domain,d.name,c,d),c=!0)}AnyBalance.getCookie("login")||AnyBalance.setCookie("login.mts.ru","login",'"https://login.mts.ru:443/amserver/UI/Login?service=lk&goto=http%3A%2F%2Fonline.mts.ru%2F"',{path:"/amserver/UI/Login"});return c}
function saveLoginCookies(){var a=AnyBalance.getPreferences();AnyBalance.setData("login",a.login);AnyBalance.saveCookies();AnyBalance.saveData()}function restoreLoginCookies(){var a=AnyBalance.getPreferences();AnyBalance.getData("login")==a.login&&AnyBalance.restoreCookies()}
function enterMTS(a){var c=a.baseurl||g_baseurl,b=a.url||g_baseurlLogin+"/amserver/UI/Login?goto="+c,d=a.allowRetry,e=a.html;fixCookies();if(!e||!/<form[^>]+name="Login"/i.test(e))if(e=AnyBalance.requestGet(b,g_headers),500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500. Пробуем ещё разок..."),e=AnyBalance.requestGet(b,g_headers)),500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС, сервер не смог обработать запрос. Можно попытаться позже...",
d);if(0==AnyBalance.getLastUrl().indexOf(c))return e;var e=redirectIfNeeded(e),f=getParam(e,null,null,/<form[^>]+name="Login"[^>]*>([\s\S]*?)<\/form>/i);if(!f){if(!e)throw new AnyBalance.Error("Личный кабинет МТС временно недоступен. Попробуйте ещё раз позже");if(/<h1[^>]*>\s*Request Error/i.test(e))throw new AnyBalance.Error("Личный кабинет МТС временно не работает. Попробуйте ещё раз позже");AnyBalance.trace(e);throw new AnyBalance.Error("Не удаётся найти форму входа! Сайт изменен?",d);}c=createFormParams(f,
function(b,d,c,e){"IDToken1"==c?e=a.login:"IDToken2"==c?e=a.password:"noscript"==c?e=void 0:"IDButton"==c&&(e="Submit");return e});if(e=getParam(f,/data-sitekey="([^"]*)/i,replaceHtmlEntities))AnyBalance.trace("МТС требует рекапчу :("),e=solveRecaptcha("МТС требует ввода рекапчи, как и при входе через браузер. Пожалуйста, докажите, что вы не робот.",b,e),c.IDToken3=e;AnyBalance.trace("Логинимся с заданным номером");e=AnyBalance.requestPost(b,c,addHeaders({Origin:g_baseurlLogin,Referer:b}));500<=AnyBalance.getLastStatusCode()&&
(AnyBalance.trace("МТС вернул 500 при попытке логина. Пробуем ещё разок..."),e=AnyBalance.requestPost(b,c,addHeaders({Origin:g_baseurlLogin,Referer:b})));if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС при попытке зайти, сервер не смог обработать запрос! Можно попытаться позже...",d);isOnLogin()&&(e=checkLoginError(e,b));if(isOnLogin())throw AnyBalance.trace(e),new AnyBalance.Error("Не удаётся зайти в личный кабинет. Он изменился или проблемы на сайте.",d);
return e};
