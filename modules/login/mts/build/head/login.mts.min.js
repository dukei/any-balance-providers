var g_baseurlLogin="https://login.mts.ru";
function checkLoginError(a,d){function c(a){var b=sumParam(a,/var\s+(?:passwordErr|loginErr)\s*=\s*'([^']*)/g,replaceSlashes,null,aggregate_join);b||(b=getElement(a,/<[^>]+field-help/i,replaceTagsAndSpaces));if(b)throw new AnyBalance.Error(b,null,/логин|парол/i.test(b));if(b=getElement(a,/<div[^>]+b-page_error__msg[^>]*>/,replaceTagsAndSpaces))throw new AnyBalance.Error(b);}var e=AnyBalance.getPreferences();c(a);var b=getElement(a,/<[^>]+captcha-wrapper/i);b&&(b=getParam(b,/data:image\/\w+;base64,([^'"]+)/i,
replaceHtmlEntities));b&&0<=b.indexOf("iVBORw0KGgoAAAANSUhEUgAAANMAAAA6CAIAAAClLvvEAAAeQElEQVR42u3de7yVVZkH8NTQSi3N7uUltQuaoGFp")&&(AnyBalance.trace("Капча спрятана. Ищем её в другом месте"),b=null);b||(b=getParam(a,/#captcha-wrapper\s*\{[^\}]*/));b&&(b=getParam(b,/data:image\/\w+;base64,([^'"]+)/i));if(b){AnyBalance.trace("МТС решило показать капчу :( Жаль");var f=AnyBalance.retrieveCode("МТС требует ввести капчу для входа в личный кабинет, чтобы подтвердить, что вы не робот. Введите символы, которые вы видите на картинке.",
b);a=getElement(a,/<form[^>]+name="Login"/i);b=createFormParams(a,function(a,b,c,d){if("IDToken1"==c||"IDToken2"==c)d=e.password;return d});AnyBalance.trace("Логинимся с заданным номером и капчей");a=AnyBalance.requestPost(d,b,addHeaders({Origin:g_baseurlLogin,Referer:d}));fixCookies();500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500 при попытке логина. Пробуем ещё разок..."),a=AnyBalance.requestPost(d,b,addHeaders({Origin:g_baseurlLogin,Referer:d})),fixCookies());if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС при попытке зайти, сервер не смог обработать запрос! Можно попытаться позже...",
allowRetry);0==AnyBalance.getLastUrl().indexOf(g_baseurlLogin)&&c(a)}else if(/МТС\s*-\s*Установка пароля/i.test(a)){AnyBalance.trace("МТС потребовало установить пароль. Установим старый");a=getElement(a,/<form[^>]+name="Login"/i);b=createFormParams(a,function(a,b,c,d){"IDToken2"==c&&(d=f);return d});a=AnyBalance.requestPost(d,b,addHeaders({Origin:g_baseurlLogin,Referer:d}));fixCookies();if(/Ваш пароль успешно/i.test(a))throw AnyBalance.trace(a),new AnyBalance.Error("МТС потребовала установить новый пароль, автоматическая установка старого не удалась. Сайт изменен?");
a=getElement(a,/<form[^>]+name="Login"/i);b=createFormParams(a);a=AnyBalance.requestPost(d,b,addHeaders({Origin:g_baseurlLogin,Referer:d}));fixCookies()}else throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти капчу. Сайт изменен?");return a}
function redirectIfNeeded(a){if(/<body[^>]+onload[^>]+submit/i.test(a)){AnyBalance.trace("Потребовался редирект формой...");var d=createFormParams(a),c=getParam(a,/<form[^>]+action=['"]([^'"]*)/,replaceHtmlEntities);a=AnyBalance.getLastUrl();a=AnyBalance.requestPost(joinUrl(a,c),d,addHeaders({Refefer:a}));fixCookies()}if(d=getParam(a,/<meta[^>]+http-equiv="REFRESH"[^>]*content="0;url=([^";]*)/i,replaceHtmlEntities))AnyBalance.trace("Потребовался get редирект..."),a=AnyBalance.getLastUrl(),a=AnyBalance.requestGet(joinUrl(a,
d),addHeaders({Refefer:a})),fixCookies();return a}function isOnLogin(){return 0==AnyBalance.getLastUrl().indexOf(g_baseurlLogin)}
function enterMtsLK(a){var d=a.url||g_baseurlLogin,c=AnyBalance.requestGet(d,g_headers);fixCookies()&&(AnyBalance.trace("Куки исправлены на входе..."),c=AnyBalance.requestGet(AnyBalance.getLastUrl(),g_headers),fixCookies());500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500. Пробуем ещё разок..."),c=AnyBalance.requestGet(d,g_headers),fixCookies());if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС, сервер не смог обработать запрос. Можно попытаться позже...");
/Произошла ошибка при попытке авторизации/i.test(c)&&(AnyBalance.trace("Куки протухли :( Придется авторизоваться заново"),clearAllCookies(),c=AnyBalance.requestGet(d,g_headers),fixCookies());fixCookies()&&(AnyBalance.trace("Куки исправлены, перезагружаем страницу. Пробуем ещё разок..."),c=AnyBalance.requestGet(AnyBalance.getLastUrl(),g_headers),fixCookies());c=redirectIfNeeded(c);if(d=getParam(c,/Продолжить вход с номером([\s\S]*?)<\/[bp]/i,replaceTagsAndSpaces)){AnyBalance.trace("Предлагает автоматически залогиниться на "+
d);c=getElement(c,/<form[^>]+name="Login"/i);if(endsWith(d.replace(/\D+/g,""),a.login)){AnyBalance.trace("А нам этот номер и нужен. Соглашаемся...");var e="Login"}else AnyBalance.trace("А нам нужен номер "+a.login+". Отказываемся..."),e="Ignore";c=createFormParams(c,function(a,c,d,g){"IDButton"==d&&(g=e);return g});c=AnyBalance.requestPost(AnyBalance.getLastUrl(),c,addHeaders({Referer:AnyBalance.getLastUrl()}));fixCookies()}isOnLogin()?(a.html=c,a.url||(a.url=AnyBalance.getLastUrl()),c=enterMTS(a)):
AnyBalance.trace("Мы не на странице логина. Внутри уже?");if(isOnLogin())throw AnyBalance.trace(c),new AnyBalance.Error("Не удаётся зайти в личный кабинет");return c}
function fixCookies(){for(var a=AnyBalance.getCookies(),d=!1,c=0;c<a.length;++c){var e=a[c];/^login|REDIRECT_BACK_SERVER_URL$/i.test(e.name)&&!/^"/.test(e.value)&&(d='"'+e.value+'"',AnyBalance.trace("Исправляем куки "+e.name+" на "+d),AnyBalance.setCookie(e.domain,e.name,d,e),d=!0)}AnyBalance.getCookie("login")||AnyBalance.setCookie("login.mts.ru","login",'"https://login.mts.ru:443/amserver/UI/Login?service=lk&goto=http%3A%2F%2Flk.mts.ru%2F"',{path:"/amserver/UI/Login"});return d}
function saveLoginCookies(){var a=AnyBalance.getPreferences();AnyBalance.setData("login",a.login+"-v1");AnyBalance.saveCookies();AnyBalance.saveData()}function restoreLoginCookies(){var a=AnyBalance.getPreferences();AnyBalance.getData("login")===a.login+"-v1"&&AnyBalance.restoreCookies()}
function enterMTS(a){var d=a.baseurl||g_baseurl,c=a.url||g_baseurlLogin+"/amserver/UI/Login?goto="+d,e=a.allowRetry,b=a.html;fixCookies();if(!b||!/<form[^>]+name="Login"/i.test(b))if(b=AnyBalance.requestGet(c,g_headers),fixCookies(),500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500. Пробуем ещё разок..."),b=AnyBalance.requestGet(c,g_headers),fixCookies()),500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС, сервер не смог обработать запрос. Можно попытаться позже...",
e);if(0==AnyBalance.getLastUrl().indexOf(d))return b;b=redirectIfNeeded(b);var f;if(f=getElement(b,/<form[^>]+name="Login"/i)){AnyBalance.trace("Найдена обычная форма входа");d=createFormParams(f,function(b,c,d,e){"IDToken1"==d?e=a.login:"IDToken2"==d?e=a.password:"noscript"==d?e=void 0:"IDButton"==d&&(e="Submit");return e});if(b=getParam(f,/data-sitekey="([^"]*)/i,replaceHtmlEntities))AnyBalance.trace("МТС требует рекапчу :("),b=solveRecaptcha("МТС требует ввода рекапчи, как и при входе через браузер. Пожалуйста, докажите, что вы не робот.",
c,b),d.IDToken3=b;AnyBalance.trace("Логинимся с заданным номером");b=AnyBalance.requestPost(c,d,addHeaders({Origin:g_baseurlLogin,Referer:c}));fixCookies()}else if(f=getElement(b,/<form[^>]+id="login-phone-form"/i)){AnyBalance.trace("Найдена корп. форма входа");d=createFormParams(f,function(b,c,d,e){"IDToken1"==d&&(e=a.login);return e});b=AnyBalance.requestPost(c,d,addHeaders({Origin:g_baseurlLogin,Referer:c}));fixCookies();f=getElement(b,/<form[^>]+id="enter-password-form"/i);if(!f){if(c=getElement(b,
/<[^>]+intro-text/i,replaceTagsAndSpaces))throw new AnyBalance.Error(c,null,/не существует/i.test(c));AnyBalance.trace(b);throw new AnyBalance.Error("Не удалось найти форму ввода пароля. Сайт изменен?");}d=createFormParams(f,function(b,d,c,e){"IDToken1"==c?e=a.login:"IDToken2"==c&&(e=a.password);return e});b=AnyBalance.requestPost(c,d,addHeaders({Origin:g_baseurlLogin,Referer:c}));fixCookies()}else{if(/bobcmn/i.test(b))throw new AnyBalance.Error("МТС ввел защиту от автоматического входа. Пожалуйста, обратитесь в поддержку МТС, составьте обращение о невозможности использования третьесторонних программ слежения за балансом. Напомните им, что вы можете перейти к другому оператору, который не противодействует отслеживанию баланса.");
if(!b)throw new AnyBalance.Error("Личный кабинет МТС временно недоступен. Попробуйте ещё раз позже");if(/<h1[^>]*>\s*Request Error/i.test(b))throw new AnyBalance.Error("Личный кабинет МТС временно не работает. Попробуйте ещё раз позже");AnyBalance.trace(b);throw new AnyBalance.Error("Не удаётся найти форму входа! Сайт изменен?",e);}500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500 при попытке логина. Пробуем ещё разок..."),b=AnyBalance.requestPost(c,d,addHeaders({Origin:g_baseurlLogin,
Referer:c})),fixCookies());if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС при попытке зайти, сервер не смог обработать запрос! Можно попытаться позже...",e);isOnLogin()&&(b=checkLoginError(b,c));if(isOnLogin())throw AnyBalance.trace(b),new AnyBalance.Error("Не удаётся зайти в личный кабинет. Он изменился или проблемы на сайте.",e);return b};
