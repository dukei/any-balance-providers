var g_headers={Accept:"*/*","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/29.0.1547.76 Safari/537.36","X-MicrosoftAjax":"Delta=true","X-Requested-With":"XMLHttpRequest"},g_baseurl="https://retail.payment.ru";
function getViewState(b){return getParam(b,null,null,[/name="__VIEWSTATE"[^>]*value="([^"]*)"/i,/__VIEWSTATE\|([^|]*)/i],replaceHtmlEntities)}function getEventValidation(b){return getParam(b,null,null,[/name="__EVENTVALIDATION"[^>]*value="([^"]*)"/i,/__EVENTVALIDATION\|([^|]*)/i],replaceHtmlEntities)}function getViewStateGenerator(b){return getParam(b,null,null,[/name="__VIEWSTATEGENERATOR[^>]*value="([^"]*)"/i,/__VIEWSTATEGENERATOR\|([^|]*)/i],replaceHtmlEntities)}
function requestAndCheckForErrors(b,a,c,e,d){b=/POST/.test(b)?AnyBalance.requestPost(a,c,e):AnyBalance.requestGet(a,e);if(d&&!/pageRedirect/i.test(b))throw AnyBalance.trace(b),new AnyBalance.Error("Не удаётся войти в интернет банк (внутренняя ошибка сайта)");if(/KeyAuth/i.test(b))throw new AnyBalance.Error("Для входа в интернет-банк требуются одноразовые пароли. Зайдите в интернет-банк с компьютера и отключите в Настройках требование одноразовых паролей при входе. Это безопасно, для операций по переводу денег пароли всё равно будут требоваться.");
if(/UpdateContactInfo.aspx/i.test(b))throw new AnyBalance.Error("Для входа в интернет-банк требуются обновить контактную информацию. Зайдите в интернет-банк с компьютера и следуйте инструкциям.");d&&(d=getParam(b,null,null,/pageRedirect\|\|([^\|]*)/i,replaceTagsAndSpaces,decodeURIComponent),AnyBalance.trace("Нашли ссылку "+d),b=AnyBalance.requestGet(g_baseurl+d,g_headers));if(d=getParam(b,null,null,/<div[^>]*class="errorMessage"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces))throw new AnyBalance.Error(d,
null,/Неверные учетные данные/i.test(d));return b}
function login(){var b=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");checkEmpty(b.login,"Пожалуйста, укажите логин для входа в интернет-банк Промсвязбанка!");checkEmpty(b.password,"Пожалуйста, укажите пароль для входа в интернет-банк Промсвязбанка!");var a=AnyBalance.requestGet(g_baseurl+"/n/Main/Home.aspx",g_headers);if(/logout/i.test(a))AnyBalance.trace("Уже внутри. Используем существующую сессию.");else{var c=getEventValidation(a),e=getViewState(a),a=getViewStateGenerator(a);
AnyBalance.setCookie("retail.payment.ru","__dp_rsa","version%3D3%2E4%2E1%2E0%5F1%26pm%5Ffpua%3Dmozilla%2F5%2E0%20%28windows%20nt%206%2E1%3B%20wow64%29%20applewebkit%2F537%2E36%20%28khtml%2C%20like%20gecko%29%20chrome%2F42%2E0%2E2311%2E90%20safari%2F537%2E36%7C5%2E0%20%28Windows%20NT%206%2E1%3B%20WOW64%29%20AppleWebKit%2F537%2E36%20%28KHTML%2C%20like%20Gecko%29%20Chrome%2F42%2E0%2E2311%2E90%20Safari%2F537%2E36%7CWin32%26pm%5Ffpsc%3D24%7C1440%7C900%7C900%26pm%5Ffpsw%3D%26pm%5Ffptz%3D3%26pm%5Ffpln%3Dlang%3Dru%7Csyslang%3D%7Cuserlang%3D%26pm%5Ffpjv%3D1%26pm%5Ffpco%3D1%26pm%5Ffpasw%3Dwidevinecdmadapter%7Cmhjfbmdgcfjbbpaeojofohoefgiehjai%7Cpepflashplayer%7Cinternal%2Dremoting%2Dviewer%7Cinternal%2Dnacl%2Dplugin%7Cinternal%2Dpdf%2Dviewer%26pm%5Ffpan%3DNetscape%26pm%5Ffpacn%3DMozilla%26pm%5Ffpol%3Dtrue%26pm%5Ffposp%3D%26pm%5Ffpup%3D%26pm%5Ffpsaw%3D1440%26pm%5Ffpspd%3D24%26pm%5Ffpsbd%3D%26pm%5Ffpsdx%3D%26pm%5Ffpsdy%3D%26pm%5Ffpslx%3D%26pm%5Ffpsly%3D%26pm%5Ffpsfse%3D%26pm%5Ffpsui%3D%26pm%5Fos%3DWindows%26pm%5Fbrmjv%3D42%26pm%5Fbr%3DChrome%26pm%5Finpt%3D%26pm%5Fexpt%3D");
requestAndCheckForErrors("POST",g_baseurl+"/n/Default.aspx?v3=true",{ctl00$ScriptManager:"ctl00$mainArea$upLogin|ctl00$mainArea$btnLogin",__EVENTTARGET:"",__EVENTARGUMENT:"",__VIEWSTATE:e,__VIEWSTATEENCRYPTED:"",__EVENTVALIDATION:c,__VIEWSTATEGENERATOR:a,ctl00$mainArea$LoginInput$vtcLogin:b.login,ctl00$mainArea$vtcPassword:b.password,__ASYNCPOST:!0,ctl00$mainArea$btnLogin:"Войти"},addHeaders({Referer:"https://retail.payment.ru/n/Default.aspx"}),!0);a=requestAndCheckForErrors("GET",g_baseurl+"/n/Main/Home.aspx",
"",g_headers);if(!/logout/i.test(a))throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось войти в интернет-банк. Сайт изменен?");__setLoginSuccessful()}return a}
function processAccounts(b,a){if(AnyBalance.isAvailable("accounts")){var c=getEventValidation(b),e=getViewState(b);/<div[^>]*isDetExpandBtn[^>]*accountList[^>]*>\s*подробно/i.test(b)&&(b=AnyBalance.requestPost(g_baseurl+"/n/Main/Home.aspx",{ctl00$ctl00$ScriptManager:"ctl00$ctl00$mainArea$main$upAccounts|ctl00$ctl00$mainArea$main$accountList",__EVENTTARGET:"ctl00$ctl00$mainArea$main$accountList",__EVENTARGUMENT:"_det_exp",__VIEWSTATE:e,__VIEWSTATEENCRYPTED:"",__EVENTVALIDATION:c,ctl00$ctl00$mainArea$right$OperationSearchRightColumn$OperationSearch$tbSearch:"",
ctl00_ctl00_mainArea_right_OperationSearchRightColumn_OperationSearch_tbSearch_InitialTextMode:"True",__ASYNCPOST:"true","":""},addHeaders({Referer:g_baseurl+"/n/Main/Home.aspx"})));c=getElements(b,/<div[^>]+class="infoUnit"[^>]*>/ig);AnyBalance.trace("Найдено счетов: "+c.length);a.accounts||(a.accounts=[]);for(e=0;e<c.length;++e){var d=c[e],g=getElement(d,/<div[^>]+"infoUnitCaption[^>]*>/i,replaceTagsAndSpaces),h=getElement(d,/<a[^>]+"infoUnitObject[^>]*>/i,[replaceTagsAndSpaces,/\s+/g,""]),g={__id:h,
__name:g+" *"+h.substr(-4),num:h};__shouldProcess("accounts",g)&&processAccount(d,g);a.accounts.push(g)}}}
function processAccount(b,a){AnyBalance.trace("Обработка счета "+a.__name);getParam(b,a,"accounts.balance",/"balanceAmountM"[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,["accounts.currency","accounts.balance","accounts.blocked","accounts.own"],/"balanceAmountCurrencyM"[^>]*>([^<]*)/i,replaceTagsAndSpaces);AnyBalance.isAvailable("accounts.blocked","accounts.own","accounts.unused_credit","accounts.minpay","accounts.minpay_till","accounts.gracepay","accounts.gracepay_till","accounts.contract",
"accounts.limit","accounts.pct","accounts.transactions")&&processAccountDetails(b,a)}
function processAccountDetails(b,a){AnyBalance.trace("Получаем детальную информацию по счету "+a.__name);var c=getParam(b,null,null,/"infoUnitObject"[^>]*href="([^"]*)/i),c=AnyBalance.requestGet(g_baseurl+c,g_headers);getParam(c,a,"accounts.own",/"ctl00_ctl00_mainArea_main_lblAccountBalance"[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"accounts.blocked",/"ctl00_ctl00_mainArea_main_lblReserved"[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"accounts.unused_credit",
/"ctl00_ctl00_mainArea_main_lblUnusedCredit"[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"accounts.minpay",/"ctl00_ctl00_mainArea_main_CreditNextRepayment_lblNextRepaymentSum"[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"accounts.minpay_till",/"ctl00_ctl00_mainArea_main_CreditNextRepayment_lblConditionDate"[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseDateWord);getParam(c,a,"accounts.gracepay",/"ctl00_ctl00_mainArea_main_lblGraceRepaymentSum"[^>]*>([^<]*)/i,replaceTagsAndSpaces,
parseBalance);getParam(c,a,"accounts.gracepay_till",/"ctl00_ctl00_mainArea_main_lblGraceRepaymentDate"[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseDateWord);getParam(c,a,"accounts.contract",/"ctl00_ctl00_mainArea_right_lblContract"[^>]*>([^<]*)/i,replaceTagsAndSpaces);getParam(c,a,"accounts.limit",/"ctl00_ctl00_mainArea_right_lblCreditLimit"[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"accounts.pct",/"ctl00_ctl00_mainArea_right_lblInterest"[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseBalance);
AnyBalance.isAvailable("accounts.transactions")&&processAccountTransactions(c,a)}
function processAccountsPreliminaryDetails(b,a,c){var e=getElement(b,/<div[^>]+accountDetailTextBlock[^>]*>/i);if(e)for(var d=getElement(b,/<div[^>]+accountDetailValueBlock[^>]*>/i),e=getElements(e.substr(1),/<div[^>]*>/ig),d=getElements(d.substr(1),/<div[^>]*>/ig),g=0;g<e.length;g++){var h=e[g],f=d[g];/ИТОГО/i.test(h)?(getParam(f,a,[c+"currency",c+"balance",c+"blocked",c+"own"],/<div[^>]+curNameISO[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces),getParam(f,a,c+"balance",null,replaceTagsAndSpaces,
parseBalance)):/собственные средства/i.test(h)?getParam(f,a,c+"own",null,replaceTagsAndSpaces,parseBalance):/кредитные средства/i.test(h)&&getParam(f,a,c+"unused_credit",null,replaceTagsAndSpaces,parseBalance)}getParam(b,a,c+"balance",/"balanceAmountM"[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,[c+"currency",c+"balance",c+"blocked",c+"own"],/"balanceAmountCurrencyM"[^>]*>([^<]*)/i,replaceTagsAndSpaces);"cards."==c?(getParam(b,a,c+"accnum",/<a[^>]+class="infoUnitObject[^>]*>([\s\S]*?)<\/a>/i,
[replaceTagsAndSpaces,/\D/g,""]),getParam(b,a,c+"accname",/<div[^>]+class="infoUnitCaption[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces)):getParam(b,a,c+"name",/<div[^>]+class="infoUnitCaption[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(b,a,c+"minpay_till",/ближайший платеж:([^>,]*)/i,replaceTagsAndSpaces,parseDate);getParam(b,a,c+"minpay",/ближайший платеж:[^>]*сумма:([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance)}
function processCards(b,a){function c(b){if(AnyBalance.isAvailable("accounts")&&b){var c=getElement(b,/<div[^>]+"infoUnitCaption[^>]*>/i,replaceTagsAndSpaces),d=getElement(b,/<a[^>]+"infoUnitObject[^>]*>/i,[replaceTagsAndSpaces,/\s+/g,""]),c={__id:d,__name:c+" *"+d.substr(-4),num:d};__shouldProcess("accounts",c)&&(processAccountsPreliminaryDetails(b,c,"accounts."),processAccount(b,c));a.accounts.push(c)}}if(AnyBalance.isAvailable("cards","accounts")){a.cards=[];a.accounts||(a.accounts=[]);b=AnyBalance.requestGet(g_baseurl+
"/n/Main/CardsAndAccounts.aspx",addHeaders({Referer:g_baseurl+"/n/Main/Home.aspx"}));var e=getElements(b,/<div[^>]+class="(?:cardAccountBlock|card)"/ig);AnyBalance.trace("Найдено карт и карточных счетов: "+e.length);for(var d=null,g=0;g<e.length;++g){var h=e[g];if(/cardAccountBlock/i.test(h))c(d),d=h;else if(AnyBalance.isAvailable("cards"))if(/emptyAccount/i.test(h))AnyBalance.trace("Пустая карта, пропускаем");else{var f=getParam(h,null,null,/<span[^>]+class="cardnumber[^>]*>([\s\S]*?)<\/span>/i,
replaceTagsAndSpaces),k=getParam(h,null,null,/<a[^>]+class="cardStandAloneCaption[^>]*>([\s\S]*?)<\/a>/i,replaceTagsAndSpaces),f={__id:f,num:f,__name:k+" *"+f.substr(-4)};__shouldProcess("cards",f)&&(processAccountsPreliminaryDetails(d,f,"cards."),processCard(h,f));a.cards.push(f)}}c(d)}}
function processCard(b,a){getParam(b,a,"cards.status",/<span[^>]+class="cardStatus[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces);getParam(b,a,"cards.name",/<a[^>]+class="cardStandAloneCaption[^>]*>([\s\S]*?)<\/a>/i,replaceTagsAndSpaces);getParam(b,a,"cards.ps",/<div[^>]+class="cardIconBlock[^>]*>[\s\S]*?<img[^>]+title="([^"]*)/i,replaceHtmlEntities);if(AnyBalance.isAvailable("cards.limit_cash_day","cards.limit_cash_month","cards.limit_pay_day","cards.limit_pay_month","cards.blocked","cards.till",
"cards.transactions")){var c=getParam(b,null,null,/<a[^>]+class="cardStandAloneCaption"[^>]*href="([^"]*)/i,replaceHtmlEntities);AnyBalance.trace("Запрашиваем детали по карте");c=AnyBalance.requestGet(g_baseurl+c,g_headers);getParam(c,a,"cards.limit_cash_day",/Снятие наличных в день:[\s\S]*?<span[^>]+class="limit"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"cards.limit_cash_month",/Снятие наличных в месяц:[\s\S]*?<span[^>]+class="limit"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,
parseBalance);getParam(c,a,"cards.limit_pay_day",/Другие расходные операции в день:[\s\S]*?<span[^>]+class="limit"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"cards.limit_pay_month",/Другие расходные операции в месяц:[\s\S]*?<span[^>]+class="limit"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"cards.blocked",/"ctl00_ctl00_mainArea_main_lblReserved"[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"cards.till",/"ctl00_ctl00_mainArea_main_lblExpireDate"[^>]*>([^<]*)/i,
replaceTagsAndSpaces,parseDate);AnyBalance.isAvailable("cards.transactions")&&processCardsTransactions(c,a)}}
function processDeposits(b,a){if(AnyBalance.isAvailable("deposits")){b=AnyBalance.requestGet(g_baseurl+"/n/Main/Deposits.aspx",addHeaders({Referer:g_baseurl+"/n/Main/Home.aspx"}));var c=getElement(b,/<div[^>]*infoSectionContents[^>]*>/i);if(c){c=getElements(c,/<div[^>]+infoUnit[^>]*>/ig);AnyBalance.trace("Найдено депозитов: "+c.length);a.deposits=[];for(var e=0;e<c.length;++e){var d=c[e],g=getParam(d,null,null,/<a[^>]+?infoUnitObject[^>]*?href="([^"]*)/i,replaceHtmlEntities),g=joinUrl(g_baseurl,g),
h=getElement(d,/<a[^>]+infoUnitObject[^>]*>/i,replaceTagsAndSpaces),d=AnyBalance.requestGet(g,addHeaders({Referer:g_baseurl+"/n/Main/Deposits.aspx"})),f=getElement(d,/<span[^>]+lblContract\b[^>]*>/i,replaceTagsAndSpaces),k=getParam(d,null,null,/Депозитный счет[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces),h=h+" "+f.substr(-4),f={__id:f,__name:h,num:k,contract:f};__shouldProcess("deposits",f)&&processDeposit(d,f,g);a.deposits.push(f)}}else/У вас нет депозитов/i.test(b)?(AnyBalance.trace("У вас нет депозитов"),
a.deposits=[]):(AnyBalance.trace(b),AnyBalance.trace("Не удалось найти таблицу с депозитами."))}}
function processDeposit(b,a,c){AnyBalance.trace("Обработка депозита "+a.__name);getParam(b,a,"deposits.balance",/<span[^>]+balanceMainAmountR[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,["deposits.currency","deposits.balance"],/<span[^>]+balanceMainCurrencyS[^>]*>([\s\S]*?)<\/span>/,replaceTagsAndSpaces);getParam(b,a,"deposits.date_start",/<span[^>]+lblContractDates[^>]*>([\s\S]*?)<\/span>/,replaceTagsAndSpaces,parseDateWord);getParam(b,a,"deposits.period",/<span[^>]+lblDepositPeriod[^>]*>([\s\S]*?)<\/span>/,
replaceTagsAndSpaces,parseBalance);getParam(b,a,"deposits.till",/<span[^>]+lblContractDates[^>]*>[^\-]*([\s\S]*?)<\/span>/,replaceTagsAndSpaces,parseDateWord);getParam(b,a,"deposits.name",/<span[^>]+lblCaption[^>]*>([\s\S]*?)<\/span>/,replaceTagsAndSpaces);getParam(b,a,"deposits.balance_start",/Первоначальный взнос[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"deposits.add",/>\s*Пополнение\s*<[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);
getParam(b,a,"deposits.add_till",/Последняя дата возможного пополнения[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseDateWord);getParam(b,a,"deposits.sub",/Списание[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"deposits.pcts",/Капитализация[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"deposits.pct",/Годовая ставка[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"deposits.pct_condition",
/Тип выплаты[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(b,a,"deposits.pct_period",/Период выплаты[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(b,a,"deposits.estimated_value",/Ожидаемый доход[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);isAvailable("deposits.transactions")&&processDepositTransactions(b,a,c)}
function processInfo(b,a){var c=a.info={};getParam(b,c,"info.fio",/<div[^>]+id="[^"]*divUserName"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);AnyBalance.isAvailable("info.mphone","info.smsphone","info.email","info.alias")&&(b=AnyBalance.requestGet(g_baseurl+"/n/Settings/Settings.aspx",g_headers),getParam(b,c,"info.mphone",/Номер телефона:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces),getParam(b,c,"info.email",/E-mail:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,[replaceTagsAndSpaces,
/<не заполнено>/i,""]),getParam(b,c,"info.smsphone",/<span[^>]+id="[^"]*lblSmsPhone"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces),getParam(b,c,"info.alias",/<input[^>]+vtcUserAlias[^>]*value="([^"]*)/i,replaceHtmlEntities))}
function processBonuses(b,a){isAvailable(["bonuses","bonuses_grade"])&&(b=AnyBalance.requestGet(g_baseurl+"/n/Services/BonusProgram.aspx"),getParam(b,a,"bonuses",[/class="bonusAmount"[^>]*>([^<]*)/i,/"ctl00_ctl00_mainArea_main_lblBonusAmount"[^>]*>([^<]*)/i],replaceTagsAndSpaces,parseBalance),getParam(b,a,"bonuses_grade",[/Уровень\s*"([^"]*)/i,/"ctl00_ctl00_mainArea_main_lblStatus"[^>]*>([^<]*)/i],replaceTagsAndSpaces))};
